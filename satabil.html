<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeknoHesap - YÃ¶netim Paneli</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* CSS Custom Properties for Theme System */
        :root {
            /* Light Theme Colors */
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-accent: #f1f5f9;
            --text-primary: #0f172a;
            --text-secondary: #475569;
            --text-muted: #64748b;
            --border-color: #e2e8f0;
            --border-hover: #cbd5e1;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
            --primary-color: #10b981;
            --primary-hover: #059669;
            --success-color: #34d399;
            --warning-color: #f59e0b;
            --error-color: #ef4444;
            --info-color: #3b82f6;
        }
        
        /* BASIT SCROLL OPTÄ°MÄ°ZASYONU */
        html {
            scroll-behavior: auto !important;
        }
        
        body {
            overscroll-behavior: none;
        }
        
        /* TÃ¼m elementler iÃ§in basit performans */
        * {
            backface-visibility: hidden;
        }
        
        /* Dark Theme */
        [data-theme="dark"] {
            --bg-primary: #0f172a;
            --bg-secondary: #1e293b;
            --bg-accent: #334155;
            --text-primary: #f8fafc;
            --text-secondary: #cbd5e1;
            --text-muted: #94a3b8;
            --border-color: #475569;
            --border-hover: #64748b;
            --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.3);
            --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.4), 0 2px 4px -2px rgb(0 0 0 / 0.4);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.5), 0 4px 6px -4px rgb(0 0 0 / 0.5);
        }
        
        /* Blue Theme */
        [data-theme="blue"] {
            --primary-color: #3b82f6;
            --primary-hover: #2563eb;
            --success-color: #06b6d4;
        }
        
        /* Purple Theme */
        [data-theme="purple"] {
            --primary-color: #8b5cf6;
            --primary-hover: #7c3aed;
            --success-color: #a78bfa;
        }
        
        /* Orange Theme */
        [data-theme="orange"] {
            --primary-color: #f97316;
            --primary-hover: #ea580c;
            --success-color: #fb923c;
        }
        
        /* Red Theme */
        [data-theme="red"] {
            --primary-color: #ef4444;
            --primary-hover: #dc2626;
            --success-color: #f87171;
        }
        
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: var(--bg-primary); 
            color: var(--text-primary);
            font-weight: 600;
        }
        
        .card { 
            background-color: var(--bg-secondary); 
            border-radius: 8px;
            border: 1px solid var(--border-color); 
            padding: 1rem; 
            font-weight: 600;
            color: #1e293b;
        }
        
        .card::before {
            display: none;
        }
        
        /* Hover before kaldÄ±rÄ±ldÄ± - performans iÃ§in */
        
        @media (min-width: 768px) { 
            .card {
                padding: 1.5rem; 
            }
        }
        
        .btn { 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            padding: 0.75rem 1.25rem; 
            border-radius: 8px; 
            font-weight: 700; 
            cursor: pointer; 
            border: 1px solid transparent;
            user-select: none;
        }
        
        .btn::before {
            display: none;
        }
        
        /* Active state kaldÄ±rÄ±ldÄ± */
        
        .btn > * {
            position: relative;
            z-index: 1;
        }
        
        .btn:disabled { 
            background-color: #e2e8f0; 
            color: #94a3b8; 
            cursor: not-allowed; 
            opacity: 0.7; 
            transform: none !important;
        }
        
        .btn-primary { 
            background: #10b981; 
            color: white; 
            font-weight: 700;
            border: none;
        } 
        
        .btn-secondary { 
            background: #e2e8f0; 
            color: #1e293b; 
            font-weight: 700;
            border: 1px solid #cbd5e1; 
        } 
        
        .btn-success { 
            background: #10b981; 
            color: white; 
            font-weight: 700;
            border: none;
        } 
        
        .btn-danger { 
            background: #ef4444; 
            color: white; 
            font-weight: 700;
            border: none;
        }
        
        .input-field { 
            width: 100%; 
            padding: 0.875rem 1rem; 
            border: 2px solid var(--border-color); 
            border-radius: 8px; 
            background: var(--bg-secondary); 
            color: var(--text-primary); 
            font-weight: 600;
        } 
        
        .input-field:focus { 
            outline: none; 
            border-color: var(--primary-color); 
        }
        
        /* Input hover kaldÄ±rÄ±ldÄ± - performans iÃ§in */
        
        /* TÃœM ANÄ°MASYONLAR KALDIRILDI - PERFORMANS Ä°Ã‡Ä°N */
        
        /* Pulse loader sadeleÅŸtirildi */
        .pulse-loader {
            display: inline-flex;
            gap: 4px;
            align-items: center;
        }
        
        .pulse-loader .dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #10b981;
            /* Animation kaldÄ±rÄ±ldÄ± */
        }
        
        .tab {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.25rem;
            cursor: pointer; 
            color: #475569;
            font-weight: 700;
            font-size: 0.875rem;
            margin: 0.25rem;
            border-radius: 8px;
            background: #f1f5f9;
            border: 2px solid #cbd5e1;
        }
        
        .tab::before {
            display: none;
        }
        
        .tab svg {
            width: 1.25rem;
            height: 1.25rem;
            /* Transition kaldÄ±rÄ±ldÄ± - performans iÃ§in */
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1));
        }
        
        /* Tab ikon animasyonlarÄ± - TAMAMIYLA KALDIRILDI */
        /* Performans iÃ§in tÃ¼m ikon animasyonlarÄ± devre dÄ±ÅŸÄ± */
        
        .tab span {
            font-family: 'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
            font-weight: 500;
            letter-spacing: -0.025em;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.06);
            /* Transition kaldÄ±rÄ±ldÄ± - performans iÃ§in */
        }
        
        /* Tab hover efektleri - PERFORMANS Ä°Ã‡Ä°N SADELEÅžTÄ°RÄ°LDÄ° */
        @media (hover: hover) and (pointer: fine) {
            .tab:hover:not(.active) {
                color: #1e293b;
                border-color: #64748b;
            }
        }

        /* Sekme Ã¶zel renkleri - DÃœZ RENKLER */
        .tab[data-tab="sales-panel"].active {
            background: #10b981;
            color: white;
            border-color: #059669;
            font-weight: 800;
        }
        
        .tab[data-tab="service-panel"].active {
            background: #3b82f6;
            color: white;
            border-color: #2563eb;
            font-weight: 800;
        }
        
        .tab[data-tab="service-history-panel"].active {
            background: #8b5cf6;
            color: white;
            border-color: #7c3aed;
            font-weight: 800;
        }
        
        .tab[data-tab="phone-stock-panel"].active {
            background: #f59e0b;
            color: white;
            border-color: #d97706;
            font-weight: 800;
        }
        
        .tab[data-tab="sold-phones-panel"].active {
            background: #06b6d4;
            color: white;
            border-color: #0891b2;
            font-weight: 800;
        }
        
        .tab[data-tab="debt-panel"].active {
            background: #ef4444;
            color: white;
            border-color: #dc2626;
            font-weight: 800;
        }
        
        .tab[data-tab="shortages-panel"].active {
            background: #f97316;
            color: white;
            border-color: #ea580c;
            font-weight: 800;
        }
        
        .tab[data-tab="daily-report-panel"].active {
            background: #84cc16;
            color: white;
            border-color: #65a30d;
            font-weight: 800;
        }
        
        .tab[data-tab="reports-panel"].active {
            background: #6366f1;
            color: white;
            border-color: #4f46e5;
            font-weight: 800;
        }
        
        .tab[data-tab="sales-history-panel"].active {
            background: #6366f1;
            color: white;
            border-color: #4f46e5;
            font-weight: 800;
        }
        
        .tab[data-tab="product-prices-panel"].active {
            background: #ec4899;
            color: white;
            border-color: #db2777;
            font-weight: 800;
        }
        
        .tab.active svg {
            color: white;
            /* Transform kaldÄ±rÄ±ldÄ± - performans iÃ§in */
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
        }
        
        .tab.active {
            /* Transform kaldÄ±rÄ±ldÄ± - performans iÃ§in */
            border-width: 2px;
        }

        /* Pasif durumlarda sekmelere Ã¶zel hafif renk tonlarÄ± - DÃœZ RENKLER */
        .tab[data-tab="sales-panel"]:not(.active) {
            background: #f0fdf4;
            border-color: #a7f3d0;
        }
        
        .tab[data-tab="service-panel"]:not(.active) {
            background: #eff6ff;
            border-color: #93c5fd;
        }
        
        .tab[data-tab="service-history-panel"]:not(.active) {
            background: #f5f3ff;
            border-color: #c4b5fd;
        }
        
        .tab[data-tab="phone-stock-panel"]:not(.active) {
            background: #fffbeb;
            border-color: #fcd34d;
        }
        
        .tab[data-tab="sold-phones-panel"]:not(.active) {
            background: #f0fdfa;
            border-color: #5eead4;
        }
        
        .tab[data-tab="debt-panel"]:not(.active) {
            background: #fef2f2;
            border-color: #f87171;
        }
        
        .tab[data-tab="shortages-panel"]:not(.active) {
            background: #fff7ed;
            border-color: #fb923c;
        }
        
        .tab[data-tab="daily-report-panel"]:not(.active) {
            background: #f7fee7;
            border-color: #a3e635;
        }
        
        .tab[data-tab="reports-panel"]:not(.active) {
            background: #eef2ff;
            border-color: #a5b4fc;
        }
        
        .tab[data-tab="cash-advances-panel"]:not(.active) {
            background: #dbeafe;
            color: #1e40af;
            border: 2px solid #93c5fd;
        }

        .tab[data-tab="product-prices-panel"]:not(.active) {
            background: #fdf2f8;
            border-color: #f9a8d4;
        }

        /* TÃœM HOVER EFEKTLERÄ° KALDIRILDI - PERFORMANS Ä°Ã‡Ä°N */
        
        .tab[data-tab="phone-stock-panel"]:not(.active):hover {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 50%, #fcd34d 100%);
            border-color: #facc15;
        }
        
        .tab[data-tab="sold-phones-panel"]:not(.active):hover {
            background: linear-gradient(135deg, #ccfbf1 0%, #99f6e4 50%, #5eead4 100%);
            border-color: #2dd4bf;
        }
        
        .tab[data-tab="debt-panel"]:not(.active):hover {
            background: linear-gradient(135deg, #fecaca 0%, #fca5a5 50%, #f87171 100%);
            border-color: #f56565;
        }
        
        .tab[data-tab="shortages-panel"]:not(.active):hover {
            background: linear-gradient(135deg, #fed7aa 0%, #fdba74 50%, #fb923c 100%);
            border-color: #f97316;
        }
        
        .tab[data-tab="daily-report-panel"]:not(.active):hover {
            background: linear-gradient(135deg, #d9f99d 0%, #bef264 50%, #a3e635 100%);
            border-color: #84cc16;
        }
        
        .tab[data-tab="reports-panel"]:not(.active):hover {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 50%, #a5b4fc 100%);
            border-color: #818cf8;
        }
        
        .tab[data-tab="sales-history-panel"]:not(.active) {
            background: linear-gradient(135deg, #eef2ff 0%, #e0e7ff 50%, #c7d2fe 100%);
            border-color: #a5b4fc;
        }
        
        .tab[data-tab="sales-history-panel"]:not(.active):hover {
            background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 50%, #a5b4fc 100%);
            border-color: #818cf8;
        }
        
        .tab[data-tab="cash-advances-panel"]:not(.active):hover {
            background: linear-gradient(135deg, #bfdbfe, #93c5fd) !important;
            color: #1e40af !important;
            transform: translateY(-2px) !important;
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3) !important;
            border-color: #60a5fa !important;
        }

        .tab[data-tab="product-prices-panel"]:not(.active):hover {
            background: linear-gradient(135deg, #fce7f3 0%, #fbcfe8 50%, #f9a8d4 100%);
            border-color: #f472b6;
        }

        @media (max-width: 639px) { /* Mobile devices */
            .tab {
                gap: 0.375rem;
                padding: 0.625rem 0.875rem;
                font-size: 0.8rem;
                margin: 0.125rem;
                border-radius: 0.75rem;
                box-shadow: 0 4px 8px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            }
            .tab svg {
                width: 1rem;
                height: 1rem;
            }
            .tab span {
                display: block;
                font-family: 'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
                font-size: 0.7rem;
                font-weight: 500;
                letter-spacing: -0.015em;
                line-height: 1.2;
                text-align: center;
                color: inherit;
                margin-top: 0.25rem;
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
            }
            .tab:hover:not(.active) {
                transform: translateY(-1px) scale(1.01);
                box-shadow: 0 8px 15px -3px rgba(0, 0, 0, 0.15), 0 4px 6px -2px rgba(0, 0, 0, 0.1);
            }
        }

        /* PERFORMANS Ä°Ã‡Ä°N ANIMASYON KALDIRILDI */

        /* Tab Grid Layout System */
        .tabs-container {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
            max-width: 100%;
        }

        .tab-category {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-radius: 1.25rem;
            padding: 1.5rem;
            border: 2px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .tab-category-title {
            font-size: 0.875rem;
            font-weight: 600;
            color: #475569;
            margin-bottom: 1rem;
            text-align: center;
            letter-spacing: 0.025em;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .tab-category-title::before,
        .tab-category-title::after {
            content: '';
            flex: 1;
            height: 1px;
            background: linear-gradient(90deg, transparent, #cbd5e1, transparent);
        }

        .tab-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 0.75rem;
        }

        /* Enhanced tab styling for grid layout */
        .tab {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem;
            cursor: pointer;
            color: #334155;
            font-weight: 600;
            font-size: 0.875rem;
            border-radius: 1rem;
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 50%, #cbd5e1 100%);
            border: 2px solid #94a3b8;
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 6px 12px -2px rgba(0, 0, 0, 0.15), 0 3px 6px -1px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.1);
            overflow: hidden;
            backdrop-filter: blur(10px);
            min-height: 80px;
            justify-content: center;
        }

        .tab svg {
            width: 1.5rem;
            height: 1.5rem;
            transition: all 0.3s ease;
            filter: drop-shadow(0 1px 2px rgba(0, 0, 0, 0.1));
        }

        .tab .tab-text {
            font-family: 'Inter', 'SF Pro Display', system-ui, -apple-system, sans-serif;
            letter-spacing: -0.025em;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
            text-align: center;
            line-height: 1.2;
        }

        @media (max-width: 768px) {
            .tabs-container {
                gap: 1rem;
            }
            
            .tab-category {
                padding: 1rem;
            }
            
            .tab-grid {
                grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
                gap: 0.5rem;
            }
            
            .tab {
                padding: 0.75rem 0.5rem;
                font-size: 0.8rem;
                min-height: 80px;
            }
            
            .tab svg {
                width: 1.25rem;
                height: 1.25rem;
            }
        }

        @media (max-width: 480px) {
            .tab-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .tab .tab-text {
                font-size: 0.75rem;
            }
            
            .tab span {
                font-family: 'Inter', 'SF Pro Display', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
                font-size: 0.68rem;
                font-weight: 500;
                letter-spacing: -0.015em;
                line-height: 1.1;
                text-align: center;
                color: inherit;
                margin-top: 0.2rem;
                text-shadow: 0 1px 2px rgba(0, 0, 0, 0.08);
                word-break: break-word;
                hyphens: auto;
            }
        }

        @media (min-width: 640px) { /* sm breakpoint and up */
            .tab {
                gap: 0.5rem;
                padding: 0.75rem 1.25rem;
                font-size: 0.875rem;
                margin: 0.25rem;
            }
            .tab svg {
                width: 1.25rem;
                height: 1.25rem;
            }
            .tab span {
                display: inline; /* Show text on larger screens */
            }
        }
        
        label { display: block; margin-bottom: 0.5rem; font-size: 0.875rem; font-weight: 500; color: #334155; } /* text-slate-700 */
        
        .modal-overlay { 
            position: fixed; 
            top: 0; 
            left: 0; 
            right: 0; 
            bottom: 0; 
            background-color: rgba(15, 23, 42, 0.6); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            z-index: 50; 
            backdrop-filter: blur(8px); 
            /* Animation kaldÄ±rÄ±ldÄ± - performans iÃ§in */
            padding: 1rem;
        }
        
        .modal-overlay .card {
            /* Animation kaldÄ±rÄ±ldÄ± - performans iÃ§in */
            max-height: 90vh;
            overflow-y: auto;
        }
        
        /* Modal animasyon keyframeleri kaldÄ±rÄ±ldÄ± - performans iÃ§in */
        
        th { font-weight: 600; color: #1e293b; } /* text-slate-800 */
        tbody tr { border-color: #e2e8f0 !important; } /* border-slate-200 */
        tbody tr:nth-child(even) { background-color: #f8fafc; } /* bg-slate-50 */
        tbody tr:hover { background-color: #f1f5f9; } /* bg-slate-100 */
        
        tfoot tr { background-color: #f1f5f9; font-weight: 600; } /* bg-slate-100 */

        .status-badge { display: inline-flex; align-items: center; padding: 0.25rem 0.75rem; border-radius: 9999px; font-weight: 500; font-size: 0.75rem; }
        .badge-green { background-color: #dcfce7; color: #166534; } /* bg-green-100, text-green-700 */
        .badge-yellow { background-color: #fefce8; color: #a16207; } /* bg-yellow-50, text-yellow-700 */
        .badge-blue { background-color: #dbeafe; color: #1e40af; } /* bg-blue-100, text-blue-700 */
        .badge-gray { background-color: #e2e8f0; color: #475569; } /* bg-slate-200, text-slate-600 */

        .stat-card-gradient { 
            padding: 1.5rem; 
            border-radius: 0.75rem; 
            color: white; 
            /* Transition ve transform kaldÄ±rÄ±ldÄ± - performans iÃ§in */
            box-shadow: 0 10px 15px -3px rgba(0,0,0,.3), 0 4px 6px -4px rgba(0,0,0,.3); 
        }

        /* Modern Quick Actions Cards */
        .quick-action-card {
            background: linear-gradient(135deg, var(--card-from), var(--card-to));
            border: none;
            border-radius: 16px;
            padding: 1.5rem;
            color: white;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 0 4px 15px -3px rgba(0, 0, 0, 0.1), 0 2px 6px -2px rgba(0, 0, 0, 0.05);
            position: relative;
            overflow: hidden;
        }
        
        .quick-action-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .quick-action-card:hover::before {
            opacity: 1;
        }
        
        .quick-action-card:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px -12px rgba(0, 0, 0, 0.25), 0 8px 16px -8px rgba(0, 0, 0, 0.3);
        }
        
        .quick-action-card:active {
            transform: translateY(-4px) scale(1.01);
        }
        
        .quick-action-card.emerald {
            --card-from: #10b981;
            --card-to: #059669;
        }
        
        .quick-action-card.amber {
            --card-from: #f59e0b;
            --card-to: #d97706;
        }
        
        .quick-action-card.sky {
            --card-from: #0ea5e9;
            --card-to: #0284c7;
        }
        
        .quick-action-icon {
            background: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 12px;
            padding: 12px;
            /* Transition kaldÄ±rÄ±ldÄ± - performans iÃ§in */
        }
        
        /* Hover efektleri kaldÄ±rÄ±ldÄ± - performans iÃ§in */
        
        .quick-action-title {
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 4px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }
        
        .quick-action-subtitle {
            font-size: 0.875rem;
            opacity: 0.9;
            line-height: 1.4;
        }
        
        @media (max-width: 768px) {
            .quick-action-card {
                padding: 1.25rem;
                border-radius: 12px;
            }
            
            .quick-action-icon {
                padding: 10px;
                border-radius: 10px;
            }
            
            .quick-action-title {
                font-size: 0.9rem;
            }
            
            .quick-action-subtitle {
                font-size: 0.8rem;
            }
        }

        .action-card {
            border-radius: 0.75rem; padding: 1rem; transition: all 0.2s ease-in-out; border: 1px solid; cursor: pointer;
            background: linear-gradient(#ffffff, #ffffff) padding-box, linear-gradient(145deg, #e2e8f0, #cbd5e1) border-box; /* bg-white, border-slate-200, border-slate-300 */
            border: 1px solid transparent;
        }
        .action-card:hover { transform: translateY(-2px); box-shadow: 0 8px 25px -5px rgba(0,0,0,.1), 0 4px 10px -6px rgba(0,0,0,.1); border-color: #cbd5e1; } /* border-slate-300 */
        
        .table-loader-row td, .table-error-row td { padding: 2rem; text-align: center; }
        .table-error-row td { color: #fca5a5; background-color: #450a0a; }

        .service-progress-bar { display: flex; width: 100%; height: 1rem; border-radius: 0.5rem; overflow: hidden; background-color: #334155; }
        .progress-segment { height: 100%; transition: all 0.3s ease-in-out; display: flex; align-items: center; justify-content: center; color: white; font-size: 0.75rem; font-weight: 600; }
        .progress-segment:hover { transform: scale(1.05); z-index: 10; filter: brightness(1.2); }
        
        /* PERFORMANS Ä°Ã‡Ä°N TÃœM ANÄ°MASYONLAR KALDIRILDI */
        
        /* Basit baÅŸlÄ±k stilleri */
        .animated-title {
            /* Animation kaldÄ±rÄ±ldÄ± */
            font-weight: 700;
            background: linear-gradient(135deg, #34d399, #10b981, #059669);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .attention-title {
            position: relative;
            display: inline-block;
            font-weight: bold;
            color: #3b82f6 !important;
            /* TÃ¼m animasyon ve hover efektleri kaldÄ±rÄ±ldÄ± */
        }

        [data-theme="dark"] .attention-title {
            color: #60a5fa !important;
        }

        /* Basit container */
        .modern-title-container {
            position: relative;
            padding: 20px 30px;
            margin: 10px 0;
            border-radius: 16px;
            text-align: center;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #e2e8f0;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            color: #3b82f6 !important;
            /* TÃ¼m animasyonlar kaldÄ±rÄ±ldÄ± */
        }

        .modern-title-container:hover .title-border-glow {
            animation-duration: 2s;
            opacity: 1;
            filter: blur(0.5px);
        }

        .modern-title-container:hover .title-bg-effect {
            opacity: 1;
            animation-duration: 1.5s;
        }

        /* Dark theme iÃ§in Ã¶zel efektler */
        [data-theme="dark"] .modern-title-container {
            background: linear-gradient(135deg, 
                rgba(30, 41, 59, 0.9) 0%, 
                rgba(51, 65, 85, 0.95) 50%, 
                rgba(71, 85, 105, 0.9) 100%
            );
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                0 4px 16px rgba(96, 165, 250, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1);
            color: #60a5fa !important;
        }

        [data-theme="dark"] .title-bg-effect {
            background: linear-gradient(45deg, 
                rgba(96, 165, 250, 0.1) 0%,
                rgba(147, 197, 253, 0.15) 25%,
                rgba(191, 219, 254, 0.1) 50%,
                rgba(147, 197, 253, 0.08) 75%,
                rgba(96, 165, 250, 0.05) 100%
            );
        }

        [data-theme="dark"] .title-border-glow {
            background: linear-gradient(45deg, 
                #60a5fa, #93c5fd, #bfdbfe, #dbeafe, #bfdbfe, #93c5fd, #60a5fa, #3b82f6
            );
            filter: blur(2px);
        }

        /* Tablet ve mobile responsive */
        @media (max-width: 768px) {
            .modern-title-container {
                padding: 16px 20px;
                margin: 8px 0;
                border-radius: 12px;
            }
            
            .title-border-glow {
                border-radius: 14px;
            }
            
            .title-bg-effect {
                border-radius: 10px;
            }
        }

        /* Ultra geniÅŸ ekranlar iÃ§in */
        @media (min-width: 1920px) {
            .modern-title-container {
                padding: 24px 40px;
                border-radius: 20px;
            }
        }

        /* HÄ±zlÄ± Ä°ÅŸlemler iÃ§in Ã¶zel turuncu tema */
        .quick-actions-title {
            background: linear-gradient(135deg, 
                rgba(255, 251, 235, 0.9) 0%, 
                rgba(254, 243, 199, 0.95) 50%, 
                rgba(253, 230, 138, 0.9) 100%
            ) !important;
            color: #d97706 !important;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.1),
                0 4px 16px rgba(217, 119, 6, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.8) !important;
        }

        /* PERFORMANS Ä°Ã‡Ä°N - HIZLI Ä°ÅžLEMLER BAÅžLIÄžI SADELEÅžTÄ°RÄ°LDÄ° */
        .quick-actions-title .attention-title {
            color: #d97706 !important;
            /* TÃ¼m animasyonlar kaldÄ±rÄ±ldÄ± */
        }

        [data-theme="dark"] .quick-actions-title .attention-title {
            color: #fbbf24 !important;
            /* TÃ¼m animasyonlar kaldÄ±rÄ±ldÄ± */
        }

        [data-theme="dark"] .quick-actions-title .title-bg-effect {
            background: linear-gradient(45deg, 
                rgba(251, 191, 36, 0.1) 0%,
                rgba(252, 211, 77, 0.15) 25%,
                rgba(253, 230, 138, 0.1) 50%,
                rgba(252, 211, 77, 0.08) 75%,
                rgba(251, 191, 36, 0.05) 100%
            ) !important;
        }

        [data-theme="dark"] .quick-actions-title .title-border-glow {
            background: linear-gradient(45deg, 
                #fbbf24, #fcd34d, #fde68a, #fef3c7, #fde68a, #fcd34d, #fbbf24, #f59e0b
            ) !important;
            filter: blur(2px);
        }

        @keyframes quick-glow-dark {
            0% {
                text-shadow: 
                    0 0 10px rgba(251, 191, 36, 0.7),
                    0 0 20px rgba(251, 191, 36, 0.6),
                    0 0 30px rgba(251, 191, 36, 0.5);
                color: #fbbf24;
            }
            25% {
                text-shadow: 
                    0 0 15px rgba(252, 211, 77, 0.8),
                    0 0 30px rgba(252, 211, 77, 0.7),
                    0 0 45px rgba(252, 211, 77, 0.6);
                color: #fcd34d;
            }
            50% {
                text-shadow: 
                    0 0 20px rgba(253, 230, 138, 0.9),
                    0 0 40px rgba(253, 230, 138, 0.8),
                    0 0 60px rgba(253, 230, 138, 0.7);
                color: #fde68a;
            }
            75% {
                text-shadow: 
                    0 0 15px rgba(252, 211, 77, 0.8),
                    0 0 30px rgba(252, 211, 77, 0.7),
                    0 0 45px rgba(252, 211, 77, 0.6);
                color: #fcd34d;
            }
            100% {
                text-shadow: 
                    0 0 10px rgba(251, 191, 36, 0.7),
                    0 0 20px rgba(251, 191, 36, 0.6),
                    0 0 30px rgba(251, 191, 36, 0.5);
                color: #fbbf24;
            }
        }

        [data-theme="dark"] .quick-actions-title:hover .attention-title {
            text-shadow: 0 0 25px rgba(251, 191, 36, 0.9);
        }

        /* Servis boÅŸ durumu iÃ§in Ã¶zel yeÅŸil tema */
        .service-empty-state {
            background: linear-gradient(135deg, 
                rgba(236, 253, 245, 0.9) 0%, 
                rgba(209, 250, 229, 0.95) 50%, 
                rgba(167, 243, 208, 0.9) 100%
            ) !important;
            color: #059669 !important;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.1),
                0 4px 16px rgba(5, 150, 105, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.8) !important;
            border: 2px solid rgba(16, 185, 129, 0.2) !important;
        }

        .service-empty-state .attention-title {
            color: #059669 !important;
            text-shadow: 0 0 10px rgba(5, 150, 105, 0.5);
            /* animation: service-pulse 2s ease-in-out infinite, service-glow 3s ease-in-out infinite alternate; */
        }

        .service-empty-state .title-bg-effect {
            background: linear-gradient(45deg, 
                rgba(5, 150, 105, 0.05) 0%,
                rgba(16, 185, 129, 0.08) 25%,
                rgba(52, 211, 153, 0.06) 50%,
                rgba(110, 231, 183, 0.04) 75%,
                rgba(167, 243, 208, 0.02) 100%
            ) !important;
        }

        .service-empty-state .title-border-glow {
            background: linear-gradient(45deg, 
                #059669, #10b981, #34d399, #6ee7b7, #a7f3d0, #6ee7b7, #34d399, #10b981
            ) !important;
            opacity: 0.7; /* Statik opacity */
        }

        @keyframes service-pulse {
            0%, 100% {
                transform: scale(1);
                opacity: 1;
            }
            50% {
                transform: scale(1.03);
                opacity: 0.95;
            }
        }

        @keyframes service-glow {
            0% {
                text-shadow: 
                    0 0 5px rgba(5, 150, 105, 0.5),
                    0 0 10px rgba(5, 150, 105, 0.4),
                    0 0 15px rgba(5, 150, 105, 0.3);
                color: #059669;
            }
            25% {
                text-shadow: 
                    0 0 10px rgba(16, 185, 129, 0.6),
                    0 0 20px rgba(16, 185, 129, 0.5),
                    0 0 30px rgba(16, 185, 129, 0.4);
                color: #10b981;
            }
            50% {
                text-shadow: 
                    0 0 15px rgba(52, 211, 153, 0.7),
                    0 0 30px rgba(52, 211, 153, 0.6),
                    0 0 45px rgba(52, 211, 153, 0.5);
                color: #34d399;
            }
            75% {
                text-shadow: 
                    0 0 10px rgba(110, 231, 183, 0.6),
                    0 0 20px rgba(110, 231, 183, 0.5),
                    0 0 30px rgba(110, 231, 183, 0.4);
                color: #6ee7b7;
            }
            100% {
                text-shadow: 
                    0 0 5px rgba(5, 150, 105, 0.5),
                    0 0 10px rgba(5, 150, 105, 0.4),
                    0 0 15px rgba(5, 150, 105, 0.3);
                color: #059669;
            }
        }

        .service-empty-state:hover {
            transform: scale(1.02);
            transition: transform 0.3s ease;
        }

        .service-empty-state:hover .attention-title {
            text-shadow: 0 0 20px rgba(5, 150, 105, 0.8);
        }

        /* Dark mode iÃ§in Servis boÅŸ durumu */
        [data-theme="dark"] .service-empty-state {
            background: linear-gradient(135deg, 
                rgba(30, 41, 59, 0.9) 0%, 
                rgba(51, 65, 85, 0.95) 50%, 
                rgba(71, 85, 105, 0.9) 100%
            ) !important;
            color: #34d399 !important;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.3),
                0 4px 16px rgba(52, 211, 153, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.1) !important;
            border: 2px solid rgba(52, 211, 153, 0.3) !important;
        }

        /* PERFORMANS Ä°Ã‡Ä°N - SERVÄ°S BOÅžLUK DURUMU SADELEÅžTÄ°RÄ°LDÄ° */
        [data-theme="dark"] .service-empty-state .attention-title {
            color: #34d399 !important;
            /* TÃ¼m animasyonlar kaldÄ±rÄ±ldÄ± */
        }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="theme-toggle" onclick="toggleThemePanel()" title="Tema AyarlarÄ±">
        ðŸŽ¨
    </div>

    <div id="loginView" class="min-h-screen flex items-center justify-center bg-slate-900">
        <div class="card w-full max-w-md !bg-slate-800"> <!-- Login kartÄ± koyu kalabilir veya aydÄ±nlÄ±k temaya uygun hale getirilebilir -->
            <h2 class="text-3xl font-bold text-center text-slate-100 mb-2">TeknoHesap</h2><p class="text-center text-slate-400 mb-8">LÃ¼tfen giriÅŸ yapÄ±n</p>
            <form id="loginForm" class="space-y-4">
                <div><label for="loginEmail" class="!text-slate-300">E-posta Adresi</label><input type="email" id="loginEmail" class="input-field !bg-slate-700 !text-slate-200 !border-slate-600 focus:!bg-slate-600" placeholder="ornek@mail.com" required></div>
                <div><label for="loginPassword" class="!text-slate-300">Åžifre</label><input type="password" id="loginPassword" class="input-field !bg-slate-700 !text-slate-200 !border-slate-600 focus:!bg-slate-600" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" required></div>
                <p id="loginError" class="text-red-400 text-sm text-center h-4"></p>
                <button type="submit" class="btn btn-primary w-full !py-3 !text-base">GiriÅŸ Yap</button>
            </form>
        </div>
    </div>
    
    <div id="loadingScreen" class="text-center hidden"><div class="loader"></div><p class="text-slate-400">Veriler yÃ¼kleniyor...</p></div>

    <div id="appContent" class="max-w-7xl mx-auto hidden">
        <!-- BÃ–LÃœM 1: BAÅžLIK VE KUR DÃ–NÃœÅžTÃœRÃœCÃœ -->
        <header class="flex flex-col sm:flex-row justify-between sm:items-center mb-10 space-y-4 sm:space-y-0">
            <div>
                <h1 class="text-4xl sm:text-5xl lg:text-6xl font-extrabold tracking-normal bg-clip-text text-transparent bg-gradient-to-r from-emerald-500 via-teal-500 to-cyan-500 animated-title">TeknoHesap</h1>
                <p class="text-slate-600 mt-2">SatÄ±ÅŸ, servis, stok ve finans takibiniz burada.</p>
            </div>
            <div class="flex flex-col items-end space-y-3 sm:flex-row sm:items-center sm:space-y-0 sm:space-x-4 lg:space-x-6">
                <!-- Logout Button -->
                <button id="logoutBtn" class="btn btn-secondary">Ã‡Ä±kÄ±ÅŸ Yap</button>
            </div>
        </header>

        <!-- BÃ–LÃœM 2: GÃœNLÃœK Ã–ZET KARTLARI -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
            <div class="stat-card-gradient bg-gradient-to-br from-emerald-700 to-emerald-500">
                <div class="flex justify-between items-start">
                    <h3 class="text-lg font-bold">GÃœNLÃœK CÄ°RO</h3>
                    <div class="icon-container p-3 bg-white/10 rounded-xl">
                        <svg class="icon icon-pulse icon-hover" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                            <circle cx="12" cy="12" r="1" fill="currentColor" opacity="0.8">
                                <animate attributeName="r" values="1;3;1" dur="2s" repeatCount="indefinite"/>
                                <animate attributeName="opacity" values="0.8;0.3;0.8" dur="2s" repeatCount="indefinite"/>
                            </circle>
                        </svg>
                    </div>
                </div>
                <p id="totalRevenue" class="text-3xl font-bold mt-2">0 TL</p>
            </div>
            <div class="stat-card-gradient bg-gradient-to-br from-rose-700 to-rose-500">
                <div class="flex justify-between items-start">
                    <h3 class="text-lg font-bold">GÃœNLÃœK MALÄ°YET</h3>
                    <div class="icon-container p-3 bg-white/10 rounded-xl">
                        <svg class="icon icon-shake icon-hover" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z"/>
                            <animateTransform attributeName="transform" type="rotate" values="0 12 12;5 12 12;-5 12 12;0 12 12" dur="0.8s" repeatCount="indefinite"/>
                        </svg>
                    </div>
                </div>
                <p id="totalCost" class="text-2xl font-bold mt-2">0 TL</p>
            </div>
            <div class="stat-card-gradient bg-gradient-to-br from-teal-700 to-teal-500">
                <div class="flex justify-between items-start">
                    <h3 class="text-lg font-bold">GÃœNLÃœK NET KÃ‚R</h3>
                    <div class="icon-container p-3 bg-white/10 rounded-xl">
                        <svg class="icon icon-bounce icon-hover" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <path d="M16 6l2 14-8-4-8 4 2-14 6-2z"/>
                            <circle cx="12" cy="4" r="2" fill="currentColor">
                                <animate attributeName="r" values="2;3;2" dur="1s" repeatCount="indefinite"/>
                            </circle>
                            <path d="M12 8v8" stroke-dasharray="2,2">
                                <animate attributeName="stroke-dashoffset" values="0;4" dur="1s" repeatCount="indefinite"/>
                            </path>
                        </svg>
                    </div>
                </div>
                <p id="totalProfit" class="text-3xl font-bold mt-2">0 TL</p>
            </div>
            <div class="stat-card-gradient bg-gradient-to-br from-amber-700 to-amber-500">
                <div class="flex justify-between items-start">
                    <h3 class="text-lg font-bold">Toplam BorÃ§ (USD)</h3>
                    <div class="icon-container p-3 bg-white/10 rounded-xl">
                        <svg class="icon icon-glow icon-hover-spin" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                            <circle cx="12" cy="12" r="10"/>
                            <path d="M12 8v8"/>
                            <path d="M8 12h8"/>
                            <circle cx="12" cy="12" r="3" fill="none" stroke="currentColor" stroke-width="1" opacity="0.5">
                                <animate attributeName="r" values="3;6;3" dur="2s" repeatCount="indefinite"/>
                                <animate attributeName="opacity" values="0.5;0.1;0.5" dur="2s" repeatCount="indefinite"/>
                            </circle>
                        </svg>
                    </div>
                </div>
                <p id="totalDebt" class="text-3xl font-bold mt-2">0.00 $</p>
            </div>
        </div>
        
        <!-- BÃ–LÃœM 3: AKTÄ°F SERVÄ°S DURUM PANELÄ° -->
        <div id="activeServiceStatusPanel" class="mb-10"></div>

        <!-- BÃ–LÃœM 4: ANA NAVÄ°GASYON VE Ä°Ã‡ERÄ°K PANELLERÄ° -->
        <div class="card !p-4 sm:!p-6 mb-8">
            <div class="tabs-container" id="tabs">
                <!-- Ana Ä°ÅŸlemler Kategorisi -->
                <div class="tab-category">
                    <h3 class="tab-category-title">
                        âš¡ Ana Ä°ÅŸlemler
                    </h3>
                    <div class="tab-grid">
                        <button class="tab active" data-tab="sales-panel">
                            <svg class="icon-hover-scale icon-active-glow" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <defs>
                                    <linearGradient id="salesGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:#10b981;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#059669;stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 3h1.386c.51 0 .955.343 1.087.835l.383 1.437M7.5 14.25a3 3 0 00-3 3h15.75m-12.75-3h11.218c1.121-2.3 2.1-4.684 2.924-7.138a60.114 60.114 0 00-16.536-1.84M7.5 14.25L5.106 5.272M6 20.25a.75.75 0 11-1.5 0 .75.75 0 011.5 0zm12.75 0a.75.75 0 11-1.5 0 .75.75 0 011.5 0z"/>
                                <!-- Kasa iÃ§indeki paralar -->
                                <circle cx="12" cy="10" r="1.5" fill="url(#salesGradient)" opacity="0.8">
                                    <animate attributeName="opacity" values="0.5;1;0.5" dur="2s" repeatCount="indefinite"/>
                                </circle>
                                <circle cx="14" cy="8" r="1" fill="url(#salesGradient)" opacity="0.6">
                                    <animate attributeName="opacity" values="0.3;0.8;0.3" dur="2.5s" repeatCount="indefinite"/>
                                </circle>
                                <circle cx="10" cy="8" r="0.8" fill="url(#salesGradient)" opacity="0.7">
                                    <animate attributeName="opacity" values="0.4;0.9;0.4" dur="1.8s" repeatCount="indefinite"/>
                                </circle>
                            </svg>
                            <span class="tab-text">ðŸ’° SatÄ±ÅŸ Paneli</span>
                        </button>
                        <button class="tab" data-tab="service-panel">
                            <svg class="icon-hover-rotate icon-glow" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <defs>
                                    <linearGradient id="serviceGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#1d4ed8;stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                                <path stroke-linecap="round" stroke-linejoin="round" d="M11.42 15.17L17.25 21A2.652 2.652 0 0021 17.25l-5.877-5.877M11.42 15.17l2.496-3.03c.317-.384.74-.626 1.208-.766M11.42 15.17l-4.655 5.653a2.548 2.548 0 11-3.586-3.586l6.837-5.63m5.108-.233c.55-.164 1.163-.188 1.743-.14a4.5 4.5 0 004.486-6.336l-3.276 3.277a3.004 3.004 0 01-2.25-2.25l3.276-3.276a4.5 4.5 0 00-6.336 4.486c.091 1.076-.071 2.264-.904 2.95l-.102.085m-1.745 1.437L5.909 7.5H4.5L2.25 3.75l1.5-1.5L7.5 4.5v1.409l4.26 4.26m-1.745 1.437l1.745-1.437m6.615 8.206L15.75 15.75M4.867 19.125h.008v.008h-.008v-.008z"/>
                                <!-- Tamir Ä±ÅŸÄ±ÄŸÄ± efekti -->
                                <circle cx="15" cy="12" r="0.5" fill="url(#serviceGradient)">
                                    <animate attributeName="r" values="0.3;0.8;0.3" dur="1.5s" repeatCount="indefinite"/>
                                    <animate attributeName="opacity" values="0.8;0.3;0.8" dur="1.5s" repeatCount="indefinite"/>
                                </circle>
                                <!-- ParÃ§alar -->
                                <rect x="8" y="6" width="1" height="1" fill="url(#serviceGradient)" opacity="0.6">
                                    <animate attributeName="opacity" values="0.3;0.9;0.3" dur="2s" repeatCount="indefinite"/>
                                </rect>
                                <rect x="10" y="4" width="0.8" height="0.8" fill="url(#serviceGradient)" opacity="0.7">
                                    <animate attributeName="opacity" values="0.4;1;0.4" dur="1.8s" repeatCount="indefinite"/>
                                </rect>
                            </svg>
                            <span class="tab-text">ðŸ”§ Teknik Servis</span>
                        </button>
                        <button class="tab" data-tab="phone-stock-panel">
                            <svg class="icon-hover-bounce icon-float" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <defs>
                                    <linearGradient id="phoneGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:#f59e0b;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#d97706;stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                                <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 1.5H8.25A2.25 2.25 0 006 3.75v16.5a2.25 2.25 0 002.25 2.25h7.5A2.25 2.25 0 0018 20.25V3.75a2.25 2.25 0 00-2.25-2.25H13.5m-3 0V3h3V1.5m-3 0h3m-3 18.75h3"/>
                                <!-- Telefon ekranÄ± -->
                                <rect x="8" y="5" width="8" height="12" rx="1" fill="none" stroke="currentColor" stroke-width="1" opacity="0.3"/>
                                <!-- Sinyal gÃ¶stergesi -->
                                <rect x="9" y="7" width="0.5" height="1" fill="url(#phoneGradient)">
                                    <animate attributeName="height" values="1;3;1" dur="2s" repeatCount="indefinite"/>
                                </rect>
                                <rect x="10" y="7" width="0.5" height="2" fill="url(#phoneGradient)">
                                    <animate attributeName="height" values="2;4;2" dur="2.2s" repeatCount="indefinite"/>
                                </rect>
                                <rect x="11" y="7" width="0.5" height="3" fill="url(#phoneGradient)">
                                    <animate attributeName="height" values="3;5;3" dur="1.8s" repeatCount="indefinite"/>
                                </rect>
                                <rect x="12" y="7" width="0.5" height="4" fill="url(#phoneGradient)">
                                    <animate attributeName="height" values="4;6;4" dur="2.5s" repeatCount="indefinite"/>
                                </rect>
                                <!-- Stok sayÄ±sÄ± gÃ¶stergesi -->
                                <circle cx="13" cy="9" r="1" fill="url(#phoneGradient)" opacity="0.8">
                                    <animate attributeName="opacity" values="0.5;1;0.5" dur="1.5s" repeatCount="indefinite"/>
                                </circle>
                            </svg>
                            <span class="tab-text">  Telefon Stok</span>
                        </button>
                        <button class="tab" data-tab="debt-panel">
                            <svg class="icon-hover-scale icon-pulse" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <defs>
                                    <linearGradient id="debtGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:#ef4444;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#dc2626;stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 21h19.5m-18-18v18m2.25-18v18m2.25-18v18m2.25-18v18M15 7.5V6a1.5 1.5 0 011.5-1.5h1.5A1.5 1.5 0 0119.5 6v1.5m0 0V9a1.5 1.5 0 01-1.5 1.5H16.5A1.5 1.5 0 0115 9V7.5m4.5 0H15m4.5 0h2.25m-4.5 0v2.25"/>
                                <!-- Bina Ä±ÅŸÄ±ÄŸÄ± -->
                                <rect x="4" y="8" width="1" height="1" fill="url(#debtGradient)" opacity="0.8">
                                    <animate attributeName="opacity" values="0.3;1;0.3" dur="3s" repeatCount="indefinite"/>
                                </rect>
                                <rect x="6" y="10" width="1" height="1" fill="url(#debtGradient)" opacity="0.6">
                                    <animate attributeName="opacity" values="0.4;0.9;0.4" dur="2.5s" repeatCount="indefinite"/>
                                </rect>
                                <rect x="8" y="6" width="1" height="1" fill="url(#debtGradient)" opacity="0.7">
                                    <animate attributeName="opacity" values="0.2;0.8;0.2" dur="3.5s" repeatCount="indefinite"/>
                                </rect>
                                <!-- Para simgesi -->
                                <circle cx="17" cy="8" r="1" fill="url(#debtGradient)" opacity="0.9">
                                    <animate attributeName="r" values="0.8;1.2;0.8" dur="2s" repeatCount="indefinite"/>
                                </circle>
                                <text x="17" y="8.5" text-anchor="middle" font-size="1" fill="white">â‚º</text>
                            </svg>
                            <span class="tab-text">ðŸ›ï¸ ToptancÄ± BorÃ§larÄ±</span>
                        </button>
                    </div>
                </div>

                <!-- Raporlar & YÃ¶netim Kategorisi -->
                <div class="tab-category">
                    <h3 class="tab-category-title">
                        ðŸ“Š Raporlar & YÃ¶netim
                    </h3>
                    <div class="tab-grid">
                        <button class="tab" data-tab="sold-phones-panel">
                            <svg class="icon-hover-bounce icon-active-glow" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <defs>
                                    <linearGradient id="soldGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:#06b6d4;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#0891b2;stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                <!-- Check mark animasyonu -->
                                <circle cx="12" cy="12" r="8" fill="none" stroke="url(#soldGradient)" stroke-width="0.5" opacity="0.3">
                                    <animate attributeName="r" values="8;10;8" dur="2s" repeatCount="indefinite"/>
                                    <animate attributeName="opacity" values="0.3;0.1;0.3" dur="2s" repeatCount="indefinite"/>
                                </circle>
                                <!-- Ä°Ã§ daire -->
                                <circle cx="12" cy="12" r="2" fill="url(#soldGradient)" opacity="0.6">
                                    <animate attributeName="opacity" values="0.4;0.8;0.4" dur="1.5s" repeatCount="indefinite"/>
                                </circle>
                                <!-- Onay parÃ§acÄ±klarÄ± -->
                                <circle cx="8" cy="10" r="0.5" fill="url(#soldGradient)">
                                    <animate attributeName="opacity" values="0;1;0" dur="3s" repeatCount="indefinite"/>
                                </circle>
                                <circle cx="16" cy="14" r="0.3" fill="url(#soldGradient)">
                                    <animate attributeName="opacity" values="0;0.8;0" dur="2.5s" repeatCount="indefinite"/>
                                </circle>
                            </svg>
                            <span class="tab-text">âœ… SatÄ±lan Cihazlar</span>
                        </button>
                        <button class="tab" data-tab="service-history-panel">
                            <svg class="icon-hover-rotate icon-float" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <defs>
                                    <linearGradient id="historyGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:#8b5cf6;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#7c3aed;stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                                <path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                <!-- Saat akrebi -->
                                <line x1="12" y1="12" x2="15" y2="10" stroke="url(#historyGradient)" stroke-width="2" opacity="0.8">
                                    <animateTransform attributeName="transform" type="rotate" values="0 12 12;360 12 12" dur="10s" repeatCount="indefinite"/>
                                </line>
                                <!-- Saat yelkovanÄ± -->
                                <line x1="12" y1="12" x2="16" y2="12" stroke="url(#historyGradient)" stroke-width="1.5" opacity="0.6">
                                    <animateTransform attributeName="transform" type="rotate" values="0 12 12;360 12 12" dur="1s" repeatCount="indefinite"/>
                                </line>
                                <!-- Merkez nokta -->
                                <circle cx="12" cy="12" r="1" fill="url(#historyGradient)">
                                    <animate attributeName="r" values="0.8;1.2;0.8" dur="2s" repeatCount="indefinite"/>
                                </circle>
                                <!-- Zaman Ã§izgileri -->
                                <circle cx="12" cy="5" r="0.3" fill="url(#historyGradient)" opacity="0.4"/>
                                <circle cx="19" cy="12" r="0.3" fill="url(#historyGradient)" opacity="0.4"/>
                                <circle cx="12" cy="19" r="0.3" fill="url(#historyGradient)" opacity="0.4"/>
                                <circle cx="5" cy="12" r="0.3" fill="url(#historyGradient)" opacity="0.4"/>
                            </svg>
                            <span class="tab-text">ðŸ“‹ Servis GeÃ§miÅŸi</span>
                        </button>
                        <button class="tab" data-tab="shortages-panel">
                            <svg class="icon-hover-scale icon-shake" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <defs>
                                    <linearGradient id="shortageGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:#f97316;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#ea580c;stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z"/>
                                <!-- Liste satÄ±rlarÄ± animasyonu -->
                                <rect x="9" y="12" width="3.75" height="0.5" fill="url(#shortageGradient)" opacity="0.6">
                                    <animate attributeName="opacity" values="0.4;0.8;0.4" dur="2s" repeatCount="indefinite"/>
                                </rect>
                                <rect x="9" y="15" width="3.75" height="0.5" fill="url(#shortageGradient)" opacity="0.5">
                                    <animate attributeName="opacity" values="0.3;0.7;0.3" dur="2.5s" repeatCount="indefinite"/>
                                </rect>
                                <rect x="9" y="18" width="3.75" height="0.5" fill="url(#shortageGradient)" opacity="0.7">
                                    <animate attributeName="opacity" values="0.5;0.9;0.5" dur="1.8s" repeatCount="indefinite"/>
                                </rect>
                                <!-- UyarÄ± iÅŸareti -->
                                <circle cx="16" cy="8" r="1.5" fill="url(#shortageGradient)" opacity="0.8">
                                    <animate attributeName="r" values="1.2;1.8;1.2" dur="1.5s" repeatCount="indefinite"/>
                                </circle>
                                <text x="16" y="8.5" text-anchor="middle" font-size="1.2" fill="white" font-weight="bold">!</text>
                            </svg>
                            <span class="tab-text">ðŸ“ DÃ¼kkan Eksikleri</span>
                        </button>
                        <button class="tab" data-tab="daily-report-panel">
                            <svg class="icon-hover-bounce icon-glow" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <defs>
                                    <linearGradient id="dailyGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:#06b6d4;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#0891b2;stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                                <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5m-9-6h.008v.008H12v-.008zM12 15h.008v.008H12V15zm0 2.25h.008v.008H12v-.008zM9.75 15h.008v.008H9.75V15zm0 2.25h.008v.008H9.75v-.008zM7.5 15h.008v.008H7.5V15zm0 2.25h.008v.008H7.5v-.008zm6.75-4.5h.008v.008h-.008v-.008zm0 2.25h.008v.008h-.008V15zm0 2.25h.008v.008h-.008v-.008zm2.25-4.5h.008v.008H16.5v-.008zm0 2.25h.008v.008H16.5V15z"/>
                                <!-- Takvim gÃ¼nleri animasyonu -->
                                <rect x="7.5" y="12.5" width="1" height="1" fill="url(#dailyGradient)" opacity="0.6">
                                    <animate attributeName="opacity" values="0.3;0.9;0.3" dur="2s" repeatCount="indefinite"/>
                                </rect>
                                <rect x="12" y="12.5" width="1" height="1" fill="url(#dailyGradient)" opacity="0.8">
                                    <animate attributeName="opacity" values="0.5;1;0.5" dur="1.8s" repeatCount="indefinite"/>
                                </rect>
                                <rect x="16.5" y="12.5" width="1" height="1" fill="url(#dailyGradient)" opacity="0.7">
                                    <animate attributeName="opacity" values="0.4;0.8;0.4" dur="2.2s" repeatCount="indefinite"/>
                                </rect>
                                <rect x="9.75" y="15" width="1" height="1" fill="url(#dailyGradient)" opacity="0.9">
                                    <animate attributeName="opacity" values="0.6;1;0.6" dur="1.5s" repeatCount="indefinite"/>
                                </rect>
                                <!-- BugÃ¼nÃ¼n gÃ¶stergesi -->
                                <circle cx="12" cy="15.5" r="1.5" fill="none" stroke="url(#dailyGradient)" stroke-width="0.5" opacity="0.5">
                                    <animate attributeName="r" values="1.2;2;1.2" dur="3s" repeatCount="indefinite"/>
                                    <animate attributeName="opacity" values="0.5;0.2;0.5" dur="3s" repeatCount="indefinite"/>
                                </circle>
                            </svg>
                            <span class="tab-text">ðŸ“Š GÃ¼nlÃ¼k Rapor</span>
                        </button>
                        <button class="tab" data-tab="reports-panel">
                            <svg class="icon-hover-scale icon-active-pulse" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <defs>
                                    <linearGradient id="reportsGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:#10b981;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#059669;stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                                <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z"/>
                                <!-- Grafik Ã§ubuklarÄ± animasyonu -->
                                <rect x="4.125" y="13" width="2.25" height="6" fill="url(#reportsGradient)" opacity="0.7">
                                    <animate attributeName="height" values="6;8;6" dur="2s" repeatCount="indefinite"/>
                                    <animate attributeName="y" values="13;11;13" dur="2s" repeatCount="indefinite"/>
                                </rect>
                                <rect x="10.875" y="9" width="2.25" height="10" fill="url(#reportsGradient)" opacity="0.8">
                                    <animate attributeName="height" values="10;12;10" dur="2.5s" repeatCount="indefinite"/>
                                    <animate attributeName="y" values="9;7;9" dur="2.5s" repeatCount="indefinite"/>
                                </rect>
                                <rect x="17.625" y="5" width="2.25" height="14" fill="url(#reportsGradient)" opacity="0.9">
                                    <animate attributeName="height" values="14;16;14" dur="1.8s" repeatCount="indefinite"/>
                                    <animate attributeName="y" values="5;3;5" dur="1.8s" repeatCount="indefinite"/>
                                </rect>
                                <!-- Trend ok iÅŸareti -->
                                <path d="M16 8l2-2m0 0l2 2m-2-2v8" stroke="url(#reportsGradient)" stroke-width="1.5" opacity="0.6">
                                    <animate attributeName="opacity" values="0.4;0.8;0.4" dur="2s" repeatCount="indefinite"/>
                                </path>
                            </svg>
                            <span class="tab-text">ðŸ“ˆ GeliÅŸmiÅŸ Raporlama</span>
                        </button>
                        <button class="tab" data-tab="sales-history-panel">
                            <svg class="icon-hover-rotate icon-glow" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <defs>
                                    <linearGradient id="salesHistoryGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:#6366f1;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#4f46e5;stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z"/>
                                <!-- GeÃ§miÅŸ iÅŸlem satÄ±rlarÄ± -->
                                <rect x="9" y="12" width="3.75" height="0.5" fill="url(#salesHistoryGradient)" opacity="0.7">
                                    <animate attributeName="opacity" values="0.5;0.9;0.5" dur="2s" repeatCount="indefinite"/>
                                </rect>
                                <rect x="9" y="15" width="3.75" height="0.5" fill="url(#salesHistoryGradient)" opacity="0.6">
                                    <animate attributeName="opacity" values="0.4;0.8;0.4" dur="2.3s" repeatCount="indefinite"/>
                                </rect>
                                <rect x="9" y="18" width="3.75" height="0.5" fill="url(#salesHistoryGradient)" opacity="0.8">
                                    <animate attributeName="opacity" values="0.6;1;0.6" dur="1.8s" repeatCount="indefinite"/>
                                </rect>
                                <!-- Zaman Ã§arkÄ± -->
                                <circle cx="16" cy="8" r="2" fill="none" stroke="url(#salesHistoryGradient)" stroke-width="0.5" opacity="0.5">
                                    <animateTransform attributeName="transform" type="rotate" values="0 16 8;360 16 8" dur="8s" repeatCount="indefinite"/>
                                </circle>
                                <line x1="16" y1="8" x2="17" y2="7" stroke="url(#salesHistoryGradient)" stroke-width="1" opacity="0.7">
                                    <animateTransform attributeName="transform" type="rotate" values="0 16 8;360 16 8" dur="4s" repeatCount="indefinite"/>
                                </line>
                                <!-- Merkez nokta -->
                                <circle cx="16" cy="8" r="0.5" fill="url(#salesHistoryGradient)">
                                    <animate attributeName="opacity" values="0.6;1;0.6" dur="2s" repeatCount="indefinite"/>
                                </circle>
                            </svg>
                            <span class="tab-text">ðŸ“‹ Ä°ÅŸlem GeÃ§miÅŸi</span>
                        </button>
                        <button class="tab" data-tab="cash-advances-panel">
                            <svg class="icon-hover-scale icon-pulse" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <defs>
                                    <linearGradient id="cashAdvancesGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:#3b82f6;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#1d4ed8;stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H4.5m2.25 0v3m0 0v.375c0 .621.504 1.125 1.125 1.125H9M11.25 4v8.25H9m4.5-1.5a3.75 3.75 0 11-7.5 0m7.5 0a3.75 3.75 0 11-7.5 0m7.5 0v1.5a.75.75 0 01-.75.75h-3a.75.75 0 01-.75-.75V15m4.5 0a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z"/>
                                <!-- Para simgesi animasyonu -->
                                <circle cx="12" cy="12" r="2" fill="url(#cashAdvancesGradient)" opacity="0.8">
                                    <animate attributeName="r" values="1.5;2.5;1.5" dur="2s" repeatCount="indefinite"/>
                                    <animate attributeName="opacity" values="0.6;1;0.6" dur="2s" repeatCount="indefinite"/>
                                </circle>
                                <!-- Avans ok iÅŸareti -->
                                <path d="M8 12l4-4m0 0l4 4m-4-4v8" stroke="url(#cashAdvancesGradient)" stroke-width="1.5" opacity="0.7">
                                    <animate attributeName="opacity" values="0.5;0.9;0.5" dur="1.5s" repeatCount="indefinite"/>
                                </path>
                                <!-- Para parÃ§acÄ±klarÄ± -->
                                <circle cx="6" cy="8" r="0.5" fill="url(#cashAdvancesGradient)">
                                    <animate attributeName="opacity" values="0;1;0" dur="3s" repeatCount="indefinite"/>
                                </circle>
                                <circle cx="18" cy="16" r="0.3" fill="url(#cashAdvancesGradient)">
                                    <animate attributeName="opacity" values="0;0.8;0" dur="2.5s" repeatCount="indefinite"/>
                                </circle>
                            </svg>
                            <span class="tab-text">ðŸ’° Kasa AvanslarÄ±</span>
                        </button>
                        <button class="tab" data-tab="product-prices-panel">
                            <svg class="icon-hover-rotate icon-float" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                                <defs>
                                    <linearGradient id="priceGradient" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:#f59e0b;stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:#d97706;stop-opacity:1" />
                                    </linearGradient>
                                </defs>
                                <path stroke-linecap="round" stroke-linejoin="round" d="M9 14.25l6-6m4.5-3.493V21.75l-3.75-1.5-3.75 1.5-3.75-1.5-3.75 1.5V4.757c0-1.108.806-2.057 1.907-2.185a48.507 48.507 0 0111.186 0c1.1.128 1.907 1.077 1.907 2.185zM9.75 9h.008v.008H9.75V9zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm4.125 4.5h.008v.008h-.008V13.5zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z"/>
                                <!-- Fiyat etiketleri -->
                                <circle cx="9.75" cy="9" r="1" fill="url(#priceGradient)" opacity="0.8">
                                    <animate attributeName="r" values="0.8;1.2;0.8" dur="2s" repeatCount="indefinite"/>
                                </circle>
                                <circle cx="14.25" cy="13.5" r="1" fill="url(#priceGradient)" opacity="0.7">
                                    <animate attributeName="r" values="0.7;1.1;0.7" dur="2.5s" repeatCount="indefinite"/>
                                </circle>
                                <!-- Para iÅŸaretleri -->
                                <text x="9.75" y="9.5" text-anchor="middle" font-size="0.8" fill="white" font-weight="bold">â‚º</text>
                                <text x="14.25" y="14" text-anchor="middle" font-size="0.8" fill="white" font-weight="bold">â‚º</text>
                                <!-- Trend Ã§izgisi -->
                                <line x1="9" y1="14.25" x2="15" y2="8.25" stroke="url(#priceGradient)" stroke-width="1" opacity="0.5">
                                    <animate attributeName="opacity" values="0.3;0.7;0.3" dur="3s" repeatCount="indefinite"/>
                                </line>
                                <!-- Liste satÄ±rlarÄ± -->
                                <rect x="6" y="6" width="4" height="0.3" fill="url(#priceGradient)" opacity="0.4">
                                    <animate attributeName="opacity" values="0.2;0.6;0.2" dur="2s" repeatCount="indefinite"/>
                                </rect>
                                <rect x="6" y="12" width="4" height="0.3" fill="url(#priceGradient)" opacity="0.5">
                                    <animate attributeName="opacity" values="0.3;0.7;0.3" dur="2.2s" repeatCount="indefinite"/>
                                </rect>
                                <rect x="6" y="18" width="4" height="0.3" fill="url(#priceGradient)" opacity="0.6">
                                    <animate attributeName="opacity" values="0.4;0.8;0.4" dur="1.8s" repeatCount="indefinite"/>
                                </rect>
                            </svg>
                            <span class="tab-text">ðŸ’¸ ÃœrÃ¼n Fiyat Listesi</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="sales-panel">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
                <div class="lg:col-span-1 space-y-4"> <!-- HÄ±zlÄ± Ä°ÅŸlemler BaÅŸlÄ±ÄŸÄ± -->
                    <div class="relative mb-6">
                        <h2 class="text-xl font-bold text-slate-800 modern-title-container quick-actions-title">
                            <span class="relative z-10 attention-title">âš¡ HÄ±zlÄ± Ä°ÅŸlemler</span>
                            <div class="title-bg-effect"></div>
                            <div class="title-border-glow"></div>
                        </h2>
                    </div>
                    <button id="stockSellBtn" class="quick-action-card emerald w-full text-left">
                        <div class="flex items-center">
                            <div class="quick-action-icon">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path></svg>
                            </div>
                            <div>
                                <p class="quick-action-title">Stoktan Cihaz Sat</p>
                                <p class="quick-action-subtitle">Mevcut stoktan bir telefon satÄ±ÅŸÄ± yap.</p>
                            </div>
                        </div>
                    </button>
                    <button id="serviceDeliveryBtn" class="quick-action-card amber w-full text-left">
                        <div class="flex items-center">
                            <div class="quick-action-icon">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v10a2 2 0 002 2h8a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>
                            </div>
                            <div>
                                <p class="quick-action-title">Servis TeslimatÄ± Yap</p>
                                <p class="quick-action-subtitle">Tamamlanan bir servis iÅŸlemini teslim et.</p>
                            </div>
                        </div>
                    </button>
                    <button id="manualSellBtn" class="quick-action-card sky w-full text-left">
                        <div class="flex items-center">
                            <div class="quick-action-icon">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.75 10.5V6a3.75 3.75 0 10-7.5 0v4.5m11.356-1.993l1.263 12c.07.665-.45 1.243-1.119 1.243H4.25a1.125 1.125 0 01-1.12-1.243l1.264-12A1.125 1.125 0 015.513 7.5h12.974c.576 0 1.059.435 1.119.993zM8.625 10.5a.375.375 0 11-.75 0 .375.375 0 01.75 0zm7.5 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z"/></svg>
                            </div>
                            <div>
                                <p class="quick-action-title">Aksesuar / Hizmet Sat</p>
                                <p class="quick-action-subtitle">Stok dÄ±ÅŸÄ± Ã¼rÃ¼n veya hizmet satÄ±ÅŸÄ± ekle.</p>
                            </div>
                        </div>
                    </button>
                    
                    <!-- Currency Converter Module -->
                    <div class="bg-gradient-to-br from-yellow-50 to-amber-50 p-4 rounded-lg border border-yellow-300 shadow-md mt-6 currency-converter-mobile">
                        <div class="text-center mb-4">
                            <h4 class="font-bold text-yellow-800 text-lg flex items-center justify-center gap-2">
                                <span>ðŸ’±</span> DÃ¶viz Ã‡evirici
                            </h4>
                        </div>
                        
                        <div class="space-y-4">
                            <!-- USD to TRY -->
                            <div class="bg-white p-4 rounded-lg border border-yellow-200 shadow-sm currency-conversion-item">
                                <div class="text-center mb-3">
                                    <span class="text-yellow-700 font-semibold text-sm">USD â†’ TRY</span>
                                </div>
                                <div class="flex flex-col sm:flex-row items-center justify-center gap-3">
                                    <input type="number" id="usdToTryInput" 
                                           class="w-24 h-12 py-2 px-3 text-center text-yellow-800 bg-yellow-50 border border-yellow-300 rounded-md focus:ring-2 focus:ring-yellow-400 focus:border-transparent font-semibold" 
                                           placeholder="USD" step="any">
                                    <span class="text-yellow-600 font-bold text-xl">=</span>
                                    <div id="tryOutput" class="w-32 h-12 py-2 px-3 flex items-center justify-center text-yellow-800 font-bold bg-yellow-100 border border-yellow-300 rounded-md text-sm">
                                        0.00 TL
                                    </div>
                                </div>
                            </div>
                            
                            <!-- TRY to USD -->
                            <div class="bg-white p-4 rounded-lg border border-yellow-200 shadow-sm currency-conversion-item">
                                <div class="text-center mb-3">
                                    <span class="text-yellow-700 font-semibold text-sm">TRY â†’ USD</span>
                                </div>
                                <div class="flex flex-col sm:flex-row items-center justify-center gap-3">
                                    <input type="number" id="tryToUsdInput" 
                                           class="w-24 h-12 py-2 px-3 text-center text-yellow-800 bg-yellow-50 border border-yellow-300 rounded-md focus:ring-2 focus:ring-yellow-400 focus:border-transparent font-semibold" 
                                           placeholder="TL" step="any">
                                    <span class="text-yellow-600 font-bold text-xl">=</span>
                                    <div id="usdOutput" class="w-32 h-12 py-2 px-3 flex items-center justify-center text-yellow-800 font-bold bg-yellow-100 border border-yellow-300 rounded-md text-sm">
                                        0.00 $
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4 text-center bg-yellow-100 py-3 rounded-lg border border-yellow-200 currency-rate-display">
                            <span class="text-yellow-700 font-medium text-sm">GÃ¼ncel Kur: </span>
                            <span id="converterUsdRate" class="text-yellow-800 font-bold">0.00</span>
                            <span class="text-yellow-700 font-medium text-sm"> TL</span>
                        </div>
                    </div>
                </div>
                <div class="card lg:col-span-3"> <!-- BugÃ¼nÃ¼n Ä°ÅŸlemleri BaÅŸlÄ±ÄŸÄ± -->
                    <div class="relative mb-6">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3">
                            <h2 class="text-xl font-bold text-slate-800 modern-title-container">
                                <span class="relative z-10 attention-title">ðŸ“Š BugÃ¼nÃ¼n Ä°ÅŸlemleri (SatÄ±ÅŸ & Servis)</span>
                                <div class="title-bg-effect"></div>
                                <div class="title-border-glow"></div>
                            </h2>
                            <button id="addExpenseTodayBtn" class="btn btn-danger whitespace-nowrap self-start sm:self-center">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="mr-2">
                                    <path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M15 12H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                </svg>
                                Gider Ekle
                            </button>
                        </div>
                    </div>
                    <div class="overflow-y-auto h-[30rem] overflow-x-auto"><table class="w-full text-sm text-left min-w-[768px] sm:min-w-full"><thead class="text-xs text-slate-500 uppercase bg-slate-100 tracking-wide"><tr><th class="px-1 py-3 sm:px-2 sm:py-4">#</th><th class="px-2 py-3 sm:px-4 sm:py-4">TÃ¼r</th><th class="px-2 py-3 sm:px-4 sm:py-4">AÃ§Ä±klama</th><th class="px-2 py-3 sm:px-4 sm:py-4">Ciro</th><th class="px-2 py-3 sm:px-4 sm:py-4">Maliyet</th><th class="px-2 py-3 sm:px-4 sm:py-4">KÃ¢r</th><th class="px-2 py-3 sm:px-4 sm:py-4">Tarih</th><th class="px-2 py-3 sm:px-4 sm:py-4">Saat</th><th class="px-2 py-3 sm:px-4 sm:py-4 text-center">Ä°ÅŸlem</th></tr></thead><tbody id="salesLog"></tbody></table></div>
                </div>
            </div>
        </div>
        
        <div id="service-panel" class="hidden"> <div class="grid grid-cols-1 xl:grid-cols-3 gap-8"><div class="card xl:col-span-1"><h2 class="text-xl font-bold mb-6 text-slate-800">Yeni Servis KaydÄ±</h2><form id="addServiceForm" class="space-y-6"><div><label for="customerName">MÃ¼ÅŸteri AdÄ± SoyadÄ±</label><input type="text" id="customerName" class="input-field" placeholder="MÃ¼ÅŸteri AdÄ± SoyadÄ±" required></div><div><label for="customerPhone">MÃ¼ÅŸteri Telefonu</label><input type="tel" id="customerPhone" class="input-field" placeholder="MÃ¼ÅŸteri Telefonu"></div><div><label for="deviceName">Cihaz Modeli</label><input type="text" id="deviceName" class="input-field" placeholder="Ã–rn: iPhone 13" required></div><div><label for="deviceProblem">ArÄ±za AÃ§Ä±klamasÄ±</label><textarea id="deviceProblem" class="input-field" placeholder="ArÄ±za AÃ§Ä±klamasÄ±" rows="2"></textarea></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label for="partCost">ParÃ§a Ãœcreti (Maliyet)</label><input type="number" id="partCost" class="input-field" min="0" step="0.01"></div><div><label for="laborCost">Usta Ãœcreti (Maliyet)</label><input type="number" id="laborCost" class="input-field" min="0" step="0.01"></div></div><div><label for="totalFee">Toplam Servis Ãœcreti (MÃ¼ÅŸteri)</label><input type="number" id="totalFee" class="input-field" placeholder="MÃ¼ÅŸteriden alÄ±nacak Ã¼cret" min="0" step="0.01" required></div><button type="submit" class="btn btn-primary w-full">Servis KaydÄ± OluÅŸtur</button></form></div><div class="card xl:col-span-2"><h2 class="text-xl font-bold mb-6 text-slate-800">Aktif Servis Ä°ÅŸlemleri</h2><div class="overflow-x-auto"><table class="w-full text-sm text-left min-w-[640px] sm:min-w-full"><thead class="text-xs text-slate-500 uppercase bg-slate-100 tracking-wide"><tr><th class="px-2 py-3 sm:px-4 sm:py-4">MÃ¼ÅŸteri</th><th class="px-2 py-3 sm:px-4 sm:py-4">Cihaz</th><th class="px-2 py-3 sm:px-4 sm:py-4">Net KÃ¢r</th><th class="px-2 py-3 sm:px-4 sm:py-4">Durum</th><th class="px-2 py-3 sm:px-4 sm:py-4 text-center">Ä°ÅŸlemler</th></tr></thead><tbody id="serviceLog"></tbody></table></div></div></div></div>
        <div id="service-history-panel" class="hidden"><div class="card"><div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-3"><h2 class="text-2xl font-bold text-slate-800">Tamamlanan Servis GeÃ§miÅŸi</h2><button class="btn btn-secondary export-btn self-start sm:self-center" data-table-id="serviceHistoryLogTable" data-filename="servis-gecmisi"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="m12 18-2-2 2-2"/><path d="m7 16h5"/></svg>Excel'e Aktar</button></div><input type="text" id="serviceHistorySearchInput" class="input-field mb-4" placeholder="MÃ¼ÅŸteri AdÄ±, Cihaz Modeli veya Sorun ile ara..."><div class="overflow-x-auto"><table class="w-full text-sm text-left min-w-[700px] sm:min-w-full" id="serviceHistoryLogTable"><thead class="text-xs text-slate-500 uppercase bg-slate-100 tracking-wide"><tr><th class="px-2 py-3 sm:px-4 sm:py-4">Teslim Tarihi</th><th class="px-2 py-3 sm:px-4 sm:py-4">MÃ¼ÅŸteri</th><th class="px-2 py-3 sm:px-4 sm:py-4">Cihaz</th><th class="px-2 py-3 sm:px-4 sm:py-4">Sorun</th><th class="px-2 py-3 sm:px-4 sm:py-4 text-right">Toplam Ãœcret</th><th class="px-2 py-3 sm:px-4 sm:py-4 text-right">Net KÃ¢r</th></tr></thead><tbody id="serviceHistoryLog"></tbody></table></div></div></div>
        <div id="phone-stock-panel" class="hidden"><div class="grid grid-cols-1 xl:grid-cols-3 gap-8"><div class="card xl:col-span-1"><h2 class="text-xl font-bold mb-6 text-slate-800">Yeni Telefon StoÄŸu Ekle</h2><form id="addPhoneForm" class="space-y-6"><div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label for="phoneStatus">Durum</label><select id="phoneStatus" class="input-field"><option>SÄ±fÄ±r</option><option>2. El</option></select></div><div><label for="phoneImei">IMEI NumarasÄ±</label><input type="text" id="phoneImei" class="input-field" placeholder="IMEI" required></div></div></div><div><label for="phoneModel">Marka & Model</label><input type="text" id="phoneModel" class="input-field" placeholder="Ã–rn: Apple iPhone 14 Pro" required></div><div><label for="phoneSpecs">HafÄ±za & Renk</label><input type="text" id="phoneSpecs" class="input-field" placeholder="Ã–rn: 256 GB Mor"></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label for="phonePurchasePrice">AlÄ±ÅŸ FiyatÄ±</label><input type="number" id="phonePurchasePrice" class="input-field" placeholder="AlÄ±ÅŸ" min="0" step="0.01" required></div><div><label for="phoneSellingPrice">SatÄ±ÅŸ FiyatÄ±</label><input type="number" id="phoneSellingPrice" class="input-field" placeholder="SatÄ±ÅŸ" min="0" step="0.01" required></div></div><hr class="border-slate-300 !my-4"/><p class="text-sm font-semibold text-slate-500 !-mt-2 !mb-4">DetaylÄ± Cihaz Bilgileri (2. El iÃ§in)</p><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label for="phoneBatteryHealth">Pil SaÄŸlÄ±ÄŸÄ± (%)</label><input type="number" id="phoneBatteryHealth" class="input-field" placeholder="95" min="0" max="100"></div><div><label for="phoneCosmetic">Kozmetik Durumu</label><select id="phoneCosmetic" class="input-field"><option value="">Belirtilmedi</option><option>A+ (Kusursuz)</option><option>A (Ã‡ok Temiz)</option><option>B (Hafif YÄ±pranma)</option><option>C (Belirgin YÄ±pranma)</option></select></div></div><div><label for="phoneAccessories">Kutu/Aksesuar Durumu</label><select id="phoneAccessories" class="input-field"><option value="">Belirtilmedi</option><option>Full Kutu</option><option>Sadece Cihaz</option><option>Åžarj Aleti Var</option></select></div><div><label for="addPhoneImageUrl">FotoÄŸraf URL'si</label><input type="text" id="addPhoneImageUrl" class="input-field" placeholder="https://ornek.com/resim.jpg"></div><button type="submit" class="btn btn-primary w-full">StoÄŸa Ekle</button></form></div><div class="card xl:col-span-2"><h2 class="text-xl font-bold mb-6 text-slate-800">Stoktaki Telefonlar</h2><div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 text-center"><div><p class="text-sm text-slate-500">Toplam Cihaz</p><p id="stockCount" class="text-2xl font-bold text-slate-700"></p></div><div><p class="text-sm text-slate-500">Stok Maliyeti</p><p id="stockCost" class="text-2xl font-bold text-slate-700"></p></div><div><p class="text-sm text-slate-500">Stok DeÄŸeri</p><p id="stockValue" class="text-2xl font-bold text-slate-700"></p></div><div><p class="text-sm text-slate-500">Potansiyel KÃ¢r</p><p id="stockProfit" class="text-2xl font-bold text-emerald-600"></p></div></div><input type="text" id="phoneSearchInput" class="input-field mb-4" placeholder="Model veya IMEI ile ara..."><div class="overflow-y-auto h-96 overflow-x-auto"><table class="w-full text-sm text-left min-w-[768px] sm:min-w-full"><thead class="text-xs text-slate-500 uppercase bg-slate-100 sticky top-0 tracking-wide"><tr id="analysisTableHeaders"><th class="px-2 py-3 sm:px-4 sm:py-4 sortable" data-sort="model">Model</th><th class="px-2 py-3 sm:px-4 sm:py-4 sortable" data-sort="imei">IMEI</th><th class="px-2 py-3 sm:px-4 sm:py-4">Detaylar</th><th class="px-2 py-3 sm:px-4 sm:py-4 sortable" data-sort="potentialProfit">Pot. KÃ¢r</th><th class="px-2 py-3 sm:px-4 sm:py-4 sortable" data-sort="daysInStock">Stok SÃ¼resi</th><th class="px-1 py-3 sm:px-2 sm:py-4 text-center">ðŸ–¼ï¸</th><th class="px-2 py-3 sm:px-4 sm:py-4 text-center">Ä°ÅŸlemler</th></tr></thead><tbody id="phoneStockLog"></tbody></table></div></div></div></div>
        <div id="sold-phones-panel" class="hidden"><div class="card"><div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-3"><h2 class="text-2xl font-bold text-slate-800">SatÄ±lan Cihaz GeÃ§miÅŸi</h2><button class="btn btn-secondary export-btn self-start sm:self-center" data-table-id="soldPhonesLogTable" data-filename="satilan-cihazlar"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="m12 18-2-2 2-2"/><path d="m7 16h5"/></svg>Excel'e Aktar</button></div><input type="text" id="soldPhoneSearchInput" class="input-field mb-4" placeholder="Model, IMEI veya MÃ¼ÅŸteri AdÄ± ile ara..."><div class="overflow-x-auto"><table class="w-full text-sm text-left min-w-[768px] sm:min-w-full" id="soldPhonesLogTable"><thead class="text-xs text-slate-500 uppercase bg-slate-100 tracking-wide"><tr><th class="px-2 py-3 sm:px-4 sm:py-4">SatÄ±ÅŸ Tarihi</th><th class="px-2 py-3 sm:px-4 sm:py-4">AlÄ±cÄ± AdÄ± SoyadÄ±</th><th class="px-2 py-3 sm:px-4 sm:py-4">Cihaz Bilgisi</th><th class="px-2 py-3 sm:px-4 sm:py-4">IMEI</th><th class="px-2 py-3 sm:px-4 sm:py-4 text-right">AlÄ±ÅŸ FiyatÄ±</th><th class="px-2 py-3 sm:px-4 sm:py-4 text-right">SatÄ±ÅŸ FiyatÄ±</th><th class="px-2 py-3 sm:px-4 sm:py-4 text-right">KÃ¢r</th></tr></thead><tbody id="soldPhonesLog"></tbody></table></div></div></div>
        <div id="debt-panel" class="hidden"><div id="wholesaler-list-view"><div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-3"><h2 class="text-2xl font-bold text-slate-800">ToptancÄ±lar</h2><button id="addWholesalerBtn" class="btn btn-primary self-start sm:self-center">Yeni ToptancÄ± Ekle</button></div><div id="wholesaler-list-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div></div><div id="wholesaler-detail-view" class="hidden"><div class="card p-4 sm:p-6"><div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-8"><div class="flex items-center mb-4 sm:mb-0"><button id="backToWholesalersBtn" class="mr-4 p-2 rounded-full hover:bg-slate-100 transition-colors" aria-label="ToptancÄ±lar listesine geri dÃ¶n"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="m15 18-6-6 6-6"/></svg></button><div> <h2 id="detailWholesalerName" class="text-2xl sm:text-3xl font-bold text-slate-800"></h2> </div></div><div class="flex flex-col space-y-2 sm:space-y-0 sm:flex-row sm:space-x-2 w-full sm:w-auto mt-3 sm:mt-0"><button id="addDebtToWholesalerBtn" class="btn btn-danger flex-1 sm:flex-initial">BorÃ§ Ekle</button><button id="addPaymentToWholesalerBtn" class="btn btn-success flex-1 sm:flex-initial">Ã–deme Yap</button></div></div><div id="detailWholesalerBalance" class="bg-slate-50 rounded-lg p-6 mb-8 text-center"></div><div class="flex justify-between items-center mb-6"><h3 class="text-xl font-bold text-slate-700">Hesap Ekstresi</h3><button id="deleteWholesalerBtn" class="btn btn-danger !py-1 !px-3 !text-sm">ToptancÄ±yÄ± Sil</button></div><div class="overflow-x-auto"><table class="w-full text-sm text-left min-w-[600px] sm:min-w-full"><thead class="text-xs text-slate-500 uppercase bg-slate-100 tracking-wide"><tr><th class="px-2 py-3 sm:px-4 sm:py-4">Tarih</th><th class="px-2 py-3 sm:px-4 sm:py-4">AÃ§Ä±klama</th><th class="px-2 py-3 sm:px-4 sm:py-4 text-right">Ä°ÅŸlem TutarÄ±</th><th class="px-2 py-3 sm:px-4 sm:py-4 text-center">Sil</th></tr></thead><tbody id="transactionHistory"></tbody></table></div></div></div></div>
        
        <div id="shortages-panel" class="hidden">
            <div class="card bg-white border border-slate-200 shadow-xl shadow-slate-200/60 rounded-xl p-6 sm:p-8">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
                    <h2 class="text-3xl font-bold text-sky-500 tracking-tight">DÃ¼kkan Eksikleri</h2>
                    <button id="downloadShortagesPdfBtn" class="btn btn-primary shadow-lg hover:shadow-emerald-500/40 transition-all duration-300 ease-in-out transform hover:-translate-y-0.5">
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 mr-2">
                            <path d="M10.75 2.75a.75.75 0 0 0-1.5 0v8.614L6.295 8.235a.75.75 0 1 0-1.09 1.03l4.25 4.5a.75.75 0 0 0 1.09 0l4.25-4.5a.75.75 0 0 0-1.09-1.03l-2.955 3.129V2.75Z" />
                            <path d="M3.5 12.75a.75.75 0 0 0-1.5 0v2.5A2.75 2.75 0 0 0 4.75 18h10.5A2.75 2.75 0 0 0 18 15.25v-2.5a.75.75 0 0 0-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5Z" />
                        </svg>
                        PDF Ä°ndir
                    </button>
                </div>
                <form id="addShortageForm" class="mb-10 p-6 bg-slate-50 rounded-lg shadow">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 items-end">
                        <div class="lg:col-span-2">
                            <label for="shortageItemName" class="text-slate-700 font-semibold">Eksik ÃœrÃ¼n AdÄ±</label>
                            <input type="text" id="shortageItemName" class="input-field focus:ring-2 focus:ring-emerald-500" placeholder="Ã–rn: KÄ±rÄ±lmaz Cam (iPhone 13)" required>
                        </div>
                        <div>
                            <label for="shortageItemQuantity" class="text-slate-700 font-semibold">Adet</label>
                            <input type="number" id="shortageItemQuantity" class="input-field focus:ring-2 focus:ring-emerald-500" placeholder="10" min="1" required>
                        </div>
                        <div>
                            <label for="shortageItemPriceTL" class="text-slate-700 font-semibold">Fiyat (TL)</label>
                            <input type="number" id="shortageItemPriceTL" class="input-field focus:ring-2 focus:ring-emerald-500" placeholder="0.00" min="0" step="0.01">
                        </div>
                        <div>
                            <label for="shortageItemPriceUSD" class="text-slate-700 font-semibold">Fiyat (USD)</label>
                            <input type="number" id="shortageItemPriceUSD" class="input-field focus:ring-2 focus:ring-emerald-500" placeholder="0.00" min="0" step="0.01">
                        </div>
                    </div>
                    <div class="mt-4 flex justify-end">
                        <button type="submit" class="btn btn-success whitespace-nowrap shadow-md hover:shadow-lg hover:bg-emerald-500 transition-all transform hover:-translate-y-px">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 mr-2">
                                <path d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5V4.75Z" />
                            </svg>
                            Listeye Ekle
                        </button>
                    </div>
                </form>
                <div class="overflow-x-auto shadow-xl rounded-lg border border-slate-200 bg-slate-50/50">
                    <table class="w-full text-sm text-left min-w-full">
                        <thead class="bg-slate-100 text-slate-600 uppercase tracking-wider">
                            <tr >
                                <th scope="col" class="px-3 py-3 sm:px-6 sm:py-4 font-semibold">ÃœrÃ¼n AdÄ±</th>
                                <th scope="col" class="px-3 py-3 sm:px-6 sm:py-4 text-center font-semibold">Adet</th>
                                <th scope="col" class="px-3 py-3 sm:px-6 sm:py-4 text-center font-semibold">Fiyat (TL)</th>
                                <th scope="col" class="px-3 py-3 sm:px-6 sm:py-4 text-center font-semibold">Fiyat (USD)</th>
                                <th scope="col" class="px-3 py-3 sm:px-6 sm:py-4 text-center font-semibold">Ä°ÅŸlem</th>
                            </tr>
                        </thead>
                        <tbody id="shortagesLog" class="divide-y divide-slate-200">
                            <!-- Shortage items will be rendered here by JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Kasa AvanslarÄ± Paneli -->
        <div id="cash-advances-panel" class="hidden">
            <div class="card bg-white border border-slate-200 shadow-xl shadow-slate-200/60 rounded-xl p-6 sm:p-8">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-8 gap-4">
                    <h2 class="text-3xl font-bold text-emerald-500 tracking-tight">Kasa AvanslarÄ±</h2>
                    <div class="flex gap-2">
                        <button id="downloadCashAdvancesPdfBtn" class="btn btn-primary shadow-lg hover:shadow-emerald-500/40 transition-all duration-300 ease-in-out transform hover:-translate-y-0.5">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 mr-2">
                                <path d="M10.75 2.75a.75.75 0 0 0-1.5 0v8.614L6.295 8.235a.75.75 0 1 0-1.09 1.03l4.25 4.5a.75.75 0 0 0 1.09 0l4.25-4.5a.75.75 0 0 0-1.09-1.03l-2.955 3.129V2.75Z" />
                                <path d="M3.5 12.75a.75.75 0 0 0-1.5 0v2.5A2.75 2.75 0 0 0 4.75 18h10.5A2.75 2.75 0 0 0 18 15.25v-2.5a.75.75 0 0 0-1.5 0v2.5c0 .69-.56 1.25-1.25 1.25H4.75c-.69 0-1.25-.56-1.25-1.25v-2.5Z" />
                            </svg>
                            PDF Ä°ndir
                        </button>
                    </div>
                </div>

                <!-- Avans Ekleme Formu -->
                <form id="addCashAdvanceForm" class="mb-10 p-6 bg-slate-50 rounded-lg shadow">
                    <!-- Form Durumu GÃ¶stergesi -->
                    <div id="formModeIndicator" class="mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg hidden">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-blue-500 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"/>
                                </svg>
                                <span class="text-blue-700 font-medium">
                                    <span id="selectedPersonName"></span> iÃ§in ek avans ekliyorsunuz
                                </span>
                            </div>
                            <button type="button" id="cancelPersonMode" class="text-blue-500 hover:text-blue-700 p-1 rounded transition-colors">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 items-end">
                        <div>
                            <label for="advancePersonName" class="text-slate-700 font-semibold">KiÅŸi AdÄ±</label>
                            <input type="text" id="advancePersonName" class="input-field focus:ring-2 focus:ring-emerald-500" placeholder="Ã–rn: Ahmet YÄ±lmaz" required>
                        </div>
                        <div>
                            <label for="advanceAmount" class="text-slate-700 font-semibold">Tutar (â‚º)</label>
                            <input type="number" id="advanceAmount" class="input-field focus:ring-2 focus:ring-emerald-500" placeholder="0.00" min="0" step="0.01" required>
                        </div>
                        <div>
                            <label for="advanceDescription" class="text-slate-700 font-semibold">AÃ§Ä±klama</label>
                            <input type="text" id="advanceDescription" class="input-field focus:ring-2 focus:ring-emerald-500" placeholder="Avans aÃ§Ä±klamasÄ±">
                        </div>
                        <div>
                            <label for="advanceDate" class="text-slate-700 font-semibold">Tarih</label>
                            <input type="date" id="advanceDate" class="input-field focus:ring-2 focus:ring-emerald-500" required>
                        </div>
                    </div>
                    <div class="mt-4 flex justify-end">
                        <button type="submit" class="btn btn-success whitespace-nowrap shadow-md hover:shadow-lg hover:bg-emerald-500 transition-all transform hover:-translate-y-px">
                            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 mr-2">
                                <path d="M10.75 4.75a.75.75 0 0 0-1.5 0v4.5h-4.5a.75.75 0 0 0 0 1.5h4.5v4.5a.75.75 0 0 0 1.5 0v-4.5h4.5a.75.75 0 0 0 0-1.5h-4.5V4.75Z" />
                            </svg>
                            Avans Ekle
                        </button>
                    </div>
                </form>

                <!-- Filtreleme ve Arama -->
                <div class="mb-6 p-4 bg-slate-50 rounded-lg shadow">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label for="cashAdvanceSearchInput" class="text-slate-700 font-semibold">Ara</label>
                            <input type="text" id="cashAdvanceSearchInput" class="input-field" placeholder="KiÅŸi adÄ± veya aÃ§Ä±klama...">
                        </div>
                        <div>
                            <label for="cashAdvancePersonFilter" class="text-slate-700 font-semibold">KiÅŸi Filtresi</label>
                            <select id="cashAdvancePersonFilter" class="input-field">
                                <option value="">TÃ¼m KiÅŸiler</option>
                            </select>
                        </div>
                        <div>
                            <label for="cashAdvanceDateFilter" class="text-slate-700 font-semibold">Tarih Filtresi</label>
                            <input type="date" id="cashAdvanceDateFilter" class="input-field">
                        </div>
                    </div>
                </div>

                <!-- Ã–zet KartlarÄ± -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                        <div class="flex items-center gap-2 mb-1">
                            <svg class="w-5 h-5 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1"/>
                            </svg>
                            <span class="text-sm font-medium text-blue-700">Toplam Avans</span>
                        </div>
                        <div class="text-2xl font-bold text-blue-900" id="totalAdvances">â‚º0.00</div>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                        <div class="flex items-center gap-2 mb-1">
                            <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
                            </svg>
                            <span class="text-sm font-medium text-green-700">Toplam KiÅŸi</span>
                        </div>
                        <div class="text-2xl font-bold text-green-900" id="totalPeople">0</div>
                    </div>
                    <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                        <div class="flex items-center gap-2 mb-1">
                            <svg class="w-5 h-5 text-purple-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"/>
                            </svg>
                            <span class="text-sm font-medium text-purple-700">Toplam KayÄ±t</span>
                        </div>
                        <div class="text-2xl font-bold text-purple-900" id="totalAdvanceRecords">0</div>
                    </div>
                </div>

                <!-- KiÅŸi BazlÄ± Ã–zet -->
                <div class="mb-6 bg-slate-50 rounded-lg p-4 shadow">
                    <h3 class="text-lg font-semibold text-slate-700 mb-4">KiÅŸi BazlÄ± Avans Ã–zeti</h3>
                    <div id="personAdvancesSummary" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- KiÅŸi bazlÄ± Ã¶zetler burada gÃ¶sterilecek -->
                    </div>
                </div>

                <!-- Avans Listesi -->
                <div class="overflow-x-auto shadow-xl rounded-lg border border-slate-200 bg-slate-50/50">
                    <table class="w-full text-sm text-left min-w-full">
                        <thead class="bg-slate-100 text-slate-600 uppercase tracking-wider">
                            <tr>
                                <th scope="col" class="px-3 py-3 sm:px-6 sm:py-4 font-semibold">Tarih</th>
                                <th scope="col" class="px-3 py-3 sm:px-6 sm:py-4 font-semibold">KiÅŸi AdÄ±</th>
                                <th scope="col" class="px-3 py-3 sm:px-6 sm:py-4 text-center font-semibold">Tutar</th>
                                <th scope="col" class="px-3 py-3 sm:px-6 sm:py-4 font-semibold">AÃ§Ä±klama</th>
                                <th scope="col" class="px-3 py-3 sm:px-6 sm:py-4 text-center font-semibold">Ä°ÅŸlem</th>
                            </tr>
                        </thead>
                        <tbody id="cashAdvancesLog" class="divide-y divide-slate-200">
                            <!-- Avans kayÄ±tlarÄ± burada gÃ¶sterilecek -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="daily-report-panel" class="hidden"><div class="card">
            <div class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                <h2 class="text-xl sm:text-2xl font-bold text-slate-800">GÃ¼nlÃ¼k Finans Raporu</h2> <!-- GÃ¼nlÃ¼k Finans Raporu BaÅŸlÄ±ÄŸÄ± -->
                <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 w-full sm:w-auto">
                    <input type="date" id="reportDate" class="input-field w-auto">
                    <button id="addExpenseBtn" class="btn btn-danger whitespace-nowrap">Gider Ekle</button>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-5 gap-6 mb-10 text-center">
                <div class="bg-blue-50 p-4 rounded-lg flex flex-col items-center justify-center border border-blue-200">
                    <div class="flex items-center gap-2 mb-1">
                        <svg class="w-5 h-5 text-blue-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                        <h4 class="text-sm font-semibold text-blue-600">Toplam Ciro</h4>
                    </div>
                    <p id="reportTotalRevenue" class="text-2xl font-bold text-blue-700">0.00 TL</p>
                </div>
                <div class="bg-orange-50 p-4 rounded-lg flex flex-col items-center justify-center border border-orange-200">
                    <div class="flex items-center gap-2 mb-1">
                        <svg class="w-5 h-5 text-orange-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        <h4 class="text-sm font-semibold text-orange-600">Toplam Maliyet</h4>
                    </div>
                    <p id="reportTotalCost" class="text-2xl font-bold text-orange-700">0.00 TL</p>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg flex flex-col items-center justify-center border border-purple-200">
                    <div class="flex items-center gap-2 mb-1">
                        <svg class="w-5 h-5 text-purple-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 8h6m-5 4h4m5 6H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2z"></path></svg>
                        <h4 class="text-sm font-semibold text-purple-600">BrÃ¼t KÃ¢r</h4>
                    </div>
                    <p id="reportGrossProfit" class="text-2xl font-bold text-purple-700">0.00 TL</p>
                </div>
                <div class="bg-red-50 p-4 rounded-lg flex flex-col items-center justify-center border border-red-200">
                    <div class="flex items-center gap-2 mb-1">
                        <svg class="w-5 h-5 text-red-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                        <h4 class="text-sm font-semibold text-red-600">DÃ¼kkan Giderleri</h4>
                    </div>
                    <p id="reportTotalExpenses" class="text-2xl font-bold text-red-700">0.00 TL</p>
                </div>
                <div class="bg-green-50 p-4 rounded-lg flex flex-col items-center justify-center border border-green-200">
                    <div class="flex items-center gap-2 mb-1">
                        <svg class="w-5 h-5 text-green-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        <h4 class="text-sm font-semibold text-green-600">GÃœN SONU NET KÃ‚R</h4>
                    </div>
                    <p id="reportNetProfit" class="text-2xl font-bold text-green-700">0.00 TL</p>
                </div>
            </div>
            
            <div id="dailyCostAnalysisSection" class="mb-8 p-4 border border-slate-200 rounded-lg bg-slate-50"></div>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div>
                    <div class="flex flex-col sm:flex-row flex-wrap justify-between items-start sm:items-center mb-6 gap-y-2 gap-x-4">
                        <h3 class="text-xl font-bold text-slate-700">Gelir DÃ¶kÃ¼mÃ¼</h3>
                        <div id="dailyReportIncomeFilterContainer" class="flex space-x-1 sm:space-x-2">
                            <button class="btn btn-primary !py-1 !px-2 !text-xs" data-filter="all">TÃ¼mÃ¼</button>
                            <button class="btn btn-secondary !py-1 !px-2 !text-xs" data-filter="device">Cihaz</button>
                            <button class="btn btn-secondary !py-1 !px-2 !text-xs" data-filter="service">Servis</button>
                            <button class="btn btn-secondary !py-1 !px-2 !text-xs" data-filter="accessory">Aksesuar</button>
                        </div>
                        <button class="btn btn-secondary export-btn !py-1.5 !px-3 !text-sm self-start sm:self-center" data-table-id="reportIncomeTable" data-filename="gunluk-gelirler"><svg width="16" height="16" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" class="mr-1.5"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="m12 18-2-2 2-2"/><path d="m7 16h5"/></svg>Excel</button>
                    </div>
                    <div class="overflow-x-auto border border-slate-200 rounded-lg"><table class="w-full text-sm text-left min-w-[700px] sm:min-w-full" id="reportIncomeTable"><thead class="text-xs text-slate-500 uppercase bg-slate-100 tracking-wide"><tr><th class="px-1 py-3 sm:px-2 sm:py-4">#</th><th class="px-2 py-3 sm:px-4 sm:py-4">Saat</th><th class="px-2 py-3 sm:px-4 sm:py-4">AÃ§Ä±klama</th><th class="px-2 py-3 sm:px-4 sm:py-4 text-right">Ciro</th><th class="px-2 py-3 sm:px-4 sm:py-4 text-right">Maliyet</th><th class="px-2 py-3 sm:px-4 sm:py-4 text-right">KÃ¢r</th><th class="px-2 py-3 sm:px-4 sm:py-4 text-right">KÃ¢r MarjÄ±</th></tr></thead><tbody id="reportIncomeBody"></tbody><tfoot id="reportIncomeFoot"></tfoot></table></div>
                </div>
                <div>
                    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-3"><h3 class="text-xl font-bold text-slate-700">Gider DÃ¶kÃ¼mÃ¼</h3><button class="btn btn-secondary export-btn self-start sm:self-center" data-table-id="reportExpenseTable" data-filename="gunluk-giderler"><svg width="16" height="16" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="m12 18-2-2 2-2"/><path d="m7 16h5"/></svg>Excel'e Aktar</button></div>
                    <div class="overflow-x-auto border border-slate-200 rounded-lg"><table class="w-full text-sm text-left min-w-[400px] sm:min-w-full" id="reportExpenseTable"><thead class="text-xs text-slate-500 uppercase bg-slate-100 tracking-wide"><tr><th class="px-2 py-3 sm:px-4 sm:py-4">AÃ§Ä±klama</th><th class="px-2 py-3 sm:px-4 sm:py-4 text-right">Tutar</th><th class="px-2 py-3 sm:px-4 sm:py-4 text-center">Sil</th></tr></thead><tbody id="reportExpenseBody"></tbody><tfoot id="reportExpenseFoot"></tfoot></table></div>
                </div>
            </div>
        </div></div>
        <div id="reports-panel" class="hidden"><div class="card">
            <div class="bg-slate-50 p-4 rounded-lg mb-8 flex flex-wrap items-center gap-4 border border-slate-200">
                <h2 class="text-xl font-bold text-slate-800 mr-4">GeliÅŸmiÅŸ Raporlama</h2> <!-- GeliÅŸmiÅŸ Raporlama BaÅŸlÄ±ÄŸÄ± -->
                <label for="advReportRange" class="font-medium">Zaman AralÄ±ÄŸÄ±</label><select id="advReportRange" class="input-field w-auto"><option value="this_week">Bu Hafta</option><option value="this_month" selected>Bu Ay</option><option value="last_30_days">Son 30 GÃ¼n</option><option value="this_year">Bu YÄ±l</option><option value="custom">Ã–zel AralÄ±k</option></select><div id="customDateRange" class="hidden flex items-center gap-4"><label for="advStartDate">BaÅŸlangÄ±Ã§</label><input type="date" id="advStartDate" class="input-field w-auto"><label for="advEndDate">BitiÅŸ</label><input type="date" id="advEndDate" class="input-field w-auto"></div><button id="generateAdvReportBtn" class="btn btn-primary ml-auto">Rapor OluÅŸtur</button>
            </div>
            <div id="advReportContentPlaceholder">
                <div class="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-5 gap-6 mb-10 text-center">
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-200"><h4 class="text-sm font-semibold text-blue-600">Toplam Ciro</h4><p id="advTotalRevenue" class="text-2xl font-bold text-blue-700">0.00 TL</p></div>
                    <div class="bg-orange-50 p-4 rounded-lg border border-orange-200"><h4 class="text-sm font-semibold text-orange-600">Toplam Maliyet</h4><p id="advTotalCost" class="text-2xl font-bold text-orange-700">0.00 TL</p></div>
                    <div class="bg-purple-50 p-4 rounded-lg border border-purple-200"><h4 class="text-sm font-semibold text-purple-600">BrÃ¼t KÃ¢r</h4><p id="advGrossProfit" class="text-2xl font-bold text-purple-700">0.00 TL</p></div>
                    <div class="bg-red-50 p-4 rounded-lg border border-red-200"><h4 class="text-sm font-semibold text-red-600">Toplam Gider</h4><p id="advTotalExpenses" class="text-2xl font-bold text-red-700">0.00 TL</p></div>
                    <div class="bg-green-50 p-4 rounded-lg border border-green-200"><h4 class="text-sm font-semibold text-green-600">NET KÃ‚R</h4><p id="advNetProfit" class="text-2xl font-bold text-green-700">0.00 TL</p></div>
                </div>
                <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                    <div><h3 class="text-xl font-bold text-slate-700 mb-6">GÃ¼nlÃ¼k Net KÃ¢r Trendi</h3><div class="p-4 border border-slate-200 rounded-lg bg-slate-50 h-64 sm:h-80 lg:h-96"><canvas id="profitChart"></canvas></div></div>
                    <div><h3 class="text-xl font-bold text-slate-700 mb-6">Ciro KaynaklarÄ± DaÄŸÄ±lÄ±mÄ±</h3><div class="p-4 border border-slate-200 rounded-lg bg-slate-50 flex justify-center items-center h-64 sm:h-80 lg:h-96"><canvas id="revenuePieChart"></canvas></div></div>
                    <div class="xl:col-span-2"><div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 gap-3"><h3 class="text-xl font-bold text-slate-700">Kategori BazlÄ± KÃ¢r Analizi</h3><button class="btn btn-secondary export-btn self-start sm:self-center" data-table-id="categoryProfitTable" data-filename="kategori-kar-analizi"><svg width="16" height="16" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/><path d="m12 18-2-2 2-2"/><path d="m7 16h5"/></svg>Excel'e Aktar</button></div><div class="overflow-x-auto border border-slate-200 rounded-lg"><table class="w-full text-sm text-left min-w-[500px] sm:min-w-full" id="categoryProfitTable"><thead class="text-xs text-slate-500 uppercase bg-slate-100 sticky top-0 tracking-wide"><tr><th class="px-2 py-3 sm:px-4 sm:py-4">Kategori</th><th class="px-2 py-3 sm:px-4 sm:py-4 text-right">Toplam Ciro</th><th class="px-2 py-3 sm:px-4 sm:py-4 text-right">Toplam KÃ¢r</th></tr></thead><tbody id="categoryProfitBody"></tbody></table></div></div>
                </div>
            </div>
        </div></div>
        <div id="product-prices-panel" class="hidden">
            <div class="grid grid-cols-1 xl:grid-cols-3 gap-8">
                <div class="card xl:col-span-1">
                    <h2 class="text-xl font-bold mb-6 text-slate-800">Yeni ÃœrÃ¼n/Maliyet Ekle</h2>
                    <form id="addProductPriceForm" class="space-y-6">
                        <div>
                            <label for="productPriceName">ÃœrÃ¼n AdÄ± / Kodu</label>
                            <input type="text" id="productPriceName" class="input-field" placeholder="Ã–rn: iPhone 13 KÄ±rÄ±lmaz Cam" required>
                        </div>
                        
                        <!-- Ã‡ift Para Birimi AlÄ±ÅŸ FiyatÄ± -->
                        <div>
                            <label for="productPriceCost">AlÄ±ÅŸ FiyatÄ±</label>
                            <div class="flex gap-2">
                                <div class="flex-1">
                                    <input type="number" id="productPriceCost" class="input-field" placeholder="50.00" min="0" step="0.01" required>
                                </div>
                                <div class="w-24">
                                    <select id="productPriceCurrency" class="input-field text-sm">
                                        <option value="TRY">TL</option>
                                        <option value="USD">USD</option>
                                    </select>
                                </div>
                            </div>
                            <div id="productPriceConversion" class="text-sm text-slate-500 mt-2 min-h-[1.5rem]">
                                <!-- Otomatik dÃ¶nÃ¼ÅŸÃ¼m bilgisi burada gÃ¶sterilecek -->
                            </div>
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-full">Listeye Ekle</button>
                    </form>
                </div>
                <div class="card xl:col-span-2">
                    <h2 class="text-xl font-bold mb-6 text-slate-800">KayÄ±tlÄ± ÃœrÃ¼n FiyatlarÄ±</h2>
                    <input type="text" id="productPriceSearchInput" class="input-field mb-4" placeholder="ÃœrÃ¼n AdÄ± veya Kodu ile ara...">
                    <div class="overflow-y-auto h-96 overflow-x-auto">
                        <table class="w-full text-sm text-left min-w-[500px] sm:min-w-full">
                            <thead class="text-xs text-slate-500 uppercase bg-slate-100 sticky top-0 tracking-wide">
                                <tr>
                                    <th class="px-2 py-3 sm:px-4 sm:py-4">ÃœrÃ¼n AdÄ± / Kodu</th>
                                    <th class="px-2 py-3 sm:px-4 sm:py-4 text-right">AlÄ±ÅŸ FiyatÄ± (TL)</th>
                                    <th class="px-2 py-3 sm:px-4 sm:py-4 text-right">AlÄ±ÅŸ FiyatÄ± (USD)</th>
                                    <th class="px-2 py-3 sm:px-4 sm:py-4 text-center">Ä°ÅŸlemler</th>
                                </tr>
                            </thead>
                            <tbody id="productPricesLog">
                                <!-- Product prices will be rendered here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <div id="settings-panel" class="hidden">
            <div class="max-w-4xl mx-auto space-y-8">
                <!-- KullanÄ±cÄ± Profili -->
                <div class="card">
                    <div class="flex items-center mb-6">
                        <div class="p-3 bg-blue-100 rounded-lg mr-4">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-slate-800">KullanÄ±cÄ± Profili</h2>
                            <p class="text-slate-600">Hesap bilgilerinizi yÃ¶netin</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="userEmail">E-posta Adresi</label>
                            <input type="email" id="userEmail" class="input-field" readonly>
                        </div>
                        <div>
                            <label for="businessName">Ä°ÅŸletme AdÄ±</label>
                            <input type="text" id="businessName" class="input-field" placeholder="TeknoHesap MaÄŸaza">
                        </div>
                        <div>
                            <label for="businessPhone">Ä°ÅŸletme Telefonu</label>
                            <input type="tel" id="businessPhone" class="input-field" placeholder="0532 XXX XX XX">
                        </div>
                        <div>
                            <label for="businessAddress">Ä°ÅŸletme Adresi</label>
                            <input type="text" id="businessAddress" class="input-field" placeholder="Adres bilginiz">
                        </div>
                    </div>
                    <div class="mt-6">
                        <button id="saveProfileBtn" class="btn btn-primary">Profil Bilgilerini Kaydet</button>
                    </div>
                </div>

                <!-- Uygulama AyarlarÄ± -->
                <div class="card">
                    <div class="flex items-center mb-6">
                        <div class="p-3 bg-green-100 rounded-lg mr-4">
                            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 100 4m0-4v2m0-6V4"></path>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-slate-800">Uygulama AyarlarÄ±</h2>
                            <p class="text-slate-600">Sistemin genel ayarlarÄ±nÄ± dÃ¼zenleyin</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label for="defaultCurrency">VarsayÄ±lan Para Birimi</label>
                            <select id="defaultCurrency" class="input-field">
                                <option value="TRY">TÃ¼rk LirasÄ± (TL)</option>
                                <option value="USD">Amerikan DolarÄ± ($)</option>
                                <option value="EUR">Euro (â‚¬)</option>
                            </select>
                        </div>
                        <div>
                            <label for="taxRate">KDV OranÄ± (%)</label>
                            <input type="number" id="taxRate" class="input-field" placeholder="20" min="0" max="100" step="0.01">
                        </div>
                        <div>
                            <label for="autoBackup">Otomatik Yedekleme</label>
                            <select id="autoBackup" class="input-field">
                                <option value="daily">GÃ¼nlÃ¼k</option>
                                <option value="weekly">HaftalÄ±k</option>
                                <option value="monthly">AylÄ±k</option>
                                <option value="disabled">KapalÄ±</option>
                            </select>
                        </div>
                        <div>
                            <label for="lowStockAlert">DÃ¼ÅŸÃ¼k Stok UyarÄ±sÄ± (Adet)</label>
                            <input type="number" id="lowStockAlert" class="input-field" placeholder="5" min="0">
                        </div>
                    </div>
                    <div class="mt-6">
                        <button id="saveSettingsBtn" class="btn btn-primary">AyarlarÄ± Kaydet</button>
                    </div>
                </div>

                <!-- DÃ¶viz Kuru AyarlarÄ± -->
                <div class="card">
                    <div class="flex items-center mb-6">
                        <div class="p-3 bg-yellow-100 rounded-lg mr-4">
                            <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-slate-800">DÃ¶viz Kuru AyarlarÄ±</h2>
                            <p class="text-slate-600">GÃ¼ncel kur bilgilerini yÃ¶netin</p>
                        </div>
                    </div>
                    
                    <!-- Kur Bilgisi KartÄ± -->
                    <div class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                        <div class="flex items-start">
                            <svg class="w-5 h-5 text-blue-600 mt-0.5 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div>
                                <h3 class="font-semibold text-blue-800 mb-2">Otomatik Kur GÃ¼ncelleme</h3>
                                <p class="text-sm text-blue-700 leading-relaxed">
                                    Sistem sÄ±rasÄ±yla ÅŸu kaynaklardan gÃ¼ncel kurlarÄ± Ã§ekmeyi dener:
                                    <br><strong>1.</strong> Currency-API (CDN) - Ãœcretsiz, hÄ±zlÄ±
                                    <br><strong>2.</strong> ExchangeRate-API - GÃ¼venilir, Ã¼cretsiz
                                    <br><strong>3.</strong> TCMB (Merkez BankasÄ±) - Resmi kurlar
                                    <br><strong>4.</strong> VarsayÄ±lan kurlar (API hatalarÄ± durumunda)
                                </p>
                                <p class="text-xs text-blue-600 mt-2">ðŸ’¡ Ä°nternet baÄŸlantÄ±sÄ± gereklidir. API baÅŸarÄ±sÄ±z olursa manuel giriÅŸ seÃ§eneÄŸi sunulur.</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label for="currentUsdRate">GÃ¼ncel USD Kuru</label>
                            <input type="number" id="currentUsdRate" class="input-field" placeholder="32.85" min="0" step="0.01">
                        </div>
                        <div>
                            <label for="currentEurRate">GÃ¼ncel EUR Kuru</label>
                            <input type="number" id="currentEurRate" class="input-field" placeholder="35.20" min="0" step="0.01">
                        </div>
                        <div>
                            <label for="autoUpdateRates">Otomatik Kur GÃ¼ncelleme</label>
                            <select id="autoUpdateRates" class="input-field">
                                <option value="enabled">Aktif</option>
                                <option value="disabled">KapalÄ±</option>
                            </select>
                        </div>
                    </div>
                    <div class="mt-6 flex flex-wrap gap-3">
                        <button id="updateRatesBtn" class="btn btn-primary">Manuel Kur Kaydet</button>
                        <button id="fetchRatesBtn" class="btn btn-success">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            Otomatik Kur Ã‡ek
                        </button>
                        <div id="lastUpdateInfo" class="text-sm text-slate-500 self-center ml-2">
                            <!-- Son gÃ¼ncelleme bilgisi buraya gelecek -->
                        </div>
                    </div>
                </div>

                <!-- Veri YÃ¶netimi -->
                <div class="card">
                    <div class="flex items-center mb-6">
                        <div class="p-3 bg-purple-100 rounded-lg mr-4">
                            <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s8-1.79 8-4"></path>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-slate-800">Veri YÃ¶netimi</h2>
                            <p class="text-slate-600">Verilerinizi yedekleyin ve yÃ¶netin</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="p-4 border border-slate-200 rounded-lg">
                            <h3 class="font-semibold text-slate-700 mb-2">Veri Yedekleme</h3>
                            <p class="text-sm text-slate-600 mb-4">TÃ¼m verilerinizi JSON formatÄ±nda yedekleyin</p>
                            <button id="exportDataBtn" class="btn btn-success w-full">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                </svg>
                                Verileri DÄ±ÅŸa Aktar
                            </button>
                        </div>
                        <div class="p-4 border border-slate-200 rounded-lg">
                            <h3 class="font-semibold text-slate-700 mb-2">Veri Geri YÃ¼kleme</h3>
                            <p class="text-sm text-slate-600 mb-4">Ã–nceki yedeklemelerinizi geri yÃ¼kleyin</p>
                            <input type="file" id="importDataFile" accept=".json" class="input-field mb-2">
                            <button id="importDataBtn" class="btn btn-secondary w-full">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                                </svg>
                                Verileri Ä°Ã§e Aktar
                            </button>
                        </div>
                    </div>
                    <div class="mt-6 p-4 bg-red-50 border border-red-200 rounded-lg">
                        <h3 class="font-semibold text-red-700 mb-2">âš ï¸ Tehlikeli BÃ¶lge</h3>
                        <p class="text-sm text-red-600 mb-4">Bu iÅŸlemler geri alÄ±namaz. LÃ¼tfen dikkatli olun.</p>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <button id="clearAllDataBtn" class="btn btn-danger">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                </svg>
                                TÃ¼m Verileri Sil
                            </button>
                            <button id="resetAppBtn" class="btn btn-danger">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                UygulamayÄ± SÄ±fÄ±rla
                            </button>
                        </div>
                    </div>
                </div>

                <!-- SÃ¼rÃ¼m Bilgisi -->
                <div class="card">
                    <div class="flex items-center mb-6">
                        <div class="p-3 bg-slate-100 rounded-lg mr-4">
                            <svg class="w-6 h-6 text-slate-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-slate-800">Uygulama Bilgileri</h2>
                            <p class="text-slate-600">TeknoHesap sÃ¼rÃ¼m ve geliÅŸtirilme bilgileri</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <p class="text-sm text-slate-500">SÃ¼rÃ¼m</p>
                            <p class="font-semibold text-slate-700">v2.1.0</p>
                        </div>
                        <div>
                            <p class="text-sm text-slate-500">Son GÃ¼ncelleme</p>
                            <p class="font-semibold text-slate-700">26 Haziran 2025</p>
                        </div>
                        <div>
                            <p class="text-sm text-slate-500">GeliÅŸtirici</p>
                            <p class="font-semibold text-slate-700">TeknoHesap Team</p>
                        </div>
                        <div>
                            <p class="text-sm text-slate-500">Lisans</p>
                            <p class="font-semibold text-slate-700">MIT License</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Kasa Takip Paneli -->
        <div id="cash-tracker-panel" class="hidden">
            <div class="max-w-6xl mx-auto space-y-8">
                <!-- Tarih ve Durum BaÅŸlÄ±ÄŸÄ± -->
                <div class="bg-gradient-to-r from-blue-600 to-green-600 text-white rounded-lg p-6 shadow-lg">
                    <div class="flex items-center justify-between">
                        <div>
                            <h1 class="text-2xl font-bold mb-2">ðŸ’° Kasa Takip Sistemi</h1>
                            <div class="flex items-center space-x-4">
                                <div class="flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                    <span id="currentCashDate" class="font-semibold">--</span>
                                </div>
                                <div class="flex items-center">
                                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                    </svg>
                                    <span id="lastUpdateTime" class="text-sm opacity-90">--</span>
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <div class="flex items-center space-x-3 mb-2">
                                <label for="cashTrackerDate" class="text-sm font-medium">Tarih SeÃ§in:</label>
                                <input type="date" id="cashTrackerDate" class="bg-white/20 text-white placeholder-white/70 border border-white/30 rounded px-3 py-1 text-sm">
                                <button id="loadSelectedDateBtn" class="bg-white/20 hover:bg-white/30 text-white px-3 py-1 rounded text-sm transition-colors">
                                    ðŸ“… YÃ¼kle
                                </button>
                            </div>
                            <div class="text-sm opacity-90 mb-1">Kasa Durumu</div>
                            <div id="quickCashStatus" class="text-xl font-bold">
                                <span class="bg-white/20 px-3 py-1 rounded-full">HazÄ±rlanÄ±yor...</span>
                            </div>
                        </div>
                    </div>
                    <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
                        <div class="bg-white/10 rounded-lg p-3">
                            <div class="text-sm opacity-80">Sabah AÃ§Ä±lÄ±ÅŸ</div>
                            <div id="headerMorningAmount" class="text-lg font-bold">0 TL</div>
                        </div>
                        <div class="bg-white/10 rounded-lg p-3">
                            <div class="text-sm opacity-80">GÃ¼nlÃ¼k Gelir</div>
                            <div id="headerDailyIncome" class="text-lg font-bold">0 TL</div>
                        </div>
                        <div class="bg-white/10 rounded-lg p-3">
                            <div class="text-sm opacity-80">Bekleyen Ã–deme</div>
                            <div id="headerPendingPayments" class="text-lg font-bold">0 TL</div>
                        </div>
                        <div class="bg-white/10 rounded-lg p-3">
                            <div class="text-sm opacity-80">Kasa FarkÄ±</div>
                            <div id="headerCashDifference" class="text-lg font-bold">--</div>
                        </div>
                    </div>
                </div>

                <!-- Sabah AÃ§Ä±lÄ±ÅŸ -->
                <div class="card">
                    <div class="flex items-center mb-6">
                        <div class="p-3 bg-green-100 rounded-lg mr-4">
                            <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-slate-800">ðŸŒ… Sabah Kasa AÃ§Ä±lÄ±ÅŸÄ±</h2>
                            <p class="text-slate-600">Kasaya bÄ±raktÄ±ÄŸÄ±nÄ±z baÅŸlangÄ±Ã§ parasÄ±nÄ± kaydedin</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <label for="dailyOpeningCash">Sabah Kasa TutarÄ± (TL)</label>
                            <input type="number" id="dailyOpeningCash" class="input-field" placeholder="1500.00" min="0" step="0.01">
                        </div>
                        <div>
                            <label for="openingTime">AÃ§Ä±lÄ±ÅŸ Saati</label>
                            <input type="time" id="openingTime" class="input-field">
                        </div>
                        <div class="flex items-end">
                            <button id="saveDailyOpeningBtn" class="btn btn-primary w-full">ðŸ’¾ AÃ§Ä±lÄ±ÅŸÄ± Kaydet</button>
                        </div>
                    </div>
                    <div id="lastOpeningInfo" class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg text-sm text-blue-700">
                        <div class="flex justify-between items-center">
                            <span>KayÄ±tlÄ± Sabah AÃ§Ä±lÄ±ÅŸ KasasÄ±:</span>
                            <span id="morningCashDisplay" class="font-bold text-lg">0 TL</span>
                        </div>
                        <span id="lastOpeningText" class="text-xs opacity-75"><!-- Son aÃ§Ä±lÄ±ÅŸ bilgisi --></span>
                    </div>
                </div>

                <!-- GÃ¼nlÃ¼k Otomatik Hesap -->
                <div class="card">
                    <div class="flex items-center mb-6">
                        <div class="p-3 bg-blue-100 rounded-lg mr-4">
                            <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-slate-800">ðŸ“Š GÃ¼nlÃ¼k Otomatik Hesap</h2>
                            <p class="text-slate-600">Sistem tarafÄ±ndan otomatik hesaplanan gÃ¼nlÃ¼k hareketler</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        <div class="p-4 bg-green-50 border border-green-200 rounded-lg">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-green-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                <span class="text-sm font-medium text-green-700">Aksesuar SatÄ±ÅŸ</span>
                            </div>
                            <p id="todayAccessorySales" class="text-lg font-bold text-green-800 mt-1">+0,00 TL</p>
                        </div>
                        <div class="p-4 bg-purple-50 border border-purple-200 rounded-lg">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-purple-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                                </svg>
                                <span class="text-sm font-medium text-purple-700">Telefon SatÄ±ÅŸ</span>
                            </div>
                            <p id="todayPhoneSales" class="text-lg font-bold text-purple-800 mt-1">+0,00 TL</p>
                        </div>
                        <div class="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-yellow-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                                </svg>
                                <span class="text-sm font-medium text-yellow-700">Servis Geliri</span>
                            </div>
                            <p id="todayServiceIncome" class="text-lg font-bold text-yellow-800 mt-1">+0,00 TL</p>
                        </div>
                        <div class="p-4 bg-red-50 border border-red-200 rounded-lg">
                            <div class="flex items-center">
                                <svg class="w-5 h-5 text-red-600 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4"></path>
                                </svg>
                                <span class="text-sm font-medium text-red-700">Nakit Giderler</span>
                            </div>
                            <p id="todayExpenses" class="text-lg font-bold text-red-800 mt-1">-0,00 TL</p>
                        </div>
                    </div>
                </div>

                <!-- ToptancÄ± Ã–demeler -->
                <div class="card">
                    <div class="flex items-center mb-6">
                        <div class="p-3 bg-orange-100 rounded-lg mr-4">
                            <svg class="w-6 h-6 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-slate-800">ðŸ‘¥ ToptancÄ± Ã–deme Takibi</h2>
                            <p class="text-slate-600">AkÄ±llÄ± hatÄ±rlatma ve Ã¶deme durumu</p>
                        <div>
                            <h2 class="text-xl font-bold text-slate-800">ðŸ‘¥ ToptancÄ± Ã–deme Takibi</h2>
                            <p class="text-slate-600">ToptancÄ± borÃ§larÄ±nÄ±zÄ± takip edin ve Ã¶demelerinizi yÃ¶netin</p>
                        </div>
                        <div>
                            <button id="addWholesalerPaymentBtn" class="btn btn-primary">
                                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                </svg>
                                Yeni Ã–deme Ekle
                            </button>
                        </div>
                    </div>
                    <div id="wholesalerPaymentsList" class="space-y-4">
                        <!-- ToptancÄ± Ã¶demeler buraya gelecek -->
                    </div>
                    <div id="noWholesalerPayments" class="text-center py-8 text-slate-500">
                        <svg class="w-12 h-12 mx-auto mb-4 text-slate-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                        </svg>
                        BugÃ¼n bekleyen toptancÄ± Ã¶demesi bulunmuyor
                    </div>
                </div>

                <!-- Hesaplama Sonucu -->
                <div class="card">
                    <div class="flex items-center mb-6">
                        <div class="p-3 bg-indigo-100 rounded-lg mr-4">
                            <svg class="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z"></path>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-slate-800">ðŸ§® Otomatik Kasa Hesaplama</h2>
                            <p class="text-slate-600">Beklenen kasa durumu ve akÅŸam sayÄ±mÄ±</p>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                        <!-- Sol: Hesaplama -->
                        <div class="space-y-4">
                            <div class="p-4 bg-slate-50 border border-slate-200 rounded-lg">
                                <h3 class="font-semibold text-slate-700 mb-3">Hesaplama DetayÄ±</h3>
                                <div class="space-y-2 text-sm">
                                    <div class="flex justify-between">
                                        <span>BaÅŸlangÄ±Ã§ Kasa:</span>
                                        <span id="calcOpeningCash" class="font-mono">0,00 TL</span>
                                    </div>
                                    <div class="flex justify-between text-green-700">
                                        <span>+ GÃ¼nlÃ¼k Gelirler:</span>
                                        <span id="calcTotalIncome" class="font-mono">0,00 TL</span>
                                    </div>
                                    <div class="flex justify-between text-red-700">
                                        <span>- GÃ¼nlÃ¼k Giderler:</span>
                                        <span id="calcTotalExpenses" class="font-mono">0,00 TL</span>
                                    </div>
                                    <div class="flex justify-between text-orange-700">
                                        <span>- ToptancÄ± Ã–demeler:</span>
                                        <span id="calcWholesalerPayments" class="font-mono">0,00 TL</span>
                                    </div>
                                    <div class="flex justify-between text-blue-700">
                                        <span>- KÃ¶ÅŸeye AyrÄ±lan:</span>
                                        <span id="calcReservedCash" class="font-mono">0,00 TL</span>
                                    </div>
                                    <hr class="border-slate-300">
                                    <div class="flex justify-between font-bold text-lg">
                                        <span>BEKLENEN KASA:</span>
                                        <span id="expectedCashTotal" class="font-mono text-green-600">0,00 TL</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- SaÄŸ: SayÄ±m -->
                        <div class="space-y-4">
                            <div class="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                <h3 class="font-semibold text-slate-700 mb-3">ðŸŒ™ AkÅŸam Kasa SayÄ±mÄ±</h3>
                                <div class="space-y-4">
                                    <div>
                                        <label for="realCashCount">GerÃ§ek Kasa TutarÄ± (TL)</label>
                                        <input type="number" id="realCashCount" class="input-field" placeholder="3650.00" min="0" step="0.01">
                                    </div>
                                    <button id="calculateCashDifferenceBtn" class="btn btn-primary w-full">ðŸ” Kasa KontrolÃ¼ Yap</button>
                                </div>
                            </div>
                            
                            <div id="cashResultCard" class="p-4 border rounded-lg hidden">
                                <h3 class="font-semibold mb-3">ðŸ“ˆ SonuÃ§ Raporu</h3>
                                <div id="cashResult" class="text-center">
                                    <!-- SonuÃ§ buraya gelecek -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- HatÄ±rlatmalar -->
                <div id="remindersCard" class="card hidden">
                    <div class="flex items-center mb-6">
                        <div class="p-3 bg-yellow-100 rounded-lg mr-4">
                            <svg class="w-6 h-6 text-yellow-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-5 5v-5zM10.01 3L4 9h7v11l6-6H10.01V3z"></path>
                            </svg>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-slate-800">ðŸ”” AkÄ±llÄ± HatÄ±rlatmalar</h2>
                            <p class="text-slate-600">Sistem uyarÄ±larÄ± ve Ã¶neriler</p>
                        </div>
                    </div>
                    <div id="remindersList" class="space-y-3">
                        <!-- HatÄ±rlatmalar buraya gelecek -->
                    </div>
                </div>
                
                <!-- GÃ¼n Sonu Ä°ÅŸlemleri -->
                <div class="card bg-slate-50 border-dashed">
                    <div class="text-center space-y-4">
                        <div>
                            <svg class="w-12 h-12 mx-auto text-slate-400 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                            </svg>
                            <h3 class="text-lg font-semibold text-slate-700">GÃ¼nÃ¼ Bitir</h3>
                            <p class="text-sm text-slate-500">Mevcut gÃ¼nÃ¼n verilerini kaydet ve yeni gÃ¼ne geÃ§</p>
                        </div>
                        <button id="startNewDayBtn" class="btn btn-warning">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z"></path>
                            </svg>
                            ðŸŒ… Yeni GÃ¼n BaÅŸlat
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="sellConfirmModal" class="modal-overlay hidden"><div class="card w-full max-w-md relative"><h2 class="text-xl font-bold text-slate-800 mb-6">Cihaz SatÄ±ÅŸÄ±nÄ± Onayla</h2><p id="sellConfirmText" class="mb-4 text-slate-600"></p><div class="space-y-6"><div><label for="buyerName">AlÄ±cÄ± AdÄ± SoyadÄ±</label><input type="text" id="buyerName" class="input-field" placeholder="MÃ¼ÅŸterinin adÄ± ve soyadÄ±" required></div><div><label for="finalSellPrice">PazarlÄ±klÄ± (Nihai) SatÄ±ÅŸ FiyatÄ±</label><input type="number" id="finalSellPrice" class="input-field" min="0" step="0.01" required></div></div><div class="flex justify-end space-x-4 mt-8"><button id="cancelSellBtn" class="btn btn-secondary">Ä°ptal</button><button id="confirmSellBtn" class="btn btn-danger">Evet, SatÄ±ÅŸÄ± Tamamla</button></div></div></div>
    <div id="stockSellModal" class="modal-overlay hidden"><div class="card w-full max-w-lg relative"><button id="closeStockSellModalBtn" class="absolute top-4 right-4 text-2xl font-bold text-slate-500 hover:text-slate-800" aria-label="Kapat">&times;</button><h2 class="text-xl font-bold text-slate-800 mb-6">Stoktan SatÄ±lacak CihazÄ± SeÃ§in</h2><input type="text" id="stockSellSearch" class="input-field mb-4" placeholder="Model veya IMEI ile ara..."><div id="stockSellList" class="overflow-y-auto h-96"></div></div></div>
    <div id="manualSellModal" class="modal-overlay hidden"><div class="card w-full max-w-lg relative"><button id="closeManualSellModalBtn" class="absolute top-4 right-4 text-2xl font-bold text-slate-500 hover:text-slate-800" aria-label="Kapat">&times;</button><h2 class="text-xl font-bold text-slate-800 mb-6">Aksesuar / Hizmet SatÄ±ÅŸÄ±</h2><form id="addManualSaleForm" class="space-y-6"><div><label for="saleProductNameModal">ÃœrÃ¼n veya Hizmet AdÄ±</label><input type="text" id="saleProductNameModal" class="input-field" placeholder="Ã–rn: Ekran Koruyucu" required></div><div class="grid grid-cols-2 gap-4"><div><label for="salePurchasePriceModal">AlÄ±ÅŸ FiyatÄ± (Birim)</label><input type="number" id="salePurchasePriceModal" class="input-field" placeholder="25" min="0" step="0.01" required></div><div><label for="saleSellingPriceModal">SatÄ±ÅŸ FiyatÄ± (Birim)</label><input type="number" id="saleSellingPriceModal" class="input-field" placeholder="100" min="0" step="0.01" required></div></div><div><label for="quantityModal">Adet</label><input type="number" id="quantityModal" class="input-field" value="1" min="1" required></div><button type="submit" class="btn btn-success w-full">Manuel SatÄ±ÅŸÄ± Ekle</button></form></div></div>
    <div id="serviceDeliveryModal" class="modal-overlay hidden"><div class="card w-full max-w-xl md:max-w-2xl relative"><button id="closeServiceDeliveryModalBtn" class="absolute top-4 right-4 text-2xl font-bold text-slate-500 hover:text-slate-800" aria-label="Kapat">&times;</button><h2 class="text-xl font-bold text-slate-800 mb-6">Servis TeslimatÄ± Yap</h2><input type="text" id="serviceDeliverySearch" class="input-field mb-4" placeholder="MÃ¼ÅŸteri veya cihaz modeli ile ara..."><div id="serviceDeliveryList" class="overflow-y-auto h-96"></div></div></div>
    <div id="advanceHistoryModal" class="modal-overlay hidden">
        <div class="card w-full max-w-2xl relative">
            <button id="closeAdvanceHistoryModalBtn" class="absolute top-4 right-4 text-2xl font-bold text-slate-500 hover:text-slate-800" aria-label="Kapat">&times;</button>
            <h2 class="text-xl font-bold text-slate-800 mb-6">
                <span class="text-emerald-600">ðŸ’°</span> 
                <span id="historyPersonName"></span> - Avans GeÃ§miÅŸi
            </h2>
            <div id="advanceHistoryContent" class="space-y-4 max-h-96 overflow-y-auto">
                <!-- Avans geÃ§miÅŸi burada gÃ¶sterilecek -->
            </div>
            <div class="mt-6 p-4 bg-slate-50 rounded-lg">
                <div class="flex justify-between items-center">
                    <span class="font-semibold text-slate-700">Toplam Avans:</span>
                    <span id="historyTotalAmount" class="text-xl font-bold text-emerald-600"></span>
                </div>
                <div class="flex justify-between items-center mt-2">
                    <span class="font-semibold text-slate-700">Toplam Ä°ÅŸlem:</span>
                    <span id="historyTotalCount" class="text-lg font-semibold text-blue-600"></span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Ä°ÅŸlem GeÃ§miÅŸi Paneli -->
    <div id="sales-history-panel" class="hidden">
        <div class="card">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4">
                <h2 class="text-3xl font-bold text-indigo-600 tracking-tight">ðŸ“‹ Ä°ÅŸlem GeÃ§miÅŸi</h2>
                <div class="flex gap-2">
                    <button id="exportHistoryBtn" class="btn btn-primary">
                        <svg width="16" height="16" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" class="mr-2">
                            <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/>
                            <polyline points="14 2 14 8 20 8"/>
                            <path d="m12 18-2-2 2-2"/>
                            <path d="m7 16h5"/>
                        </svg>
                        Excel'e Aktar
                    </button>
                </div>
            </div>

            <!-- Filtre ve Arama BÃ¶lÃ¼mÃ¼ -->
            <div class="bg-slate-50 p-6 rounded-lg mb-8 border border-slate-200">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                    <div>
                        <label for="historyStartDate" class="text-slate-700 font-semibold">BaÅŸlangÄ±Ã§ Tarihi</label>
                        <input type="date" id="historyStartDate" class="input-field">
                    </div>
                    <div>
                        <label for="historyEndDate" class="text-slate-700 font-semibold">BitiÅŸ Tarihi</label>
                        <input type="date" id="historyEndDate" class="input-field">
                    </div>
                    <div>
                        <label for="historyTypeFilter" class="text-slate-700 font-semibold">Ä°ÅŸlem TÃ¼rÃ¼</label>
                        <select id="historyTypeFilter" class="input-field">
                            <option value="all">TÃ¼m Ä°ÅŸlemler</option>
                            <option value="device">Cihaz SatÄ±ÅŸlarÄ±</option>
                            <option value="service">Servis Ä°ÅŸlemleri</option>
                            <option value="accessory">Aksesuar/DiÄŸer</option>
                        </select>
                    </div>
                    <div>
                        <label for="historySearchInput" class="text-slate-700 font-semibold">Arama</label>
                        <input type="text" id="historySearchInput" class="input-field" placeholder="ÃœrÃ¼n adÄ±, mÃ¼ÅŸteri vs.">
                    </div>
                </div>
                <div class="flex justify-end gap-2">
                    <button id="clearHistoryFilters" class="btn btn-secondary">
                        <svg width="16" height="16" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" class="mr-2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                        </svg>
                        Temizle
                    </button>
                    <button id="filterHistoryBtn" class="btn btn-primary">
                        <svg width="16" height="16" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" class="mr-2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.707A1 1 0 013 7V4z"/>
                        </svg>
                        Filtrele
                    </button>
                </div>
            </div>

            <!-- Ä°statistik KartlarÄ± -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                <div class="bg-blue-50 p-4 rounded-lg border border-blue-200">
                    <h4 class="text-sm font-semibold text-blue-600">Toplam Ä°ÅŸlem</h4>
                    <p id="historyTotalCount" class="text-2xl font-bold text-blue-700">0</p>
                </div>
                <div class="bg-green-50 p-4 rounded-lg border border-green-200">
                    <h4 class="text-sm font-semibold text-green-600">Toplam Ciro</h4>
                    <p id="historyTotalRevenue" class="text-2xl font-bold text-green-700">0.00 TL</p>
                </div>
                <div class="bg-orange-50 p-4 rounded-lg border border-orange-200">
                    <h4 class="text-sm font-semibold text-orange-600">Toplam Maliyet</h4>
                    <p id="historyTotalCost" class="text-2xl font-bold text-orange-700">0.00 TL</p>
                </div>
                <div class="bg-purple-50 p-4 rounded-lg border border-purple-200">
                    <h4 class="text-sm font-semibold text-purple-600">Toplam KÃ¢r</h4>
                    <p id="historyTotalProfit" class="text-2xl font-bold text-purple-700">0.00 TL</p>
                </div>
            </div>

            <!-- GeÃ§miÅŸ Ä°ÅŸlemler Tablosu -->
            <div class="overflow-x-auto border border-slate-200 rounded-lg">
                <table class="w-full text-sm text-left min-w-[900px]">
                    <thead class="text-xs text-slate-500 uppercase bg-slate-100 sticky top-0 tracking-wide">
                        <tr>
                            <th class="px-4 py-4 text-center">#</th>
                            <th class="px-4 py-4">Tarih/Saat</th>
                            <th class="px-4 py-4">TÃ¼r</th>
                            <th class="px-4 py-4">ÃœrÃ¼n/AÃ§Ä±klama</th>
                            <th class="px-4 py-4 text-right">Ciro</th>
                            <th class="px-4 py-4 text-right">Maliyet</th>
                            <th class="px-4 py-4 text-right">KÃ¢r</th>
                            <th class="px-4 py-4 text-center">Ä°ÅŸlemler</th>
                        </tr>
                    </thead>
                    <tbody id="salesHistoryLog" class="divide-y divide-slate-200">
                        <!-- GeÃ§miÅŸ iÅŸlemler buraya JavaScript ile yÃ¼klenecek -->
                    </tbody>
                </table>
            </div>

            <!-- Sayfalama -->
            <div class="flex justify-between items-center mt-6">
                <div class="text-sm text-slate-500" id="paginationInfo">
                    <!-- Sayfa bilgisi buraya JavaScript ile yÃ¼klenecek -->
                </div>
                <div class="flex gap-2">
                    <button id="prevHistoryPage" class="btn btn-secondary" disabled>
                        <svg width="16" height="16" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <polyline points="15 18 9 12 15 6"/>
                        </svg>
                        Ã–nceki
                    </button>
                    <button id="nextHistoryPage" class="btn btn-secondary" disabled>
                        Sonraki
                        <svg width="16" height="16" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <polyline points="9 18 15 12 9 6"/>
                        </svg>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div id="addWholesalerModal" class="modal-overlay hidden"><div class="card w-full max-w-md"><h2 class="text-xl font-bold text-slate-800 mb-6">Yeni ToptancÄ± Ekle</h2><form id="addWholesalerForm"><label for="newWholesalerName">ToptancÄ± AdÄ±</label><input type="text" id="newWholesalerName" class="input-field" placeholder="TedarikÃ§i A.Åž." required><div class="flex justify-end space-x-4 mt-8"><button type="button" id="cancelAddWholesaler" class="btn btn-secondary">Ä°ptal</button><button type="submit" class="btn btn-primary">Ekle</button></div></form></div></div>
    <div id="addTransactionModal" class="modal-overlay hidden"><div class="card w-full max-w-lg"><h2 id="transactionModalTitle" class="text-xl font-bold text-slate-800 mb-6"></h2><form id="addTransactionForm" class="space-y-6"><input type="hidden" id="transactionWholesalerName"><input type="hidden" id="transactionType"><div><label for="transactionDescription">AÃ§Ä±klama</label><input type="text" id="transactionDescription" class="input-field" placeholder="AlÄ±nan Ã¼rÃ¼n veya yapÄ±lan Ã¶deme"></div><div id="debt-fields"><label for="transactionAmountDebt">Tutar (USD)</label><input type="number" id="transactionAmountDebt" class="input-field" placeholder="500" min="0.01" step="0.01"></div><div id="payment-fields" class="hidden space-y-4"><div><label for="transactionAmountPayment">Ã–denen Tutar (TL)</label><input type="number" id="transactionAmountPayment" class="input-field" placeholder="15000" min="0.01" step="0.01"></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-end"><div><label for="exchangeRate">Ã–deme AnÄ±ndaki Dolar Kuru</label><input type="number" id="exchangeRate" class="input-field" placeholder="32.50" min="0.01" step="0.0001"></div><p id="usdEquivalent" class="text-sm text-slate-500 bg-slate-100 p-2 rounded-md text-center">KarÅŸÄ±lÄ±ÄŸÄ±: <span class="font-bold text-slate-800">0.00 $</span></p></div></div><div class="flex justify-end space-x-4 mt-8"><button type="button" id="cancelTransaction" class="btn btn-secondary">Ä°ptal</button><button type="submit" class="btn">Ä°ÅŸlemi Kaydet</button></div></form></div></div>
    <div id="addExpenseModal" class="modal-overlay hidden"><div class="card w-full max-w-md"><h2 class="text-xl font-bold text-slate-800 mb-6">Manuel Gider Ekle</h2><form id="addExpenseForm" class="space-y-6"><div><label for="expenseDescription">Gider AÃ§Ä±klamasÄ±</label><input type="text" id="expenseDescription" class="input-field" placeholder="Ã–rn: Elektrik FaturasÄ±" required></div><div><label for="expenseAmount">Tutar (TL)</label><input type="number" id="expenseAmount" class="input-field" placeholder="250" min="0.01" step="0.01" required></div><div class="flex justify-end space-x-4 mt-8"><button type="button" id="cancelAddExpense" class="btn btn-secondary">Ä°ptal</button><button type="submit" class="btn btn-danger">Gideri Ekle</button></div></form></div></div>
    <div id="editSaleModal" class="modal-overlay hidden"><div class="card w-full max-w-md"><h2 class="text-xl font-bold text-slate-800 mb-6">SatÄ±ÅŸ Ä°ÅŸlemini DÃ¼zenle</h2><form id="editSaleForm" class="space-y-6"><input type="hidden" id="editSaleId"><div><label>ÃœrÃ¼n AdÄ±</label><p id="editSaleProductName" class="p-2 bg-slate-100 rounded text-slate-700"></p></div><div id="editSaleSourceContainer" class="hidden"> <label>Kaynak</label> <p id="editSaleSource" class="p-2 bg-slate-100 rounded text-sm text-slate-600"></p></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label for="editSaleRevenue">SatÄ±ÅŸ FiyatÄ± (TL)</label><input type="number" id="editSaleRevenue" class="input-field" min="0" step="0.01" required></div><div><label for="editSaleCost">Maliyet FiyatÄ± (TL)</label><input type="number" id="editSaleCost" class="input-field" min="0" step="0.01" required></div></div><div class="flex justify-end space-x-4 mt-8"><button type="button" id="cancelEditSale" class="btn btn-secondary">Ä°ptal</button><button type="submit" class="btn btn-success">DeÄŸiÅŸiklikleri Kaydet</button></div></form></div></div>
    <div id="editPhoneModal" class="modal-overlay hidden"><div class="card w-full max-w-lg"><h2 class="text-xl font-bold text-slate-800 mb-6">Telefon Bilgilerini DÃ¼zenle</h2><form id="editPhoneForm" class="space-y-6"><input type="hidden" id="editPhoneId"><div><label>IMEI NumarasÄ±</label><p id="editPhoneImei" class="p-3 bg-slate-100 rounded text-slate-700"></p></div><div><label for="editPhoneModel">Marka & Model</label><input type="text" id="editPhoneModel" class="input-field" required></div><div><label for="editPhoneSpecs">HafÄ±za & Renk</label><input type="text" id="editPhoneSpecs" class="input-field"></div><div class="grid grid-cols-2 gap-4"><div><label for="editPhonePurchasePrice">AlÄ±ÅŸ FiyatÄ±</label><input type="number" id="editPhonePurchasePrice" class="input-field" min="0" step="0.01" required></div><div><label for="editPhoneSellingPrice">SatÄ±ÅŸ FiyatÄ±</label><input type="number" id="editPhoneSellingPrice" class="input-field" min="0" step="0.01" required></div></div><hr class="border-slate-300 !my-4"/><p class="text-sm font-semibold text-slate-500 !-mt-2 !mb-4">DetaylÄ± Cihaz Bilgileri</p><div class="grid grid-cols-2 gap-4"><div><label for="editPhoneBatteryHealth">Pil SaÄŸlÄ±ÄŸÄ± (%)</label><input type="number" id="editPhoneBatteryHealth" class="input-field" min="0" max="100"></div><div><label for="editPhoneCosmetic">Kozmetik Durumu</label><select id="editPhoneCosmetic" class="input-field"><option value="">Belirtilmedi</option><option>A+ (Kusursuz)</option><option>A (Ã‡ok Temiz)</option><option>B (Hafif YÄ±pranma)</option><option>C (Belirgin YÄ±pranma)</option></select></div></div><div><label for="editPhoneAccessories">Kutu/Aksesuar Durumu</label><select id="editPhoneAccessories" class="input-field"><option value="">Belirtilmedi</option><option>Full Kutu</option><option>Sadece Cihaz</option><option>Åžarj Aleti Var</option></select></div><div><label for="editPhoneImageUrl">FotoÄŸraf URL'si</label><input type="text" id="editPhoneImageUrl" class="input-field" placeholder="https://ornek.com/resim.jpg"></div><div class="flex justify-end space-x-4 mt-8"><button type="button" id="cancelEditPhone" class="btn btn-secondary">Ä°ptal</button><button type="submit" class="btn btn-primary">DeÄŸiÅŸiklikleri Kaydet</button></div></form></div></div>
    <div id="editServiceModal" class="modal-overlay hidden"><div class="card w-full max-w-lg"><h2 class="text-xl font-bold text-slate-800 mb-6">Servis KaydÄ±nÄ± DÃ¼zenle</h2><form id="editServiceForm" class="space-y-6"><input type="hidden" id="editServiceId"><div><label for="editCustomerName">MÃ¼ÅŸteri AdÄ± SoyadÄ±</label><input type="text" id="editCustomerName" class="input-field" required></div><div><label for="editCustomerPhone">MÃ¼ÅŸteri Telefonu</label><input type="tel" id="editCustomerPhone" class="input-field"></div><div><label for="editDeviceName">Cihaz Modeli</label><input type="text" id="editDeviceName" class="input-field" required></div><div><label for="editDeviceProblem">ArÄ±za AÃ§Ä±klamasÄ±</label><textarea id="editDeviceProblem" class="input-field" rows="2"></textarea></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4"><div><label for="editPartCost">ParÃ§a Maliyeti</label><input type="number" id="editPartCost" class="input-field" min="0" step="0.01"></div><div><label for="editLaborCost">Usta Maliyeti</label><input type="number" id="editLaborCost" class="input-field" min="0" step="0.01"></div></div><div><label for="editTotalFee">Toplam Servis Ãœcreti</label><input type="number" id="editTotalFee" class="input-field" min="0" step="0.01" required></div><div class="flex justify-end space-x-4 mt-8"><button type="button" id="cancelEditService" class="btn btn-secondary">Ä°ptal</button><button type="submit" class="btn btn-primary">DeÄŸiÅŸiklikleri Kaydet</button></div></form></div></div>
    <div id="editProductPriceModal" class="modal-overlay hidden"><div class="card w-full max-w-md"><h2 class="text-xl font-bold text-slate-800 mb-6">ÃœrÃ¼n FiyatÄ±nÄ± DÃ¼zenle</h2><form id="editProductPriceForm" class="space-y-6"><input type="hidden" id="editProductPriceId"><div><label for="editProductPriceName">ÃœrÃ¼n AdÄ± / Kodu</label><input type="text" id="editProductPriceName" class="input-field" required></div><div><label for="editProductPriceCost">AlÄ±ÅŸ FiyatÄ±</label><div class="flex gap-2"><div class="flex-1"><input type="number" id="editProductPriceCost" class="input-field" min="0" step="0.01" required></div><div class="w-24"><select id="editProductPriceCurrency" class="input-field text-sm"><option value="TRY">TL</option><option value="USD">USD</option></select></div></div><div id="editProductPriceConversion" class="text-sm text-slate-500 mt-2 min-h-[1.5rem]"></div></div><div class="flex justify-end space-x-4 mt-8"><button type="button" id="cancelEditProductPrice" class="btn btn-secondary">Ä°ptal</button><button type="submit" class="btn btn-primary">DeÄŸiÅŸiklikleri Kaydet</button></div></form></div></div>
    <div id="deleteConfirmGenericModal" class="modal-overlay hidden"><div class="card w-full max-w-md text-center"><svg class="mx-auto h-12 w-12 text-red-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86 1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg><h2 class="text-xl font-bold text-slate-800 my-4">Emin misiniz?</h2><p id="deleteConfirmText" class="text-slate-600 mb-8"></p><div class="flex justify-center space-x-4"><button id="cancelDeleteBtn" class="btn btn-secondary">Ä°ptal</button><button id="confirmDeleteBtn" class="btn btn-danger">Evet, Sil</button></div></div></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, query, Timestamp, orderBy, doc, updateDoc, deleteDoc, writeBatch, getDoc, where, getDocs, runTransaction, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // --- GÃœVENLÄ°K NOTU ---
        // Bu firebaseConfig bilgileri istemci tarafÄ±nda (tarayÄ±cÄ±da) gÃ¶rÃ¼nÃ¼r durumdadÄ±r.
        // Bu, Firebase'in doÄŸasÄ± gereÄŸi normal olsa da, Ã¼retim ortamÄ±nda veritabanÄ±nÄ±zÄ±n
        // gÃ¼venliÄŸini saÄŸlamak iÃ§in **Firestore GÃ¼venlik KurallarÄ±**'nÄ± (Firestore Security Rules)
        // mutlaka yapÄ±landÄ±rmanÄ±z gerekir. Kurallar, yetkisiz kullanÄ±cÄ±larÄ±n verilerinize
        // eriÅŸmesini, verileri deÄŸiÅŸtirmesini veya silmesini engeller.
        const firebaseConfig = {
            apiKey: "AIzaSyABvD-5_pmFQiHItVyZahezjyguji63_TQ",
            authDomain: "alpaslan-bf1bf.firebaseapp.com",
            projectId: "alpaslan-bf1bf",
            storageBucket: "alpaslan-bf1bf.appspot.com",
            messagingSenderId: "864533610672",
            appId: "1:864533610672:web:5564db35f05555ec3e3b75"
        };
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let currentUserId = null;
        let services = [], phones = [], wholesalers = [], transactions = [], shopShortages = [], productPrices = [], cashAdvances = [];
        let cashTracker = {
            dailyOpening: 0,
            openingTime: null,
            wholesalerPayments: [],
            realCashCount: 0,
            lastCalculation: null,
            date: null
        };
        let todaysSales = []; 
        let allSales = []; // TÃ¼m geÃ§miÅŸ satÄ±ÅŸlar
        let filteredHistorySales = []; // FiltrelenmiÅŸ geÃ§miÅŸ satÄ±ÅŸlar
        let currentHistoryPage = 1;
        const historyItemsPerPage = 50;
        let listeners = {};
        
        let advancedReportHTMLCache = ''; 
        let previouslyFocusedElement;
        let exchangeRateIntervalId = null;

        let sortState = { key: 'daysInStock', order: 'desc' };
        let phoneToSellId = null;
        let currentWholesalerDetail = { id: null, name: null };
        let currentUsdRate = 32.85; // Default rate
        let profitChartInstance = null;
        let revenuePieChartInstance = null; 
        
        let advancedReportDataCache = { sales: [], expenses: [] };
        let cachedReportRange = "";
        
        let selectedPersonForAdvance = null; // SeÃ§ili kiÅŸi modu iÃ§in

        function enterPersonAdvanceMode(personName) {
            selectedPersonForAdvance = personName;
            
            // Form gÃ¶stergesini gÃ¶ster
            if (el.formModeIndicator) {
                el.formModeIndicator.classList.remove('hidden');
            }
            if (el.selectedPersonName) {
                el.selectedPersonName.textContent = personName;
            }
            
            // KiÅŸi adÄ± inputunu doldur ve devre dÄ±ÅŸÄ± bÄ±rak
            el.advancePersonName.value = personName;
            el.advancePersonName.disabled = true;
            el.advancePersonName.classList.add('bg-gray-100', 'cursor-not-allowed');
            
            // Formu vurgula
            el.addCashAdvanceForm.classList.add('ring-2', 'ring-blue-300', 'bg-blue-50');
            el.addCashAdvanceForm.classList.remove('bg-slate-50');
            
            // Tutara odaklan
            el.advanceAmount.focus();
        }

        function exitPersonAdvanceMode() {
            selectedPersonForAdvance = null;
            
            // Form gÃ¶stergesini gizle
            el.formModeIndicator.classList.add('hidden');
            
            // KiÅŸi adÄ± inputunu normal hale getir
            el.advancePersonName.value = '';
            el.advancePersonName.disabled = false;
            el.advancePersonName.classList.remove('bg-gray-100', 'cursor-not-allowed');
            
            // Form stilini normal hale getir
            el.addCashAdvanceForm.classList.remove('ring-2', 'ring-blue-300', 'bg-blue-50');
            el.addCashAdvanceForm.classList.add('bg-slate-50');
        }

        let currentDailyReportIncomeFilter = 'all'; // 'all', 'device', 'service', 'accessory'
        const el = {
            loginView: document.getElementById('loginView'), loginForm: document.getElementById('loginForm'), loginError: document.getElementById('loginError'), logoutBtn: document.getElementById('logoutBtn'),
            loadingScreen: document.getElementById('loadingScreen'), appContent: document.getElementById('appContent'), tabs: document.getElementById('tabs'),
            totalRevenue: document.getElementById('totalRevenue'), totalCost: document.getElementById('totalCost'), totalProfit: document.getElementById('totalProfit'), totalDebt: document.getElementById('totalDebt'),
            activeServiceStatusPanel: document.getElementById('activeServiceStatusPanel'),
            salesPanel: document.getElementById('sales-panel'), servicePanel: document.getElementById('service-panel'), serviceHistoryPanel: document.getElementById('service-history-panel'), phoneStockPanel: document.getElementById('phone-stock-panel'), soldPhonesPanel: document.getElementById('sold-phones-panel'), debtPanel: document.getElementById('debt-panel'), shortagesPanel: document.getElementById('shortages-panel'), dailyReportPanel: document.getElementById('daily-report-panel'), reportsPanel: document.getElementById('reports-panel'), productPricesPanel: document.getElementById('product-prices-panel'), cashTrackerPanel: document.getElementById('cash-tracker-panel'), salesHistoryPanel: document.getElementById('sales-history-panel'),
            salesLog: document.getElementById('salesLog'), stockSellBtn: document.getElementById('stockSellBtn'), serviceDeliveryBtn: document.getElementById('serviceDeliveryBtn'), manualSellBtn: document.getElementById('manualSellBtn'),
            addServiceForm: document.getElementById('addServiceForm'), serviceLog: document.getElementById('serviceLog'),
            serviceHistoryLog: document.getElementById('serviceHistoryLog'), serviceHistorySearchInput: document.getElementById('serviceHistorySearchInput'),
            addPhoneForm: document.getElementById('addPhoneForm'), phoneStockLog: document.getElementById('phoneStockLog'), stockCount: document.getElementById('stockCount'), stockCost: document.getElementById('stockCost'), stockValue: document.getElementById('stockValue'), stockProfit: document.getElementById('stockProfit'), phoneSearchInput: document.getElementById('phoneSearchInput'), analysisTableHeaders: document.getElementById('analysisTableHeaders'),
            soldPhonesLog: document.getElementById('soldPhonesLog'), soldPhoneSearchInput: document.getElementById('soldPhoneSearchInput'),
            wholesalerListView: document.getElementById('wholesaler-list-view'), wholesalerListContainer: document.getElementById('wholesaler-list-container'), addWholesalerBtn: document.getElementById('addWholesalerBtn'),
            wholesalerDetailView: document.getElementById('wholesaler-detail-view'), backToWholesalersBtn: document.getElementById('backToWholesalersBtn'), detailWholesalerName: document.getElementById('detailWholesalerName'), detailWholesalerBalance: document.getElementById('detailWholesalerBalance'), addDebtToWholesalerBtn: document.getElementById('addDebtToWholesalerBtn'), addPaymentToWholesalerBtn: document.getElementById('addPaymentToWholesalerBtn'), deleteWholesalerBtn: document.getElementById('deleteWholesalerBtn'), transactionHistory: document.getElementById('transactionHistory'),
            addShortageForm: document.getElementById('addShortageForm'), shortagesLog: document.getElementById('shortagesLog'), downloadShortagesPdfBtn: document.getElementById('downloadShortagesPdfBtn'),
            shortageItemPriceTL: document.getElementById('shortageItemPriceTL'), shortageItemPriceUSD: document.getElementById('shortageItemPriceUSD'),
            // Settings panel elements
            userEmail: document.getElementById('userEmail'), businessName: document.getElementById('businessName'), businessPhone: document.getElementById('businessPhone'), businessAddress: document.getElementById('businessAddress'), saveProfileBtn: document.getElementById('saveProfileBtn'),
            defaultCurrency: document.getElementById('defaultCurrency'), taxRate: document.getElementById('taxRate'), autoBackup: document.getElementById('autoBackup'), lowStockAlert: document.getElementById('lowStockAlert'), saveSettingsBtn: document.getElementById('saveSettingsBtn'),
            currentUsdRate: document.getElementById('currentUsdRate'), currentEurRate: document.getElementById('currentEurRate'), autoUpdateRates: document.getElementById('autoUpdateRates'), updateRatesBtn: document.getElementById('updateRatesBtn'), fetchRatesBtn: document.getElementById('fetchRatesBtn'),
            exportDataBtn: document.getElementById('exportDataBtn'), importDataFile: document.getElementById('importDataFile'), importDataBtn: document.getElementById('importDataBtn'), clearAllDataBtn: document.getElementById('clearAllDataBtn'), resetAppBtn: document.getElementById('resetAppBtn'),
            addProductPriceForm: document.getElementById('addProductPriceForm'), productPricesLog: document.getElementById('productPricesLog'), productPriceSearchInput: document.getElementById('productPriceSearchInput'),
            productPriceName: document.getElementById('productPriceName'), productPriceCost: document.getElementById('productPriceCost'), productPriceCurrency: document.getElementById('productPriceCurrency'), productPriceConversion: document.getElementById('productPriceConversion'),
            reportDate: document.getElementById('reportDate'), addExpenseBtn: document.getElementById('addExpenseBtn'), reportTotalRevenue: document.getElementById('reportTotalRevenue'), reportTotalCost: document.getElementById('reportTotalCost'), reportGrossProfit: document.getElementById('reportGrossProfit'), reportTotalExpenses: document.getElementById('reportTotalExpenses'), reportNetProfit: document.getElementById('reportNetProfit'), dailyCostAnalysisSection: document.getElementById('dailyCostAnalysisSection'), reportIncomeBody: document.getElementById('reportIncomeBody'), reportIncomeFoot: document.getElementById('reportIncomeFoot'), reportExpenseBody: document.getElementById('reportExpenseBody'), reportExpenseFoot: document.getElementById('reportExpenseFoot'),
            dailyReportIncomeFilterContainer: document.getElementById('dailyReportIncomeFilterContainer'), advReportRange: document.getElementById('advReportRange'), customDateRange: document.getElementById('customDateRange'), advStartDate: document.getElementById('advStartDate'), advEndDate: document.getElementById('advEndDate'), generateAdvReportBtn: document.getElementById('generateAdvReportBtn'), advReportContentPlaceholder: document.getElementById('advReportContentPlaceholder'),
            sellConfirmModal: document.getElementById('sellConfirmModal'), sellConfirmText: document.getElementById('sellConfirmText'), buyerName: document.getElementById('buyerName'), finalSellPrice: document.getElementById('finalSellPrice'), cancelSellBtn: document.getElementById('cancelSellBtn'), confirmSellBtn: document.getElementById('confirmSellBtn'),
            stockSellModal: document.getElementById('stockSellModal'), closeStockSellModalBtn: document.getElementById('closeStockSellModalBtn'), stockSellSearch: document.getElementById('stockSellSearch'), stockSellList: document.getElementById('stockSellList'),
            manualSellModal: document.getElementById('manualSellModal'), closeManualSellModalBtn: document.getElementById('closeManualSellModalBtn'), addManualSaleForm: document.getElementById('addManualSaleForm'),
            serviceDeliveryModal: document.getElementById('serviceDeliveryModal'), closeServiceDeliveryModalBtn: document.getElementById('closeServiceDeliveryModalBtn'), serviceDeliverySearch: document.getElementById('serviceDeliverySearch'), serviceDeliveryList: document.getElementById('serviceDeliveryList'),
            addWholesalerModal: document.getElementById('addWholesalerModal'), addWholesalerForm: document.getElementById('addWholesalerForm'), newWholesalerName: document.getElementById('newWholesalerName'), cancelAddWholesaler: document.getElementById('cancelAddWholesaler'),
            addTransactionModal: document.getElementById('addTransactionModal'), addTransactionForm: document.getElementById('addTransactionForm'), transactionModalTitle: document.getElementById('transactionModalTitle'), transactionWholesalerName: document.getElementById('transactionWholesalerName'), transactionType: document.getElementById('transactionType'), transactionDescription: document.getElementById('transactionDescription'),
            debtFields: document.getElementById('debt-fields'), transactionAmountDebt: document.getElementById('transactionAmountDebt'),
            paymentFields: document.getElementById('payment-fields'), transactionAmountPayment: document.getElementById('transactionAmountPayment'), exchangeRate: document.getElementById('exchangeRate'), usdEquivalent: document.getElementById('usdEquivalent'),
            cancelTransaction: document.getElementById('cancelTransaction'),
            addExpenseModal: document.getElementById('addExpenseModal'), addExpenseForm: document.getElementById('addExpenseForm'), cancelAddExpense: document.getElementById('cancelAddExpense'),
            editSaleModal: document.getElementById('editSaleModal'), editSaleForm: document.getElementById('editSaleForm'), editSaleSourceContainer: document.getElementById('editSaleSourceContainer'), editSaleSource: document.getElementById('editSaleSource'),
            editPhoneModal: document.getElementById('editPhoneModal'), editPhoneForm: document.getElementById('editPhoneForm'),
            editServiceModal: document.getElementById('editServiceModal'), editServiceForm: document.getElementById('editServiceForm'),
            editProductPriceModal: document.getElementById('editProductPriceModal'), editProductPriceForm: document.getElementById('editProductPriceForm'), cancelEditProductPrice: document.getElementById('cancelEditProductPrice'),
            editProductPriceName: document.getElementById('editProductPriceName'), editProductPriceCost: document.getElementById('editProductPriceCost'), editProductPriceCurrency: document.getElementById('editProductPriceCurrency'), editProductPriceConversion: document.getElementById('editProductPriceConversion'),
            deleteConfirmGenericModal: document.getElementById('deleteConfirmGenericModal'), deleteConfirmText: document.getElementById('deleteConfirmText'), cancelDeleteBtn: document.getElementById('cancelDeleteBtn'), confirmDeleteBtn: document.getElementById('confirmDeleteBtn'),
            usdToTryInput: document.getElementById('usdToTryInput'), 
            tryOutput: document.getElementById('tryOutput'), 
            converterUsdRate: document.getElementById('converterUsdRate'),
            tryToUsdInput: document.getElementById('tryToUsdInput'),
            usdOutput: document.getElementById('usdOutput'),
            // Cash Advances Panel Elements
            cashAdvancesPanel: document.getElementById('cash-advances-panel'),
            // Sales History Panel Elements
            historyStartDate: document.getElementById('historyStartDate'),
            historyEndDate: document.getElementById('historyEndDate'),
            historyTypeFilter: document.getElementById('historyTypeFilter'),
            historySearchInput: document.getElementById('historySearchInput'),
            filterHistoryBtn: document.getElementById('filterHistoryBtn'),
            clearHistoryFilters: document.getElementById('clearHistoryFilters'),
            salesHistoryLog: document.getElementById('salesHistoryLog'),
            historyTotalCount: document.getElementById('historyTotalCount'),
            historyTotalRevenue: document.getElementById('historyTotalRevenue'),
            historyTotalCost: document.getElementById('historyTotalCost'),
            historyTotalProfit: document.getElementById('historyTotalProfit'),
            paginationInfo: document.getElementById('paginationInfo'),
            prevHistoryPage: document.getElementById('prevHistoryPage'),
            nextHistoryPage: document.getElementById('nextHistoryPage'),
            exportHistoryBtn: document.getElementById('exportHistoryBtn'),
            addCashAdvanceForm: document.getElementById('addCashAdvanceForm'),
            cashAdvancesLog: document.getElementById('cashAdvancesLog'),
            cashAdvanceSearchInput: document.getElementById('cashAdvanceSearchInput'),
            cashAdvancePersonFilter: document.getElementById('cashAdvancePersonFilter'),
            cashAdvanceDateFilter: document.getElementById('cashAdvanceDateFilter'),
            totalAdvances: document.getElementById('totalAdvances'),
            totalPeople: document.getElementById('totalPeople'),
            totalAdvanceRecords: document.getElementById('totalAdvanceRecords'),
            personAdvancesSummary: document.getElementById('personAdvancesSummary'),
            advancePersonName: document.getElementById('advancePersonName'),
            advanceAmount: document.getElementById('advanceAmount'),
            advanceDescription: document.getElementById('advanceDescription'),
            downloadCashAdvancesPdfBtn: document.getElementById('downloadCashAdvancesPdfBtn'),
            advanceDate: document.getElementById('advanceDate'),
            formModeIndicator: document.getElementById('formModeIndicator'),
            selectedPersonName: document.getElementById('selectedPersonName'),
            cancelPersonMode: document.getElementById('cancelPersonMode'),
            // Advance History Modal Elements
            advanceHistoryModal: document.getElementById('advanceHistoryModal'),
            closeAdvanceHistoryModalBtn: document.getElementById('closeAdvanceHistoryModalBtn'),
            historyPersonName: document.getElementById('historyPersonName'),
            advanceHistoryContent: document.getElementById('advanceHistoryContent'),
            historyTotalAmount: document.getElementById('historyTotalAmount'),
            historyTotalCount: document.getElementById('historyTotalCount'),
        };
        
        const serviceStatuses = {
            PENDING: { label: 'SÄ±rada', color: 'bg-sky-500' },
            IN_PROGRESS: { label: 'Ä°ÅŸlemde', color: 'bg-amber-500' },
            WAITING_FOR_PARTS: { label: 'ParÃ§a Bekliyor', color: 'bg-orange-500' },
            READY: { label: 'HazÄ±r', color: 'bg-green-500' },
            DELIVERED: { label: 'Teslim Edildi', color: 'bg-gray-500' }
        };

        const saleTypeIcons = {
            device: { icon: 'ðŸ“±', color: 'text-sky-400' },
            service: { icon: 'ðŸ”§', color: 'text-amber-400' },
            accessory: { icon: 'ðŸŽ§', color: 'text-green-400' },
            other: { icon: 'ðŸ›’', color: 'text-slate-400' }
        };

        const PROFIT_MARGIN_THRESHOLD = 20; // Define threshold as a constant

        const getSafeFloat = (val) => {
            if (val === null || val === undefined) return 0;
            const num = parseFloat(String(val).replace(',', '.'));
            return isNaN(num) ? 0 : num;
        };
        
        // Debounce function for performance optimization
        const debounce = (func, wait) => {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        };
        
        // Auto currency conversion for shortage items
        const setupShortageAutoCurrencyConversion = () => {
            if (!el.shortageItemPriceTL || !el.shortageItemPriceUSD) return;
            
            el.shortageItemPriceTL.addEventListener('input', (e) => {
                const tlValue = getSafeFloat(e.target.value);
                if (tlValue > 0 && currentUsdRate > 0) {
                    const usdValue = tlValue / currentUsdRate;
                    el.shortageItemPriceUSD.value = usdValue.toFixed(2);
                } else if (tlValue === 0) {
                    el.shortageItemPriceUSD.value = '';
                }
            });
            
            el.shortageItemPriceUSD.addEventListener('input', (e) => {
                const usdValue = getSafeFloat(e.target.value);
                if (usdValue > 0 && currentUsdRate > 0) {
                    const tlValue = usdValue * currentUsdRate;
                    el.shortageItemPriceTL.value = tlValue.toFixed(2);
                } else if (usdValue === 0) {
                    el.shortageItemPriceTL.value = '';
                }
            });
        };
        
        const formatCurrency = (val, currency = 'TL') => {
            const num = getSafeFloat(val);
            if (currency === 'USD') {
                return num.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
            }
            return num.toLocaleString('tr-TR', { style: 'currency', currency: 'TRY' });
        }

        const getPath = (coll) => `users/${currentUserId}/${coll}`;
        const getLoaderRow = (colspan) => `<tr class="table-loader-row"><td colspan="${colspan}"><div class="loader !w-6 !h-6"></div></td></tr>`;
        const getErrorRow = (colspan, message) => `<tr class="table-error-row"><td colspan="${colspan}">${message}</td></tr>`;
        
        const sanitizeHTML = (str) => {
            if (!str) return '';
            const temp = document.createElement('div');
            temp.textContent = str;
            return temp.innerHTML;
        };
        
        const sanitizeDoc = (doc) => {
            const data = doc.data();
            const sanitizedData = { id: doc.id, ...data };

            const financialFields = [
                'totalRevenue', 'totalCost', 'totalProfit', 'partCost', 
                'laborCost', 'totalFee', 'purchasePrice', 'sellingPrice',
                'amount', 'paymentAmount', 'exchangeRateUsed', 'balanceUSD'
            ];
            
            financialFields.forEach(field => {
                sanitizedData[field] = getSafeFloat(data[field]);
            });
            
            // Recalculate profit only if it wasn't explicitly set (e.g., 0)
            // This handles cases where profit might be missing or incorrectly stored as 0 initially
            if (sanitizedData.totalProfit === 0 && sanitizedData.totalRevenue !== 0 && sanitizedData.totalCost !== 0 && data.totalProfit === undefined) {
               sanitizedData.totalProfit = sanitizedData.totalRevenue - sanitizedData.totalCost;
            }

            // Sanitize date fields
            ['date', 'deliveryDate', 'createdAt'].forEach(field => {
                if (data[field] && typeof data[field].toDate === 'function') {
                    sanitizedData[field] = data[field].toDate();
                }
            });
            
            // Sanitize nested originalPhoneData if it exists
            if(data.originalPhoneData){
                 // Recursively sanitize the nested object
                 sanitizedData.originalPhoneData = sanitizeDoc({ data: () => data.originalPhoneData, id: data.originalPhoneData.id || '' });
            }

            return sanitizedData;
        };

        const getLocalYYYYMMDD = (date = new Date()) => {
            const year = date.getFullYear();
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const dd = String(date.getDate()).padStart(2, '0');
            return `${year}-${mm}-${dd}`;
        };
        
        function setupListeners(userId) {
            if (!userId) return;
            cleanupListeners();
            const errHandler = (error) => { console.error("Veri dinleme hatasÄ±:", error); showToast(`Veri alÄ±nÄ±rken hata: ${error.message}`, 'error'); };
            
            const todayStart = new Date(); todayStart.setHours(0, 0, 0, 0);
            const todayEnd = new Date(); todayEnd.setHours(23, 59, 59, 999);
            
            const initialLoadPromises = [];

            // Listen for today's sales
            const salesQuery = query(collection(db, getPath('sales')), where('date', '>=', todayStart), where('date', '<=', todayEnd), orderBy('date', 'desc'));
            listeners.sales = onSnapshot(salesQuery, snapshot => {
                todaysSales = snapshot.docs.map(sanitizeDoc);
                
                // Ä°statistikleri anÄ±nda gÃ¼ncelle
                debouncedUpdateStats();
                
                renderTodaysSalesLog();
                renderDailyDashboardStats(); 
                // Only re-render daily report if the current date matches the report date
                if (el.dailyReportPanel.style.display !== 'none' && el.reportDate.value === getLocalYYYYMMDD()) {
                    renderDailyReport(getLocalYYYYMMDD());
                }
            }, errHandler);

            // Listen for all sales (for history panel)
            const allSalesQuery = query(collection(db, getPath('sales')), orderBy('date', 'desc'));
            listeners.allSales = onSnapshot(allSalesQuery, snapshot => {
                allSales = snapshot.docs.map(sanitizeDoc);
                
                // BugÃ¼nÃ¼n satÄ±ÅŸlarÄ±nÄ± filtrele ve istatistikleri gÃ¼ncelle
                const today = new Date();
                const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                const endOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 23, 59, 59);
                
                todaysSales = allSales.filter(sale => {
                    const saleDate = sale.date.toDate();
                    return saleDate >= startOfDay && saleDate <= endOfDay;
                });
                
                // Ä°statistikleri gÃ¼ncelle
                debouncedUpdateStats();
                
                // Only render history if the panel is active
                if (el.salesHistoryPanel.style.display !== 'none') {
                    filterAndRenderSalesHistory();
                }
            }, errHandler);

            // Listen for all services (active and completed)
            listeners.services = onSnapshot(query(collection(db, getPath('services')), orderBy('date', 'desc')), s => { 
                services = s.docs.map(sanitizeDoc);
                renderActiveServiceStatus();
                // Only render service logs if the respective panel is active
                if (el.servicePanel.style.display !== 'none') renderServiceLog(); 
                if (el.serviceHistoryPanel.style.display !== 'none') renderServiceHistoryLog();
            }, errHandler);

            // Listen for all phones in stock
            listeners.phones = onSnapshot(query(collection(db, getPath('phones')), orderBy('date', 'desc')), s => { 
                phones = s.docs.map(sanitizeDoc); 
                 // Only render stock view if the panel is active
                if (el.phoneStockPanel.style.display !== 'none') renderAnalysisView(); 
            }, errHandler);
            
            // Listen for wholesalers
            const wholesalerQuery = query(collection(db, getPath('wholesalers')), orderBy('name'));
            listeners.wholesalers = onSnapshot(wholesalerQuery, s => { 
                wholesalers = s.docs.map(sanitizeDoc);
                // Ä°statistikleri gÃ¼ncelle
                debouncedUpdateStats();
                updateDashboardDebt();
                
                // Only update/render if transactions are also loaded or panel is active
                if (listeners.transactions) { 
                    if (el.debtPanel.style.display !== 'none' && el.wholesalerListView.style.display !== 'none') {
                        renderWholesalerList();
                    } else if (el.debtPanel.style.display !== 'none' && currentWholesalerDetail.id) {
                         renderWholesalerDetail(currentWholesalerDetail);
                    }
                }
            }, errHandler);

            // Listen for all transactions
            const transactionsQuery = query(collection(db, getPath('transactions')), orderBy('createdAt', 'desc'));
            listeners.transactions = onSnapshot(transactionsQuery, s => { 
                transactions = s.docs.map(sanitizeDoc);
                // Ä°statistikleri gÃ¼ncelle
                debouncedUpdateStats();
                updateDashboardDebt();
                
                 // Only update/render if wholesalers are also loaded or panel is active
                if (listeners.wholesalers) {
                    if (el.debtPanel.style.display !== 'none') {
                        if (el.wholesalerListView.style.display !== 'none') {
                            renderWholesalerList();
                        } else if (currentWholesalerDetail.id) {
                             renderWholesalerDetail(currentWholesalerDetail);
                        }
                    }
                }
            }, errHandler);

            // Listen for product prices
            listeners.productPrices = onSnapshot(query(collection(db, getPath('productPrices')), orderBy('name', 'asc')), snapshot => {
                productPrices = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (el.productPricesPanel.style.display !== 'none') renderProductPricesLog();
            }, errHandler);

            // Listen for cash advances
            listeners.cashAdvances = onSnapshot(query(collection(db, getPath('cashAdvances')), orderBy('createdAt', 'desc')), snapshot => {
                cashAdvances = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (el.cashAdvancesPanel && el.cashAdvancesPanel.style.display !== 'none') {
                    renderCashAdvancesLog();
                    updateCashAdvancesStats();
                    updatePersonFilter();
                    renderPersonAdvancesSummary();
                }
            }, errHandler);

            // Listen for shop shortages
            listeners.shopShortages = onSnapshot(query(collection(db, getPath('shopShortages')), orderBy('name', 'asc')), snapshot => {
                shopShortages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (el.shortagesPanel.style.display !== 'none') {
                    renderShopShortagesLog();
                }
            }, errHandler);
            
            // Listen for expenses
            listeners.expenses = onSnapshot(query(collection(db, getPath('expenses')), orderBy('date', 'desc')), snapshot => {
                // Ä°statistikleri gÃ¼ncelle
                debouncedUpdateStats();
                
                // Sadece gÃ¼nlÃ¼k rapor paneli aÃ§Ä±ksa gÃ¼ncelle
                if (el.dailyReportPanel && !el.dailyReportPanel.classList.contains('hidden')) {
                    renderDailyReport(el.reportDate.value);
                }
            }, errHandler);
            
            // Wait for initial data load for some critical collections before showing content
            const dataReadyPromise = new Promise(resolve => { // Check if listeners for core data (like wholesalers and shortages for dashboard stats/initial views) are active
                let checkData = setInterval(() => { // Check if listeners for core data (like wholesalers and shortages for dashboard stats/initial views) are active
                    // Check if listeners for core data (like wholesalers and shortages for dashboard stats/initial views) are active
                    if (listeners.wholesalers && listeners.shopShortages) { 
                        clearInterval(checkData);
                        resolve();
                    }
                }, 100); // Check every 100ms
            });
            initialLoadPromises.push(dataReadyPromise);

            return Promise.all(initialLoadPromises);
        }

        function cleanupListeners() {
            // Unsubscribe from all active listeners
            Object.values(listeners).forEach(l => l && typeof l === 'function' && l());
            listeners = {}; // Clear the listeners object
            // Clear any active intervals (like exchange rate fetch)
            if(exchangeRateIntervalId) {
                clearInterval(exchangeRateIntervalId);
                exchangeRateIntervalId = null;
            }
        }
        
        function cleanupAndShowLogin() {
            cleanupListeners();
            // Clear local data caches
            services = [];
            phones = [];
            wholesalers = [];
            transactions = [];
            shopShortages = [];
            productPrices = [];
            cashAdvances = [];
            todaysSales = [];
            advancedReportDataCache = { sales: [], expenses: [] };
            cachedReportRange = "";
            currentUserId = null;
            // Hide app content and show login
            el.appContent.classList.add('hidden');
            el.loadingScreen.classList.add('hidden');
            el.loginView.classList.remove('hidden');
        }
        
        function updateCurrencyConverterDisplay() {
            if (el.converterUsdRate) {
                el.converterUsdRate.textContent = currentUsdRate.toFixed(2);
            }
            
            // USD to TRY conversion
            if (el.usdToTryInput && el.tryOutput) {
                const usdAmount = getSafeFloat(el.usdToTryInput.value);
                const tryAmount = usdAmount * currentUsdRate;
                el.tryOutput.textContent = formatCurrency(tryAmount, 'TRY');
            }
            
            // TRY to USD conversion
            if (el.tryToUsdInput && el.usdOutput) {
                const tryAmount = getSafeFloat(el.tryToUsdInput.value);
                const usdAmount = currentUsdRate > 0 ? tryAmount / currentUsdRate : 0;
                el.usdOutput.textContent = formatCurrency(usdAmount, 'USD');
            }
        }

        async function fetchExchangeRate() { 
            try { 
                const r = await fetch('https://api.exchangerate-api.com/v4/latest/USD'); 
                if (!r.ok) throw new Error('API request failed'); 
                const d = await r.json(); 
                currentUsdRate = d.rates.TRY; 
            } catch (e) { 
                console.error(e); 
                showToast(`Dolar kuru gÃ¼ncellenemedi, varsayÄ±lan (${currentUsdRate}) kullanÄ±lÄ±yor.`, 'error'); 
            } finally {
                updateCurrencyConverterDisplay(); 
                // Update the exchange rate input in the transaction modal if it's open
                if (el.exchangeRate && el.addTransactionModal.style.display !== 'none' && el.paymentFields.style.display !== 'none') {
                    el.exchangeRate.value = getSafeFloat(currentUsdRate).toFixed(4);
                    updateUsdEquivalent();
                }
            }
        }


        async function completeService(serviceId) {
            const serviceRef = doc(db, getPath(`services/${serviceId}`));
            const newSaleRef = doc(collection(db, getPath('sales')));

            try {
                await runTransaction(db, async (transaction) => {
                    const serviceSnap = await transaction.get(serviceRef);
                    if (!serviceSnap.exists()) throw "Servis kaydÄ± bulunamadÄ±.";
                    
                    const service = sanitizeDoc(serviceSnap);
                    // Double check status in case it changed since the button was enabled
                    if (service.status !== serviceStatuses.READY.label) throw "Servis hazÄ±r deÄŸil.";

                    const saleData = {
                        productName: `Servis: ${service.deviceName}`, type: 'service', originalServiceId: serviceId, quantity: 1,
                        totalCost: service.partCost + service.laborCost, totalRevenue: service.totalFee,
                        totalProfit: service.totalFee - (service.partCost + service.laborCost),
                        date: Timestamp.now(), lastUpdated: Timestamp.now()
                    };
                    
                    transaction.set(newSaleRef, saleData);
                    transaction.update(serviceRef, { status: serviceStatuses.DELIVERED.label, deliveryDate: Timestamp.now() });
                });
                showToast("Servis baÅŸarÄ±yla teslim edildi.", "success");
            } catch(e) { console.error("Servis teslimat iÅŸlemi baÅŸarÄ±sÄ±z:", e); showToast(`Hata: ${e}`, "error"); }
        }
        
        async function confirmSale(phoneToSellId) {
            const phoneRef = doc(db, getPath(`phones/${phoneToSellId}`));
            try {
                const phoneSnap = await getDoc(phoneRef);
                if (!phoneSnap.exists()) throw new Error("SatÄ±lacak cihaz stokta bulunamadÄ±.");
                
                const buyerName = el.buyerName.value.trim();
                if (!buyerName) throw new Error("AlÄ±cÄ± adÄ± soyadÄ± zorunludur.");
                
                const phoneData = sanitizeDoc(phoneSnap);
                const finalPrice = getSafeFloat(el.finalSellPrice.value);
                if (isNaN(finalPrice) || finalPrice < 0) throw new Error("GeÃ§ersiz satÄ±ÅŸ fiyatÄ±.");
                
                const saleData = {
                    productName: `Cihaz: ${phoneData.model}`, type: 'device', buyerName: buyerName, 
                    originalPhoneData: phoneData, // Store original phone data for history/restoration
                    quantity: 1, totalCost: phoneData.purchasePrice, totalRevenue: finalPrice,
                    totalProfit: finalPrice - phoneData.purchasePrice,
                    date: Timestamp.now(), lastUpdated: Timestamp.now()
                };

                const batch = writeBatch(db);
                batch.set(doc(collection(db, getPath('sales'))), saleData);
                batch.delete(phoneRef); // Remove from stock
                await batch.commit();

                showToast('Cihaz satÄ±ldÄ± ve stoktan dÃ¼ÅŸÃ¼ldÃ¼.', 'success');
                closeModal(el.sellConfirmModal);
            } catch (e) {
                console.error("Atomik cihaz satÄ±ÅŸ hatasÄ±:", e);
                showToast(e.message, "error");
            }
        }

        async function handleDeleteWholesaler(wholesalerId) {
            const wholesalerRef = doc(db, getPath(`wholesalers/${wholesalerId}`));
            const wholesalerSnap = await getDoc(wholesalerRef);
            const wholesalerName = wholesalerSnap.data()?.name;
            if (!wholesalerName) {
                 showToast("Silinecek toptancÄ± bulunamadÄ±.", "error");
                 return;
            }

            try {
                const batch = writeBatch(db);
                // Find and delete all transactions related to this wholesaler
                const transactionsQuery = query(collection(db, getPath('transactions')), where("wholesalerName", "==", wholesalerName));
                const transactionsSnapshot = await getDocs(transactionsQuery);
                transactionsSnapshot.forEach(doc => batch.delete(doc.ref));
                
                // Delete the wholesaler document
                batch.delete(wholesalerRef);
                
                await batch.commit();
                showToast(`${wholesalerName} ve tÃ¼m iÅŸlemleri silindi.`, 'success');
                // Navigate back to the list view after deletion
                el.wholesalerDetailView.classList.add('hidden');
                el.wholesalerListView.classList.remove('hidden');
                currentWholesalerDetail = { id: null, name: null }; // Clear detail state
            } catch (e) { console.error("ToptancÄ± silme hatasÄ±:", e); showToast("ToptancÄ± silinirken bir hata oluÅŸtu.", "error"); }
        }

        function openSellModal(phoneId) { 
            const phone = phones.find(p => p.id === phoneId); 
            if (!phone) {
                showToast("Cihaz bulunamadÄ±.", "error");
                return;
            }
            phoneToSellId = phoneId; 
            el.sellConfirmText.textContent = `${sanitizeHTML(phone.model)} model cihaz satÄ±lacak. Liste fiyatÄ±: ${formatCurrency(phone.sellingPrice, 'TRY')} TL`; 
            el.finalSellPrice.value = getSafeFloat(phone.sellingPrice).toFixed(2); 
            el.buyerName.value = ''; // Clear previous buyer name
            openModal(el.sellConfirmModal); 
        }
        
        function updateUsdEquivalent() {
            const amountTRY = getSafeFloat(el.transactionAmountPayment.value);
            const rate = getSafeFloat(el.exchangeRate.value);
            const equivalent = (rate > 0) ? (amountTRY / rate) : 0;
            el.usdEquivalent.innerHTML = `KarÅŸÄ±lÄ±ÄŸÄ±: <span class="font-bold text-slate-800">${formatCurrency(equivalent, 'USD')}</span>`;
        }

        function openTransactionModal(type, wholesalerName) {
            el.transactionWholesalerName.value = wholesalerName;
            el.transactionType.value = type;
            const form = el.addTransactionForm;
            form.reset();
            const submitBtn = form.querySelector('button[type="submit"]');

            if (type === 'debt') {
                el.transactionModalTitle.textContent = `${wholesalerName}: Yeni BorÃ§ Ekle (USD)`;
                el.debtFields.style.display = 'block'; 
                el.paymentFields.style.display = 'none';
                el.transactionAmountDebt.required = true; 
                el.transactionAmountPayment.required = false; 
                el.exchangeRate.required = false;
                submitBtn.className = 'btn btn-danger';
            } else { // type === 'payment'
                el.transactionModalTitle.textContent = `${wholesalerName}: Ã–deme Yap (TL)`;
                el.debtFields.style.display = 'none'; 
                el.paymentFields.style.display = 'block';
                el.transactionAmountDebt.required = false; 
                el.transactionAmountPayment.required = true; 
                el.exchangeRate.required = true;
                el.exchangeRate.value = getSafeFloat(currentUsdRate).toFixed(4); // Pre-fill with current rate
                updateUsdEquivalent(); // Calculate initial equivalent
                submitBtn.className = 'btn btn-success';
            }
            openModal(el.addTransactionModal);
        }

        async function openEditSaleModal(saleId) { 
            const saleRef = doc(db, getPath(`sales/${saleId}`)); 
            const saleSnap = await getDoc(saleRef); 
            if(!saleSnap.exists()) { showToast('SatÄ±ÅŸ bulunamadÄ±.', 'error'); return; } 
            
            const sale = sanitizeDoc(saleSnap); 
            el.editSaleModal.querySelector('#editSaleId').value = saleId; 
            el.editSaleModal.querySelector('#editSaleProductName').textContent = sale.productName; 
            el.editSaleModal.querySelector('#editSaleRevenue').value = sale.totalRevenue; 
            el.editSaleModal.querySelector('#editSaleCost').value = sale.totalCost; 
            
            let sourceText = 'Manuel SatÄ±ÅŸ'; 
            if (sale.type === 'device') { sourceText = 'Kaynak: Stok CihazÄ±'; } 
            else if (sale.type === 'service') { sourceText = 'Kaynak: Servis KaydÄ±'; } 
            
            el.editSaleSource.textContent = sourceText; 
            el.editSaleSourceContainer.classList.remove('hidden'); 
            
            openModal(el.editSaleModal); 
        }
        
        function openEditServiceModal(serviceId) { 
            const service = services.find(s => s.id === serviceId); 
            if(!service) { showToast('Servis kaydÄ± bulunamadÄ±.', 'error'); return; }
            
            const modal = el.editServiceModal; 
            modal.querySelector('#editServiceId').value = serviceId; 
            modal.querySelector('#editCustomerName').value = service.customerName; 
            modal.querySelector('#editCustomerPhone').value = service.customerPhone || ''; 
            modal.querySelector('#editDeviceName').value = service.deviceName; 
            modal.querySelector('#editDeviceProblem').value = service.deviceProblem || ''; 
            modal.querySelector('#editPartCost').value = service.partCost; 
            modal.querySelector('#editLaborCost').value = service.laborCost; 
            modal.querySelector('#editTotalFee').value = service.totalFee; 
            
            openModal(modal); 
        }
        
        async function handleDeleteTransaction(transactionId, transactionName) {
            const transactionRef = doc(db, getPath(`transactions/${transactionId}`));
            try {
                const transactionSnap = await getDoc(transactionRef);
                if (!transactionSnap.exists()) throw new Error("Ä°ÅŸlem bulunamadÄ±.");

                const transactionData = transactionSnap.data();
                const wholesaler = wholesalers.find(w => w.name === transactionData.wholesalerName);
                if (!wholesaler) throw new Error("Ä°ÅŸleme baÄŸlÄ± toptancÄ± bulunamadÄ±.");
                
                const wholesalerRef = doc(db, getPath(`wholesalers/${wholesaler.id}`));
                let amountToReverse = 0;
                if (transactionData.type === 'debt') {
                    amountToReverse = -getSafeFloat(transactionData.amount); // Subtract debt amount
                } else if (transactionData.type === 'payment') {
                    amountToReverse = getSafeFloat(transactionData.amount); // Add back the USD equivalent of the payment
                } else {
                     throw new Error("Bilinmeyen iÅŸlem tÃ¼rÃ¼.");
                }

                const batch = writeBatch(db);
                batch.update(wholesalerRef, { balanceUSD: increment(amountToReverse) });
                batch.delete(transactionRef);
                await batch.commit();
                
                showToast('Ä°ÅŸlem silindi ve bakiye gÃ¼ncellendi.', 'success');
            } catch(e) {
                console.error("Ä°ÅŸlem silme hatasÄ±:", e);
                showToast(e.message, "error");
            }
        }

        function openEditProductPriceModal(priceId) {
            const priceEntry = productPrices.find(p => p.id === priceId);
            if (!priceEntry) { showToast('ÃœrÃ¼n fiyat kaydÄ± bulunamadÄ±.', 'error'); return; }
            const modal = el.editProductPriceModal;
            modal.querySelector('#editProductPriceId').value = priceId;
            modal.querySelector('#editProductPriceName').value = priceEntry.name;
            modal.querySelector('#editProductPriceCost').value = priceEntry.cost;
            modal.querySelector('#editProductPriceCurrency').value = priceEntry.currency || 'TRY';
            openModal(modal);
            // Modal aÃ§Ä±ldÄ±ÄŸÄ±nda dÃ¶nÃ¼ÅŸÃ¼m bilgisini gÃ¼ncelle
            updateEditProductPriceConversion();
        }

        // Edit modal iÃ§in dÃ¶nÃ¼ÅŸÃ¼m fonksiyonu
        function updateEditProductPriceConversion() {
            if (!el.editProductPriceCost || !el.editProductPriceCurrency || !el.editProductPriceConversion) return;
            
            const amount = parseFloat(el.editProductPriceCost.value);
            const currency = el.editProductPriceCurrency.value;
            
            if (isNaN(amount) || amount <= 0) {
                el.editProductPriceConversion.innerHTML = '';
                return;
            }
            
            let conversionText = '';
            if (currency === 'TRY') {
                const usdAmount = amount / currentUsdRate;
                conversionText = `
                    <div class="flex items-center text-slate-600">
                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4V2a1 1 0 011-1h8a1 1 0 011 1v2m-9 4h10m-10 0V6a1 1 0 011-1h8a1 1 0 011 1v2m-10 0v12a1 1 0 001 1h8a1 1 0 001 1V8"></path>
                        </svg>
                        â‰ˆ ${formatCurrency(usdAmount, 'USD')} (GÃ¼ncel kur: ${currentUsdRate.toFixed(2)})
                    </div>
                `;
            } else {
                const tryAmount = amount * currentUsdRate;
                conversionText = `
                    <div class="flex items-center text-slate-600">
                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4V2a1 1 0 011-1h8a1 1 0 011 1v2m-9 4h10m-10 0V6a1 1 0 011-1h8a1 1 0 011 1v2m-10 0v12a1 1 0 001 1h8a1 1 0 001 1V8"></path>
                        </svg>
                        â‰ˆ ${formatCurrency(tryAmount, 'TRY')} (GÃ¼ncel kur: ${currentUsdRate.toFixed(2)})
                    </div>
                `;
            }
            
            el.editProductPriceConversion.innerHTML = conversionText;
        }

        async function handleUpdateProductPrice(e) {
            e.preventDefault();
            const modal = el.editProductPriceModal;
            const id = modal.querySelector('#editProductPriceId').value;
            const name = modal.querySelector('#editProductPriceName').value.trim();
            const cost = getSafeFloat(modal.querySelector('#editProductPriceCost').value);
            const currency = modal.querySelector('#editProductPriceCurrency').value;
            if (!name || cost < 0) { showToast('ÃœrÃ¼n adÄ± ve geÃ§erli maliyet girin.', 'error'); throw new Error("Validation failed"); }
            await updateDocument(`productPrices/${id}`, { name: name, cost: cost, currency: currency }, 'ÃœrÃ¼n fiyatÄ± gÃ¼ncellendi.');
            closeModal(modal);
        }

        function openDeleteConfirmModal(itemType, itemId, itemName) { 
            let confirmationMessage = ""; 
            let deleteFunction = () => {}; 
            
            switch (itemType) { 
                case 'sale': 
                    confirmationMessage = `<b>"${sanitizeHTML(itemName)}"</b> iÅŸlemini silmek Ã¼zeresiniz. Bu iÅŸlem tÃ¼m raporlarÄ± etkileyecektir. Cihaz veya servis satÄ±ÅŸÄ± ise ilgili kayÄ±tlar gÃ¼ncellenecektir.`; 
                    deleteFunction = () => handleDeleteSale(itemId); 
                    break; 
                case 'phone': 
                    confirmationMessage = `<b>"${sanitizeHTML(itemName)}"</b> isimli cihazÄ± stoktan kalÄ±cÄ± olarak silmek Ã¼zeresiniz. Bu iÅŸlem geri alÄ±namaz.`; 
                    deleteFunction = () => deleteDocument(`phones/${itemId}`, 'Cihaz stoktan silindi.'); 
                    break; 
                case 'service': 
                    confirmationMessage = `<b>"${sanitizeHTML(itemName)}"</b> servis kaydÄ±nÄ± kalÄ±cÄ± olarak silmek Ã¼zeresiniz. Bu iÅŸlem geri alÄ±namaz.`; 
                    deleteFunction = () => deleteDocument(`services/${itemId}`, 'Servis kaydÄ± silindi.'); 
                    break; 
                case 'wholesaler': 
                    const wholesalerToDelete = wholesalers.find(w => w.id === itemId);
                    if (!wholesalerToDelete) { showToast("ToptancÄ± bulunamadÄ±.", "error"); return; }
                    confirmationMessage = `<b>"${sanitizeHTML(wholesalerToDelete.name)}"</b> isimli toptancÄ±yÄ± silmek Ã¼zeresiniz. BU Ä°ÅžLEM, TOPTANCIYA AÄ°T TÃœM BORÃ‡ VE Ã–DEME GEÃ‡MÄ°ÅžÄ°NÄ° KALICI OLARAK SÄ°LECEKTÄ°R. Bu iÅŸlem geri alÄ±namaz.`; 
                    deleteFunction = () => handleDeleteWholesaler(itemId); 
                    break; 
                case 'transaction': 
                    confirmationMessage = `<b>${sanitizeHTML(itemName)}</b> tutarÄ±ndaki iÅŸlemi silmek Ã¼zeresiniz. Bu iÅŸlem toptancÄ± bakiyesini etkileyecektir ve geri alÄ±namaz.`; 
                    deleteFunction = () => handleDeleteTransaction(itemId, itemName); 
                    break; 
                case 'expense': 
                    confirmationMessage = `<b>"${sanitizeHTML(itemName)}"</b> giderini silmek Ã¼zeresiniz. Bu iÅŸlem gÃ¼n sonu raporunu etkileyecektir ve geri alÄ±namaz.`; 
                    deleteFunction = async () => { 
                        await deleteDocument(`expenses/${itemId}`, 'Gider silindi.'); 
                        // Gider silindikten sonra gÃ¼nlÃ¼k raporu gÃ¼ncelle
                        if (el.dailyReportPanel && !el.dailyReportPanel.classList.contains('hidden')) {
                            await renderDailyReport(el.reportDate.value);
                        }
                    }; 
                    break; 
                case 'shortage': 
                    confirmationMessage = `<b>"${sanitizeHTML(itemName)}"</b> adlÄ± eksik Ã¼rÃ¼nÃ¼ listeden silmek Ã¼zeresiniz.`; 
                    deleteFunction = () => deleteDocument(`shopShortages/${itemId}`, 'Eksik Ã¼rÃ¼n silindi.'); 
                    break; 
                case 'productPrice':
                    confirmationMessage = `<b>"${sanitizeHTML(itemName)}"</b> isimli Ã¼rÃ¼n fiyat kaydÄ±nÄ± silmek Ã¼zeresiniz. Bu iÅŸlem geri alÄ±namaz.`;
                    deleteFunction = () => deleteDocument(`productPrices/${itemId}`, 'ÃœrÃ¼n fiyat kaydÄ± silindi.');
                    break;
                case 'cashAdvance':
                    confirmationMessage = `<b>"${sanitizeHTML(itemName)}"</b> kiÅŸisinin avans kaydÄ±nÄ± silmek Ã¼zeresiniz. Bu iÅŸlem geri alÄ±namaz.`;
                    deleteFunction = () => deleteDocument(`cashAdvances/${itemId}`, 'Avans kaydÄ± silindi.');
                    break;

                default: 
                    console.error("Bilinmeyen silme tÃ¼rÃ¼:", itemType);
                    showToast("Silme iÅŸlemi iÃ§in geÃ§ersiz tÃ¼r.", "error");
                    return; 
            } 
            
            el.deleteConfirmText.innerHTML = confirmationMessage; 
            el.confirmDeleteBtn.onclick = () => { 
                handleActionWithButton(el.confirmDeleteBtn, async () => { 
                    await deleteFunction(); 
                    closeModal(el.deleteConfirmGenericModal); 
                }); 
            }; 
            openModal(el.deleteConfirmGenericModal); 
        }
        
        async function handleDeleteSale(saleId) {
            const saleRef = doc(db, getPath(`sales/${saleId}`));
            try {
                const saleSnap = await getDoc(saleRef);
                if (!saleSnap.exists()) throw new Error('Silinecek satÄ±ÅŸ kaydÄ± bulunamadÄ±.');
                
                const sale = saleSnap.data();
                const batch = writeBatch(db);

                // If the sale was a device sale originating from stock, restore the phone to stock
                if (sale.type === 'device' && sale.originalPhoneData && sale.originalPhoneData.id) {
                    const phoneRef = doc(db, getPath(`phones/${sale.originalPhoneData.id}`));
                    const docSnap = await getDoc(phoneRef);
                    // Prevent restoring if a phone with the same ID already exists in stock (shouldn't happen with normal flow, but good check)
                    if (docSnap.exists()) {
                        throw new Error("SatÄ±ÅŸ silinemiyor: Orijinal cihaz ID'si stokta zaten mevcut. LÃ¼tfen verileri kontrol edin.");
                    }
                    // Restore the phone data, updating date/lastUpdated
                    const phoneToRestore = { ...sale.originalPhoneData, date: Timestamp.now(), lastUpdated: Timestamp.now() };
                    batch.set(phoneRef, phoneToRestore); // Use set to create the document if it doesn't exist
                } 
                // If the sale was a service delivery, revert the service status to "HazÄ±r"
                else if (sale.type === 'service' && sale.originalServiceId) {
                    batch.update(doc(db, getPath(`services/${sale.originalServiceId}`)), { status: serviceStatuses.READY.label, deliveryDate: null, lastUpdated: Timestamp.now() });
                }

                // Delete the sale document
                batch.delete(saleRef);
                await batch.commit();
                showToast('Ä°ÅŸlem silindi ve ilgili kayÄ±tlar geri alÄ±ndÄ±.', 'success');
            } catch (e) { console.error("SatÄ±ÅŸ silme hatasÄ±:", e); showToast(e.message, "error"); }
        }
        
        function openEditPhoneModal(phoneId) {
            const phone = phones.find(p => p.id === phoneId);
            if (!phone) { showToast('Telefon bulunamadÄ±.', 'error'); return; }
            const modal = el.editPhoneModal;
            modal.querySelector('#editPhoneId').value = phoneId;
            modal.querySelector('#editPhoneImei').textContent = phone.imei; // IMEI is not editable
            modal.querySelector('#editPhoneModel').value = phone.model;
            modal.querySelector('#editPhoneSpecs').value = phone.specs;
            modal.querySelector('#editPhonePurchasePrice').value = phone.purchasePrice;
            modal.querySelector('#editPhoneSellingPrice').value = phone.sellingPrice;
            modal.querySelector('#editPhoneBatteryHealth').value = phone.batteryHealth || '';
            modal.querySelector('#editPhoneCosmetic').value = phone.cosmetic || '';
            modal.querySelector('#editPhoneAccessories').value = phone.accessories || ''; 
            modal.querySelector('#editPhoneImageUrl').value = phone.imageUrl || '';
            openModal(modal);
        }
        
        async function handleUpdatePhone(e) {
            e.preventDefault();
            const modal = el.editPhoneModal;
            const id = modal.querySelector('#editPhoneId').value;
            const d = {
                model: modal.querySelector('#editPhoneModel').value.trim(),
                specs: modal.querySelector('#editPhoneSpecs').value.trim(),
                purchasePrice: getSafeFloat(modal.querySelector('#editPhonePurchasePrice').value),
                sellingPrice: getSafeFloat(modal.querySelector('#editPhoneSellingPrice').value),
                batteryHealth: parseInt(modal.querySelector('#editPhoneBatteryHealth').value) || null,
                cosmetic: modal.querySelector('#editPhoneCosmetic').value,
                accessories: modal.querySelector('#editPhoneAccessories').value,
                imageUrl: modal.querySelector('#editPhoneImageUrl').value.trim(),
                lastUpdated: Timestamp.now()
            };
            // Basic validation
            if (!d.model || d.purchasePrice < 0 || d.sellingPrice < 0) {
                 showToast('Model, AlÄ±ÅŸ ve SatÄ±ÅŸ fiyatÄ± alanlarÄ± zorunludur ve geÃ§erli deÄŸerler iÃ§ermelidir.', 'error');
                 throw new Error("Validation failed");
            }
            await updateDocument(`phones/${id}`, d, 'Telefon bilgileri gÃ¼ncellendi.');
            closeModal(modal);
        }
        
        async function handleUpdateService(e) { 
            e.preventDefault(); 
            const modal = el.editServiceModal; 
            const id = modal.querySelector('#editServiceId').value; 
            const d = { 
                customerName: modal.querySelector('#editCustomerName').value.trim(), 
                customerPhone: modal.querySelector('#editCustomerPhone').value.trim(), 
                deviceName: modal.querySelector('#editDeviceName').value.trim(), 
                deviceProblem: modal.querySelector('#editDeviceProblem').value.trim(), 
                partCost: getSafeFloat(modal.querySelector('#editPartCost').value), 
                laborCost: getSafeFloat(modal.querySelector('#editLaborCost').value), 
                totalFee: getSafeFloat(modal.querySelector('#editTotalFee').value), 
                lastUpdated: Timestamp.now() 
            }; 
            
            if (!d.customerName || !d.deviceName || d.totalFee < 0) { 
                showToast('MÃ¼ÅŸteri AdÄ±, Cihaz Modeli ve Toplam Ãœcret alanlarÄ± zorunludur ve geÃ§erli deÄŸerler iÃ§ermelidir.', 'error'); 
                throw new Error("Validation failed"); 
            } 
            
            try { 
                const batch = writeBatch(db); 
                const serviceRef = doc(db, getPath(`services/${id}`));
                batch.update(serviceRef, d); 
                
                // Find and update the corresponding sale record if it exists (for delivered services)
                const salesQuery = query(collection(db, getPath('sales')), where("type", "==", "service"), where("originalServiceId", "==", id));
                const salesSnapshot = await getDocs(salesQuery); 
                
                if (!salesSnapshot.empty) { 
                    const saleDoc = salesSnapshot.docs[0]; 
                    const newTotalCost = d.partCost + d.laborCost; 
                    const newTotalProfit = d.totalFee - newTotalCost; 
                    batch.update(saleDoc.ref, { 
                        totalRevenue: d.totalFee, 
                        totalCost: newTotalCost, 
                        totalProfit: newTotalProfit, 
                        lastUpdated: Timestamp.now() 
                    }); 
                } 
                
                await batch.commit(); 
                showToast('Servis kaydÄ± gÃ¼ncellendi.', 'success'); 
                closeModal(modal); 
            } catch (err) { 
                console.error(err); 
                showToast('Servis gÃ¼ncellenirken hata.', 'error'); 
                throw err; // Re-throw to be caught by handleActionWithButton
            } 
        }
        
        async function handleUpdateSale(e) { 
            e.preventDefault(); 
            const modal = el.editSaleModal; 
            const saleId = modal.querySelector('#editSaleId').value; 
            const newRevenue = getSafeFloat(modal.querySelector('#editSaleRevenue').value); 
            const newCost = getSafeFloat(modal.querySelector('#editSaleCost').value); 
            
            if (newRevenue < 0 || newCost < 0) {
                 showToast('Ciro ve Maliyet alanlarÄ± geÃ§erli deÄŸerler iÃ§ermelidir.', 'error');
                 throw new Error("Validation failed");
            }

            const saleRef = doc(db, getPath(`sales/${saleId}`)); 
            try { 
                const newProfit = newRevenue - newCost; 
                await updateDoc(saleRef, { 
                    totalRevenue: newRevenue, 
                    totalCost: newCost, 
                    totalProfit: newProfit, 
                    lastUpdated: Timestamp.now() 
                }); 
                showToast("SatÄ±ÅŸ bilgileri baÅŸarÄ±yla gÃ¼ncellendi.", "success"); 
                closeModal(modal); 
            } catch (err) { 
                console.error("SatÄ±ÅŸ gÃ¼ncelleme hatasÄ±:", err); 
                showToast('SatÄ±ÅŸ gÃ¼ncellenirken bir hata oluÅŸtu.', 'error'); 
                throw err; // Re-throw to be caught by handleActionWithButton
            } 
        }

        function renderTodaysSalesLog() { 
            if (todaysSales.length === 0) { 
                el.salesLog.innerHTML = `<tr><td colspan="9" class="text-center p-8 text-slate-500">BugÃ¼n iÃ§in iÅŸlem yok.</td></tr>`; 
                return; 
            } 
            const typeMap = { 
                device: { text: 'Cihaz SatÄ±ÅŸ', color: 'badge-blue', icon: 'ðŸ“±' }, 
                service: { text: 'Servis', color: 'badge-yellow', icon: 'ðŸ”§' }, 
                accessory: { text: 'Aksesuar', color: 'badge-green', icon: 'ðŸŽ§' } 
            }; 
            el.salesLog.innerHTML = todaysSales.map((s, index) => { 
                const typeInfo = typeMap[s.type] || { text: 'DiÄŸer', color: 'badge-gray', icon: 'ðŸ›’' }; 
                const profit = getSafeFloat(s.totalProfit); 
                return `<tr class="border-b border-slate-200">
                    <td class="px-2 py-4 text-center text-slate-500">${index + 1}</td>
                    <td class="px-4 py-4"><span class="status-badge ${typeInfo.color} !font-semibold">${typeInfo.icon} ${typeInfo.text}</span></td>
                    <td class="px-4 py-4 font-medium text-slate-800">${sanitizeHTML(s.productName)} ${s.quantity>1?`(${s.quantity} Adet)`:''}</td>
                    <td class="px-4 py-4">${formatCurrency(s.totalRevenue, 'TRY')}</td>
                    <td class="px-4 py-4 text-red-600">${formatCurrency(s.totalCost, 'TRY')}</td>
                    <td class="px-4 py-4 font-bold ${profit>=0?'text-green-600':'text-red-600'}">${formatCurrency(profit, 'TRY')}</td>
                    <td class="px-4 py-4 text-sm text-slate-500">${s.date.toLocaleDateString('tr-TR')}</td>
                    <td class="px-4 py-4 text-sm text-slate-500">${s.date.toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'})}</td>
                    <td class="px-4 py-4">
                        <div class="flex items-center justify-center space-x-2">
                            <button data-id="${s.id}" class="edit-sale-btn p-1 text-slate-400 hover:text-sky-500" title="DÃ¼zenle" aria-label="SatÄ±ÅŸÄ± DÃ¼zenle">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                            </button>
                            <button data-id="${s.id}" data-name="${s.productName}" class="delete-sale-btn p-1 text-slate-400 hover:text-red-500" title="Sil" aria-label="SatÄ±ÅŸÄ± Sil">
                                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="m5 6 1 0-1 0V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v2"/></svg>
                            </button>
                        </div>
                    </td>
                </tr>`; 
            }).join(''); 
        }
        
        function renderServiceLog() { 
            const activeServices = services.filter(s => s.status !== serviceStatuses.DELIVERED.label); 
            if (activeServices.length === 0) { 
                el.serviceLog.innerHTML = `<tr><td colspan="5" class="text-center p-8 text-slate-500">Aktif servis kaydÄ± bulunmuyor.</td></tr>`; 
                return; 
            } 
            el.serviceLog.innerHTML = activeServices.map(s => { 
                const netProfit = s.totalFee - (s.partCost + s.laborCost); 
                // Generate status options dynamically based on serviceStatuses object
                const statusOptions = Object.values(serviceStatuses)
                                            .filter(status => status.label !== serviceStatuses.DELIVERED.label) // Exclude Delivered from active list dropdown
                                            .map(status => `<option value="${status.label}" ${s.status===status.label?'selected':''}>${status.label}</option>`)
                                            .join('');
                
                return `<tr class="border-b border-slate-200">
                    <td class="px-4 py-4">${sanitizeHTML(s.customerName)}</td>
                    <td class="px-4 py-4">${sanitizeHTML(s.deviceName)}</td>
                    <td class="px-4 py-4 font-bold ${netProfit>=0?'text-green-600':'text-red-600'}">${formatCurrency(netProfit, 'TRY')}</td>
                    <td class="px-4 py-4">
                        <select data-id="${s.id}" class="status-select input-field !p-1.5 !text-xs">
                            ${statusOptions}
                        </select>
                    </td>
                    <td class="px-4 py-4 text-center">
                        <div class="flex items-center justify-center space-x-2">
                            <button data-id="${s.id}" class="btn complete-btn !py-1 !px-2 !text-xs ${s.status===serviceStatuses.READY.label?'btn-success':'btn-disabled'}" ${s.status!==serviceStatuses.READY.label?'disabled':''}>Teslim Et</button>
                            <button data-id="${s.id}" class="edit-service-btn p-1 text-slate-400 hover:text-sky-500" title="DÃ¼zenle" aria-label="Servisi DÃ¼zenle">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg>
                            </button>
                            <button data-id="${s.id}" data-name="${s.customerName} - ${s.deviceName}" class="delete-service-btn p-1 text-slate-400 hover:text-red-500" title="Sil" aria-label="Servisi Sil">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/></svg>
                            </button>
                        </div>
                    </td>
                </tr>`; 
            }).join(''); 
        }
        
        function renderServiceHistoryLog() {
            const searchTerm = el.serviceHistorySearchInput.value.toLowerCase();
            let completedServices = services.filter(s => s.status === serviceStatuses.DELIVERED.label);
            
            // Sort by delivery date descending
            completedServices.sort((a, b) => {
                const dateA = a.deliveryDate ? a.deliveryDate.getTime() : 0; 
                const dateB = b.deliveryDate ? b.deliveryDate.getTime() : 0;
                return dateB - dateA; 
            });

            const filteredServices = completedServices.filter(s => 
                s.customerName.toLowerCase().includes(searchTerm) || 
                s.deviceName.toLowerCase().includes(searchTerm) || 
                (s.deviceProblem && s.deviceProblem.toLowerCase().includes(searchTerm))
            );

            if (filteredServices.length === 0) {
                el.serviceHistoryLog.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-slate-500">TamamlanmÄ±ÅŸ servis kaydÄ± bulunamadÄ±.</td></tr>`;
                return;
            }

            el.serviceHistoryLog.innerHTML = filteredServices.map(s => {
                const profit = s.totalFee - (s.partCost + s.laborCost);
                const deliveryDateFormatted = s.deliveryDate 
                    ? s.deliveryDate.toLocaleDateString('tr-TR', {day:'2-digit', month:'short', year:'numeric'}) 
                    : 'Bilinmiyor';
                return `
                    <tr class="border-b border-slate-200">
                        <td class="px-4 py-4 text-slate-600">${deliveryDateFormatted}</td>
                        <td class="px-4 py-4 font-medium text-slate-700">${sanitizeHTML(s.customerName)}</td>
                        <td class="px-4 py-4 text-slate-700">${sanitizeHTML(s.deviceName)}</td>
                        <td class="px-4 py-4 text-slate-500 truncate max-w-xs" title="${sanitizeHTML(s.deviceProblem||'')}">${sanitizeHTML(s.deviceProblem||'-')}</td>
                        <td class="px-4 py-4 text-right text-sky-600">${formatCurrency(s.totalFee, 'TRY')}</td>
                        <td class="px-4 py-4 text-right font-bold ${profit>=0?'text-green-600':'text-red-600'}">${formatCurrency(profit, 'TRY')}</td>
                    </tr>`;
            }).join('');
        }
        
        function renderActiveServiceStatus() { 
            const activeServices = services.filter(s => s.status !== serviceStatuses.DELIVERED.label); 
            const totalActive = activeServices.length; 
            
            if (totalActive === 0) { 
                el.activeServiceStatusPanel.innerHTML = `<div class="card !p-6 modern-title-container service-empty-state"><div class="title-bg-effect"></div><div class="title-border-glow"></div><div class="flex items-center justify-center gap-4 relative z-10"><svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-emerald-500"><path d="M12.22 2h-4.44a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8.38"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg><p class="attention-title text-lg">âœ… Serviste bekleyen cihaz bulunmuyor.</p></div></div>`; 
                return; 
            } 
            
            // Group services by status, excluding 'Teslim Edildi'
            const statusGroups = Object.values(serviceStatuses)
                                    .filter(status => status.label !== serviceStatuses.DELIVERED.label)
                                    .reduce((acc, status) => {
                                        acc[status.label] = activeServices.filter(s => s.status === status.label);
                                        return acc;
                                    }, {});

            const progressBarSegmentsHTML = Object.entries(statusGroups).map(([statusLabel, devices]) => { 
                const count = devices.length; 
                if (count === 0) return ''; 
                const percentage = (count / totalActive) * 100; 
                const statusInfo = Object.values(serviceStatuses).find(s => s.label === statusLabel); // Find color
                const tooltipContent = `${statusLabel} (${count} Cihaz):\n${devices.map(d => `- ${sanitizeHTML(d.deviceName)}`).join('\n')}`; 
                return `<div class="progress-segment ${statusInfo?.color || 'bg-gray-500'}" style="width: ${percentage}%;" title="${tooltipContent}"></div>`; 
            }).join(''); 
            
            const legendHTML = Object.entries(statusGroups).map(([statusLabel, devices]) => { 
                const count = devices.length; 
                if (count === 0) return ''; 
                 const statusInfo = Object.values(serviceStatuses).find(s => s.label === statusLabel); // Find color
                return `<div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full ${statusInfo?.color || 'bg-gray-500'}"></span><span>${statusLabel} (${count})</span></div>` 
            }).join(''); 
            
            const panelHTML = `<div class="card !p-5"><div class="flex justify-between items-center mb-4"><h2 class="text-lg font-semibold text-slate-800">Aktif Servis Takibi</h2><div class="text-right"><p class="text-2xl font-bold text-slate-700">${totalActive}</p><p class="text-xs text-slate-500 -mt-1">Toplam Cihaz</p></div></div><div class="service-progress-bar mb-4">${progressBarSegmentsHTML}</div><div class="flex flex-wrap justify-center gap-x-4 gap-y-2 text-xs text-slate-500">${legendHTML}</div></div>`; 
            
            if (el.activeServiceStatusPanel) { el.activeServiceStatusPanel.innerHTML = panelHTML; } 
        }
        
        function renderAnalysisView() { 
            const headerMap={model:"Model",imei:"IMEI",potentialProfit:"Pot. KÃ¢r",daysInStock:"Stok SÃ¼resi"}; 
            el.analysisTableHeaders.querySelectorAll('.sortable').forEach(th=>{
                const text = headerMap[th.dataset.sort];
                if(th.dataset.sort===sortState.key){
                    th.classList.add('sorted-column');
                    th.innerHTML=`${text} ${sortState.order==='asc'?'â–²':'â–¼'}`;
                }else{
                    th.classList.remove('sorted-column');
                    th.innerHTML=text;
                }
            }); 
            
            const searchTerm = el.phoneSearchInput.value.toLowerCase(); 
            let filteredPhones = phones.filter(p=>p.model.toLowerCase().includes(searchTerm)||p.imei.toLowerCase().includes(searchTerm)); 
            
            filteredPhones.forEach(p=>{
                const purchasePrice = getSafeFloat(p.purchasePrice); 
                const sellingPrice = getSafeFloat(p.sellingPrice); 
                p.daysInStock=Math.floor((new Date()- p.date)/(1000*60*60*24)); 
                p.potentialProfit=sellingPrice - purchasePrice;
                p.profitMargin=purchasePrice > 0 ? (p.potentialProfit / purchasePrice) * 100 : 0;
            }); 
            
            filteredPhones.sort((a,b)=>{
                const sortKey = sortState.key;
                const valueA = a[sortKey];
                const valueB = b[sortKey];
                
                if(typeof valueA === 'string') {
                    return sortState.order === 'asc' ? valueA.localeCompare(valueB, 'tr', { sensitivity: 'base' }) : valueB.localeCompare(valueA, 'tr', { sensitivity: 'base' });
                }
                // Handle null/undefined for numeric sorts
                const numA = getSafeFloat(valueA);
                const numB = getSafeFloat(valueB);

                return sortState.order === 'asc' ? numA - numB : numB - numA;
            }); 
            
            if (filteredPhones.length === 0) {
                 el.phoneStockLog.innerHTML = `<tr><td colspan="7" class="text-center p-8 text-slate-500">Stokta cihaz bulunamadÄ±.</td></tr>`;
            } else {
                el.phoneStockLog.innerHTML = filteredPhones.map(p=>{
                    let rowClass = '';
                    if(p.daysInStock > 90) rowClass = 'bg-red-100/60'; // Highlight items older than 90 days (light red)
                    else if(p.daysInStock > 60) rowClass = 'bg-orange-100/60'; // Highlight items older than 60 days (light orange)
                    
                    // Highlight low profit margin items (can combine with age highlight if needed)
                    if (p.profitMargin < PROFIT_MARGIN_THRESHOLD && p.potentialProfit > 0) {
                         rowClass += ' border-l-4 border-yellow-400'; // Add a visual indicator for low profit (light yellow)
                    }


                    const detailsHtml = `<div class="flex items-center space-x-2 text-xs">
                        ${p.batteryHealth !== null && p.batteryHealth !== undefined ? `<span title="Pil: ${p.batteryHealth}%" class="flex items-center bg-slate-100 text-slate-700 px-1.5 py-0.5 rounded">ðŸ”‹ ${p.batteryHealth}%</span>` : ''}
                        ${p.cosmetic ? `<span title="Kozmetik: ${sanitizeHTML(p.cosmetic)}" class="flex items-center bg-slate-100 text-slate-700 px-1.5 py-0.5 rounded">âœ¨ ${sanitizeHTML(p.cosmetic.substring(0,1))}</span>` : ''}
                        ${p.accessories ? `<span title="Aksesuar: ${sanitizeHTML(p.accessories)}" class="flex items-center bg-slate-100 text-slate-700 px-1.5 py-0.5 rounded">ðŸ“¦</span>` : ''}
                    </div>`;
                    
                    const photoHtml = p.imageUrl ? 
                        `<a href="${sanitizeHTML(p.imageUrl)}" target="_blank" class="text-sky-500 hover:text-sky-600" title="FotoÄŸrafÄ± GÃ¶rÃ¼ntÃ¼le" aria-label="FotoÄŸrafÄ± GÃ¶rÃ¼ntÃ¼le">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-sky-500 hover:text-sky-600"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="9" cy="9" r="2"></circle><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
                        </a>` : 
                        `<span class="text-slate-600" title="FotoÄŸraf Yok">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="9" cy="9" r="2"></circle><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
                        </span>`;
                    
                    return `<tr class="border-b border-slate-200 ${rowClass}">
                        <td class="px-4 py-4 text-slate-700">${sanitizeHTML(p.model)}</td>
                        <td class="px-4 py-4 text-slate-500">${sanitizeHTML(p.imei)}</td>
                        <td class="px-4 py-4">${detailsHtml}</td>
                        <td class="px-4 py-4 font-bold ${p.potentialProfit>=0?'text-green-600':'text-red-600'}">${formatCurrency(p.potentialProfit, 'TRY')}</td>
                        <td class="px-4 py-4 text-slate-600">${p.daysInStock} gÃ¼n</td>
                        <td class="px-2 py-4 text-center">${photoHtml}</td>
                        <td class="px-4 py-4 text-center">
                            <div class="flex items-center justify-center space-x-2">
                                <button data-id="${p.id}" class="btn btn-success sell-btn !p-2 !text-xs" title="Sat" aria-label="CihazÄ± Sat">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="8" cy="21" r="1"/><circle cx="19" cy="21" r="1"/><path d="M2.05 2.05h2l2.66 12.42a2 2 0 0 0 2 1.58h9.78a2 2 0 0 0 1.95-1.57l1.65-7.43H5.16"/></svg>
                                </button>
                                <button data-id="${p.id}" class="edit-phone-btn p-2 text-slate-400 hover:text-sky-500" title="DÃ¼zenle" aria-label="CihazÄ± DÃ¼zenle">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg>
                                </button>
                                <button data-id="${p.id}" data-name="${p.model}" class="delete-phone-btn p-2 text-slate-400 hover:text-red-500" title="Sil" aria-label="CihazÄ± Sil">
                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/></svg>
                                </button>
                            </div>
                        </td>
                    </tr>`;
                }).join(''); 
            }

            const totalStockCost = phones.reduce((sum,p)=>sum+getSafeFloat(p.purchasePrice),0); 
            const totalStockValue = phones.reduce((sum,p)=>sum+getSafeFloat(p.sellingPrice),0); 
            
            el.stockCount.textContent = phones.length; 
            el.stockCost.textContent = `${formatCurrency(totalStockCost, 'TRY')}`; 
            el.stockValue.textContent = `${formatCurrency(totalStockValue, 'TRY')}`; 
            el.stockProfit.textContent = `${formatCurrency(totalStockValue - totalStockCost, 'TRY')}`;
        }
        
        function renderServiceDeliveryList(searchTerm = '') { 
            const lowerCaseSearchTerm = searchTerm.toLowerCase(); 
            const filteredServices = services.filter(s => 
                s.status !== serviceStatuses.DELIVERED.label && 
                (s.customerName.toLowerCase().includes(lowerCaseSearchTerm) || s.deviceName.toLowerCase().includes(lowerCaseSearchTerm))
            ); 
            
            if(filteredServices.length === 0){
                el.serviceDeliveryList.innerHTML=`<p class="text-center text-slate-500 p-4">Teslim edilecek cihaz bulunamadÄ±.</p>`;
                return;
            } 
            
            el.serviceDeliveryList.innerHTML = filteredServices.map(s => {
                 const statusOptions = Object.values(serviceStatuses)
                                            .filter(status => status.label !== serviceStatuses.DELIVERED.label) // Exclude Delivered
                                            .map(status => `<option value="${status.label}" ${s.status===status.label?'selected':''}>${status.label}</option>`)
                                            .join('');

                return `<div class="p-3 border-b border-slate-200 grid grid-cols-3 gap-4 items-center hover:bg-slate-100">
                    <div>
                        <p class="font-semibold text-slate-700">${sanitizeHTML(s.customerName)}</p>
                        <p class="text-xs text-slate-500">${sanitizeHTML(s.deviceName)}</p>
                    </div>
                    <select data-id="${s.id}" class="delivery-status-select input-field !p-1.5 !text-xs">
                        ${statusOptions}
                    </select>
                    <button data-id="${s.id}" class="btn deliver-service-btn !py-1.5 !px-2 !text-xs ${s.status===serviceStatuses.READY.label?'btn-success':'btn-disabled'}" ${s.status!==serviceStatuses.READY.label?'disabled':''}>Teslim Et</button>
                </div>`;
            }).join(''); 
        }
        
        function renderStockSellList(searchTerm = '') { 
            const lowerCaseSearchTerm = searchTerm.toLowerCase(); 
            const filteredPhones = phones.filter(p => 
                p.model.toLowerCase().includes(lowerCaseSearchTerm) || p.imei.toLowerCase().includes(lowerCaseSearchTerm)
            ); 
            
            if(filteredPhones.length === 0){
                el.stockSellList.innerHTML=`<p class="text-center text-slate-500 p-4">Stokta cihaz bulunamadÄ±.</p>`;
                return;
            } 
            
            el.stockSellList.innerHTML = filteredPhones.map(p => 
                `<div class="p-3 border-b border-slate-200 flex justify-between items-center hover:bg-slate-100">
                    <div>
                        <p class="font-semibold text-slate-700">${sanitizeHTML(p.model)} - ${sanitizeHTML(p.specs)}</p>
                        <p class="text-sm text-slate-500">IMEI: ${sanitizeHTML(p.imei)} | Fiyat: ${formatCurrency(p.sellingPrice, 'TRY')}</p>
                    </div>
                    <button data-id="${p.id}" class="btn btn-primary select-phone-btn !py-1 !px-3 !text-sm">SeÃ§</button>
                </div>`
            ).join(''); 
        }
        
        function renderWholesalerList() {
            if (wholesalers.length === 0) {
                el.wholesalerListContainer.innerHTML = `<div class="col-span-full text-center p-8 bg-slate-50 rounded-lg border border-slate-200"><p class="text-slate-500">HenÃ¼z toptancÄ± eklenmemiÅŸ.</p></div>`;
                return;
            }
            el.wholesalerListContainer.innerHTML = wholesalers.map(w => {
                // Calculate balance based on transactions for this wholesaler
                const balance = transactions
                    .filter(t => t.wholesalerName === w.name)
                    .reduce((bal, t) => {
                        if (t.type === 'debt') return bal + getSafeFloat(t.amount);
                        if (t.type === 'payment') return bal - getSafeFloat(t.amount);
                        return bal;
                    }, 0);

                return `<div class="card transform hover:shadow-xl hover:-translate-y-1 transition-all !bg-white/80 backdrop-blur-sm">
                    <h3 class="font-bold text-lg text-slate-800 truncate">${sanitizeHTML(w.name)}</h3>
                    <div class="space-y-2">
                        <p class="text-2xl font-bold ${balance > 0 ? 'text-red-500' : 'text-green-600'}">${formatCurrency(balance, 'USD')}</p>
                    </div>
                    <p class="text-xs text-slate-500 mb-4 mt-1">Kalan BorÃ§ (USD)</p>
                    <button data-id="${w.id}" data-name="${w.name}" class="btn btn-primary w-full view-wholesaler-details-btn">Hesap DetaylarÄ±</button>
                </div>`;
            }).join('');
        }

        function renderWholesalerDetail(wInfo) {
            currentWholesalerDetail = wInfo; // Store current detail view info
            const wholesaler = wholesalers.find(w => w.id === wInfo.id);
            if (!wholesaler) {
                // If wholesaler not found (maybe deleted), go back to list
                el.wholesalerListView.classList.remove('hidden');
                el.wholesalerDetailView.classList.add('hidden');
                currentWholesalerDetail = { id: null, name: null };
                showToast("ToptancÄ± bulunamadÄ±.", "error");
                return;
            }
            el.detailWholesalerName.textContent = wholesaler.name;

            const wholesalerTransactions = transactions
                                            .filter(t => t.wholesalerName === wholesaler.name)
                                            .sort((a, b) => b.createdAt - a.createdAt); // Sort by date descending

            const balance = wholesalerTransactions.reduce((bal, t) => {
                if (t.type === 'debt') return bal + getSafeFloat(t.amount);
                if (t.type === 'payment') return bal - getSafeFloat(t.amount);
                return bal;
            }, 0);

            el.detailWholesalerBalance.innerHTML = `<p class="text-sm text-slate-500 mb-2">Toplam Kalan BorÃ§</p><p class="text-4xl font-bold ${balance > 0 ? 'text-red-500' : 'text-green-600'}">${formatCurrency(balance, 'USD')}</p>`;
            
            if (wholesalerTransactions.length === 0) {
                el.transactionHistory.innerHTML = `<tr><td colspan="4" class="text-center p-8 text-slate-500">HenÃ¼z iÅŸlem yapÄ±lmamÄ±ÅŸ.</td></tr>`;
            } else {
                el.transactionHistory.innerHTML = wholesalerTransactions.map(t => {
                    let amountHtml, rowName;
                    if (t.type === 'debt') {
                        amountHtml = `<span class="font-medium text-red-500">+ ${formatCurrency(t.amount, 'USD')}</span>`;
                        rowName = `${formatCurrency(t.amount, 'USD')} BorÃ§`;
                    } else { // type === 'payment'
                        amountHtml = `<div class="text-right"><span class="font-medium text-green-600">- ${formatCurrency(t.paymentAmount, 'TRY')}</span><p class="text-xs text-slate-500">(${formatCurrency(t.amount, 'USD')} @ ${getSafeFloat(t.exchangeRateUsed).toFixed(2)})</p></div>`;
                        rowName = `${formatCurrency(t.paymentAmount, 'TRY')} Ã–deme`;
                    }
                    return `<tr class="border-b border-slate-200">
                        <td class="px-4 py-4 text-slate-600">${t.createdAt.toLocaleDateString('tr-TR', {day:'2-digit', month:'2-digit', year:'numeric'})}</td>
                        <td class="px-4 py-4 text-slate-700">${sanitizeHTML(t.description)}</td>
                        <td class="px-4 py-4 text-right">${amountHtml}</td>
                        <td class="px-4 py-4 text-center"><button data-id="${t.id}" data-name="${rowName}" class="delete-transaction-btn text-slate-400 hover:text-red-500 p-1" title="Sil" aria-label="Ä°ÅŸlemi Sil"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/></svg></button></td>
                    </tr>`;
                }).join('');
            }
            el.wholesalerListView.classList.add('hidden');
            el.wholesalerDetailView.classList.remove('hidden');
        }

        function renderShopShortagesLog() {
            if (!el.shortagesLog) return;
            if (shopShortages.length === 0) {
                el.shortagesLog.innerHTML = `<tr><td colspan="5" class="text-center p-8 text-slate-500">Eksik Ã¼rÃ¼n bulunmuyor.</td></tr>`;
                return;
            }
            // Sort shortages alphabetically by name
            const sortedShortages = [...shopShortages].sort((a,b) => a.name.localeCompare(b.name, 'tr', { sensitivity: 'base' }));

            el.shortagesLog.innerHTML = sortedShortages.map(item => {
                const priceTL = getSafeFloat(item.priceTL);
                const priceUSD = getSafeFloat(item.priceUSD);
                
                return `
                <tr class="hover:bg-slate-100/60 transition-colors duration-150">
                    <td class="px-6 py-4 whitespace-nowrap font-medium text-slate-800">${sanitizeHTML(item.name)}</td>
                    <td class="px-6 py-4 text-center">
                        <span class="inline-flex items-center justify-center bg-sky-100 text-sky-700 text-xs font-bold px-3 py-1.5 rounded-full shadow-sm min-w-[30px]">
                            ${item.quantity}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <span class="text-slate-700 font-medium">
                            ${priceTL > 0 ? formatCurrency(priceTL, 'TL') : '-'}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <span class="text-slate-700 font-medium">
                            ${priceUSD > 0 ? formatCurrency(priceUSD, 'USD') : '-'}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <button data-id="${item.id}" data-name="${sanitizeHTML(item.name)}" class="delete-shortage-btn text-red-500 hover:text-red-400 p-1.5 rounded-md hover:bg-red-700/20 transition-all" title="Sil" aria-label="EksiÄŸi Sil">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="w-5 h-5"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="m5 6 1 0-1 0V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v2"/></svg>
                        </button>
                    </td>
                </tr>
            `;
            }).join('');
        }
        
        function renderProductPricesLog() {
            if (!el.productPricesLog) return;
            const searchTerm = el.productPriceSearchInput.value.toLowerCase();
            const filteredPrices = productPrices.filter(p => p.name.toLowerCase().includes(searchTerm));

            if (filteredPrices.length === 0) {
                el.productPricesLog.innerHTML = `<tr><td colspan="4" class="text-center p-8 text-slate-500">KayÄ±tlÄ± Ã¼rÃ¼n fiyatÄ± bulunmuyor.</td></tr>`;
                return;
            }

            // Renkli satÄ±r alternatifleri
            const colorClasses = [
                'bg-gradient-to-r from-blue-50 to-blue-100 border-l-4 border-blue-400',
                'bg-gradient-to-r from-emerald-50 to-emerald-100 border-l-4 border-emerald-400', 
                'bg-gradient-to-r from-purple-50 to-purple-100 border-l-4 border-purple-400',
                'bg-gradient-to-r from-amber-50 to-amber-100 border-l-4 border-amber-400',
                'bg-gradient-to-r from-rose-50 to-rose-100 border-l-4 border-rose-400',
                'bg-gradient-to-r from-cyan-50 to-cyan-100 border-l-4 border-cyan-400',
                'bg-gradient-to-r from-indigo-50 to-indigo-100 border-l-4 border-indigo-400',
                'bg-gradient-to-r from-orange-50 to-orange-100 border-l-4 border-orange-400'
            ];

            el.productPricesLog.innerHTML = filteredPrices.map((item, index) => {
                // Ã‡ift para birimi desteÄŸi
                const costTRY = item.currency === 'USD' ? (item.cost * currentUsdRate) : item.cost;
                const costUSD = item.currency === 'USD' ? item.cost : (item.cost / currentUsdRate);
                
                // Her satÄ±r iÃ§in farklÄ± renk seÃ§
                const colorClass = colorClasses[index % colorClasses.length];
                
                return `
                    <tr class="hover:scale-[1.02] transition-all duration-200 ${colorClass} shadow-sm">
                        <td class="px-4 py-4 whitespace-nowrap">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 bg-gradient-to-r from-slate-600 to-slate-700 rounded-full flex items-center justify-center text-white text-xs font-bold shadow-lg">
                                    ${index + 1}
                                </div>
                                <span class="font-bold text-slate-800 text-lg">${sanitizeHTML(item.name)}</span>
                            </div>
                        </td>
                        <td class="px-4 py-4 text-right">
                            <div class="font-bold text-xl text-slate-800">${formatCurrency(costTRY, 'TRY')}</div>
                            ${item.currency === 'USD' ? '<span class="text-xs text-slate-600 bg-blue-100 px-2 py-1 rounded-full">(USD\'den Ã§evrildi)</span>' : '<span class="text-xs text-emerald-600 bg-emerald-100 px-2 py-1 rounded-full">Orijinal TL</span>'}
                        </td>
                        <td class="px-4 py-4 text-right">
                            <div class="font-bold text-xl text-slate-800">${formatCurrency(costUSD, 'USD')}</div>
                            ${item.currency === 'TRY' ? '<span class="text-xs text-slate-600 bg-blue-100 px-2 py-1 rounded-full">(TL\'den Ã§evrildi)</span>' : '<span class="text-xs text-emerald-600 bg-emerald-100 px-2 py-1 rounded-full">Orijinal USD</span>'}
                        </td>
                        <td class="px-4 py-4 text-center">
                            <div class="flex items-center justify-center space-x-2">
                                <button data-id="${item.id}" class="edit-product-price-btn p-2 bg-white/70 hover:bg-blue-200 text-blue-600 hover:text-blue-800 rounded-lg transition-all duration-200 hover:scale-110 shadow-md" title="DÃ¼zenle">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></svg>
                                </button>
                                <button data-id="${item.id}" data-name="${sanitizeHTML(item.name)}" class="delete-product-price-btn p-2 bg-white/70 hover:bg-red-200 text-red-600 hover:text-red-800 rounded-lg transition-all duration-200 hover:scale-110 shadow-md" title="Sil">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="m5 6 1 0-1 0V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v2"/></svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Real-time fiyat dÃ¶nÃ¼ÅŸÃ¼m fonksiyonu
        function updateProductPriceConversion() {
            if (!el.productPriceCost || !el.productPriceCurrency || !el.productPriceConversion) return;
            
            const amount = parseFloat(el.productPriceCost.value);
            const currency = el.productPriceCurrency.value;
            
            if (isNaN(amount) || amount <= 0) {
                el.productPriceConversion.innerHTML = '';
                return;
            }
            
            let conversionText = '';
            if (currency === 'TRY') {
                const usdAmount = amount / currentUsdRate;
                conversionText = `
                    <div class="flex items-center text-slate-600">
                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4V2a1 1 0 011-1h8a1 1 0 011 1v2m-9 4h10m-10 0V6a1 1 0 011-1h8a1 1 0 011 1v2m-10 0v12a1 1 0 001 1h8a1 1 0 001 1V8"></path>
                        </svg>
                        â‰ˆ ${formatCurrency(usdAmount, 'USD')} (GÃ¼ncel kur: ${currentUsdRate.toFixed(2)})
                    </div>
                `;
            } else {
                const tryAmount = amount * currentUsdRate;
                conversionText = `
                    <div class="flex items-center text-slate-600">
                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 4V2a1 1 0 011-1h8a1 1 0 011 1v2m-9 4h10m-10 0V6a1 1 0 011-1h8a1 1 0 011 1v2m-10 0v12a1 1 0 001 1h8a1 1 0 001 1V8"></path>
                        </svg>
                        â‰ˆ ${formatCurrency(tryAmount, 'TRY')} (GÃ¼ncel kur: ${currentUsdRate.toFixed(2)})
                    </div>
                `;
            }
            
            el.productPriceConversion.innerHTML = conversionText;
        }

        function findProductPrice(name) {
            return productPrices.find(p => p.name.toLowerCase() === name.toLowerCase());
        }

        // ===== GEÃ‡MÄ°Åž Ä°ÅžLEMLER YÃ–NETÄ°MÄ° =====
        
        function filterAndRenderSalesHistory() {
            // Show loading state
            if (el.salesHistoryLog) {
                el.salesHistoryLog.innerHTML = `<tr><td colspan="8" class="text-center p-8 text-slate-500">
                    <div class="flex items-center justify-center">
                        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-slate-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        YÃ¼kleniyor...
                    </div>
                </td></tr>`;
            }
            
            // Use setTimeout to prevent UI blocking
            setTimeout(() => {
                if (!allSales.length) {
                    el.salesHistoryLog.innerHTML = `<tr><td colspan="8" class="text-center p-8 text-slate-500">HenÃ¼z satÄ±ÅŸ iÅŸlemi bulunmuyor.</td></tr>`;
                    updateHistoryStats([], 0, 0, 0);
                    return;
                }

                const startDate = el.historyStartDate?.value ? new Date(el.historyStartDate.value) : null;
                const endDate = el.historyEndDate?.value ? new Date(el.historyEndDate.value + 'T23:59:59') : null;
                const typeFilter = el.historyTypeFilter?.value || 'all';
                const searchTerm = el.historySearchInput?.value?.toLowerCase() || '';

                filteredHistorySales = allSales.filter(sale => {
                    // Date filter
                    if (startDate && sale.date < startDate) return false;
                    if (endDate && sale.date > endDate) return false;
                    
                    // Type filter
                    if (typeFilter !== 'all' && sale.type !== typeFilter) return false;
                    
                    // Search filter - search in multiple fields
                    if (searchTerm && !(
                        sale.productName?.toLowerCase().includes(searchTerm) ||
                        sale.type?.toLowerCase().includes(searchTerm) ||
                        sale.customerName?.toLowerCase().includes(searchTerm)
                    )) return false;
                    
                    return true;
                });

                // Calculate stats
                const totalCount = filteredHistorySales.length;
                const totalRevenue = filteredHistorySales.reduce((sum, sale) => sum + getSafeFloat(sale.totalRevenue), 0);
                const totalCost = filteredHistorySales.reduce((sum, sale) => sum + getSafeFloat(sale.totalCost), 0);
                const totalProfit = totalRevenue - totalCost;

                updateHistoryStats(filteredHistorySales, totalCount, totalRevenue, totalCost, totalProfit);
                renderHistoryPage(1); // Reset to first page
            }, 50);
        }

        function updateHistoryStats(sales, count, revenue, cost, profit) {
            if (!el.historyTotalCount) return;
            
            el.historyTotalCount.textContent = count.toString();
            el.historyTotalRevenue.textContent = formatCurrency(revenue, 'TRY');
            el.historyTotalCost.textContent = formatCurrency(cost, 'TRY');
            el.historyTotalProfit.textContent = formatCurrency(profit, 'TRY');
            el.historyTotalProfit.className = `text-2xl font-bold ${profit >= 0 ? 'text-purple-700' : 'text-red-700'}`;
        }

        function renderHistoryPage(page) {
            if (!filteredHistorySales || filteredHistorySales.length === 0) {
                el.salesHistoryLog.innerHTML = `<tr><td colspan="8" class="text-center p-8 text-slate-500">SeÃ§ilen kriterlere uygun iÅŸlem bulunamadÄ±.</td></tr>`;
                updatePaginationInfo(0, 0, 0);
                return;
            }

            currentHistoryPage = page;
            const startIndex = (page - 1) * historyItemsPerPage;
            const endIndex = startIndex + historyItemsPerPage;
            const pageItems = filteredHistorySales.slice(startIndex, endIndex);

            const typeMap = {
                device: { text: 'Cihaz SatÄ±ÅŸ', color: 'badge-blue', icon: 'ðŸ“±' },
                service: { text: 'Servis', color: 'badge-yellow', icon: 'ðŸ”§' },
                accessory: { text: 'Aksesuar', color: 'badge-green', icon: 'ðŸŽ§' }
            };

            el.salesHistoryLog.innerHTML = pageItems.map((sale, index) => {
                const globalIndex = startIndex + index + 1;
                const typeInfo = typeMap[sale.type] || { text: 'DiÄŸer', color: 'badge-gray', icon: 'ðŸ›’' };
                const profit = getSafeFloat(sale.totalProfit);
                
                return `<tr class="border-b border-slate-200 hover:bg-slate-50">
                    <td class="px-4 py-4 text-center text-slate-500 font-medium">${globalIndex}</td>
                    <td class="px-4 py-4 text-sm">
                        <div class="flex flex-col">
                            <span class="text-slate-800">${sale.date.toLocaleDateString('tr-TR')}</span>
                            <span class="text-slate-500">${sale.date.toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'})}</span>
                        </div>
                    </td>
                    <td class="px-4 py-4">
                        <span class="status-badge ${typeInfo.color} !font-semibold !text-xs">
                            ${typeInfo.icon} ${typeInfo.text}
                        </span>
                    </td>
                    <td class="px-4 py-4 font-medium text-slate-800">
                        ${sanitizeHTML(sale.productName)}
                        ${sale.quantity > 1 ? `<span class="text-slate-500 text-sm">(${sale.quantity} Adet)</span>` : ''}
                        ${sale.source ? `<div class="text-xs text-slate-500 mt-1">Kaynak: ${sale.source}</div>` : ''}
                    </td>
                    <td class="px-4 py-4 text-right font-semibold text-green-700">${formatCurrency(sale.totalRevenue, 'TRY')}</td>
                    <td class="px-4 py-4 text-right font-semibold text-red-600">${formatCurrency(sale.totalCost, 'TRY')}</td>
                    <td class="px-4 py-4 text-right font-bold ${profit >= 0 ? 'text-green-600' : 'text-red-600'}">${formatCurrency(profit, 'TRY')}</td>
                    <td class="px-4 py-4">
                        <div class="flex items-center justify-center space-x-1">
                            <button data-id="${sale.id}" class="edit-sale-btn inline-flex items-center justify-center w-8 h-8 rounded-md bg-blue-50 text-blue-600 hover:bg-blue-100 hover:text-blue-700 transition-colors duration-200 border border-blue-200" title="Ä°ÅŸlemi DÃ¼zenle" aria-label="SatÄ±ÅŸ Ä°ÅŸlemini DÃ¼zenle">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></svg>
                            </button>
                            <button data-id="${sale.id}" data-name="${sale.productName}" class="delete-sale-btn inline-flex items-center justify-center w-8 h-8 rounded-md bg-red-50 text-red-600 hover:bg-red-100 hover:text-red-700 transition-colors duration-200 border border-red-200" title="Ä°ÅŸlemi Sil" aria-label="SatÄ±ÅŸ Ä°ÅŸlemini Sil">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/><path d="M10 11v6"/><path d="M14 11v6"/><path d="m5 6 1 0-1 0V4a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v2"/></svg>
                            </button>
                        </div>
                    </td>
                </tr>`;
            }).join('');

            const totalPages = Math.ceil(filteredHistorySales.length / historyItemsPerPage);
            updatePaginationInfo(page, totalPages, filteredHistorySales.length);
        }

        function updatePaginationInfo(currentPage, totalPages, totalItems) {
            if (!el.paginationInfo) return;
            
            if (totalItems === 0) {
                el.paginationInfo.textContent = 'GÃ¶sterilen iÅŸlem yok';
                el.prevHistoryPage.disabled = true;
                el.nextHistoryPage.disabled = true;
                return;
            }

            const startItem = (currentPage - 1) * historyItemsPerPage + 1;
            const endItem = Math.min(currentPage * historyItemsPerPage, totalItems);
            
            el.paginationInfo.textContent = `${startItem}-${endItem} / ${totalItems} iÅŸlem (Sayfa ${currentPage}/${totalPages})`;
            
            el.prevHistoryPage.disabled = currentPage <= 1;
            el.nextHistoryPage.disabled = currentPage >= totalPages;
        }

        function renderCashAdvancesLog() {
            if (!el.cashAdvancesLog) return;
            
            const searchTerm = el.cashAdvanceSearchInput ? el.cashAdvanceSearchInput.value.toLowerCase() : '';
            const selectedPerson = el.cashAdvancePersonFilter ? el.cashAdvancePersonFilter.value : '';
            const selectedDate = el.cashAdvanceDateFilter ? el.cashAdvanceDateFilter.value : '';
            
            // Filter advances based on search and filters
            let filteredAdvances = cashAdvances.filter(advance => {
                const matchesSearch = advance.personName.toLowerCase().includes(searchTerm) ||
                                    (advance.description && advance.description.toLowerCase().includes(searchTerm));
                const matchesPerson = !selectedPerson || advance.personName === selectedPerson;
                
                let matchesDate = true;
                if (selectedDate) {
                    const advanceDate = advance.date instanceof Date ? advance.date : new Date(advance.date);
                    const filterDate = new Date(selectedDate);
                    matchesDate = advanceDate.toDateString() === filterDate.toDateString();
                }
                
                return matchesSearch && matchesPerson && matchesDate;
            });

            // Sort advances by last advance date (newest first)
            filteredAdvances.sort((a, b) => {
                const dateA = a.lastAdvanceDate ? 
                    (a.lastAdvanceDate instanceof Date ? a.lastAdvanceDate : new Date(a.lastAdvanceDate)) :
                    (a.date instanceof Date ? a.date : new Date(a.date));
                const dateB = b.lastAdvanceDate ? 
                    (b.lastAdvanceDate instanceof Date ? b.lastAdvanceDate : new Date(b.lastAdvanceDate)) :
                    (b.date instanceof Date ? b.date : new Date(b.date));
                return dateB - dateA; // Newest first
            });
            
            // Update statistics
            updateCashAdvancesStats();
            
            // Update person filter dropdown
            updatePersonFilter();
            
            // Update person advances summary
            renderPersonAdvancesSummary();
            
            if (filteredAdvances.length === 0) {
                el.cashAdvancesLog.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center p-8 text-slate-500">
                            ${searchTerm || selectedPerson ? 'Arama kriterlerinize uygun avans kaydÄ± bulunamadÄ±.' : 'Avans kaydÄ± bulunmuyor.'}
                        </td>
                    </tr>
                `;
                return;
            }
            
            el.cashAdvancesLog.innerHTML = filteredAdvances.map((advance, index) => {
                // Yeni sistem: totalAmount ve lastAdvanceDate kullan, eski sistem uyumluluÄŸu iÃ§in fallback'ler
                const lastDate = advance.lastAdvanceDate ? 
                    (advance.lastAdvanceDate instanceof Date ? advance.lastAdvanceDate : new Date(advance.lastAdvanceDate)) :
                    (advance.date instanceof Date ? advance.date : new Date(advance.date));
                const formattedDate = lastDate.toLocaleDateString('tr-TR');
                
                const totalAmount = advance.totalAmount || advance.amount || 0;
                const advanceCount = advance.advanceCount || 1;
                const lastDescription = advance.lastAdvanceDescription || advance.description || 'Avans';
                
                return `
                    <tr class="hover:bg-slate-50 transition-colors duration-150">
                        <td class="px-2 py-3 sm:px-4 sm:py-4">
                            <div class="text-sm text-slate-600">${formattedDate}</div>
                            <div class="text-xs text-slate-400">Son avans</div>
                        </td>
                        <td class="px-2 py-3 sm:px-4 sm:py-4">
                            <div class="font-medium text-slate-800 cursor-pointer hover:text-blue-600 transition-colors add-advance-to-person" 
                                 data-person-name="${sanitizeHTML(advance.personName)}"
                                 title="Bu kiÅŸi iÃ§in yeni avans ekle">
                                ${sanitizeHTML(advance.personName)} 
                                <span class="text-blue-500 ml-1 add-advance-to-person" data-person-name="${sanitizeHTML(advance.personName)}">âž•</span>
                            </div>
                            <div class="text-xs text-slate-500">${advanceCount} kez avans aldÄ±</div>
                        </td>
                        <td class="px-2 py-3 sm:px-4 sm:py-4">
                            <div class="text-sm text-slate-600 max-w-xs">${sanitizeHTML(lastDescription)}</div>
                            <div class="text-xs text-slate-400">Son iÅŸlem aÃ§Ä±klamasÄ±</div>
                        </td>
                        <td class="px-2 py-3 sm:px-4 sm:py-4 text-right">
                            <div class="font-bold text-lg text-emerald-600">${formatCurrency(totalAmount, 'TL')}</div>
                            <div class="text-xs text-slate-500">Toplam avans</div>
                        </td>
                        <td class="px-2 py-3 sm:px-4 sm:py-4 text-center">
                            <div class="flex flex-col gap-1">
                                <button data-id="${advance.id}" data-name="${sanitizeHTML(advance.personName)}" 
                                        class="view-advance-history-btn text-blue-500 hover:text-blue-700 hover:bg-blue-50 p-1 rounded transition-all duration-200" 
                                        title="Avans GeÃ§miÅŸini GÃ¶r">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/>
                                        <circle cx="12" cy="12" r="3"/>
                                    </svg>
                                </button>
                                <button data-id="${advance.id}" data-name="${sanitizeHTML(advance.personName)}" 
                                        class="delete-cash-advance-btn text-red-500 hover:text-red-700 hover:bg-red-50 p-1 rounded transition-all duration-200" 
                                        title="TÃ¼m Avans KaydÄ±nÄ± Sil">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M3 6h18"/>
                                        <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/>
                                        <path d="M8 6V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                        <line x1="10" y1="11" x2="10" y2="17"/>
                                        <line x1="14" y1="11" x2="14" y2="17"/>
                                    </svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }
        
        function updateCashAdvancesStats() {
            if (!el.totalAdvances || !el.totalPeople || !el.totalAdvanceRecords) return;
            
            // Toplam avans tutarÄ± (yeni sistem: totalAmount, eski sistem: amount)
            const totalAmount = cashAdvances.reduce((sum, advance) => 
                sum + getSafeFloat(advance.totalAmount || advance.amount), 0);
            el.totalAdvances.textContent = formatCurrency(totalAmount, 'TL');
            
            // Avans alan benzersiz kiÅŸi sayÄ±sÄ±
            const uniquePersons = new Set(cashAdvances.map(advance => advance.personName));
            el.totalPeople.textContent = uniquePersons.size.toString();
            
            // Toplam avans verme sayÄ±sÄ± (tÃ¼m iÅŸlemler)
            const totalTransactions = cashAdvances.reduce((sum, advance) => 
                sum + (advance.advanceCount || 1), 0);
            el.totalAdvanceRecords.textContent = totalTransactions.toString();
        }
        
        function updatePersonFilter() {
            if (!el.cashAdvancePersonFilter) return;
            
            // Mevcut seÃ§ili deÄŸeri koru
            const currentValue = el.cashAdvancePersonFilter.value;
            
            // Benzersiz kiÅŸi adlarÄ±nÄ± al
            const uniquePersons = [...new Set(cashAdvances.map(advance => advance.personName))].sort();
            
            el.cashAdvancePersonFilter.innerHTML = `
                <option value="">TÃ¼m KiÅŸiler</option>
                ${uniquePersons.map(person => 
                    `<option value="${sanitizeHTML(person)}">${sanitizeHTML(person)}</option>`
                ).join('')}
            `;
            
            // Ã–nceki seÃ§imi geri yÃ¼kle
            el.cashAdvancePersonFilter.value = currentValue;
        }
        
        function renderPersonAdvancesSummary() {
            if (!el.personAdvancesSummary) return;
            
            // KiÅŸi bazlÄ± avans Ã¶zetini hesapla
            const personSummary = {};
            
            cashAdvances.forEach(advance => {
                const personName = advance.personName;
                const totalAmount = advance.totalAmount || advance.amount || 0;
                const advanceCount = advance.advanceCount || 1;
                const lastDate = advance.lastAdvanceDate ? 
                    (advance.lastAdvanceDate instanceof Date ? advance.lastAdvanceDate : new Date(advance.lastAdvanceDate)) :
                    (advance.date instanceof Date ? advance.date : new Date(advance.date));
                
                personSummary[personName] = {
                    count: advanceCount,
                    totalAmount: totalAmount,
                    lastDate: lastDate
                };
            });
            
            const sortedPersons = Object.entries(personSummary)
                .sort(([,a], [,b]) => b.totalAmount - a.totalAmount); // En Ã§ok avans alan Ã¶nce
            
            if (sortedPersons.length === 0) {
                el.personAdvancesSummary.innerHTML = `
                    <div class="col-span-full text-center p-8 text-slate-500">Avans kaydÄ± bulunmuyor.</div>
                `;
                return;
            }
            
            el.personAdvancesSummary.innerHTML = sortedPersons.map(([personName, summary]) => {
                const lastDateFormatted = summary.lastDate.toLocaleDateString('tr-TR');
                
                return `
                    <div class="bg-white border border-slate-200 rounded-lg p-4 shadow-sm hover:shadow-md transition-shadow">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-semibold text-slate-800">${sanitizeHTML(personName)}</h4>
                            <span class="bg-blue-100 text-blue-700 text-xs font-bold px-2 py-1 rounded-full">
                                ${summary.count} kez
                            </span>
                        </div>
                        <div class="flex items-center justify-between">
                            <div class="text-lg font-bold text-emerald-600">${formatCurrency(summary.totalAmount, 'TL')}</div>
                            <div class="text-sm text-slate-500">Son: ${lastDateFormatted}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        async function showAdvanceHistory(advanceId, personName) {
            try {
                // Modal baÅŸlÄ±ÄŸÄ±nÄ± ayarla
                el.historyPersonName.textContent = personName;
                
                // YÃ¼kleme gÃ¶stergesi
                el.advanceHistoryContent.innerHTML = `
                    <div class="text-center p-8">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-500 mx-auto mb-4"></div>
                        <p class="text-slate-500">Avans geÃ§miÅŸi yÃ¼kleniyor...</p>
                    </div>
                `;
                
                // Modal'Ä± aÃ§
                openModal(el.advanceHistoryModal);
                
                // Avans geÃ§miÅŸini Ã§ek - orderBy kaldÄ±rÄ±larak index sorunu giderildi
                const historyQuery = query(
                    collection(db, getPath('cashAdvanceHistory')), 
                    where('parentAdvanceId', '==', advanceId)
                );
                const historySnapshot = await getDocs(historyQuery);
                const history = historySnapshot.docs
                    .map(doc => ({ id: doc.id, ...doc.data() }))
                    .sort((a, b) => {
                        // JavaScript'te manuel sÄ±ralama
                        const aTime = a.createdAt instanceof Timestamp ? a.createdAt.toDate() : new Date(a.createdAt);
                        const bTime = b.createdAt instanceof Timestamp ? b.createdAt.toDate() : new Date(b.createdAt);
                        return bTime - aTime; // En yeniden eskiye doÄŸru
                    });
                
                if (history.length === 0) {
                    // Avans geÃ§miÅŸi yoksa ana kayÄ±ttan bilgi gÃ¶ster
                    const mainAdvanceDoc = await getDoc(doc(db, getPath(`cashAdvances/${advanceId}`)));
                    if (mainAdvanceDoc.exists()) {
                        const mainData = mainAdvanceDoc.data();
                        el.advanceHistoryContent.innerHTML = `
                            <div class="border border-slate-200 rounded-lg p-4 bg-blue-50">
                                <div class="flex items-center space-x-3 mb-3">
                                    <div class="flex-shrink-0 w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                        <span class="text-blue-600 font-bold text-sm">1</span>
                                    </div>
                                    <div>
                                        <div class="font-bold text-lg text-blue-600">
                                            ${formatCurrency(mainData.totalAmount || mainData.amount || 0, 'TL')}
                                        </div>
                                        <div class="text-sm text-slate-600">
                                            ${sanitizeHTML((mainData.lastAdvanceDescription || mainData.description) || 'Ana avans kaydÄ±')}
                                        </div>
                                    </div>
                                </div>
                                <div class="text-sm text-slate-600 mb-2">
                                    <strong>Son Avans Tarihi:</strong> ${mainData.lastAdvanceDate ? 
                                        new Date(mainData.lastAdvanceDate).toLocaleDateString('tr-TR') : 
                                        (mainData.date ? new Date(mainData.date).toLocaleDateString('tr-TR') : 'Bilinmiyor')
                                    }
                                </div>
                                <div class="text-xs text-slate-500 bg-blue-100 p-2 rounded">
                                    â„¹ï¸ Bu kayÄ±t detaylÄ± geÃ§miÅŸ sistemi Ã¶ncesinde oluÅŸturulmuÅŸ. Yeni avans eklendiÄŸinde detaylÄ± geÃ§miÅŸ tutulacak.
                                </div>
                            </div>
                        `;
                        el.historyTotalAmount.textContent = formatCurrency(mainData.totalAmount || mainData.amount || 0, 'TL');
                        el.historyTotalCount.textContent = `${mainData.advanceCount || 1} iÅŸlem`;
                    } else {
                        el.advanceHistoryContent.innerHTML = `
                            <div class="text-center p-8">
                                <svg class="w-12 h-12 mx-auto text-slate-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                                </svg>
                                <p class="text-slate-500">HenÃ¼z avans geÃ§miÅŸi bulunmuyor.</p>
                                <p class="text-sm text-slate-400 mt-2">Bu kiÅŸi iÃ§in henÃ¼z detaylÄ± avans kaydÄ± oluÅŸturulmamÄ±ÅŸ.</p>
                            </div>
                        `;
                        el.historyTotalAmount.textContent = 'â‚º0.00';
                        el.historyTotalCount.textContent = '0 iÅŸlem';
                    }
                } else {
                    // GeÃ§miÅŸi render et
                    el.advanceHistoryContent.innerHTML = history.map((item, index) => {
                        const date = item.date instanceof Date ? item.date : new Date(item.date);
                        const createdAt = item.createdAt instanceof Timestamp ? 
                            item.createdAt.toDate() : new Date(item.createdAt);
                        
                        return `
                            <div class="border border-slate-200 rounded-lg p-4 bg-white hover:bg-slate-50 transition-colors">
                                <div class="flex justify-between items-start mb-3">
                                    <div class="flex items-center space-x-3">
                                        <div class="flex-shrink-0 w-8 h-8 bg-emerald-100 rounded-full flex items-center justify-center">
                                            <span class="text-emerald-600 font-bold text-sm">${index + 1}</span>
                                        </div>
                                        <div>
                                            <div class="font-bold text-lg text-emerald-600">
                                                ${formatCurrency(item.amount, 'TL')}
                                            </div>
                                            <div class="text-sm text-slate-600">
                                                ${sanitizeHTML(item.description || 'Avans')}
                                            </div>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <div class="text-sm font-medium text-slate-700">
                                            ${date.toLocaleDateString('tr-TR')}
                                        </div>
                                        <div class="text-xs text-slate-500">
                                            ${date.toLocaleDateString('tr-TR', { weekday: 'long' })}
                                        </div>
                                    </div>
                                </div>
                                <div class="text-xs text-slate-400 border-t border-slate-100 pt-2">
                                    <div class="flex items-center">
                                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                        </svg>
                                        Kaydedilme: ${createdAt.toLocaleDateString('tr-TR')} ${createdAt.toLocaleTimeString('tr-TR', { hour: '2-digit', minute: '2-digit' })}
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    // Toplam bilgileri hesapla ve gÃ¶ster
                    const totalAdvance = history.reduce((sum, item) => sum + getSafeFloat(item.amount), 0);
                    el.historyTotalAmount.textContent = formatCurrency(totalAdvance, 'TL');
                    el.historyTotalCount.textContent = `${history.length} iÅŸlem`;
                }
                
            } catch (error) {
                console.error('Avans geÃ§miÅŸi yÃ¼klenirken hata:', error);
                el.advanceHistoryContent.innerHTML = `
                    <div class="text-center p-8">
                        <svg class="w-12 h-12 mx-auto text-red-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                        </svg>
                        <p class="text-red-600 font-semibold">Avans geÃ§miÅŸi yÃ¼klenirken hata oluÅŸtu</p>
                        <p class="text-sm text-slate-500 mt-2">${error.message}</p>
                    </div>
                `;
                showToast('Avans geÃ§miÅŸi yÃ¼klenirken hata oluÅŸtu.', 'error');
            }
        }

        // Settings Panel Functions
        
        function updateLastRateInfo() {
            const lastUpdateInfoElement = document.getElementById('lastUpdateInfo');
            if (!lastUpdateInfoElement) return;
            
            const savedSettings = JSON.parse(localStorage.getItem('teknoHesapSettings') || '{}');
            
            if (savedSettings.lastRateUpdate) {
                const updateDate = new Date(savedSettings.lastRateUpdate);
                const now = new Date();
                const timeDiff = now - updateDate;
                const hours = Math.floor(timeDiff / (1000 * 60 * 60));
                const minutes = Math.floor((timeDiff % (1000 * 60 * 60)) / (1000 * 60));
                
                let timeText = '';
                if (hours > 24) {
                    const days = Math.floor(hours / 24);
                    timeText = `${days} gÃ¼n Ã¶nce`;
                } else if (hours > 0) {
                    timeText = `${hours} saat Ã¶nce`;
                } else if (minutes > 0) {
                    timeText = `${minutes} dakika Ã¶nce`;
                } else {
                    timeText = 'Az Ã¶nce';
                }
                
                const source = savedSettings.rateSource || 'Bilinmeyen';
                const isManual = savedSettings.isManualRate ? ' (Manuel)' : '';
                
                lastUpdateInfoElement.innerHTML = `
                    <div class="flex items-center text-xs text-slate-500">
                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Son gÃ¼ncelleme: ${timeText}
                        <br>Kaynak: ${source}${isManual}
                    </div>
                `;
            } else {
                lastUpdateInfoElement.innerHTML = `
                    <div class="text-xs text-slate-400">
                        HenÃ¼z gÃ¼ncelleme yapÄ±lmamÄ±ÅŸ
                    </div>
                `;
            }
        }

        function saveSettings() {
            const settings = {
                businessName: el.businessName?.value || '',
                businessPhone: el.businessPhone?.value || '',
                businessAddress: el.businessAddress?.value || '',
                defaultCurrency: el.defaultCurrency?.value || 'TRY',
                taxRate: el.taxRate?.value || '20',
                autoBackup: el.autoBackup?.value || 'weekly',
                lowStockAlert: el.lowStockAlert?.value || '5',
                currentEurRate: el.currentEurRate?.value || '35.20',
                autoUpdateRates: el.autoUpdateRates?.value || 'enabled',
                lastUpdated: new Date().toISOString()
            };
            
            localStorage.setItem('teknoHesapSettings', JSON.stringify(settings));
            showToast('Ayarlar baÅŸarÄ±yla kaydedildi!', 'success');
        }

        function updateExchangeRates() {
            const newUsdRate = getSafeFloat(el.currentUsdRate?.value);
            if (newUsdRate > 0) {
                currentUsdRate = newUsdRate;
                updateCurrencyConverterDisplay();
                showToast('DÃ¶viz kurlarÄ± gÃ¼ncellendi!', 'success');
            } else {
                showToast('GeÃ§erli bir USD kuru girin!', 'error');
            }
        }

        async function fetchExchangeRates() {
            try {
                showToast('GÃ¼ncel kurlar Ã§ekiliyor...', 'info');
                
                // Birden fazla Ã¼cretsiz API kaynak kullanarak gÃ¼venilirlik artÄ±rma
                let rates = null;
                
                // 1. Currency-API (Ã¼cretsiz, gÃ¼venilir, API key gerektirmez)
                try {
                    const response = await fetch('https://cdn.jsdelivr.net/npm/@fawazahmed0/currency-api@latest/v1/currencies/usd.json');
                    if (response.ok) {
                        const data = await response.json();
                        if (data.usd && data.usd.try && data.usd.eur) {
                            rates = {
                                usd: data.usd.try,
                                eur: data.usd.try / data.usd.eur, // EUR'dan TRY'ye Ã§evir
                                source: 'Currency-API (CDN)'
                            };
                        }
                    }
                } catch (e) {
                    console.warn('Currency-API hatasÄ±:', e);
                }
                
                // 2. ExchangeRate-API (Ã¼cretsiz, gÃ¼venilir)
                if (!rates) {
                    try {
                        const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                        if (response.ok) {
                            const data = await response.json();
                            if (data.rates && data.rates.TRY) {
                                rates = {
                                    usd: data.rates.TRY,
                                    eur: data.rates.EUR ? data.rates.TRY / data.rates.EUR : data.rates.TRY / 1.1,
                                    source: 'ExchangeRate-API'
                                };
                            }
                        }
                    } catch (e) {
                        console.warn('ExchangeRate-API hatasÄ±:', e);
                    }
                }
                
                // 3. FreeCurrencyAPI (Ã¼cretsiz, API key gerektirmez)
                if (!rates) {
                    try {
                        const response = await fetch('https://api.freecurrencyapi.com/v1/latest?apikey=fca_live_YOUR_KEY&currencies=TRY%2CEUR&base_currency=USD');
                        // API key olmasa da deneyebiliriz, bazÄ± API'ler sÄ±nÄ±rlÄ± eriÅŸim verir
                        if (response.ok) {
                            const data = await response.json();
                            if (data.data && data.data.TRY) {
                                rates = {
                                    usd: data.data.TRY,
                                    eur: data.data.EUR ? data.data.TRY / data.data.EUR : data.data.TRY / 1.1,
                                    source: 'FreeCurrencyAPI'
                                };
                            }
                        }
                    } catch (e) {
                        console.warn('FreeCurrencyAPI hatasÄ±:', e);
                    }
                }
                
                // 4. Backup: JSON kur servisi (alternatif API)
                if (!rates) {
                    try {
                        const response = await fetch('https://api.currencybeacon.com/v1/latest?api_key=YOUR_KEY&base=USD&symbols=TRY,EUR');
                        // Bu da baÅŸarÄ±sÄ±z olursa diÄŸerine geÃ§
                    } catch (e) {
                        console.warn('CurrencyBeacon hatasÄ±:', e);
                    }
                }
                
                // 5. TCMB (TÃ¼rkiye Cumhuriyet Merkez BankasÄ±) - Resmi kaynak
                if (!rates) {
                    try {
                        const today = new Date();
                        let dateStr = today.toISOString().split('T')[0].replace(/-/g, '');
                        
                        // EÄŸer bugÃ¼n weekend ise veya data yoksa, son iÅŸ gÃ¼nÃ¼nÃ¼ dene
                        for (let i = 0; i < 7; i++) {
                            try {
                                const testDate = new Date(today);
                                testDate.setDate(testDate.getDate() - i);
                                dateStr = testDate.toISOString().split('T')[0].replace(/-/g, '');
                                
                                const response = await fetch(`https://www.tcmb.gov.tr/kurlar/${dateStr.slice(0,6)}/${dateStr}.xml`);
                                
                                if (response.ok) {
                                    const xmlText = await response.text();
                                    const parser = new DOMParser();
                                    const xmlDoc = parser.parseFromString(xmlText, "text/xml");
                                    
                                    const usdElement = Array.from(xmlDoc.querySelectorAll('Currency')).find(currency => 
                                        currency.getAttribute('CurrencyCode') === 'USD'
                                    );
                                    const eurElement = Array.from(xmlDoc.querySelectorAll('Currency')).find(currency => 
                                        currency.getAttribute('CurrencyCode') === 'EUR'
                                    );
                                    
                                    if (usdElement && eurElement) {
                                        const usdRate = parseFloat(usdElement.querySelector('ForexSelling').textContent);
                                        const eurRate = parseFloat(eurElement.querySelector('ForexSelling').textContent);
                                        
                                        if (usdRate > 0 && eurRate > 0) {
                                            rates = {
                                                usd: usdRate,
                                                eur: eurRate,
                                                source: 'TCMB (Merkez BankasÄ±)'
                                            };
                                            break; // BaÅŸarÄ±lÄ±, dÃ¶ngÃ¼den Ã§Ä±k
                                        }
                                    }
                                }
                            } catch (tcmbError) {
                                console.warn(`TCMB ${dateStr} hatasÄ±:`, tcmbError);
                                continue; // Bir Ã¶nceki gÃ¼nÃ¼ dene
                            }
                        }
                    } catch (e) {
                        console.warn('TCMB API genel hatasÄ±:', e);
                    }
                }
                
                // 6. Son fallback: Sabit gÃ¼ncel kurlar (gÃ¼ncel piyasa deÄŸerleri)
                if (!rates) {
                    console.warn('TÃ¼m API\'ler baÅŸarÄ±sÄ±z, varsayÄ±lan kurlar kullanÄ±lÄ±yor');
                    const currentDate = new Date();
                    
                    // 2024 yÄ±lÄ±nÄ±n genel ortalamasÄ± (gÃ¼ncellenebilir)
                    rates = {
                        usd: 34.20,  // GÃ¼ncel USD/TRY yaklaÅŸÄ±k deÄŸeri
                        eur: 37.10,  // GÃ¼ncel EUR/TRY yaklaÅŸÄ±k deÄŸeri  
                        source: 'VarsayÄ±lan Kurlar (API HatasÄ±)',
                        isDefault: true
                    };
                    
                    showToast('API\'lerden kur alÄ±namadÄ±, varsayÄ±lan kurlar kullanÄ±lÄ±yor. LÃ¼tfen manuel gÃ¼ncelleme yapÄ±n.', 'warning');
                }
                
                if (rates) {
                    // UI'yi gÃ¼ncelle
                    if (el.currentUsdRate) el.currentUsdRate.value = rates.usd.toFixed(2);
                    if (el.currentEurRate) el.currentEurRate.value = rates.eur.toFixed(2);
                    
                    // Global deÄŸiÅŸkeni gÃ¼ncelle
                    currentUsdRate = rates.usd;
                    updateCurrencyConverterDisplay();
                    
                    // Ayarlara kaydet
                    const settings = JSON.parse(localStorage.getItem('teknoHesapSettings') || '{}');
                    settings.currentUsdRate = rates.usd.toFixed(2);
                    settings.currentEurRate = rates.eur.toFixed(2);
                    settings.lastRateUpdate = new Date().toISOString();
                    settings.rateSource = rates.source;
                    settings.isManualRate = rates.isDefault || false;
                    localStorage.setItem('teknoHesapSettings', JSON.stringify(settings));
                    
                    // Son gÃ¼ncelleme bilgisini gÃ¼ncelle
                    updateLastRateInfo();
                    
                    if (rates.isDefault) {
                        showToast(`VarsayÄ±lan kurlar yÃ¼klendi (${rates.source}). Manuel gÃ¼ncelleme Ã¶nerilir.`, 'warning');
                    } else {
                        showToast(`GÃ¼ncel kurlar baÅŸarÄ±yla gÃ¼ncellendi! (Kaynak: ${rates.source})`, 'success');
                    }
                } else {
                    throw new Error('HiÃ§bir kaynaktan kur bilgisi alÄ±namadÄ±');
                }
                
            } catch (error) {
                console.error('Kur gÃ¼ncelleme hatasÄ±:', error);
                showToast('Kur gÃ¼ncellemesi baÅŸarÄ±sÄ±z! Ä°nternet baÄŸlantÄ±nÄ±zÄ± kontrol edin.', 'error');
                
                // Fallback: Manuel kur giriÅŸi Ã¶nerisi
                const userWantsManual = confirm('Otomatik kur gÃ¼ncellemesi baÅŸarÄ±sÄ±z oldu.\n\nManuel USD ve EUR kurlarÄ±nÄ± girmek ister misiniz?');
                if (userWantsManual) {
                    const userUsdRate = prompt('USD kuru (Ã¶rn: 34.20):');
                    const userEurRate = prompt('EUR kuru (Ã¶rn: 37.10):');
                    
                    if (userUsdRate && !isNaN(userUsdRate) && parseFloat(userUsdRate) > 0) {
                        const usdRate = parseFloat(userUsdRate);
                        const eurRate = userEurRate && !isNaN(userEurRate) && parseFloat(userEurRate) > 0 
                            ? parseFloat(userEurRate) 
                            : usdRate * 1.08; // EUR genelde USD'den %8 daha yÃ¼ksek
                        
                        if (el.currentUsdRate) el.currentUsdRate.value = usdRate.toFixed(2);
                        if (el.currentEurRate) el.currentEurRate.value = eurRate.toFixed(2);
                        
                        currentUsdRate = usdRate;
                        updateCurrencyConverterDisplay();
                        
                        // Manuel kurlarÄ± kaydet
                        const settings = JSON.parse(localStorage.getItem('teknoHesapSettings') || '{}');
                        settings.currentUsdRate = usdRate.toFixed(2);
                        settings.currentEurRate = eurRate.toFixed(2);
                        settings.lastRateUpdate = new Date().toISOString();
                        settings.rateSource = 'Manuel GiriÅŸ';
                        settings.isManualRate = true;
                        localStorage.setItem('teknoHesapSettings', JSON.stringify(settings));
                        
                        // Son gÃ¼ncelleme bilgisini gÃ¼ncelle
                        updateLastRateInfo();
                        
                        showToast('Manuel kurlar baÅŸarÄ±yla ayarlandÄ±!', 'success');
                    }
                }
            }
        }

        function exportAllData() {
            try {
                const allData = {
                    services: services,
                    phones: phones,
                    wholesalers: wholesalers,
                    transactions: transactions,
                    shopShortages: shopShortages,
                    productPrices: productPrices,
                    todaysSales: todaysSales,
                    settings: JSON.parse(localStorage.getItem('teknoHesapSettings') || '{}'),
                    exportDate: new Date().toISOString(),
                    version: 'v2.1.0'
                };
                
                const dataStr = JSON.stringify(allData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `teknohesap-yedek-${new Date().toLocaleDateString('tr-TR')}.json`;
                link.click();
                
                showToast('Veriler baÅŸarÄ±yla dÄ±ÅŸa aktarÄ±ldÄ±!', 'success');
            } catch (error) {
                showToast('Veri dÄ±ÅŸa aktarma hatasÄ±!', 'error');
                console.error('Export error:', error);
            }
        }

        function importAllData(file) {
            if (!file) {
                showToast('LÃ¼tfen bir dosya seÃ§in!', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    
                    // Validate data structure
                    if (!importedData.services || !Array.isArray(importedData.services)) {
                        throw new Error('GeÃ§ersiz veri formatÄ±!');
                    }
                    
                    // Confirm import
                    if (!confirm('Bu iÅŸlem mevcut tÃ¼m verileri silecek ve yedek dosyasÄ±ndaki verileri yÃ¼kleyecek. Devam etmek istiyor musunuz?')) {
                        return;
                    }
                    
                    // Import data (in production, you should use Firebase batch operations)
                    localStorage.setItem('teknoHesapSettings', JSON.stringify(importedData.settings || {}));
                    
                    showToast('Veriler baÅŸarÄ±yla iÃ§e aktarÄ±ldÄ±! Sayfa yenileniyor...', 'success');
                    
                    // Reload page to reflect changes
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                    
                } catch (error) {
                    showToast('Veri iÃ§e aktarma hatasÄ±! GeÃ§ersiz dosya formatÄ±.', 'error');
                    console.error('Import error:', error);
                }
            };
            reader.readAsText(file);
        }

        async function clearAllData() {
            if (!confirm('TÃœM VERÄ°LER SÄ°LÄ°NECEK! Bu iÅŸlem geri alÄ±namaz. Emin misiniz?')) {
                return;
            }
            
            if (!confirm('Son uyarÄ±! TÃ¼m satÄ±ÅŸ, servis, stok ve finansal verileriniz silinecek. Devam etmek istiyor musunuz?')) {
                return;
            }
            
            try {
                // In production, implement Firebase batch delete
                localStorage.clear();
                showToast('TÃ¼m veriler silindi! Sayfa yenileniyor...', 'success');
                
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
                
            } catch (error) {
                showToast('Veri silme hatasÄ±!', 'error');
                console.error('Clear data error:', error);
            }
        }

        function resetApplication() {
            if (!confirm('UYGULAMA TAMAMEN SIFIRILACAK! TÃ¼m veriler ve ayarlar silinecek. Emin misiniz?')) {
                return;
            }
            
            if (!confirm('Bu iÅŸlem geri alÄ±namaz! TÃ¼m hesap verileri silinecek. Devam etmek istiyor musunuz?')) {
                return;
            }
            
            try {
                // Clear all local data
                localStorage.clear();
                sessionStorage.clear();
                
                // Sign out user
                signOut(auth);
                
                showToast('Uygulama sÄ±fÄ±rlandÄ±! GiriÅŸ sayfasÄ±na yÃ¶nlendiriliyorsunuz...', 'success');
                
            } catch (error) {
                showToast('Uygulama sÄ±fÄ±rlama hatasÄ±!', 'error');
                console.error('Reset error:', error);
            }
        }

        async function setReportDateAndRefresh(dateString) { 
            el.reportDate.value = dateString; 
            await renderDailyReport(dateString); 
        }
        
        async function renderDailyReport(dateString) { 
            el.reportIncomeBody.innerHTML = getLoaderRow(7); // Colspan updated for new Profit Margin column
            el.reportExpenseBody.innerHTML = getLoaderRow(3); 
            
            const selectedDate = new Date(dateString); 
            if (isNaN(selectedDate)) {
                 el.reportIncomeBody.innerHTML = getErrorRow(7, "GeÃ§ersiz tarih seÃ§ildi."); // Colspan updated
                 el.reportExpenseBody.innerHTML = getErrorRow(3, "GeÃ§ersiz tarih seÃ§ildi.");
                 el.reportTotalRevenue.textContent = formatCurrency(0, 'TRY');
                 el.reportTotalCost.textContent = formatCurrency(0, 'TRY');
                 el.reportGrossProfit.textContent = formatCurrency(0, 'TRY');
                 el.reportTotalExpenses.textContent = formatCurrency(0, 'TRY');
                 el.reportNetProfit.textContent = formatCurrency(0, 'TRY');
                 el.reportNetProfit.className = `text-2xl font-bold text-emerald-700`; // Adjusted for light theme
                 el.dailyCostAnalysisSection.innerHTML = '';
                 return;
            }

            const startOfDay = new Date(selectedDate); startOfDay.setHours(0, 0, 0, 0); 
            const endOfDay = new Date(selectedDate); endOfDay.setHours(23, 59, 59, 999); 
            
            let dailySales = []; 
            let currentExpenses = []; 
            
            try { 
                const salesQuery = query(collection(db, getPath('sales')), where('date', '>=', startOfDay), where('date', '<=', endOfDay), orderBy('date', 'asc')); 
                const expensesQuery = query(collection(db, getPath('expenses')), where('date', '>=', startOfDay), where('date', '<=', endOfDay), orderBy('date', 'asc')); 
                
                const [salesSnapshot, expensesSnapshot] = await Promise.all([getDocs(salesQuery), getDocs(expensesQuery)]); 
                
                dailySales = salesSnapshot.docs.map(sanitizeDoc); 
                currentExpenses = expensesSnapshot.docs.map(sanitizeDoc); 
            } catch (error) { 
                console.error("GÃ¼nlÃ¼k rapor verileri alÄ±nÄ±rken hata:", error); 
                el.reportIncomeBody.innerHTML = getErrorRow(7, "Veri yÃ¼klenemedi. LÃ¼tfen Firestore indekslerinizi kontrol edin."); // Colspan updated
                el.reportExpenseBody.innerHTML = getErrorRow(3, "Veri yÃ¼klenemedi."); // No change here
                dailySales = []; 
                currentExpenses = []; 
            } 
            
            // Calculate OVERALL totals for the top summary cards (unfiltered)
            const overallTotalRevenue = dailySales.reduce((sum, s) => sum + getSafeFloat(s.totalRevenue), 0);
            const overallTotalCost = dailySales.reduce((sum, s) => sum + getSafeFloat(s.totalCost), 0);
            const overallGrossProfit = overallTotalRevenue - overallTotalCost;
            // currentExpenses and totalExpenses are already calculated based on the full day
            let totalExpenses = currentExpenses.reduce((sum, e) => sum + getSafeFloat(e.amount), 0);


            el.reportTotalRevenue.textContent = `${formatCurrency(overallTotalRevenue, 'TRY')}`;
            el.reportTotalCost.textContent = `${formatCurrency(overallTotalCost, 'TRY')}`;
            el.reportGrossProfit.textContent = `${formatCurrency(overallGrossProfit, 'TRY')}`;
            el.reportTotalExpenses.textContent = `${formatCurrency(totalExpenses, 'TRY')}`;
            const overallNetProfit = overallGrossProfit - totalExpenses; // totalExpenses is from all expenses for the day
            el.reportNetProfit.textContent = `${formatCurrency(overallNetProfit, 'TRY')}`;
            el.reportNetProfit.className = `text-2xl font-bold ${overallNetProfit >= 0 ? 'text-emerald-700' : 'text-red-700'}`; // Adjusted for light theme

            // Filter sales for the "Gelir DÃ¶kÃ¼mÃ¼" table
            let filteredIncomeSales = dailySales;
            if (currentDailyReportIncomeFilter !== 'all') {
                filteredIncomeSales = dailySales.filter(s => s.type === currentDailyReportIncomeFilter);
            }

            let incomeTableTotalRevenue = 0, incomeTableTotalCost = 0, incomeTableTotalProfit = 0;
            if(filteredIncomeSales.length === 0) {
                el.reportIncomeBody.innerHTML = `<tr><td colspan="7" class="p-4 text-center text-slate-500">SeÃ§ili filtre iÃ§in gelir kaydedilmedi.</td></tr>`; // Colspan updated
                el.reportIncomeFoot.innerHTML = ''; 
            } else { 
                el.reportIncomeBody.innerHTML = filteredIncomeSales.map((s, i) => {
                    const revenue = getSafeFloat(s.totalRevenue);
                    const cost = getSafeFloat(s.totalCost);
                    const profit = getSafeFloat(s.totalProfit); // Profit is already calculated and stored
                    incomeTableTotalRevenue += revenue;
                    incomeTableTotalCost += cost;
                    incomeTableTotalProfit += profit;

                    // Get icon and color based on sale type
                    const typeInfo = saleTypeIcons[s.type] || saleTypeIcons.other;
                    const iconHtml = `<span class="text-lg ${typeInfo.color} mr-2">${typeInfo.icon}</span>`;
                    let productNameDisplay = sanitizeHTML(s.productName);
                    if (s.type === 'device' && s.originalPhoneData) {
                        productNameDisplay += ` <span class="text-xs text-slate-500">(Stok)</span>`;
                    }

                    let profitMarginText = '-';
                    let profitMarginClass = '';
                    if (cost > 0) {
                        const margin = (profit / cost) * 100;
                        profitMarginText = `${margin.toFixed(1)}%`;
                        if (margin < PROFIT_MARGIN_THRESHOLD && profit > 0) { // Highlight low margin only if profit is positive
                            profitMarginClass = 'text-yellow-400';
                        }
                    }

                    return `<tr class="border-b border-slate-200">
                        <td class="px-2 py-4 text-center text-slate-500">${i + 1}</td>
                        <td class="px-4 py-4 text-slate-500">${s.date.toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'})}</td>
                        <td class="px-4 py-4 text-slate-700">${iconHtml}${productNameDisplay}</td>
                        <td class="px-4 py-4 text-right">${formatCurrency(revenue, 'TRY')}</td>
                        <td class="px-4 py-4 text-right">${formatCurrency(cost, 'TRY')}</td>
                        <td class="px-4 py-4 text-right font-bold ${profit >= 0 ? 'text-emerald-600' : 'text-red-600'}">${formatCurrency(profit, 'TRY')}</td>
                        <td class="px-4 py-4 text-right font-semibold ${profitMarginClass}">${profitMarginText}</td>
                    </tr>`;
                }).join(''); 
                el.reportIncomeFoot.innerHTML = `<tr class="border-t-2 border-slate-300"><td colspan="3" class="px-4 py-4 text-right font-bold text-slate-700">FiltrelenmiÅŸ Ara Toplam:</td><td class="px-4 py-4 text-right font-bold text-slate-700">${formatCurrency(incomeTableTotalRevenue, 'TRY')}</td><td class="px-4 py-4 text-right font-bold text-slate-700">${formatCurrency(incomeTableTotalCost, 'TRY')}</td><td class="px-4 py-4 text-right font-bold text-slate-700">${formatCurrency(incomeTableTotalProfit, 'TRY')}</td><td></td></tr>`; // Adjusted colspan and profit sum
            } 
            
            // totalExpenses is already calculated above for the summary cards
            if(currentExpenses.length === 0) { 
                el.reportExpenseBody.innerHTML = `<tr><td colspan="3" class="p-4 text-center text-slate-500">SeÃ§ili gÃ¼n iÃ§in gider kaydedilmedi.</td></tr>`; 
                el.reportExpenseFoot.innerHTML = ''; 
            } else { 
                el.reportExpenseBody.innerHTML = currentExpenses.map(e => { 
                    // totalExpenses sum is already done
                    return `<tr class="border-b border-slate-200">
                        <td class="px-4 py-4 text-slate-700">${sanitizeHTML(e.description)}</td>
                        <td class="px-4 py-4 text-right font-bold text-red-600">${formatCurrency(e.amount, 'TRY')}</td>
                        <td class="px-4 py-4 text-center">
                            <button data-id="${e.id}" data-name="${e.description}" class="delete-expense-btn text-slate-400 hover:text-red-500 p-1" title="Sil" aria-label="Gideri Sil">
                                <svg width="18" height="18" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path d="M3 6h18"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6"/></svg>
                            </button>
                        </td>
                    </tr>`; 
                }).join(''); 
                el.reportExpenseFoot.innerHTML = `<tr class="border-t-2 border-slate-300"><td class="px-4 py-4 text-right font-bold text-slate-700">Ara Toplam:</td><td class="px-4 py-4 text-right font-extrabold text-red-600">${formatCurrency(totalExpenses, 'TRY')}</td><td></td></tr>`; 
            } 
            
            // Daily Cost Analysis Section
            // This section should use overallTotalCost (cost from all sales for the day)
            const totalOutflow = overallTotalCost + totalExpenses;
            const deviceCost = dailySales.filter(s => s.type === 'device').reduce((sum, s) => sum + getSafeFloat(s.totalCost), 0); 
            const serviceCost = dailySales.filter(s => s.type === 'service').reduce((sum, s) => sum + getSafeFloat(s.totalCost), 0); 
            const accessoryCost = dailySales.filter(s => s.type === 'accessory').reduce((sum, s) => sum + getSafeFloat(s.totalCost), 0); 
            
            let costBreakdownHtml = ''; 
            if (deviceCost > 0) { costBreakdownHtml += `<div class="flex justify-between text-slate-600 py-0.5"><span>- Cihaz SatÄ±ÅŸ Maliyetleri</span><span class="font-medium">${formatCurrency(deviceCost, 'TRY')}</span></div>`; } 
            if (serviceCost > 0) { costBreakdownHtml += `<div class="flex justify-between text-slate-600 py-0.5"><span>- Servis Maliyetleri</span><span class="font-medium">${formatCurrency(serviceCost, 'TRY')}</span></div>`; } 
            if (accessoryCost > 0) { costBreakdownHtml += `<div class="flex justify-between text-slate-600 py-0.5"><span>- Aksesuar Maliyetleri</span><span class="font-medium">${formatCurrency(accessoryCost, 'TRY')}</span></div>`; } 
            
            el.dailyCostAnalysisSection.innerHTML = `
                <h4 class="text-lg font-semibold text-slate-700 mb-3">GÃ¼nlÃ¼k Kasa Ã‡Ä±kÄ±ÅŸÄ± Analizi</h4>
                <div class="space-y-3 text-sm">
                    <div class="flex justify-between items-center p-2 bg-slate-100 rounded-md">
                        <span class="text-slate-700">SatÄ±lan ÃœrÃ¼n/Hizmet Maliyetleri (Toplam):</span>
                        <span class="font-bold text-orange-600">${formatCurrency(overallTotalCost, 'TRY')}</span>
                    </div>
                    ${overallTotalCost > 0 ? `<div class="pl-4 space-y-0.5 text-xs border-l-2 border-slate-300 ml-2 py-1">${costBreakdownHtml}</div>` : ''}
                    <div class="flex justify-between items-center p-2 bg-slate-100 rounded-md">
                        <span class="text-slate-700">Toplam DÃ¼kkan Giderleri:</span>
                        <span class="font-bold text-red-600">${formatCurrency(totalExpenses, 'TRY')}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-red-50 border-t border-red-200/50 rounded-b-md mt-2">
                        <span class="font-semibold text-slate-800">TOPLAM KASA Ã‡IKIÅžI:</span>
                        <span class="font-extrabold text-lg text-red-600">${formatCurrency(totalOutflow, 'TRY')}</span>
                    </div>
                </div>`; 
        }
        
        async function loadAndRenderSoldPhonesLog() { 
            el.soldPhonesLog.innerHTML = getLoaderRow(7); 
            try { 
                // Fetch all sales and filter for device sales
                const salesQuery = query(collection(db, getPath('sales'))); 
                const snapshot = await getDocs(salesQuery); 
                
                let deviceSales = snapshot.docs 
                    .map(sanitizeDoc) 
                    .filter(sale => sale.type === 'device')
                    .sort((a, b) => b.date - a.date); // Sort by date descending
                    
                renderSoldPhonesLog(deviceSales); 
            } catch (error) { 
                console.error("SatÄ±lan cihazlar yÃ¼klenirken hata:", error); 
                el.soldPhonesLog.innerHTML = getErrorRow(7, "Veriler yÃ¼klenemedi. LÃ¼tfen daha sonra tekrar deneyin."); 
            } 
        }
        
        function renderSoldPhonesLog(soldPhonesData) { 
            const searchTerm = el.soldPhoneSearchInput.value.toLowerCase(); 
            const filteredSales = soldPhonesData.filter(s => { 
                const phoneData = s.originalPhoneData; 
                // Ensure originalPhoneData exists before searching its properties
                if (!phoneData) return false; 
                const buyerName = s.buyerName || ''; 
                return phoneData.model.toLowerCase().includes(searchTerm) || 
                       phoneData.imei.toLowerCase().includes(searchTerm) || 
                       buyerName.toLowerCase().includes(searchTerm); 
            }); 
            
            if (filteredSales.length === 0) { 
                el.soldPhonesLog.innerHTML = `<tr><td colspan="7" class="text-center p-8 text-slate-500">SatÄ±lan cihaz kaydÄ± bulunamadÄ±.</td></tr>`; 
                return; 
            } 
            
            el.soldPhonesLog.innerHTML = filteredSales.map(s => { 
                const phoneData = s.originalPhoneData; // Already sanitized by sanitizeDoc
                // Ensure phoneData exists before accessing its properties
                if (!phoneData) return ''; 

                return `<tr class="border-b border-slate-200">
                    <td class="px-4 py-4 text-slate-600">${s.date.toLocaleDateString('tr-TR',{day:'2-digit',month:'short',year:'numeric'})}</td>
                    <td class="px-4 py-4 font-medium text-slate-700">${sanitizeHTML(s.buyerName)}</td>
                    <td class="px-4 py-4 text-slate-700">${sanitizeHTML(phoneData.model)} (${sanitizeHTML(phoneData.specs)})</td>
                    <td class="px-4 py-4 text-slate-500">${sanitizeHTML(phoneData.imei)}</td>
                    <td class="px-4 py-4 text-right text-red-600">${formatCurrency(s.totalCost, 'TRY')}</td>
                    <td class="px-4 py-4 text-right text-sky-600">${formatCurrency(s.totalRevenue, 'TRY')}</td>
                    <td class="px-4 py-4 text-right font-bold ${getSafeFloat(s.totalProfit)>=0?'text-emerald-600':'text-red-600'}">${formatCurrency(s.totalProfit, 'TRY')}</td>
                </tr>`; 
            }).join(''); 
        }
        
        function updateDashboardDebt() {
            let grandTotalDebtUSD = 0;
            // Calculate total debt by summing up positive balances from wholesalers
            wholesalers.forEach(w => {
                const balance = transactions
                    .filter(t => t.wholesalerName === w.name)
                    .reduce((bal, t) => {
                        if (t.type === 'debt') return bal + getSafeFloat(t.amount);
                        if (t.type === 'payment') return bal - getSafeFloat(t.amount);
                        return bal;
                    }, 0);

                if (balance > 0) {
                    grandTotalDebtUSD += balance;
                }
            });
            el.totalDebt.textContent = `${formatCurrency(grandTotalDebtUSD, 'USD')}`;
        }
        
        async function renderDailyDashboardStats() { 
            const dailyRevenue = todaysSales.reduce((sum, sale) => sum + getSafeFloat(sale.totalRevenue), 0); 
            const dailyCost = todaysSales.reduce((sum, sale) => sum + getSafeFloat(sale.totalCost), 0); 
            const dailyProfit = dailyRevenue - dailyCost; 
            
            el.totalRevenue.textContent = `${formatCurrency(dailyRevenue, 'TRY')}`;
            el.totalCost.textContent = `${formatCurrency(dailyCost, 'TRY')}`;
            
            // NEW: Fetch total expenses for today
            const todayStart = new Date(); todayStart.setHours(0, 0, 0, 0);
            const todayEnd = new Date(); todayEnd.setHours(23, 59, 59, 999);
            const expensesQuery = query(collection(db, getPath('expenses')), where('date', '>=', todayStart), where('date', '<=', todayEnd));
            const expensesSnapshot = await getDocs(expensesQuery);
            const totalExpenses = expensesSnapshot.docs.reduce((sum, doc) => sum + getSafeFloat(doc.data().amount), 0);
            
            el.totalProfit.textContent = `${formatCurrency(dailyProfit - totalExpenses, 'TRY')}`; // Net profit after expenses
        }
        
        // Yeni dashboard istatistik gÃ¼ncelleme fonksiyonu
        function updateDashboardStats() {
            try {
                // GÃ¼nlÃ¼k istatistikleri hesapla
                const today = new Date();
                const startOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate());
                const endOfDay = new Date(today.getFullYear(), today.getMonth(), today.getDate(), 23, 59, 59);
                
                // BugÃ¼nÃ¼n satÄ±ÅŸlarÄ±
                const todaySalesData = todaysSales || [];
                
                // Toplam ciro, maliyet ve kÃ¢r hesapla
                const totalRevenue = todaySalesData.reduce((sum, sale) => sum + getSafeFloat(sale.totalRevenue), 0);
                const totalCost = todaySalesData.reduce((sum, sale) => sum + getSafeFloat(sale.totalCost), 0);
                const totalProfit = totalRevenue - totalCost;
                
                // ToptancÄ± borÃ§larÄ± hesapla
                const totalDebt = wholesalers.reduce((sum, w) => sum + getSafeFloat(w.balanceUSD), 0);
                
                // DOM elementlerini gÃ¼ncelle
                if (el.totalRevenue) el.totalRevenue.textContent = formatCurrency(totalRevenue, 'TRY');
                if (el.totalCost) el.totalCost.textContent = formatCurrency(totalCost, 'TRY');
                if (el.totalProfit) el.totalProfit.textContent = formatCurrency(totalProfit, 'TRY');
                if (el.totalDebt) el.totalDebt.textContent = formatCurrency(totalDebt, 'USD');
                
                // GÃ¼nlÃ¼k dashboard iÃ§in gider hesaplama
                renderDailyDashboardStats();
                
            } catch (error) {
                console.error('Dashboard istatistik gÃ¼ncelleme hatasÄ±:', error);
            }
        }
        
        // Debounced gÃ¼ncelleme (performans iÃ§in)
        let updateStatsTimeout = null;

        function debouncedUpdateStats() {
            if (updateStatsTimeout) {
                clearTimeout(updateStatsTimeout);
            }
            
            updateStatsTimeout = setTimeout(() => {
                updateDashboardStats();
                updateStatsTimeout = null;
            }, 100); // 100ms gecikme
        }
        
        const getChartOptions = () => ({ 
            responsive: true, 
            maintainAspectRatio: false, 
            scales: { 
                x: { 
                    ticks: { color: '#94a3b8' }, 
                    grid: { color: '#e2e8f0' }  // Light grid for x-axis
                }, 
                y: { 
                    ticks: { color: '#94a3b8' }, 
                    grid: { color: '#e2e8f0' }, // Light grid for y-axis
                    beginAtZero: false 
                } 
            }, 
            plugins: { 
                legend: { 
                    labels: { color: '#475569' } // Darker legend for light theme
                },
                tooltip: { // Use 'tooltip' instead of 'tooltips' for Chart.js v3+
                    titleColor: '#ffffff', 
                    bodyColor: '#dddddd', 
                    backgroundColor: '#1e293b', // Darker tooltip for contrast on light bg
                    borderColor: '#334155',
                    borderWidth: 1
                }
            } 
        });

        async function renderAdvancedReport() { 
            el.advReportContentPlaceholder.innerHTML = `<div class="loader"></div>`; 
            el.generateAdvReportBtn.disabled = true; 
            
            try { 
                let startDate, endDate = new Date(); 
                const today = new Date(); 
                today.setHours(0,0,0,0); 
                endDate.setHours(23,59,59,999); 
                
                const rangeSelection = el.advReportRange.value; 
                let currentRangeString; 
                
                switch (rangeSelection) { 
                    case 'this_week': 
                        startDate = new Date(today); 
                        startDate.setDate(today.getDate() - today.getDay() + (today.getDay() === 0 ? -6 : 1)); // Monday of current week
                        currentRangeString = `this_week`; 
                        break; 
                    case 'this_month': 
                        startDate = new Date(today.getFullYear(), today.getMonth(), 1); 
                        currentRangeString = `this_month`; 
                        break; 
                    case 'last_30_days': 
                        startDate = new Date(today); 
                        startDate.setDate(today.getDate() - 30); 
                        currentRangeString = `last_30_days`; 
                        break; 
                    case 'this_year': 
                        startDate = new Date(today.getFullYear(), 0, 1); 
                        currentRangeString = `this_year`; 
                        break; 
                    case 'custom': 
                        startDate = new Date(el.advStartDate.value); 
                        endDate = new Date(el.advEndDate.value); 
                        if(isNaN(startDate) || isNaN(endDate)) {
                            showToast("GeÃ§erli tarih aralÄ±ÄŸÄ± seÃ§in.", "error"); 
                            el.generateAdvReportBtn.disabled = false;
                            return;
                        } 
                        startDate.setHours(0,0,0,0); 
                        endDate.setHours(23,59,59,999); 
                        currentRangeString = `${getLocalYYYYMMDD(startDate)}-${getLocalYYYYMMDD(endDate)}`; 
                        break; 
                    default:
                         showToast("GeÃ§ersiz rapor aralÄ±ÄŸÄ±.", "error");
                         el.generateAdvReportBtn.disabled = false;
                         return;
                } 
                
                let filteredSales, filteredExpenses; 
                
                // Use cache if the range hasn't changed
                if (cachedReportRange === currentRangeString) { 
                    filteredSales = advancedReportDataCache.sales; 
                    filteredExpenses = advancedReportDataCache.expenses; 
                } else { 
                    // Fetch data for the selected range
                    const salesQuery = query(collection(db, getPath('sales')), where('date', '>=', startDate), where('date', '<=', endDate)); 
                    const expensesQuery = query(collection(db, getPath('expenses')), where('date', '>=', startDate), where('date', '<=', endDate)); 
                    
                    const [salesSnapshot, expensesSnapshot] = await Promise.all([getDocs(salesQuery), getDocs(expensesQuery)]); 
                    
                    filteredSales = salesSnapshot.docs.map(sanitizeDoc); 
                    filteredExpenses = expensesSnapshot.docs.map(sanitizeDoc); 
                    
                    // Cache the fetched data and range
                    advancedReportDataCache = { sales: filteredSales, expenses: filteredExpenses }; 
                    cachedReportRange = currentRangeString; 
                } 
                
                // Restore the placeholder HTML structure before rendering data/charts
                el.advReportContentPlaceholder.innerHTML = advancedReportHTMLCache; 
                
                // Calculate summary stats
                const totalRevenue = filteredSales.reduce((s,c)=>s+getSafeFloat(c.totalRevenue),0); 
                const totalCost = filteredSales.reduce((s,c)=>s+getSafeFloat(c.totalCost),0); 
                const grossProfit = totalRevenue - totalCost; 
                const totalExpenses=filteredExpenses.reduce((s,e)=>s+getSafeFloat(e.amount),0); 
                const netProfit = grossProfit - totalExpenses; 
                
                // Update summary stats display
                document.getElementById('advTotalRevenue').textContent=`${formatCurrency(totalRevenue, 'TRY')}`; 
                document.getElementById('advTotalCost').textContent=`${formatCurrency(totalCost, 'TRY')}`; 
                document.getElementById('advGrossProfit').textContent = `${formatCurrency(grossProfit, 'TRY')}`; 
                document.getElementById('advTotalExpenses').textContent=`${formatCurrency(totalExpenses, 'TRY')}`; 
                
                const advNetProfitEl = document.getElementById('advNetProfit'); 
                advNetProfitEl.textContent = `${formatCurrency(netProfit, 'TRY')}`; 
                advNetProfitEl.className = `text-2xl font-bold ${netProfit >= 0 ? 'text-emerald-700' : 'text-red-700'}`; // Adjusted colors for light theme
                
                // Category Profit Analysis
                const categoryData = { 
                    'Yeni Cihaz': {revenue:0, profit:0}, 
                    '2. El Cihaz': {revenue:0, profit:0}, 
                    'Servis': {revenue:0, profit:0}, 
                    'Aksesuar': {revenue:0, profit:0} 
                }; 
                
                filteredSales.forEach(s => { 
                    const profit = getSafeFloat(s.totalProfit);
                    const revenue = getSafeFloat(s.totalRevenue); 
                    
                    if (s.type === 'device') { 
                        // Check originalPhoneData and its status safely
                        const key = s.originalPhoneData && s.originalPhoneData.status === 'SÄ±fÄ±r' ? 'Yeni Cihaz' : '2. El Cihaz';
                        if (categoryData[key]) { // Ensure key exists
                            categoryData[key].revenue += revenue; 
                            categoryData[key].profit += profit; 
                        }
                    } else if (s.type === 'service') { 
                        categoryData.Servis.revenue += revenue; 
                        categoryData.Servis.profit += profit; 
                    } else if (s.type === 'accessory') { 
                        categoryData.Aksesuar.revenue += revenue; 
                        categoryData.Aksesuar.profit += profit; 
                    } 
                }); 
                
                document.getElementById('categoryProfitBody').innerHTML = Object.entries(categoryData).map(([name, data]) => 
                    `<tr class="border-b border-slate-200">
                        <td class="px-4 py-4 font-medium text-slate-700">${sanitizeHTML(name)}</td>
                        <td class="px-4 py-4 text-right text-slate-700">${formatCurrency(data.revenue, 'TRY')}</td>
                        <td class="px-4 py-4 text-right font-bold ${data.profit>=0?'text-emerald-600':'text-red-600'}">${formatCurrency(data.profit, 'TRY')}</td>
                    </tr>`
                ).join(''); 
                
                // Revenue Pie Chart
                if (revenuePieChartInstance) revenuePieChartInstance.destroy(); 
                const revenueData = Object.values(categoryData).map(d => d.revenue);
                const revenueLabels = Object.keys(categoryData);

                revenuePieChartInstance = new Chart(document.getElementById('revenuePieChart'), { 
                    type: 'doughnut', 
                    data: { 
                        labels: revenueLabels, 
                        datasets: [{ 
                            label: 'Ciro DaÄŸÄ±lÄ±mÄ±', 
                            data: revenueData, 
                            backgroundColor: ['#059669', '#16a34a', '#f59e0b', '#8b5cf6'], // emerald-700, emerald-600, amber-500, violet-500
                            hoverOffset: 4,
                            borderColor: '#ffffff' // White border for segments on light theme
                        }] 
                    }, 
                    options: { 
                        ...getChartOptions(), 
                        plugins: { 
                            legend: {
                                position: 'top', 
                                labels: { color: '#475569' } // Darker legend for light theme
                            },
                             tooltip: getChartOptions().plugins.tooltip // Use tooltip options from getChartOptions
                        } 
                    } 
                }); 
                
                // Daily Net Profit Trend Chart
                const dailyData = {}; 
                // Initialize daily data for the date range
                for (let d = new Date(startDate); d <= endDate; d.setDate(d.getDate() + 1)) { 
                    dailyData[getLocalYYYYMMDD(d)] = { profit: 0 }; 
                } 
                
                // Aggregate sales profit by day
                filteredSales.forEach(s => { 
                    const dateStr = getLocalYYYYMMDD(s.date); 
                    if(dailyData[dateStr]) dailyData[dateStr].profit += getSafeFloat(s.totalProfit); 
                }); 
                
                // Aggregate expenses by day
                filteredExpenses.forEach(e => { 
                    const dateStr = getLocalYYYYMMDD(e.date); 
                    if(dailyData[dateStr]) dailyData[dateStr].profit -= getSafeFloat(e.amount); 
                }); 
                
                const chartLabels = Object.keys(dailyData).map(dateStr => new Date(dateStr).toLocaleDateString('tr-TR', {month:'short',day:'numeric'})); 
                const chartProfitData = Object.values(dailyData).map(d => d.profit); 
                
                if (profitChartInstance) profitChartInstance.destroy(); 
                profitChartInstance = new Chart(document.getElementById('profitChart'), { 
                    type: 'line', 
                    data: { 
                        labels: chartLabels, 
                        datasets: [{ 
                            label: 'GÃ¼nlÃ¼k Net KÃ¢r (TL)', 
                            data: chartProfitData, 
                            borderColor: '#34d399', // Yeni yeÅŸil ana renk
                            tension: 0.2,
                            fill: true,
                            backgroundColor: function(context) { // Gradyan dolgu
                                const chart = context.chart;
                                const {ctx, chartArea} = chart;
                                if (!chartArea) {
                                    // This case happens on initial chart load
                                    return null;
                                }
                                const gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
                                gradient.addColorStop(0, 'rgba(52, 211, 153, 0.05)'); // emerald-400 with low opacity
                                gradient.addColorStop(1, 'rgba(16, 185, 129, 0.3)');  // emerald-500 with higher opacity
                                return gradient;
                            }
                        }] 
                    }, 
                    options: getChartOptions() 
                }); 
            } catch (error) { 
                console.error("GeliÅŸmiÅŸ rapor alÄ±nÄ±rken hata:", error); 
                el.advReportContentPlaceholder.innerHTML = `<div class="p-4 bg-red-100 text-red-700 rounded-lg">Veriler yÃ¼klenemedi. LÃ¼tfen Firestore indekslerinizi kontrol edin veya daha sonra tekrar deneyin.</div>`; 
            } finally { 
                el.generateAdvReportBtn.disabled = false; 
            } 
        }
        
        function exportTableToCSV(tableId, filename) { 
            let csv = []; 
            const table = document.getElementById(tableId); 
            if (!table) { 
                showToast('Rapor tablosu bulunamadÄ±.', 'error'); 
                return; 
            } 
            
            const rows = table.querySelectorAll("tr"); 
            
            for (const row of rows) { 
                const cols = row.querySelectorAll("td, th"); 
                const rowData = []; 
                for (const col of cols) { 
                    // Skip columns containing buttons or SVGs (like action columns)
                    if (col.querySelector('button, svg')) continue; 
                    
                    let data = col.innerText.trim(); // Use innerText and trim whitespace
                    data = data.replace(/(\r\n|\n|\r)/gm, " "); // Remove newlines
                    data = data.replace(/"/g, '""'); // Escape double quotes
                    
                    rowData.push(`"${data}"`); 
                } 
                csv.push(rowData.join(",")); 
            } 
            
            // Add BOM for UTF-8 support in Excel
            const csvFile = new Blob(["\uFEFF" + csv.join("\n")], { type: "text/csv;charset=utf-8;" }); 
            
            const downloadLink = document.createElement("a"); 
            downloadLink.href = window.URL.createObjectURL(csvFile); 
            downloadLink.download = `${filename}_${getLocalYYYYMMDD()}.csv`; // Add date to filename
            
            document.body.appendChild(downloadLink); 
            downloadLink.click(); 
            document.body.removeChild(downloadLink); 
            
            showToast(`${filename}.csv indirildi.`, 'success');
        }
        
        async function handleActionWithButton(button, asyncAction) { 
            if (button.disabled) return; 
            button.disabled = true; 
            const originalText = button.innerHTML; // Store original button content
            button.innerHTML = `<svg class="animate-spin h-5 w-5 text-white mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Ä°ÅŸleniyor...`; // Show spinner
            
            try { 
                await asyncAction(); 
            } catch (error) { 
                console.error("Eylem gerÃ§ekleÅŸtirilirken hata oluÅŸtu:", error); 
                // showToast handled within specific error handlers or default below
                if (!error.message.includes("Validation failed") && !error.message.includes("Item exists") && !error.message.includes("Duplicate IMEI")) { // Avoid showing generic error for validation/known issues
                     showToast("Ä°ÅŸlem sÄ±rasÄ±nda bir hata oluÅŸtu: " + error.message, "error"); 
                }
            } finally { 
                button.disabled = false; 
                button.innerHTML = originalText; // Restore original button content
            } 
        }

        // Helper function to fix Turkish characters in PDF
        function fixTurkishCharsForPDF(text) {
            if (!text) return text;
            return text
                .replace(/Ã§/g, 'c').replace(/Ã‡/g, 'C')
                .replace(/ÄŸ/g, 'g').replace(/Äž/g, 'G')
                .replace(/Ä±/g, 'i').replace(/I/g, 'I')
                .replace(/Ä°/g, 'I').replace(/i/g, 'i')
                .replace(/Ã¶/g, 'o').replace(/Ã–/g, 'O')
                .replace(/ÅŸ/g, 's').replace(/Åž/g, 'S')
                .replace(/Ã¼/g, 'u').replace(/Ãœ/g, 'U');
        }

        function downloadShortagesAsPDF() {
            if (shopShortages.length === 0) {
                showToast("Ä°ndirilecek eksik Ã¼rÃ¼n bulunmuyor.", "info");
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Add NotoSans font if available (for Turkish characters)
            // You might need to embed the font file if it's not universally available
            // For simplicity here, we'll try setting it and fallback to helvetica
            doc.setFont("helvetica", "bold");
            doc.setFontSize(18);
            doc.setTextColor(40, 55, 71);
            doc.text(fixTurkishCharsForPDF("DÃ¼kkan Eksikleri Listesi"), 14, 22);

            doc.setFont("helvetica", "normal");
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text(`Rapor Tarihi: ${new Date().toLocaleDateString('tr-TR', { day: '2-digit', month: 'long', year: 'numeric' })}`, 14, 30);
            doc.text(`Guncel USD Kuru: ${currentUsdRate.toFixed(2)} TL`, 14, 36);

            const tableColumn = ["#", fixTurkishCharsForPDF("ÃœrÃ¼n AdÄ±"), "Adet", "Fiyat (TL)", "Fiyat (USD)"];
            const tableRows = [];
            // Sort shortages alphabetically for the PDF
            shopShortages.sort((a,b) => a.name.localeCompare(b.name, 'tr', { sensitivity: 'base' })).forEach((item, index) => {
                const priceTL = getSafeFloat(item.priceTL);
                const priceUSD = getSafeFloat(item.priceUSD);
                
                const itemData = [
                    index + 1,
                    fixTurkishCharsForPDF(item.name), 
                    item.quantity.toString(),
                    priceTL > 0 ? `${priceTL.toFixed(2)} TL` : '-',
                    priceUSD > 0 ? `$${priceUSD.toFixed(2)}` : '-'
                ];
                tableRows.push(itemData);
            });

            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 44,
                theme: 'grid', // Add grid lines
                headStyles: {
                    fillColor: [22, 163, 74],
                    textColor: 255,
                    font: "helvetica",
                    fontStyle: 'bold', 
                    halign: 'center',
                    fontSize: 10,
                    cellPadding: 2,
                },
                bodyStyles: {
                    textColor: [30, 41, 59],
                    font: "helvetica",
                    fontSize: 9,
                    cellPadding: 2,
                },
                alternateRowStyles: {
                    fillColor: [229, 231, 235]
                },
                 styles: { 
                    font: "helvetica",
                    valign: 'middle',
                },
                columnStyles: {
                    0: { cellWidth: 15, halign: 'center' }, // # column
                    1: { cellWidth: 'auto', fontStyle: 'normal' }, // ÃœrÃ¼n AdÄ±
                    2: { cellWidth: 30, halign: 'center', fontStyle: 'bold' }  // Adet
                },
                tableLineColor: [156, 163, 175], // Slate-400
                tableLineWidth: 0.15,
                didDrawPage: function (data) { 
                    doc.setFont("helvetica", "normal");
                    doc.setFontSize(9);
                    doc.setTextColor(120);
                    const pageCount = doc.internal.getNumberOfPages();
                    doc.text(fixTurkishCharsForPDF('TeknoHesap - DÃ¼kkan Eksikleri'), data.settings.margin.left, doc.internal.pageSize.height - 10);
                    doc.text('Sayfa ' + doc.internal.getCurrentPageInfo().pageNumber + '/' + pageCount, doc.internal.pageSize.width - data.settings.margin.right, doc.internal.pageSize.height - 10, { align: 'right' });
                }
            });
            
            doc.save(`dukkan-eksikleri-${getLocalYYYYMMDD()}.pdf`);
            showToast("Eksikler listesi PDF olarak indirildi.", "success");
        }

        function downloadCashAdvancesAsPDF() {
            if (cashAdvances.length === 0) {
                showToast("Ä°ndirilecek avans kaydÄ± bulunmuyor.", "info");
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Font setup - use helvetica for better compatibility
            doc.setFont("helvetica", "bold");
            doc.setFontSize(18);
            doc.setTextColor(40, 55, 71);
            doc.text(fixTurkishCharsForPDF("Kasa AvanslarÄ± Listesi"), 14, 22);

            doc.setFont("helvetica", "normal");
            doc.setFontSize(10);
            doc.setTextColor(100);
            doc.text(`Rapor Tarihi: ${new Date().toLocaleDateString('tr-TR', { day: '2-digit', month: 'long', year: 'numeric' })}`, 14, 30);

            // Calculate totals
            const totalAmount = cashAdvances.reduce((sum, advance) => sum + (advance.totalAmount || advance.amount || 0), 0);
            const totalPeople = [...new Set(cashAdvances.map(advance => advance.personName))].length;
            doc.text(fixTurkishCharsForPDF(`Toplam Avans: ${formatCurrency(totalAmount, 'TL')}`), 14, 36);
            doc.text(fixTurkishCharsForPDF(`Toplam KiÅŸi: ${totalPeople} | Toplam KayÄ±t: ${cashAdvances.length}`), 14, 42);

            // Table columns
            const tableColumn = ["#", fixTurkishCharsForPDF("KiÅŸi AdÄ±"), fixTurkishCharsForPDF("Toplam Tutar"), fixTurkishCharsForPDF("Son Tarih"), fixTurkishCharsForPDF("AÃ§Ä±klama")];
            const tableRows = [];
            
            // Sort by person name and prepare data
            cashAdvances.sort((a,b) => a.personName.localeCompare(b.personName, 'tr', { sensitivity: 'base' }))
                .forEach((advance, index) => {
                    const amount = advance.totalAmount || advance.amount || 0;
                    const date = advance.lastAdvanceDate || advance.date;
                    const description = advance.lastAdvanceDescription || advance.description || '';
                    
                    const itemData = [
                        index + 1,
                        fixTurkishCharsForPDF(advance.personName),
                        formatCurrency(amount, 'TL'),
                        date ? new Date(date).toLocaleDateString('tr-TR') : 'Bilinmiyor',
                        fixTurkishCharsForPDF(description.length > 30 ? description.substring(0, 27) + '...' : description)
                    ];
                    tableRows.push(itemData);
                });

            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 50,
                theme: 'grid',
                headStyles: {
                    fillColor: [5, 150, 105],
                    textColor: 255,
                    font: "helvetica",
                    fontStyle: 'bold', 
                    halign: 'center',
                    fontSize: 10,
                    cellPadding: 2,
                },
                bodyStyles: {
                    textColor: [30, 41, 59],
                    font: "helvetica",
                    fontSize: 9,
                    cellPadding: 2,
                },
                alternateRowStyles: {
                    fillColor: [229, 231, 235]
                },
                styles: { 
                    font: "helvetica",
                    valign: 'middle',
                },
                columnStyles: {
                    0: { cellWidth: 15, halign: 'center' }, // # column
                    1: { cellWidth: 'auto', fontStyle: 'normal' }, // KiÅŸi AdÄ±
                    2: { cellWidth: 35, halign: 'right', fontStyle: 'bold' }, // Tutar
                    3: { cellWidth: 30, halign: 'center' }, // Tarih
                    4: { cellWidth: 'auto', fontSize: 8 } // AÃ§Ä±klama
                },
                tableLineColor: [156, 163, 175],
                tableLineWidth: 0.15,
                didDrawPage: function (data) { 
                    doc.setFont("helvetica", "normal");
                    doc.setFontSize(9);
                    doc.setTextColor(120);
                    const pageCount = doc.internal.getNumberOfPages();
                    doc.text(fixTurkishCharsForPDF('TeknoHesap - Kasa AvanslarÄ±'), data.settings.margin.left, doc.internal.pageSize.height - 10);
                    doc.text('Sayfa ' + doc.internal.getCurrentPageInfo().pageNumber + '/' + pageCount, doc.internal.pageSize.width - data.settings.margin.right, doc.internal.pageSize.height - 10, { align: 'right' });
                }
            });
            
            doc.save(`kasa-avanslari-${getLocalYYYYMMDD()}.pdf`);
            showToast("Kasa avanslarÄ± PDF olarak indirildi.", "success");
        }


        // --- Event Listeners ---
        el.logoutBtn.addEventListener('click', () => { signOut(auth).catch(e => { console.error(e); showToast('Ã‡Ä±kÄ±ÅŸ yapÄ±lamadÄ±.', 'error'); }); });
        
        el.loginForm.addEventListener('submit', (e) => { 
            e.preventDefault(); 
            handleActionWithButton(e.submitter, async () => { 
                const email = el.loginForm.loginEmail.value; 
                const password = el.loginForm.loginPassword.value; 
                el.loginError.textContent = ''; 
                try { 
                    await signInWithEmailAndPassword(auth, email, password); 
                    // onAuthStateChanged listener handles the rest
                } catch (e) { 
                    console.error(e.code); 
                    el.loginError.textContent = 'HatalÄ± e-posta veya ÅŸifre.'; 
                    throw e; // Re-throw to be caught by handleActionWithButton
                } 
            }) 
        });
        
        // ULTRA FAST TAB SWITCHING - TÃœM DONMA SORUNU Ã‡Ã–ZÃœLDÄ°
        let isTabSwitching = false;
        
        el.tabs.addEventListener('click', e => {
            const tabButton = e.target.closest('.tab');
            if (!tabButton || isTabSwitching) return;
            
            isTabSwitching = true;
            
            // HÄ±zlÄ± UI gÃ¼ncelleme - hiÃ§ gecikme yok
            const targetTab = tabButton.dataset.tab;
            
            el.tabs.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            tabButton.classList.add('active');
            
            document.querySelectorAll('[id$="-panel"]').forEach(p => p.classList.add('hidden'));
            const targetPanel = document.getElementById(targetTab);
            if (targetPanel) targetPanel.classList.remove('hidden');

            // HÄ±zlÄ± render - hiÃ§ bekleme yok
            if (targetTab === 'daily-report-panel') {
                setReportDateAndRefresh(getLocalYYYYMMDD());
            } else if (targetTab === 'reports-panel') {
                renderAdvancedReport();
            } else if (targetTab === 'sold-phones-panel') {
                loadAndRenderSoldPhonesLog();
            } else if (targetTab === 'debt-panel') {
                renderWholesalerList();
                el.wholesalerListView.classList.remove('hidden');
                el.wholesalerDetailView.classList.add('hidden');
            } else if (targetTab === 'service-history-panel') {
                renderServiceHistoryLog();
            } else if (targetTab === 'phone-stock-panel') {
                renderAnalysisView();
            } else if (targetTab === 'shortages-panel') {
                renderShopShortagesLog();
            } else if (targetTab === 'product-prices-panel') {
                renderProductPricesLog();
            } else if (targetTab === 'cash-advances-panel') {
                renderCashAdvancesLog();
                updateCashAdvancesStats();
                updatePersonFilter();
                renderPersonAdvancesSummary();
            } else if (targetTab === 'settings-panel') {
                loadSettingsData();
            } else if (targetTab === 'cash-tracker-panel') {
                showCashTrackerPanel();
            }
            
            isTabSwitching = false;
        });

        // Sales Panel Actions
        el.stockSellBtn.addEventListener('click', () => { renderStockSellList(); openModal(el.stockSellModal); });
        el.serviceDeliveryBtn.addEventListener('click', () => { renderServiceDeliveryList(); openModal(el.serviceDeliveryModal); });
        el.manualSellBtn.addEventListener('click', () => openModal(el.manualSellModal));
        
        // Service Panel Actions
        el.addServiceForm.addEventListener('submit', (e) => { 
            e.preventDefault(); 
            handleActionWithButton(e.submitter, async () => { 
                const formElements = e.target.elements; 
                const data = {
                    customerName: formElements.customerName.value.trim(),
                    customerPhone: formElements.customerPhone.value.trim(),
                    deviceName: formElements.deviceName.value.trim(),
                    deviceProblem: formElements.deviceProblem.value.trim(),
                    partCost: getSafeFloat(formElements.partCost.value),
                    laborCost: getSafeFloat(formElements.laborCost.value),
                    totalFee: getSafeFloat(formElements.totalFee.value),
                    status: serviceStatuses.PENDING.label, // Initial status
                    date: Timestamp.now(),
                    lastUpdated: Timestamp.now()
                };
                // Basic validation
                if (!data.customerName || !data.deviceName || data.totalFee < 0) {
                     showToast('MÃ¼ÅŸteri AdÄ±, Cihaz Modeli ve Toplam Ãœcret alanlarÄ± zorunludur ve geÃ§erli deÄŸerler iÃ§ermelidir.', 'error');
                     throw new Error("Validation failed");
                }
                await addDocument(`services`, data, "Servis kaydÄ± oluÅŸturuldu."); 
                e.target.reset(); 
                formElements.partCost.value = ''; // Ensure number fields are cleared properly
                formElements.laborCost.value = '';
            }); 
        });
        
        // Phone Stock Panel Actions
        el.addPhoneForm.addEventListener('submit', (e) => { 
            e.preventDefault(); 
            handleActionWithButton(e.submitter, async () => { 
                const formElements = e.target.elements; 
                const imei = formElements.phoneImei.value.trim(); 
                
                if (!imei) { 
                    showToast("IMEI numarasÄ± boÅŸ olamaz.", "error"); 
                    throw new Error("Validation failed");
                } 
                
                // Check for duplicate IMEI before adding
                const q = query(collection(db, getPath('phones')), where("imei", "==", imei)); 
                const querySnapshot = await getDocs(q); 
                if (!querySnapshot.empty) { 
                    showToast("Bu IMEI numarasÄ± zaten stokta mevcut.", "error"); 
                    formElements.phoneImei.focus(); 
                    formElements.phoneImei.classList.add('!border-red-500'); 
                    setTimeout(()=>formElements.phoneImei.classList.remove('!border-red-500'),3000); 
                    throw new Error("Duplicate IMEI");
                } 
                
                const data = {
                    status: formElements.phoneStatus.value,
                    imei: imei,
                    model: formElements.phoneModel.value.trim(),
                    specs: formElements.phoneSpecs.value.trim(),
                    purchasePrice: getSafeFloat(formElements.phonePurchasePrice.value),
                    sellingPrice: getSafeFloat(formElements.phoneSellingPrice.value),
                    batteryHealth: parseInt(formElements.phoneBatteryHealth.value) || null, // Store as number or null
                    cosmetic: formElements.phoneCosmetic.value,
                    accessories: formElements.phoneAccessories.value,
                    imageUrl: formElements.addPhoneImageUrl.value.trim(),
                    date: Timestamp.now(), // Date added to stock
                    lastUpdated: Timestamp.now()
                };
                 // Basic validation
                if (!data.model || data.purchasePrice < 0 || data.sellingPrice < 0) {
                     showToast('Model, AlÄ±ÅŸ ve SatÄ±ÅŸ fiyatÄ± alanlarÄ± zorunludur ve geÃ§erli deÄŸerler iÃ§ermelidir.', 'error');
                     throw new Error("Validation failed");
                }

                await addDocument(`phones`, data, "Telefon stoÄŸa eklendi."); 
                e.target.reset(); 
            }); 
        });
        
        el.phoneSearchInput.addEventListener('input', renderAnalysisView);
        el.stockSellSearch.addEventListener('input', e => renderStockSellList(e.target.value));
        el.serviceDeliverySearch.addEventListener('input', e => renderServiceDeliveryList(e.target.value));
        el.productPriceSearchInput.addEventListener('input', renderProductPricesLog);
        
        // Re-render sold phones log only if the panel is currently visible
        el.soldPhoneSearchInput.addEventListener('input', () => { 
            if(el.soldPhonesPanel.style.display !== 'none') {
                // No need to load data again, just filter the existing data
                renderSoldPhonesLog(advancedReportDataCache.sales.filter(s => s.type === 'device')); // Use cached data if available, or rely on listener
            } 
        }); 
        
        el.serviceHistorySearchInput.addEventListener('input', renderServiceHistoryLog); 
        
        // Event delegation for Service Log status change and buttons
        el.serviceLog.addEventListener('change', e => { 
            if(e.target.matches('.status-select')) { 
                const id = e.target.dataset.id; 
                const newStatus = e.target.value; 
                const row = e.target.closest('tr');
                const completeButton = row?.querySelector('.complete-btn');
                
                // Enable/Disable "Teslim Et" button based on status
                if(completeButton) {
                    if(newStatus === serviceStatuses.READY.label){
                        completeButton.disabled = false;
                        completeButton.classList.replace('btn-disabled','btn-success');
                    } else {
                        completeButton.disabled = true;
                        completeButton.classList.replace('btn-success','btn-disabled');
                    }
                }
                // Update status in Firestore
                updateDocument(`services/${id}`,{status: newStatus, lastUpdated: Timestamp.now()}); 
            } 
        });
        
        el.serviceLog.addEventListener('click', e => { 
            const completeButton = e.target.closest('.complete-btn'); 
            const editButton = e.target.closest('.edit-service-btn'); 
            const deleteButton = e.target.closest('.delete-service-btn'); 
            
            if (completeButton) {
                handleActionWithButton(completeButton, () => completeService(completeButton.dataset.id));
            } else if (editButton) {
                openEditServiceModal(editButton.dataset.id);
            } else if (deleteButton) {
                openDeleteConfirmModal('service', deleteButton.dataset.id, deleteButton.dataset.name);
            } 
        });
        
        // Event delegation for Phone Stock table headers (sorting)
        el.analysisTableHeaders.addEventListener('click', e => { 
            const header = e.target.closest('.sortable'); 
            if (!header) return; 
            
            const sortKey = header.dataset.sort; 
            if(sortState.key === sortKey){
                sortState.order = sortState.order === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.key = sortKey;
                sortState.order = 'desc'; // Default sort order is descending for new column
            } 
            renderAnalysisView(); 
        });
        
        // Event delegation for Phone Stock table body (sell, edit, delete buttons)
        el.phoneStockLog.addEventListener('click', e => { 
            const sellButton = e.target.closest('.sell-btn'); 
            const editButton = e.target.closest('.edit-phone-btn'); 
            const deleteButton = e.target.closest('.delete-phone-btn'); 
            
            if(sellButton) openSellModal(sellButton.dataset.id); 
            if(editButton) openEditPhoneModal(editButton.dataset.id); 
            if(deleteButton) openDeleteConfirmModal('phone', deleteButton.dataset.id, deleteButton.dataset.name); 
        });
        
        // Event delegation for Stock Sell Modal list
        el.stockSellList.addEventListener('click', e => { 
            const selectButton = e.target.closest('.select-phone-btn'); 
            if (selectButton) { 
                closeModal(el.stockSellModal); 
                openSellModal(selectButton.dataset.id); 
            } 
        });
        
        // Sell Confirmation Modal button
        el.confirmSellBtn.addEventListener('click', (e) => handleActionWithButton(e.target, () => confirmSale(phoneToSellId)));
        
        // Manual Sell Modal form submission
        el.addManualSaleForm.addEventListener('submit', (e) => { 
            e.preventDefault(); 
            handleActionWithButton(e.submitter, async () => { 
                const formElements = e.target.elements;
                const productName = formElements.saleProductNameModal.value.trim(); 
                const purchasePrice = getSafeFloat(formElements.salePurchasePriceModal.value); 
                const sellingPrice = getSafeFloat(formElements.saleSellingPriceModal.value); 
                const quantity = parseInt(formElements.quantityModal.value); 
                
                if(productName && quantity > 0 && purchasePrice >= 0 && sellingPrice >= 0){ 
                    await addDocument(`sales`, {
                        productName: productName, 
                        type: 'accessory', // Assuming manual sales are accessories/services
                        quantity: quantity, 
                        totalCost: purchasePrice * quantity, 
                        totalRevenue: sellingPrice * quantity, 
                        totalProfit: (sellingPrice - purchasePrice) * quantity, // Calculate profit here
                        date: Timestamp.now(), 
                        lastUpdated: Timestamp.now()
                    }, "SatÄ±ÅŸ kaydedildi."); 
                    e.target.reset(); 
                    closeModal(el.manualSellModal);
                } else {
                    showToast('LÃ¼tfen tÃ¼m alanlarÄ± doÄŸru doldurun (ÃœrÃ¼n AdÄ±, Adet > 0, Fiyatlar >= 0).', 'error'); 
                    throw new Error("Validation failed");
                } 
            }); 
        });
        
        // Auto-fill purchase price in Manual Sell Modal based on Product Price List
        el.manualSellModal.querySelector('#saleProductNameModal').addEventListener('input', (e) => {
            const productName = e.target.value.trim();
            const priceEntry = findProductPrice(productName);
            const purchasePriceInput = el.manualSellModal.querySelector('#salePurchasePriceModal');
            if (priceEntry) { purchasePriceInput.value = getSafeFloat(priceEntry.cost).toFixed(2); }
        });

        // Event delegation for Service Delivery Modal list
        el.serviceDeliveryList.addEventListener('click', e => { 
            const deliverButton = e.target.closest('.deliver-service-btn'); 
            if (deliverButton) { 
                handleActionWithButton(deliverButton, () => { 
                    closeModal(el.serviceDeliveryModal); 
                    completeService(deliverButton.dataset.id); 
                }); 
            } 
        });
        
        // Event delegation for Service Delivery Modal status change
        el.serviceDeliveryList.addEventListener('change', e => { 
            if(e.target.matches('.delivery-status-select')) { 
                const row = e.target.closest('.grid'); 
                if (!row) return; 
                const deliverButton = row.querySelector('.deliver-service-btn'); 
                if (!deliverButton) return; 
                
                // Enable/Disable "Teslim Et" button based on status
                if(e.target.value === serviceStatuses.READY.label){ 
                    deliverButton.disabled = false; 
                    deliverButton.classList.replace('btn-disabled','btn-success'); 
                } else { 
                    deliverButton.disabled = true; 
                    deliverButton.classList.replace('btn-success','btn-disabled'); 
                } 
                // Update status in Firestore
                updateDocument(`services/${e.target.dataset.id}`, {status: e.target.value, lastUpdated: Timestamp.now()}); 
            } 
        });
        
        // Shop Shortages Panel Actions
        el.addShortageForm.addEventListener('submit', (e) => {
            e.preventDefault();
            handleActionWithButton(e.submitter, async () => {
                const name = el.addShortageForm.shortageItemName.value.trim();
                const quantity = parseInt(el.addShortageForm.shortageItemQuantity.value);
                const priceTL = getSafeFloat(el.addShortageForm.shortageItemPriceTL.value);
                const priceUSD = getSafeFloat(el.addShortageForm.shortageItemPriceUSD.value);
                
                if (name && quantity > 0) {
                    // Check if item already exists (case-insensitive)
                    const existingItem = shopShortages.find(item => item.name.toLowerCase() === name.toLowerCase());
                    
                    if (existingItem) {
                        showToast(`"${sanitizeHTML(name)}" zaten listede mevcut. MiktarÄ± gÃ¼ncelleyebilir veya silebilirsiniz.`, 'info'); // Changed to info
                        // Optionally update quantity here instead of throwing error
                        // await updateDocument(`shopShortages/${existingItem.id}`, { quantity: existingItem.quantity + quantity, lastUpdated: Timestamp.now() }, `"${sanitizeHTML(name)}" miktarÄ± gÃ¼ncellendi.`);
                        throw new Error("Item exists"); // Still throw to prevent form reset and keep button disabled briefly
                    } else {
                        const shortageData = { 
                            name: name, 
                            quantity: quantity, 
                            priceTL: priceTL,
                            priceUSD: priceUSD,
                            createdAt: Timestamp.now() 
                        };
                        await addDocument('shopShortages', shortageData, "Eksik Ã¼rÃ¼n listeye eklendi.");
                    }
                    e.target.reset();
                } else {
                    showToast('LÃ¼tfen Ã¼rÃ¼n adÄ± ve geÃ§erli bir miktar girin (Adet > 0).', 'error');
                    throw new Error("Validation failed");
                }
            });
        });

        // Product Prices Panel Actions
        el.addProductPriceForm.addEventListener('submit', (e) => {
            e.preventDefault();
            handleActionWithButton(e.submitter, async () => {
                const name = el.addProductPriceForm.productPriceName.value.trim();
                const cost = getSafeFloat(el.addProductPriceForm.productPriceCost.value);
                const currency = el.addProductPriceForm.productPriceCurrency.value;

                if (name && cost >= 0) {
                    // Check if item already exists (case-insensitive)
                    const existingItem = productPrices.find(item => item.name.toLowerCase() === name.toLowerCase());
                    if (existingItem) {
                        showToast(`"${sanitizeHTML(name)}" zaten listede mevcut.`, 'info');
                         throw new Error("Item exists"); // Still throw to prevent form reset
                    } else {
                        await addDocument('productPrices', { 
                            name: name, 
                            cost: cost, 
                            currency: currency,
                            createdAt: Timestamp.now() 
                        }, "ÃœrÃ¼n fiyatÄ± listeye eklendi.");
                    }
                    e.target.reset();
                    // Reset sonrasÄ± dÃ¶nÃ¼ÅŸÃ¼m bilgisini temizle
                    if (el.productPriceConversion) {
                        el.productPriceConversion.innerHTML = '';
                    }
                } else {
                    showToast('LÃ¼tfen Ã¼rÃ¼n adÄ± ve geÃ§erli bir maliyet girin (Maliyet >= 0).', 'error');
                    throw new Error("Validation failed");
                }
            });
        });

        // Settings Panel Event Listeners
        if (el.saveProfileBtn) {
            el.saveProfileBtn.addEventListener('click', (e) => {
                handleActionWithButton(e.target, async () => {
                    saveSettings();
                });
            });
        }

        if (el.saveSettingsBtn) {
            el.saveSettingsBtn.addEventListener('click', (e) => {
                handleActionWithButton(e.target, async () => {
                    saveSettings();
                });
            });
        }

        if (el.updateRatesBtn) {
            el.updateRatesBtn.addEventListener('click', (e) => {
                handleActionWithButton(e.target, async () => {
                    updateExchangeRates();
                });
            });
        }

        if (el.fetchRatesBtn) {
            el.fetchRatesBtn.addEventListener('click', (e) => {
                handleActionWithButton(e.target, async () => {
                    await fetchExchangeRates();
                });
            });
        }

        if (el.exportDataBtn) {
            el.exportDataBtn.addEventListener('click', (e) => {
                handleActionWithButton(e.target, async () => {
                    exportAllData();
                });
            });
        }

        if (el.importDataBtn) {
            el.importDataBtn.addEventListener('click', (e) => {
                handleActionWithButton(e.target, async () => {
                    const file = el.importDataFile?.files[0];
                    importAllData(file);
                });
            });
        }

        if (el.clearAllDataBtn) {
            el.clearAllDataBtn.addEventListener('click', (e) => {
                handleActionWithButton(e.target, async () => {
                    await clearAllData();
                });
            });
        }

        if (el.resetAppBtn) {
            el.resetAppBtn.addEventListener('click', (e) => {
                handleActionWithButton(e.target, async () => {
                    resetApplication();
                });
            });
        }

        // Event delegation for Product Prices Log (edit, delete buttons)
        el.shortagesLog.addEventListener('click', e => {
            const deleteBtn = e.target.closest('.delete-shortage-btn');
            if (deleteBtn) {
                openDeleteConfirmModal('shortage', deleteBtn.dataset.id, deleteBtn.dataset.name);
            }
        });
        
        el.downloadShortagesPdfBtn.addEventListener('click', (e) => {
            handleActionWithButton(e.target, async () => {
                downloadShortagesAsPDF();
            });
        });

        el.downloadCashAdvancesPdfBtn.addEventListener('click', (e) => {
            handleActionWithButton(e.target, async () => {
                downloadCashAdvancesAsPDF();
            });
        });

        el.productPricesLog.addEventListener('click', e => {
            const editButton = e.target.closest('.edit-product-price-btn');
            const deleteButton = e.target.closest('.delete-product-price-btn');

            if (editButton) {
                openEditProductPriceModal(editButton.dataset.id);
            } else if (deleteButton) {
                openDeleteConfirmModal('productPrice', deleteButton.dataset.id, deleteButton.dataset.name);
            }
        });

        // Daily Report Panel Actions
        el.reportDate.addEventListener('change', (e) => setReportDateAndRefresh(e.target.value));
        el.addExpenseBtn.addEventListener('click', () => openModal(el.addExpenseModal));
        
        // BugÃ¼nÃ¼n Ä°ÅŸlemleri panelindeki Gider Ekle butonu iÃ§in event listener
        const addExpenseTodayBtn = document.getElementById('addExpenseTodayBtn');
        if (addExpenseTodayBtn) {
            addExpenseTodayBtn.addEventListener('click', () => {
                // BugÃ¼nkÃ¼ tarihi otomatik olarak set et
                el.reportDate.value = getLocalYYYYMMDD();
                openModal(el.addExpenseModal);
            });
        }
        
        // Daily Report Income Filter Buttons
        if (el.dailyReportIncomeFilterContainer) {
            el.dailyReportIncomeFilterContainer.addEventListener('click', (e) => {
                const button = e.target.closest('button[data-filter]');
                if (button) {
                    currentDailyReportIncomeFilter = button.dataset.filter;
                    el.dailyReportIncomeFilterContainer.querySelectorAll('button').forEach(btn => {
                        btn.classList.remove('btn-primary');
                        btn.classList.add('btn-secondary');
                    });
                    button.classList.add('btn-primary');
                    button.classList.remove('btn-secondary');

                    if (el.dailyReportPanel.style.display !== 'none') {
                        renderDailyReport(el.reportDate.value);
                    }
                }
            });
        }

        el.addExpenseForm.addEventListener('submit', (e) => { 
            e.preventDefault(); 
            handleActionWithButton(e.submitter, async () => { 
                const description = e.target.expenseDescription.value.trim(); 
                const amount = getSafeFloat(e.target.expenseAmount.value); 
                
                if (description && amount > 0) { 
                    const expenseDate = new Date(el.reportDate.value); 
                    if(isNaN(expenseDate)) { 
                        showToast('LÃ¼tfen geÃ§erli bir rapor tarihi seÃ§in.', 'error'); 
                        throw new Error("Invalid date"); 
                    } 
                    // Set time to noon to avoid timezone issues with start/end of day queries
                    expenseDate.setHours(12,0,0,0); 
                    
                    await addDocument('expenses',{
                        description: description,
                        amount: amount,
                        date: Timestamp.fromDate(expenseDate),
                        createdAt: Timestamp.now() // OluÅŸturulma tarihi ekle
                    },'Gider eklendi.'); 
                    
                    e.target.reset(); 
                    closeModal(el.addExpenseModal); 
                    
                    // SADECE GÃœNLÃœK RAPOR PANELÄ° AÃ‡IKsa RE-RENDER ET
                    if (el.dailyReportPanel && !el.dailyReportPanel.classList.contains('hidden')) {
                        await renderDailyReport(el.reportDate.value); 
                    }
                } else {
                    showToast('Gider aÃ§Ä±klamasÄ± ve geÃ§erli bir tutar (Tutar > 0) girin.', 'error'); 
                    throw new Error("Validation failed");
                } 
            }); 
        });
        
        // Debt Panel Actions
        el.addWholesalerForm.addEventListener('submit', (e) => { 
            e.preventDefault(); 
            handleActionWithButton(e.submitter, async () => { 
                const name = el.newWholesalerName.value.trim(); 
                // Check for duplicate wholesaler name (case-insensitive)
                if(name && !wholesalers.find(w=>w.name.toLowerCase()===name.toLowerCase())){
                    await addDocument('wholesalers',{name:name, balanceUSD: 0, createdAt: Timestamp.now()}, `${name} eklendi.`);
                    e.target.reset();
                    closeModal(el.addWholesalerModal);
                } else {
                    showToast('ToptancÄ± mevcut veya isim geÃ§ersiz.','error'); 
                    throw new Error("Validation failed");
                } 
            }); 
        });
        
        // Event delegation for Wholesaler List (view details button)
        el.wholesalerListContainer.addEventListener('click', e => { 
            const button = e.target.closest('.view-wholesaler-details-btn'); 
            if (button) {
                 // Pass id and name to render detail view
                 renderWholesalerDetail({id: button.dataset.id, name: button.dataset.name}); 
            } 
        });
        
        // Transaction Modal form submission (Debt or Payment)
        el.addTransactionForm.addEventListener('submit', (e) => { 
            e.preventDefault(); 
            handleActionWithButton(e.submitter, async () => { 
                const wholesalerName = el.transactionWholesalerName.value; 
                const wholesaler = wholesalers.find(w => w.name === wholesalerName); 
                if (!wholesaler) throw new Error("ToptancÄ± bulunamadÄ±."); 
                
                const type = el.transactionType.value; 
                let data = { 
                    type: type, 
                    wholesalerName: wholesalerName, 
                    description: el.transactionDescription.value.trim(), 
                    createdAt: Timestamp.now() 
                }; 
                
                let amountToIncrement = 0; // Amount to add/subtract from wholesaler balance (in USD)
                
                if (type === 'debt') { 
                    const amount = getSafeFloat(el.transactionAmountDebt.value); 
                    if (amount <= 0) throw new Error('GeÃ§erli bir borÃ§ tutarÄ± (USD) girin.'); 
                    data.amount = amount; 
                    data.currency = 'USD'; 
                    if (!data.description) data.description = 'BorÃ§ KaydÄ±'; 
                    amountToIncrement = amount; 
                } else { // type === 'payment'
                    const amountTRY = getSafeFloat(el.transactionAmountPayment.value); 
                    const rate = getSafeFloat(el.exchangeRate.value); 
                    if (amountTRY <= 0 || rate <= 0) throw new Error('GeÃ§erli bir Ã¶deme tutarÄ± (TL) ve kur oranÄ± girin.'); 
                    
                    // Calculate USD equivalent for balance update
                    data.amount = getSafeFloat((amountTRY / rate).toFixed(2)); 
                    data.paymentAmount = amountTRY; 
                    data.paymentCurrency = 'TRY'; 
                    data.exchangeRateUsed = rate; 
                    if (!data.description) data.description = 'Ã–deme'; 
                    amountToIncrement = -data.amount; // Subtract USD equivalent from balance
                } 
                
                const batch = writeBatch(db); 
                const wholesalerRef = doc(db, getPath(`wholesalers/${wholesaler.id}`)); 
                batch.update(wholesalerRef, { balanceUSD: increment(amountToIncrement) }); 
                batch.set(doc(collection(db, getPath('transactions'))), data); 
                
                await batch.commit(); 
                showToast('Ä°ÅŸlem kaydedildi ve bakiye gÃ¼ncellendi.', 'success'); 
                closeModal(el.addTransactionModal); 
            }); 
        });
        
        // Update USD equivalent display when payment amount or rate changes
        [el.transactionAmountPayment, el.exchangeRate].forEach(input => { 
            if(input) input.addEventListener('input', updateUsdEquivalent); 
        });
        
        // Event delegation for Sales Log (edit, delete buttons)
        el.salesLog.addEventListener('click', (e)=>{
            const editButton = e.target.closest('.edit-sale-btn'); 
            const deleteButton = e.target.closest('.delete-sale-btn'); 
            if(editButton){
                openEditSaleModal(editButton.dataset.id);
            } 
            if(deleteButton){
                openDeleteConfirmModal('sale', deleteButton.dataset.id, deleteButton.dataset.name);
            }
        });
        
        // Edit Sale Modal form submission
        el.editSaleForm.addEventListener('submit', (e) => handleActionWithButton(e.submitter, () => handleUpdateSale(e)));
        
        // Edit Phone Modal form submission
        el.editPhoneForm.addEventListener('submit', (e) => handleActionWithButton(e.submitter, () => handleUpdatePhone(e)));
        
        // Edit Service Modal form submission
        el.editServiceForm.addEventListener('submit', (e) => handleActionWithButton(e.submitter, () => handleUpdateService(e)));
        
        // Edit Product Price Modal form submission
        el.editProductPriceForm.addEventListener('submit', (e) => handleActionWithButton(e.submitter, () => handleUpdateProductPrice(e)));
        
        // Cash Advance Form submission
        el.addCashAdvanceForm.addEventListener('submit', (e) => {
            e.preventDefault();
            handleActionWithButton(e.submitter, async () => {
                const personName = el.advancePersonName.value.trim();
                const amount = getSafeFloat(el.advanceAmount.value);
                const description = el.advanceDescription.value.trim();
                const date = el.advanceDate.value;
                
                if (!personName) throw new Error('KiÅŸi adÄ± gereklidir.');
                if (amount <= 0) throw new Error('GeÃ§erli bir tutar girin.');
                if (!date) throw new Error('Tarih seÃ§imi gereklidir.');
                
                if (selectedPersonForAdvance) {
                    // SeÃ§ili kiÅŸi modu - doÄŸrudan ek avans ekle
                    const existingAdvanceQuery = query(
                        collection(db, getPath('cashAdvances')), 
                        where('personName', '==', personName)
                    );
                    const existingAdvances = await getDocs(existingAdvanceQuery);
                    
                    if (!existingAdvances.empty) {
                        const existingDoc = existingAdvances.docs[0];
                        const existingData = existingDoc.data();
                        const newTotalAmount = getSafeFloat(existingData.totalAmount || existingData.amount) + amount;
                        
                        // Ana avans kaydÄ±nÄ± gÃ¼ncelle
                        await updateDoc(doc(db, getPath(`cashAdvances/${existingDoc.id}`)), {
                            totalAmount: newTotalAmount,
                            lastAdvanceDate: date,
                            lastAdvanceAmount: amount,
                            lastAdvanceDescription: description || 'Ek avans',
                            updatedAt: Timestamp.now(),
                            advanceCount: (existingData.advanceCount || 1) + 1
                        });
                        
                        // Avans geÃ§miÅŸine kayÄ±t ekle
                        await addDoc(collection(db, getPath('cashAdvanceHistory')), {
                            personName: personName,
                            amount: amount,
                            description: description || 'Ek avans',
                            date: date,
                            createdAt: Timestamp.now(),
                            parentAdvanceId: existingDoc.id
                        });
                        
                        showToast(`${personName} iÃ§in ek avans eklendi. Toplam: ${formatCurrency(newTotalAmount, 'TL')}`, 'success');
                        exitPersonAdvanceMode();
                    } else {
                        throw new Error('SeÃ§ili kiÅŸi iÃ§in avans kaydÄ± bulunamadÄ±!');
                    }
                } else {
                    // Normal mod - yeni kiÅŸi veya mevcut kiÅŸi kontrolÃ¼
                    const existingAdvanceQuery = query(
                        collection(db, getPath('cashAdvances')), 
                        where('personName', '==', personName)
                    );
                    const existingAdvances = await getDocs(existingAdvanceQuery);
                    
                    if (!existingAdvances.empty) {
                        // Mevcut kiÅŸi var - kullanÄ±cÄ±ya sor
                        const shouldAddToExisting = confirm(`${personName} iÃ§in zaten avans kaydÄ± var. Yeni avansÄ± mevcut kayda eklemek istiyor musunuz?\n\nEvet: Mevcut kayda ekle\nHayÄ±r: Yeni ayrÄ± kayÄ±t oluÅŸtur`);
                        
                        if (shouldAddToExisting) {
                            const existingDoc = existingAdvances.docs[0];
                            const existingData = existingDoc.data();
                            const newTotalAmount = getSafeFloat(existingData.totalAmount || existingData.amount) + amount;
                            
                            await updateDoc(doc(db, getPath(`cashAdvances/${existingDoc.id}`)), {
                                totalAmount: newTotalAmount,
                                lastAdvanceDate: date,
                                lastAdvanceAmount: amount,
                                lastAdvanceDescription: description || 'Avans',
                                updatedAt: Timestamp.now(),
                                advanceCount: (existingData.advanceCount || 1) + 1
                            });
                            
                            await addDoc(collection(db, getPath('cashAdvanceHistory')), {
                                personName: personName,
                                amount: amount,
                                description: description || 'Avans',
                                date: date,
                                createdAt: Timestamp.now(),
                                parentAdvanceId: existingDoc.id
                            });
                            
                            showToast(`${personName} iÃ§in avans gÃ¼ncellendi. Toplam: ${formatCurrency(newTotalAmount, 'TL')}`, 'success');
                        } else {
                            // AyrÄ± kayÄ±t oluÅŸtur (eski sistem)
                            await addDoc(collection(db, getPath('cashAdvances')), {
                                personName: personName,
                                amount: amount,
                                description: description || 'Avans',
                                date: date,
                                createdAt: Timestamp.now()
                            });
                            showToast(`${personName} iÃ§in ayrÄ± avans kaydÄ± oluÅŸturuldu.`, 'success');
                        }
                    } else {
                        // Yeni kiÅŸi
                        const newAdvanceRef = await addDoc(collection(db, getPath('cashAdvances')), {
                            personName: personName,
                            totalAmount: amount,
                            lastAdvanceDate: date,
                            lastAdvanceAmount: amount,
                            lastAdvanceDescription: description || 'Avans',
                            createdAt: Timestamp.now(),
                            updatedAt: Timestamp.now(),
                            advanceCount: 1
                        });
                        
                        await addDoc(collection(db, getPath('cashAdvanceHistory')), {
                            personName: personName,
                            amount: amount,
                            description: description || 'Avans',
                            date: date,
                            createdAt: Timestamp.now(),
                            parentAdvanceId: newAdvanceRef.id
                        });
                        
                        showToast(`${personName} iÃ§in yeni avans kaydÄ± oluÅŸturuldu.`, 'success');
                    }
                }
                
                // Form reset ve cleanup
                el.addCashAdvanceForm.reset();
                el.advanceDate.value = getLocalYYYYMMDD(); // BugÃ¼nÃ¼n tarihini geri set et
                
                // EÄŸer person mode'daysa Ã§Ä±k
                if (selectedPersonForAdvance) {
                    exitPersonAdvanceMode();
                }
            });
        });
        
        // Cash Advance Search and Filter Event Listeners
        if (el.cashAdvanceSearchInput) {
            el.cashAdvanceSearchInput.addEventListener('input', renderCashAdvancesLog);
        }
        if (el.cashAdvancePersonFilter) {
            el.cashAdvancePersonFilter.addEventListener('change', renderCashAdvancesLog);
        }
        if (el.cashAdvanceDateFilter) {
            el.cashAdvanceDateFilter.addEventListener('change', renderCashAdvancesLog);
        }
        
        // Cash Advances Log Event Delegation (delete, history, and person click buttons)
        if (el.cashAdvancesLog) {
            el.cashAdvancesLog.addEventListener('click', e => {
                const deleteButton = e.target.closest('.delete-cash-advance-btn');
                const historyButton = e.target.closest('.view-advance-history-btn');
                const personNameClick = e.target.closest('.add-advance-to-person');
                
                if (deleteButton) {
                    openDeleteConfirmModal('cashAdvance', deleteButton.dataset.id, deleteButton.dataset.name);
                }
                
                if (historyButton) {
                    showAdvanceHistory(historyButton.dataset.id, historyButton.dataset.name);
                }
                
                if (personNameClick) {
                    const personName = personNameClick.dataset.personName;
                    enterPersonAdvanceMode(personName);
                }
            });
        }
        
        // Cancel person mode button
        if (el.cancelPersonMode) {
            el.cancelPersonMode.addEventListener('click', exitPersonAdvanceMode);
        }
        
        // Event delegation for Transaction History (delete button)
        el.transactionHistory.addEventListener('click', e => { 
            const deleteButton = e.target.closest('.delete-transaction-btn'); 
            if(deleteButton){
                openDeleteConfirmModal('transaction', deleteButton.dataset.id, deleteButton.dataset.name);
            } 
        });
        
        // Event delegation for Daily Report Expense list (delete button)
        el.reportExpenseBody.addEventListener('click', e => { 
            const deleteButton = e.target.closest('.delete-expense-btn'); 
            if(deleteButton){
                openDeleteConfirmModal('expense', deleteButton.dataset.id, deleteButton.dataset.name);
            } 
        });
        
        // Advanced Report Panel Actions
        el.advReportRange.addEventListener('change', () => { 
            // Toggle visibility of custom date range inputs
            el.customDateRange.classList.toggle('hidden', el.advReportRange.value !== 'custom'); 
        });
        
        el.generateAdvReportBtn.addEventListener('click', (e) => handleActionWithButton(e.target, renderAdvancedReport));
        
        // Event delegation for Export buttons (Excel/CSV)
        el.appContent.addEventListener('click', e => { 
            const button = e.target.closest('.export-btn'); 
            if (button) { 
                exportTableToCSV(button.dataset.tableId, button.dataset.filename); 
            } 
        });
        
        // Modal Close Buttons and Overlay Click
        const modalCloseButtons = {
            'closeStockSellModalBtn':'stockSellModal',
            'closeServiceDeliveryModalBtn':'serviceDeliveryModal',
            'closeManualSellModalBtn':'manualSellModal',
            'cancelSellBtn':'sellConfirmModal',
            'cancelAddWholesaler':'addWholesalerModal',
            'cancelTransaction':'addTransactionModal',
            'cancelAddExpense':'addExpenseModal',
            'cancelEditSale':'editSaleModal',
            'cancelEditPhone':'editPhoneModal',
            'cancelEditService':'editServiceModal',
            'cancelDeleteBtn':'deleteConfirmGenericModal',
            'cancelEditProductPrice':'editProductPriceModal',
            'closeAdvanceHistoryModalBtn':'advanceHistoryModal'
        };
        
        Object.entries(modalCloseButtons).forEach(([btnId, modalId]) => { 
            const modal = document.getElementById(modalId); 
            const button = document.getElementById(btnId); 
            if(modal){ 
                // Close modal when clicking outside the modal content
                modal.addEventListener('click', (e) => { 
                    if (e.target === modal) closeModal(modal); 
                }); 
                // Close modal when clicking the designated close button
                if (button) button.addEventListener('click',()=>closeModal(modal)); 
            } 
        });
        
        // Wholesaler Panel Buttons
        el.addWholesalerBtn.addEventListener('click',()=>openModal(el.addWholesalerModal));
        el.backToWholesalersBtn.addEventListener('click',()=>{
            el.wholesalerDetailView.classList.add('hidden');
            el.wholesalerListView.classList.remove('hidden');
            currentWholesalerDetail={id:null,name:null}; // Clear detail state
        });
        el.deleteWholesalerBtn.addEventListener('click', (e) => {
             // Ensure currentWholesalerDetail is set before opening delete modal
             if (currentWholesalerDetail.id) {
                handleActionWithButton(e.target, () => openDeleteConfirmModal('wholesaler', currentWholesalerDetail.id, null));
             } else {
                 showToast("Silinecek toptancÄ± seÃ§ili deÄŸil.", "error");
             }
        });
        el.addDebtToWholesalerBtn.addEventListener('click',()=>openTransactionModal('debt',el.detailWholesalerName.textContent));
        el.addPaymentToWholesalerBtn.addEventListener('click',()=>openTransactionModal('payment',el.detailWholesalerName.textContent));
        
        // Sales History Panel Event Listeners
        if (el.salesHistoryLog) {
            el.salesHistoryLog.addEventListener('click', e => {
                const editButton = e.target.closest('.edit-sale-btn');
                const deleteButton = e.target.closest('.delete-sale-btn');
                
                if (editButton) {
                    openEditSaleModal(editButton.dataset.id);
                } else if (deleteButton) {
                    openDeleteConfirmModal('sale', deleteButton.dataset.id, deleteButton.dataset.name);
                }
            });
        }

        // History Filter and Navigation Event Listeners
        if (el.filterHistoryBtn) {
            el.filterHistoryBtn.addEventListener('click', () => {
                filterAndRenderSalesHistory();
            });
        }

        if (el.clearHistoryFilters) {
            el.clearHistoryFilters.addEventListener('click', () => {
                el.historyStartDate.value = '';
                el.historyEndDate.value = '';
                el.historyTypeFilter.value = 'all';
                el.historySearchInput.value = '';
                filterAndRenderSalesHistory();
            });
        }

        if (el.prevHistoryPage) {
            el.prevHistoryPage.addEventListener('click', () => {
                if (currentHistoryPage > 1) {
                    renderHistoryPage(currentHistoryPage - 1);
                }
            });
        }

        if (el.nextHistoryPage) {
            el.nextHistoryPage.addEventListener('click', () => {
                const totalPages = Math.ceil(filteredHistorySales.length / historyItemsPerPage);
                if (currentHistoryPage < totalPages) {
                    renderHistoryPage(currentHistoryPage + 1);
                }
            });
        }

        // Export History Button
        if (el.exportHistoryBtn) {
            el.exportHistoryBtn.addEventListener('click', () => {
                if (filteredHistorySales.length === 0) {
                    showToast('DÄ±ÅŸa aktarÄ±lacak veri bulunamadÄ±.', 'warning');
                    return;
                }
                
                // Create a temporary table for export
                const tempTable = document.createElement('table');
                tempTable.innerHTML = `
                    <thead>
                        <tr>
                            <th>Tarih</th>
                            <th>Saat</th>
                            <th>TÃ¼r</th>
                            <th>ÃœrÃ¼n/AÃ§Ä±klama</th>
                            <th>Ciro</th>
                            <th>Maliyet</th>
                            <th>KÃ¢r</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredHistorySales.map(sale => {
                            const typeMap = {
                                device: 'Cihaz SatÄ±ÅŸ',
                                service: 'Servis', 
                                accessory: 'Aksesuar'
                            };
                            const typeText = typeMap[sale.type] || 'DiÄŸer';
                            
                            return `
                                <tr>
                                    <td>${sale.date.toLocaleDateString('tr-TR')}</td>
                                    <td>${sale.date.toLocaleTimeString('tr-TR', {hour:'2-digit', minute:'2-digit'})}</td>
                                    <td>${typeText}</td>
                                    <td>${sale.productName}</td>
                                    <td>${formatCurrency(sale.totalRevenue, 'TRY')}</td>
                                    <td>${formatCurrency(sale.totalCost, 'TRY')}</td>
                                    <td>${formatCurrency(sale.totalProfit, 'TRY')}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                `;
                tempTable.id = 'tempHistoryTable';
                document.body.appendChild(tempTable);
                
                exportTableToCSV('tempHistoryTable', 'islem-gecmisi');
                document.body.removeChild(tempTable);
            });
        }

        // History Search Input
        if (el.historySearchInput) {
            el.historySearchInput.addEventListener('input', () => {
                // Debounce search to avoid too frequent updates
                clearTimeout(window.historySearchTimeout);
                window.historySearchTimeout = setTimeout(() => {
                    filterAndRenderSalesHistory();
                }, 300);
            });
        }
        
        // --- Firebase Helper Functions ---
        async function addDocument(collectionName, data, successMessage) { 
            if(!currentUserId) {
                 showToast("KullanÄ±cÄ± oturumu aÃ§Ä±k deÄŸil.", "error");
                 throw new Error("User not authenticated");
            }
            // Ensure profit is calculated for sales if not already present
            if (collectionName === 'sales' && data.totalProfit === undefined) { 
                 data.totalProfit = getSafeFloat(data.totalRevenue) - getSafeFloat(data.totalCost); 
            } 
            try { 
                await addDoc(collection(db, getPath(collectionName)), data); 
                if (successMessage) showToast(successMessage, 'success'); 
            } catch(e) { 
                console.error(`Firestore Add Error (${collectionName}):`, e); 
                showToast("Ekleme HatasÄ±: "+e.message, "error"); 
                throw e; 
            } 
        }
        
        async function updateDocument(documentPath, data, successMessage){
            if(!currentUserId) {
                 showToast("KullanÄ±cÄ± oturumu aÃ§Ä±k deÄŸil.", "error");
                 throw new Error("User not authenticated");
            }
            try{
                await updateDoc(doc(db,getPath(documentPath)),data);
                if(successMessage) showToast(successMessage,'success');
            }catch(e){
                console.error(`Firestore Update Error (${documentPath}):`, e);
                showToast("GÃ¼ncelleme HatasÄ±: "+e.message,"error"); 
                throw e;
            }
        }
        
        async function deleteDocument(documentPath, successMessage){
            if(!currentUserId) {
                 showToast("KullanÄ±cÄ± oturumu aÃ§Ä±k deÄŸil.", "error");
                 throw new Error("User not authenticated");
            }
            try{
                await deleteDoc(doc(db,getPath(documentPath)));
                if(successMessage) showToast(successMessage,'success');
            }catch(e){
                console.error(`Firestore Delete Error (${documentPath}):`, e);
                showToast("Silme HatasÄ±: "+e.message,"error"); 
                throw e;
            }
        }
        
        // --- UI Helper Functions ---
        function showToast(message, type = 'success'){
            const toast = document.createElement('div');
            toast.className = `fixed bottom-5 right-5 p-4 rounded-lg text-white shadow-lg z-50 transform transition-all duration-300 ease-out ${type === 'success' ? 'bg-emerald-600' : type === 'error' ? 'bg-red-600' : 'bg-blue-600'} opacity-0 translate-y-4`;
            toast.textContent = sanitizeHTML(message); // Sanitize message for security
            document.body.appendChild(toast);

            // Animate in
            requestAnimationFrame(() => { // Use requestAnimationFrame for smoother animation start
                toast.classList.add('opacity-100', 'translate-y-0');
                toast.classList.remove('opacity-0', 'translate-y-4');
            }); 

            // Animate out and remove
            setTimeout(() => {
                toast.classList.add('opacity-0', 'translate-y-4');
                toast.classList.remove('opacity-100', 'translate-y-0'); 
                toast.addEventListener('transitionend', () => {
                    if (toast.parentNode) toast.parentNode.removeChild(toast); // Check if still in DOM
                });
            }, 4000); // Show for 4 seconds
        }
        
        function openModal(modalElement) { 
            if (!modalElement) return; 
            previouslyFocusedElement = document.activeElement; // Store the element that was focused before opening the modal
            modalElement.classList.remove('hidden'); 
            // Find the first focusable element inside the modal and focus it
            const firstFocusable = modalElement.querySelector('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'); 
            if (firstFocusable) { 
                firstFocusable.focus(); 
            } 
        }
        
        function closeModal(modalElement) { 
            if (!modalElement) return; 
            modalElement.classList.add('hidden'); 
            // Restore focus to the element that was focused before the modal was opened
            if (previouslyFocusedElement) { 
                previouslyFocusedElement.focus(); 
            }
        }
        
        // Check if date input is supported by the browser and add placeholder if not
        function checkDateInputSupport() { 
            const testInput = document.createElement('input'); 
            testInput.type = 'date'; 
            if (testInput.type === 'text') { 
                document.querySelectorAll('input[type="date"]').forEach(dateInput => { 
                    dateInput.placeholder = 'YYYY-AA-GG'; 
                }); 
            } 
        }
        
        // --- Initialization ---
        async function initializeAppCore() { 
            // Initialize theme system first
            initializeTheme();
            
            // Cache the initial HTML structure of the advanced report placeholder
            advancedReportHTMLCache = document.getElementById('advReportContentPlaceholder').innerHTML; 
            
            checkDateInputSupport(); 
            
            // Fetch initial exchange rate and set up interval for updates
            await fetchExchangeRate(); 
            exchangeRateIntervalId = setInterval(fetchExchangeRate, 3600000); // Update every hour

            // Set up Firebase Auth state listener
            onAuthStateChanged(auth, user => { 
                if (user) { 
                    // User is signed in
                    if (currentUserId !== user.uid) { 
                        currentUserId = user.uid; 
                        // Hide login, show loading, hide app content
                        el.loginView.classList.add('hidden'); 
                        el.loadingScreen.classList.remove('hidden'); 
                        el.appContent.classList.add('hidden'); 
                        
                        // Setup Firestore listeners and wait for initial data sync
                        setupListeners(currentUserId).then(() => { 
                            // Hide loading, show app content
                            el.loadingScreen.classList.add('hidden'); 
                            el.appContent.classList.remove('hidden'); 
                            
                            // Set default date range for reports
                            const todayStr = getLocalYYYYMMDD(); 
                            const startOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1); 
                            el.advStartDate.value = getLocalYYYYMMDD(startOfMonth); 
                            el.advEndDate.value = todayStr; 
                            
                            // Set default date for cash advance form
                            if (el.advanceDate) {
                                el.advanceDate.value = todayStr;
                            } 
                            
                            // Setup currency converter input listener
                            if (el.usdToTryInput) {
                                el.usdToTryInput.addEventListener('input', updateCurrencyConverterDisplay);
                            }
                            if (el.tryToUsdInput) {
                                el.tryToUsdInput.addEventListener('input', updateCurrencyConverterDisplay);
                            }
                            updateCurrencyConverterDisplay(); // Initial display update
                            
                            // Setup auto currency conversion for shortage items
                            setupShortageAutoCurrencyConversion();
                            
                            // Set default date for cash advances form
                            if (el.advanceDate) {
                                el.advanceDate.value = todayStr;
                            }
                            
                            // Initialize cash tracker system
                            try {
                                initializeCashTracker();
                            } catch (cashTrackerError) {
                                console.warn("Kasa takip sistemi baÅŸlatÄ±lamadÄ±:", cashTrackerError);
                                // Don't fail the whole app if cash tracker fails
                            }

                            // Render the default active tab's content after initial data load
                            const activeTab = el.tabs.querySelector('.active')?.dataset.tab; 
                            if (activeTab === 'daily-report-panel') { setReportDateAndRefresh(todayStr); } 
                            else if (activeTab === 'reports-panel') renderAdvancedReport(); 
                            else if (activeTab === 'sold-phones-panel') loadAndRenderSoldPhonesLog(); 
                            else if (activeTab === 'shortages-panel') renderShopShortagesLog(); 
                            else if (activeTab === 'product-prices-panel') renderProductPricesLog();
                            else if (activeTab === 'debt-panel') renderWholesalerList();
                            else if (activeTab === 'service-history-panel') renderServiceHistoryLog();
                            else if (activeTab === 'phone-stock-panel') renderAnalysisView();
                            // sales-panel and service-panel are rendered by their respective listeners
                            
                        }).catch(err => { 
                            console.error("BaÅŸlangÄ±Ã§ veri senkronizasyonu baÅŸarÄ±sÄ±z:", err); 
                            el.loadingScreen.classList.add('hidden'); 
                            showToast("BaÅŸlangÄ±Ã§ verileri yÃ¼klenemedi.", "error"); 
                            // Optionally force logout or show a retry option
                            signOut(auth); 
                        }); 
                    } 
                } else { 
                    // User is signed out
                    cleanupAndShowLogin(); 
                } 
            }); 
        }
        
        // === KASA TAKÄ°P SÄ°STEMÄ° JAVASCRIPT FONKSÄ°YONLARI ===
        
        // Kasa takip panelini baÅŸlat
        function initializeCashTracker() {
            try {
                loadCashTrackerData();
                setupCashTrackerEventListeners();
                updateCashTrackerDisplay();
            } catch (error) {
                console.error("Kasa takip sistemi baÅŸlatma hatasÄ±:", error);
                // Fallback - reset to empty state if there's an error
                resetDailyCashTracker();
            }
        }
        
        // Kasa verilerini yÃ¼kle
        function loadCashTrackerData() {
            const today = getLocalYYYYMMDD();
            loadCashTrackerDataForDate(today);
        }
        
        // Belirli tarih iÃ§in kasa verilerini yÃ¼kle
        function loadCashTrackerDataForDate(date) {
            const savedData = localStorage.getItem(`cashTracker_${date}`);
            if (savedData) {
                cashTracker = { ...JSON.parse(savedData), date: date };
            } else {
                // SeÃ§ilen tarih iÃ§in veri yok, boÅŸ baÅŸlat
                cashTracker = {
                    dailyOpening: 0,
                    wholesalerPayments: [],
                    realCashCount: 0,
                    lastCalculation: null,
                    date: date
                };
            }
        }
        
        // GÃ¼nlÃ¼k kasa verilerini sÄ±fÄ±rla
        function resetDailyCashTracker() {
            cashTracker = {
                dailyOpening: 0,
                wholesalerPayments: [],
                realCashCount: 0,
                lastCalculation: null,
                date: getLocalYYYYMMDD()
            };
            saveCashTrackerData();
        }
        
        // Kasa verilerini kaydet
        function saveCashTrackerData() {
            const currentDate = cashTracker.date || getLocalYYYYMMDD();
            localStorage.setItem(`cashTracker_${currentDate}`, JSON.stringify(cashTracker));
        }
        
        // Event listener'larÄ± ayarla
        function setupCashTrackerEventListeners() {
            // Check if cash tracker panel exists
            if (!el.cashTrackerPanel) {
                console.warn("Kasa takip paneli bulunamadÄ±, event listener'lar atlanÄ±yor");
                return;
            }
            
            // Sabah aÃ§Ä±lÄ±ÅŸ kaydetme
            const morningBtn = el.cashTrackerPanel.querySelector('#saveDailyOpeningBtn');
            const morningInput = el.cashTrackerPanel.querySelector('#dailyOpeningCash');
            if (morningBtn && morningInput) {
                morningBtn.addEventListener('click', () => {
                    const amount = parseFloat(morningInput.value) || 0;
                    if (amount >= 0) {
                        cashTracker.dailyOpening = amount;
                        saveCashTrackerData();
                        updateCashTrackerDisplay();
                        showToast(`Sabah aÃ§Ä±lÄ±ÅŸ kasasÄ±: ${amount.toLocaleString('tr-TR')} TL`, 'success');
                        morningInput.value = '';
                    } else {
                        showToast('GeÃ§erli bir tutar giriniz.', 'error');
                    }
                });
            }
            
            // ToptancÄ± Ã¶deme ekleme
            const addPaymentBtn = el.cashTrackerPanel.querySelector('#addWholesalerPaymentBtn');
            if (addPaymentBtn) {
                addPaymentBtn.addEventListener('click', openWholesalerPaymentModal);
            }
            
            // AkÅŸam sayÄ±m kaydetme
            const eveningBtn = el.cashTrackerPanel.querySelector('#calculateCashDifferenceBtn');
            const eveningInput = el.cashTrackerPanel.querySelector('#realCashCount');
            if (eveningBtn && eveningInput) {
                eveningBtn.addEventListener('click', () => {
                    const amount = parseFloat(eveningInput.value) || 0;
                    if (amount >= 0) {
                        cashTracker.realCashCount = amount;
                        saveCashTrackerData();
                        calculateCashBalance();
                        updateCashTrackerDisplay();
                        showToast(`AkÅŸam sayÄ±mÄ±: ${amount.toLocaleString('tr-TR')} TL`, 'success');
                    } else {
                        showToast('GeÃ§erli bir tutar giriniz.', 'error');
                    }
                });
            }
            
            // Kasa kontrolÃ¼
            const checkBtn = el.cashTrackerPanel.querySelector('#calculateCashDifferenceBtn');
            if (checkBtn) {
                checkBtn.addEventListener('click', calculateCashBalance);
            }
            
            // Yeni gÃ¼n baÅŸlatma
            const newDayBtn = el.cashTrackerPanel.querySelector('#startNewDayBtn');
            if (newDayBtn) {
                newDayBtn.addEventListener('click', confirmStartNewDay);
            }
            
            // Tarih seÃ§imi
            const dateInput = el.cashTrackerPanel.querySelector('#cashTrackerDate');
            const loadDateBtn = el.cashTrackerPanel.querySelector('#loadSelectedDateBtn');
            if (dateInput && loadDateBtn) {
                // Set today as default
                dateInput.value = getLocalYYYYMMDD();
                
                loadDateBtn.addEventListener('click', () => {
                    const selectedDate = dateInput.value;
                    if (selectedDate) {
                        loadCashTrackerDataForDate(selectedDate);
                        updateCashTrackerDisplay();
                        showToast(`${selectedDate} tarihi yÃ¼klendi.`, 'info');
                    }
                });
                
                // Also load when date changes
                dateInput.addEventListener('change', () => {
                    const selectedDate = dateInput.value;
                    if (selectedDate) {
                        loadCashTrackerDataForDate(selectedDate);
                        updateCashTrackerDisplay();
                    }
                });
            }
        }
        
        // ToptancÄ± Ã¶deme modalÄ±nÄ± aÃ§
        function openWholesalerPaymentModal() {
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="card w-full max-w-md relative">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-slate-800">ToptancÄ± Ã–deme Ekle</h3>
                        <button type="button" class="text-2xl font-bold text-slate-500 hover:text-slate-800" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label for="wholesalerName" class="block text-sm font-medium text-slate-700 mb-1">ToptancÄ± AdÄ±:</label>
                            <input type="text" id="wholesalerName" class="input-field" placeholder="ToptancÄ± adÄ±nÄ± giriniz" required>
                        </div>
                        <div>
                            <label for="paymentAmount" class="block text-sm font-medium text-slate-700 mb-1">Ã–deme TutarÄ± (TL):</label>
                            <input type="number" id="paymentAmount" class="input-field" min="0" step="0.01" placeholder="0.00" required>
                        </div>
                        <div>
                            <label for="paymentStatus" class="block text-sm font-medium text-slate-700 mb-1">Durum:</label>
                            <select id="paymentStatus" class="input-field">
                                <option value="pending">Beklemede</option>
                                <option value="reserved">KÃ¶ÅŸeye AyrÄ±ldÄ±</option>
                                <option value="paid">Ã–dendi</option>
                            </select>
                        </div>
                        <div>
                            <label for="paymentNote" class="block text-sm font-medium text-slate-700 mb-1">Not:</label>
                            <textarea id="paymentNote" class="input-field" placeholder="Ä°steÄŸe baÄŸlÄ± not..." rows="2"></textarea>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-4 mt-6">
                        <button type="button" class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ä°ptal</button>
                        <button type="button" class="btn btn-primary" onclick="addWholesalerPayment()">Ekle</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.style.display = 'flex';
            modal.querySelector('#wholesalerName').focus();
        }
        
        // ToptancÄ± Ã¶deme ekle
        function addWholesalerPayment() {
            const modal = document.querySelector('.modal-overlay:last-child');
            const name = modal.querySelector('#wholesalerName').value.trim();
            const amount = parseFloat(modal.querySelector('#paymentAmount').value) || 0;
            const status = modal.querySelector('#paymentStatus').value;
            const note = modal.querySelector('#paymentNote').value.trim();
            
            if (!name || amount <= 0) {
                showToast('ToptancÄ± adÄ± ve geÃ§erli bir tutar giriniz.', 'error');
                return;
            }
            
            const payment = {
                id: Date.now().toString(),
                name,
                amount,
                status,
                note,
                timestamp: new Date().toISOString(),
                date: getLocalYYYYMMDD()
            };
            
            cashTracker.wholesalerPayments.push(payment);
            saveCashTrackerData();
            updateCashTrackerDisplay();
            modal.remove();
            
            const statusText = {
                'pending': 'beklemede',
                'reserved': 'kÃ¶ÅŸeye ayrÄ±ldÄ±',
                'paid': 'Ã¶dendi'
            };
            
            showToast(`${name} - ${amount.toLocaleString('tr-TR')} TL (${statusText[status]}) eklendi.`, 'success');
        }
        
        // Kasa dengesini hesapla
        function calculateCashBalance() {
            const morningCash = cashTracker.dailyOpening;
            const todaySales = getTodayCashSales();
            const todayServices = getTodayCashServices();
            const paidPayments = getPaidWholesalerPayments();
            const reservedPayments = getReservedWholesalerPayments();
            
            const expectedCash = morningCash + todaySales + todayServices - paidPayments;
            const availableCash = expectedCash - reservedPayments;
            const realCash = cashTracker.realCashCount;
            
            const difference = realCash - expectedCash;
            const availableDifference = realCash - availableCash;
            
            cashTracker.lastCalculation = {
                morningCash,
                todaySales,
                todayServices,
                paidPayments,
                reservedPayments,
                expectedCash,
                availableCash,
                realCash,
                difference,
                availableDifference,
                timestamp: new Date().toISOString()
            };
            
            saveCashTrackerData();
            updateCashTrackerDisplay();
            
            // SonuÃ§ bildirimi
            let status = 'info';
            let message = '';
            
            if (Math.abs(difference) < 1) {
                status = 'success';
                message = 'âœ… Kasa dengede!';
            } else if (difference > 0) {
                status = 'warning';
                message = `âš ï¸ Kasa fazla: +${difference.toLocaleString('tr-TR')} TL`;
            } else {
                status = 'error';
                message = `âŒ Kasa aÃ§Ä±k: ${Math.abs(difference).toLocaleString('tr-TR')} TL`;
            }
            
            showToast(message, status);
        }
        
        // SeÃ§ili tarihte nakit satÄ±ÅŸlarÄ± getir
        function getTodayCashSales() {
            // Use todaysSales array if viewing today, otherwise calculate from sales
            const selectedDate = cashTracker.date || getLocalYYYYMMDD();
            
            if (selectedDate === getLocalYYYYMMDD()) {
                // If viewing today, use todaysSales array
                if (!todaysSales || !Array.isArray(todaysSales)) return 0;
                return todaysSales.filter(sale => 
                    sale.paymentMethod === 'Nakit'
                ).reduce((total, sale) => total + (sale.totalPrice || 0), 0);
            } else {
                // For other dates, we can't get sales data as we don't have historical sales
                // This is a limitation - only today's sales are loaded
                return 0;
            }
        }
        
        // SeÃ§ili tarihte nakit servis Ã¶demelerini getir
        function getTodayCashServices() {
            // For historical dates, we can't get service data
            const selectedDate = cashTracker.date || getLocalYYYYMMDD();
            
            if (selectedDate === getLocalYYYYMMDD()) {
                // If viewing today, use services array
                if (!services || !Array.isArray(services)) return 0;
                return services.filter(service => 
                    service.deliveryDate && 
                    service.deliveryDate.toDate().toLocaleDateString('tr-TR') === new Date().toLocaleDateString('tr-TR') &&
                    service.paymentMethod === 'Nakit'
                ).reduce((total, service) => total + (service.price || 0), 0);
            } else {
                // For other dates, return 0 as historical data is not available
                return 0;
            }
        }
        
        // Ã–denen toptancÄ± Ã¶demelerini getir
        function getPaidWholesalerPayments() {
            return cashTracker.wholesalerPayments
                .filter(payment => payment.status === 'paid')
                .reduce((total, payment) => total + payment.amount, 0);
        }
        
        // KÃ¶ÅŸeye ayrÄ±lan Ã¶demeleri getir
        function getReservedWholesalerPayments() {
            return cashTracker.wholesalerPayments
                .filter(payment => payment.status === 'reserved')
                .reduce((total, payment) => total + payment.amount, 0);
        }
        
        // Kasa takip ekranÄ±nÄ± gÃ¼ncelle
        function updateCashTrackerDisplay() {
            const panel = el.cashTrackerPanel;
            if (!panel) {
                console.warn("Kasa takip paneli bulunamadÄ±, display gÃ¼ncellemesi atlanÄ±yor");
                return;
            }
            
            // Tarih ve baÅŸlÄ±k bilgilerini gÃ¼ncelle
            updateCashTrackerHeader();
            
            // Sabah aÃ§Ä±lÄ±ÅŸ gÃ¶sterimi
            const morningDisplay = panel.querySelector('#morningCashDisplay');
            if (morningDisplay) {
                morningDisplay.textContent = `${cashTracker.dailyOpening.toLocaleString('tr-TR')} TL`;
            }
            
            // Otomatik hesaplamalar
            updateAutoCalculations();
            
            // ToptancÄ± Ã¶demeler listesi
            updateWholesalerPaymentsList();
            
            // AkÅŸam sayÄ±m ve sonuÃ§
            updateEveningResults();
            
            // HatÄ±rlatmalar
            updateReminders();
        }
        
        // Kasa takip baÅŸlÄ±k bilgilerini gÃ¼ncelle
        function updateCashTrackerHeader() {
            const panel = el.cashTrackerPanel;
            if (!panel) return;
            
            // SeÃ§ili tarih (cashTracker.date) veya bugÃ¼nkÃ¼ tarih
            const selectedDate = cashTracker.date || getLocalYYYYMMDD();
            const dateObj = new Date(selectedDate + 'T00:00:00');
            const dateStr = dateObj.toLocaleDateString('tr-TR', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            const currentDateEl = panel.querySelector('#currentCashDate');
            if (currentDateEl) {
                currentDateEl.textContent = dateStr;
            }
            
            // Tarih input'unu da gÃ¼ncelle
            const dateInput = panel.querySelector('#cashTrackerDate');
            if (dateInput) {
                dateInput.value = selectedDate;
            }
            
            // Son gÃ¼ncelleme zamanÄ±
            const lastUpdateEl = panel.querySelector('#lastUpdateTime');
            if (lastUpdateEl) {
                const currentTime = new Date();
                lastUpdateEl.textContent = `Son gÃ¼ncelleme: ${currentTime.toLocaleTimeString('tr-TR')}`;
            }
            
            // HÄ±zlÄ± kasa durumu
            const statusEl = panel.querySelector('#quickCashStatus');
            if (statusEl && cashTracker.lastCalculation) {
                const diff = cashTracker.lastCalculation.difference;
                if (Math.abs(diff) < 1) {
                    statusEl.innerHTML = '<span class="bg-green-500/30 text-green-100 px-3 py-1 rounded-full">âœ… Dengede</span>';
                } else if (diff > 0) {
                    statusEl.innerHTML = '<span class="bg-yellow-500/30 text-yellow-100 px-3 py-1 rounded-full">âš ï¸ Fazla</span>';
                } else {
                    statusEl.innerHTML = '<span class="bg-red-500/30 text-red-100 px-3 py-1 rounded-full">âŒ AÃ§Ä±k</span>';
                }
            } else if (statusEl) {
                statusEl.innerHTML = '<span class="bg-white/20 px-3 py-1 rounded-full">HesaplanmadÄ±</span>';
            }
            
            // BaÅŸlÄ±k Ã¶zet bilgileri
            const todaySales = getTodayCashSales();
            const todayServices = getTodayCashServices();
            const totalIncome = todaySales + todayServices;
            const pendingPayments = cashTracker.wholesalerPayments
                .filter(p => p.status === 'pending')
                .reduce((sum, p) => sum + p.amount, 0);
            
            const headerMorning = panel.querySelector('#headerMorningAmount');
            const headerIncome = panel.querySelector('#headerDailyIncome');
            const headerPending = panel.querySelector('#headerPendingPayments');
            const headerDifference = panel.querySelector('#headerCashDifference');
            
            if (headerMorning) headerMorning.textContent = `${cashTracker.dailyOpening.toLocaleString('tr-TR')} TL`;
            if (headerIncome) headerIncome.textContent = `${totalIncome.toLocaleString('tr-TR')} TL`;
            if (headerPending) headerPending.textContent = `${pendingPayments.toLocaleString('tr-TR')} TL`;
            
            if (headerDifference && cashTracker.lastCalculation) {
                const diff = cashTracker.lastCalculation.difference;
                const sign = diff >= 0 ? '+' : '';
                headerDifference.textContent = `${sign}${diff.toLocaleString('tr-TR')} TL`;
                headerDifference.className = `text-lg font-bold ${diff > 0 ? 'text-yellow-200' : diff < 0 ? 'text-red-200' : 'text-green-200'}`;
            } else if (headerDifference) {
                headerDifference.textContent = '--';
                headerDifference.className = 'text-lg font-bold';
            }
        }
        
        // Otomatik hesaplamalarÄ± gÃ¼ncelle
        function updateAutoCalculations() {
            const panel = el.cashTrackerPanel;
            const todaySales = getTodayCashSales();
            const todayServices = getTodayCashServices();
            const totalIncome = todaySales + todayServices;
            
            // HTML'deki mevcut ID'leri kullan
            const accessoryDisplay = panel.querySelector('#todayAccessorySales');
            const phoneDisplay = panel.querySelector('#todayPhoneSales');
            const serviceDisplay = panel.querySelector('#todayServiceIncome');
            
            // SatÄ±ÅŸlarÄ± kategorilere bÃ¶l (ÅŸimdilik toplam olarak gÃ¶ster)
            if (accessoryDisplay) accessoryDisplay.textContent = `+${(todaySales * 0.3).toLocaleString('tr-TR')} TL`;
            if (phoneDisplay) phoneDisplay.textContent = `+${(todaySales * 0.7).toLocaleString('tr-TR')} TL`;
            if (serviceDisplay) serviceDisplay.textContent = `+${todayServices.toLocaleString('tr-TR')} TL`;
        }
        
        // ToptancÄ± Ã¶demeler listesini gÃ¼ncelle
        function updateWholesalerPaymentsList() {
            const container = el.cashTrackerPanel.querySelector('#wholesalerPaymentsList');
            if (!container) return;
            
            if (cashTracker.wholesalerPayments.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-center py-4">HenÃ¼z toptancÄ± Ã¶demesi eklenmemiÅŸ.</p>';
                return;
            }
            
            const statusColors = {
                'pending': 'yellow',
                'reserved': 'blue', 
                'paid': 'green'
            };
            
            const statusTexts = {
                'pending': 'Beklemede',
                'reserved': 'KÃ¶ÅŸeye AyrÄ±ldÄ±',
                'paid': 'Ã–dendi'
            };
            
            let html = '<div class="space-y-3">';
            cashTracker.wholesalerPayments.forEach(payment => {
                const color = statusColors[payment.status];
                html += `
                    <div class="border border-${color}-200 bg-${color}-50 rounded-lg p-3">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center space-x-3">
                                <div>
                                    <div class="font-semibold text-slate-800">${payment.name}</div>
                                    <span class="inline-block px-2 py-1 text-xs rounded-full bg-${color}-200 text-${color}-800">${statusTexts[payment.status]}</span>
                                </div>
                            </div>
                            <div class="flex items-center space-x-3">
                                <div class="text-right">
                                    <div class="font-bold text-lg text-slate-800">${payment.amount.toLocaleString('tr-TR')} TL</div>
                                    <div class="text-xs text-slate-500">${new Date(payment.timestamp).toLocaleTimeString('tr-TR')}</div>
                                </div>
                                <div class="flex space-x-1">
                                    <button class="p-1 text-blue-600 hover:bg-blue-100 rounded" onclick="editWholesalerPayment('${payment.id}')" title="DÃ¼zenle">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                                        </svg>
                                    </button>
                                    <button class="p-1 text-red-600 hover:bg-red-100 rounded" onclick="deleteWholesalerPayment('${payment.id}')" title="Sil">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                        ${payment.note ? `<div class="mt-2 text-sm text-slate-600 italic">"${payment.note}"</div>` : ''}
                    </div>
                `;
            });
            html += '</div>';
            
            // Ã–zet
            const totalPending = cashTracker.wholesalerPayments.filter(p => p.status === 'pending').reduce((sum, p) => sum + p.amount, 0);
            const totalReserved = cashTracker.wholesalerPayments.filter(p => p.status === 'reserved').reduce((sum, p) => sum + p.amount, 0);
            const totalPaid = cashTracker.wholesalerPayments.filter(p => p.status === 'paid').reduce((sum, p) => sum + p.amount, 0);
            
            html += `
                <div class="mt-4 p-4 bg-slate-50 rounded-lg border">
                    <h4 class="font-semibold text-slate-700 mb-3 text-center">ðŸ“Š Ã–deme Durumu Ã–zeti</h4>
                    <div class="grid grid-cols-3 gap-4 text-center">
                        <div class="p-3 bg-yellow-100 rounded-lg">
                            <div class="text-xs text-yellow-700 font-medium">Beklemede</div>
                            <div class="text-lg font-bold text-yellow-800">${totalPending.toLocaleString('tr-TR')} TL</div>
                        </div>
                        <div class="p-3 bg-blue-100 rounded-lg">
                            <div class="text-xs text-blue-700 font-medium">KÃ¶ÅŸeye AyrÄ±ldÄ±</div>
                            <div class="text-lg font-bold text-blue-800">${totalReserved.toLocaleString('tr-TR')} TL</div>
                        </div>
                        <div class="p-3 bg-green-100 rounded-lg">
                            <div class="text-xs text-green-700 font-medium">Ã–dendi</div>
                            <div class="text-lg font-bold text-green-800">${totalPaid.toLocaleString('tr-TR')} TL</div>
                        </div>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
        }
        
        // AkÅŸam sonuÃ§larÄ±nÄ± gÃ¼ncelle
        function updateEveningResults() {
            const panel = el.cashTrackerPanel;
            const resultContainer = panel.querySelector('#cashResult');
            const resultCard = panel.querySelector('#cashResultCard');
            
            if (!cashTracker.lastCalculation) {
                if (resultCard) resultCard.classList.add('hidden');
                return;
            }
            
            // Show result card
            if (resultCard) resultCard.classList.remove('hidden');
            
            if (!resultContainer) return;
            
            const calc = cashTracker.lastCalculation;
            let statusClass = 'slate-200';
            let statusIcon = 'âš–ï¸';
            let statusBg = 'bg-slate-100';
            
            if (Math.abs(calc.difference) < 1) {
                statusClass = 'green-200';
                statusBg = 'bg-green-100';
                statusIcon = 'âœ…';
            } else if (calc.difference > 0) {
                statusClass = 'yellow-200';
                statusBg = 'bg-yellow-100';
                statusIcon = 'âš ï¸';
            } else {
                statusClass = 'red-200';
                statusBg = 'bg-red-100';
                statusIcon = 'âŒ';
            }
            
            resultContainer.innerHTML = `
                <div class="border-2 border-${statusClass} ${statusBg} rounded-lg p-4">
                    <div class="text-center border-b border-${statusClass} pb-3 mb-4">
                        <h5 class="text-lg font-bold">${statusIcon} Kasa Durumu</h5>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <table class="w-full text-sm">
                                <tr class="border-b"><td class="py-1">Sabah AÃ§Ä±lÄ±ÅŸ:</td><td class="text-right font-mono">${calc.morningCash.toLocaleString('tr-TR')} TL</td></tr>
                                <tr class="border-b"><td class="py-1 text-green-600">SatÄ±ÅŸ Geliri:</td><td class="text-right font-mono text-green-600">+${calc.todaySales.toLocaleString('tr-TR')} TL</td></tr>
                                <tr class="border-b"><td class="py-1 text-green-600">Servis Geliri:</td><td class="text-right font-mono text-green-600">+${calc.todayServices.toLocaleString('tr-TR')} TL</td></tr>
                                <tr class="border-b"><td class="py-1 text-red-600">Ã–denen BorÃ§lar:</td><td class="text-right font-mono text-red-600">-${calc.paidPayments.toLocaleString('tr-TR')} TL</td></tr>
                                <tr class="bg-blue-50"><td class="py-2 font-bold">Beklenen Kasa:</td><td class="text-right font-mono font-bold">${calc.expectedCash.toLocaleString('tr-TR')} TL</td></tr>
                            </table>
                        </div>
                        <div>
                            <table class="w-full text-sm">
                                <tr class="border-b"><td class="py-1 text-blue-600">KÃ¶ÅŸeye AyrÄ±lan:</td><td class="text-right font-mono text-blue-600">-${calc.reservedPayments.toLocaleString('tr-TR')} TL</td></tr>
                                <tr class="bg-blue-50"><td class="py-2 font-bold">KullanÄ±labilir:</td><td class="text-right font-mono font-bold">${calc.availableCash.toLocaleString('tr-TR')} TL</td></tr>
                                <tr class="bg-gray-50"><td class="py-2 font-bold">SayÄ±lan Kasa:</td><td class="text-right font-mono font-bold">${calc.realCash.toLocaleString('tr-TR')} TL</td></tr>
                                <tr class="bg-${statusClass}"><td class="py-2 font-bold">Fark:</td><td class="text-right font-mono font-bold">${calc.difference >= 0 ? '+' : ''}${calc.difference.toLocaleString('tr-TR')} TL</td></tr>
                            </table>
                        </div>
                    </div>
                    <div class="text-center mt-3 pt-3 border-t border-${statusClass}">
                        <small class="text-gray-500">Son gÃ¼ncelleme: ${new Date(calc.timestamp).toLocaleString('tr-TR')}</small>
                    </div>
                </div>
            `;
        }
        
        // HatÄ±rlatmalarÄ± gÃ¼ncelle
        function updateReminders() {
            const container = el.cashTrackerPanel.querySelector('#remindersList');
            const remindersCard = el.cashTrackerPanel.querySelector('#remindersCard');
            if (!container) return;
            
            const selectedDate = cashTracker.date || getLocalYYYYMMDD();
            const isToday = selectedDate === getLocalYYYYMMDD();
            
            // Sadece bugÃ¼n iÃ§in hatÄ±rlatmalar gÃ¶ster
            if (!isToday) {
                container.innerHTML = '<p class="text-muted text-center">ðŸ“… GeÃ§miÅŸ tarihler iÃ§in hatÄ±rlatma bulunmuyor.</p>';
                if (remindersCard) remindersCard.classList.add('hidden');
                return;
            }
            
            const reminders = [];
            const currentHour = new Date().getHours();
            
            // Sabah aÃ§Ä±lÄ±ÅŸ hatÄ±rlatmasÄ±
            if (cashTracker.dailyOpening === 0 && currentHour >= 9 && currentHour < 12) {
                reminders.push({
                    type: 'warning',
                    icon: 'ðŸŒ…',
                    title: 'Sabah AÃ§Ä±lÄ±ÅŸ KasasÄ±',
                    message: 'Sabah kasaya bÄ±rakÄ±lan parayÄ± kaydetmeyi unutmayÄ±nÄ±z!'
                });
            }
            
            // Bekleyen toptancÄ± Ã¶demeleri
            const pendingPayments = cashTracker.wholesalerPayments.filter(p => p.status === 'pending');
            if (pendingPayments.length > 0) {
                const totalPending = pendingPayments.reduce((sum, p) => sum + p.amount, 0);
                reminders.push({
                    type: 'info',
                    icon: 'ðŸ“‹',
                    title: 'Bekleyen Ã–demeler',
                    message: `${pendingPayments.length} toptancÄ± Ã¶demesi bekliyor (${totalPending.toLocaleString('tr-TR')} TL)`
                });
            }
            
            // AkÅŸam sayÄ±m hatÄ±rlatmasÄ±
            if (cashTracker.realCashCount === 0 && currentHour >= 18) {
                reminders.push({
                    type: 'warning',
                    icon: 'ðŸŒ™',
                    title: 'AkÅŸam SayÄ±mÄ±',
                    message: 'GÃ¼n sonunda kasayÄ± saymayÄ± unutmayÄ±nÄ±z!'
                });
            }
            
            // KÃ¶ÅŸeye ayrÄ±lan paralar
            const reservedPayments = cashTracker.wholesalerPayments.filter(p => p.status === 'reserved');
            if (reservedPayments.length > 0) {
                const totalReserved = reservedPayments.reduce((sum, p) => sum + p.amount, 0);
                reminders.push({
                    type: 'info',
                    icon: 'ðŸ’°',
                    title: 'KÃ¶ÅŸeye AyrÄ±lan',
                    message: `${totalReserved.toLocaleString('tr-TR')} TL kÃ¶ÅŸeye ayrÄ±lmÄ±ÅŸ para bulunuyor`
                });
            }
            
            if (reminders.length === 0) {
                container.innerHTML = '<p class="text-muted text-center">ðŸŽ‰ TÃ¼m iÅŸlemler tamamlanmÄ±ÅŸ!</p>';
                if (remindersCard) remindersCard.classList.add('hidden');
                return;
            }
            
            // Show reminders card if there are reminders
            if (remindersCard) remindersCard.classList.remove('hidden');
            
            let html = '';
            reminders.forEach(reminder => {
                const bgColor = reminder.type === 'warning' ? 'bg-yellow-50 border-yellow-200 text-yellow-800' :
                               reminder.type === 'info' ? 'bg-blue-50 border-blue-200 text-blue-800' :
                               'bg-gray-50 border-gray-200 text-gray-800';
                
                html += `
                    <div class="border rounded-lg p-3 ${bgColor}">
                        <div class="flex justify-between items-start">
                            <div>
                                <strong>${reminder.icon} ${reminder.title}</strong><br>
                                <span class="text-sm">${reminder.message}</span>
                            </div>
                            <button type="button" class="text-gray-500 hover:text-gray-700 ml-2" onclick="this.parentElement.parentElement.remove()">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        // ToptancÄ± Ã¶deme dÃ¼zenle
        function editWholesalerPayment(paymentId) {
            const payment = cashTracker.wholesalerPayments.find(p => p.id === paymentId);
            if (!payment) return;
            
            const modal = document.createElement('div');
            modal.className = 'modal-overlay';
            modal.innerHTML = `
                <div class="card w-full max-w-md relative">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xl font-bold text-slate-800">ToptancÄ± Ã–demeyi DÃ¼zenle</h3>
                        <button type="button" class="text-2xl font-bold text-slate-500 hover:text-slate-800" onclick="this.closest('.modal-overlay').remove()">&times;</button>
                    </div>
                    <div class="space-y-4">
                        <div>
                            <label for="editWholesalerName" class="block text-sm font-medium text-slate-700 mb-1">ToptancÄ± AdÄ±:</label>
                            <input type="text" id="editWholesalerName" class="input-field" value="${payment.name}" required>
                        </div>
                        <div>
                            <label for="editPaymentAmount" class="block text-sm font-medium text-slate-700 mb-1">Ã–deme TutarÄ± (TL):</label>
                            <input type="number" id="editPaymentAmount" class="input-field" value="${payment.amount}" min="0" step="0.01" required>
                        </div>
                        <div>
                            <label for="editPaymentStatus" class="block text-sm font-medium text-slate-700 mb-1">Durum:</label>
                            <select id="editPaymentStatus" class="input-field">
                                <option value="pending" ${payment.status === 'pending' ? 'selected' : ''}>Beklemede</option>
                                <option value="reserved" ${payment.status === 'reserved' ? 'selected' : ''}>KÃ¶ÅŸeye AyrÄ±ldÄ±</option>
                                <option value="paid" ${payment.status === 'paid' ? 'selected' : ''}>Ã–dendi</option>
                            </select>
                        </div>
                        <div>
                            <label for="editPaymentNote" class="block text-sm font-medium text-slate-700 mb-1">Not:</label>
                            <textarea id="editPaymentNote" class="input-field" rows="2">${payment.note || ''}</textarea>
                        </div>
                    </div>
                    <div class="flex justify-end space-x-4 mt-6">
                        <button type="button" class="btn btn-secondary" onclick="this.closest('.modal-overlay').remove()">Ä°ptal</button>
                        <button type="button" class="btn btn-primary" onclick="updateWholesalerPayment('${paymentId}')">GÃ¼ncelle</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            modal.style.display = 'flex';
        }
        
        // ToptancÄ± Ã¶deme gÃ¼ncelle
        function updateWholesalerPayment(paymentId) {
            const modal = document.querySelector('.modal-overlay:last-child');
            const name = modal.querySelector('#editWholesalerName').value.trim();
            const amount = parseFloat(modal.querySelector('#editPaymentAmount').value) || 0;
            const status = modal.querySelector('#editPaymentStatus').value;
            const note = modal.querySelector('#editPaymentNote').value.trim();
            
            if (!name || amount <= 0) {
                showToast('ToptancÄ± adÄ± ve geÃ§erli bir tutar giriniz.', 'error');
                return;
            }
            
            const paymentIndex = cashTracker.wholesalerPayments.findIndex(p => p.id === paymentId);
            if (paymentIndex !== -1) {
                cashTracker.wholesalerPayments[paymentIndex] = {
                    ...cashTracker.wholesalerPayments[paymentIndex],
                    name,
                    amount,
                    status,
                    note,
                    lastUpdated: new Date().toISOString()
                };
                
                saveCashTrackerData();
                updateCashTrackerDisplay();
                modal.remove();
                showToast('Ã–deme bilgileri gÃ¼ncellendi.', 'success');
            }
        }
        
        // ToptancÄ± Ã¶deme sil
        function deleteWholesalerPayment(paymentId) {
            const payment = cashTracker.wholesalerPayments.find(p => p.id === paymentId);
            if (!payment) return;
            
            if (confirm(`"${payment.name}" toptancÄ±sÄ±nÄ±n ${payment.amount.toLocaleString('tr-TR')} TL tutarÄ±ndaki Ã¶deme kaydÄ±nÄ± silmek istediÄŸinizden emin misiniz?`)) {
                cashTracker.wholesalerPayments = cashTracker.wholesalerPayments.filter(p => p.id !== paymentId);
                saveCashTrackerData();
                updateCashTrackerDisplay();
                showToast('Ã–deme kaydÄ± silindi.', 'success');
            }
        }
        
        // Yeni gÃ¼n baÅŸlatma onayÄ±
        function confirmStartNewDay() {
            if (confirm('Yeni gÃ¼n baÅŸlatmak istediÄŸinizden emin misiniz? Mevcut veriler geÃ§miÅŸ olarak kaydedilecek ve yeni gÃ¼n sÄ±fÄ±rdan baÅŸlayacaktÄ±r.')) {
                // Mevcut gÃ¼nÃ¼ geÃ§miÅŸe kaydet
                saveToHistory();
                // Yeni gÃ¼n baÅŸlat
                resetDailyCashTracker();
                updateCashTrackerDisplay();
                showToast('Yeni gÃ¼n baÅŸlatÄ±ldÄ±. Sabah aÃ§Ä±lÄ±ÅŸ kasasÄ±nÄ± kaydetmeyi unutmayÄ±nÄ±z!', 'success');
            }
        }
        
        // GeÃ§miÅŸe kaydet
        function saveToHistory() {
            const historyKey = `cashTracker_history_${cashTracker.date}`;
            const historyData = {
                ...cashTracker,
                closedAt: new Date().toISOString()
            };
            localStorage.setItem(historyKey, JSON.stringify(historyData));
        }
        
        // Kasa takip sekmesi aÃ§Ä±ldÄ±ÄŸÄ±nda Ã§alÄ±ÅŸacak fonksiyon
        
        // === TEMA SÄ°STEMÄ° ===
        
        // Tema durumu
        let currentTheme = localStorage.getItem('app-theme') || 'light';
        let currentColorScheme = localStorage.getItem('app-color-scheme') || 'emerald';
        
        // Tema baÅŸlatma
        function initializeTheme() {
            document.documentElement.setAttribute('data-theme', currentTheme);
            document.documentElement.setAttribute('data-color-scheme', currentColorScheme);
            updateThemeToggleButton();
        }
        
        // Tema deÄŸiÅŸtirme
        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            document.documentElement.setAttribute('data-theme', currentTheme);
            localStorage.setItem('app-theme', currentTheme);
            updateThemeToggleButton();
            showToast(`${currentTheme === 'dark' ? 'ðŸŒ™ KaranlÄ±k' : 'â˜€ï¸ AydÄ±nlÄ±k'} tema aktif edildi`, 'info');
        }
        
        // Renk ÅŸemasÄ± deÄŸiÅŸtirme
        function changeColorScheme(scheme) {
            currentColorScheme = scheme;
            document.documentElement.setAttribute('data-color-scheme', scheme);
            localStorage.setItem('app-color-scheme', scheme);
            
            const schemeNames = {
                'emerald': 'ðŸŸ¢ YeÅŸil',
                'blue': 'ðŸ”µ Mavi', 
                'purple': 'ðŸŸ£ Mor',
                'orange': 'ðŸŸ  Turuncu',
                'red': 'ðŸ”´ KÄ±rmÄ±zÄ±'
            };
            
            showToast(`${schemeNames[scheme]} renk temasÄ± seÃ§ildi`, 'success');
        }
        
        // Tema butonunu gÃ¼ncelle
        function updateThemeToggleButton() {
            const themeBtn = document.getElementById('theme-toggle-btn');
            if (themeBtn) {
                const icon = currentTheme === 'dark' ? 'â˜€ï¸' : 'ðŸŒ™';
                const text = currentTheme === 'dark' ? 'AydÄ±nlÄ±k' : 'KaranlÄ±k';
                themeBtn.innerHTML = `${icon} ${text}`;
            }
        }
        
        // Tema paneli oluÅŸturma
        function createThemePanel() {
            const panel = document.createElement('div');
            panel.id = 'theme-panel';
            panel.className = 'fixed top-4 right-4 z-50';
            panel.innerHTML = `
                <div class="card p-4 w-64 shadow-xl">
                    <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                        ðŸŽ¨ Tema AyarlarÄ±
                    </h3>
                    
                    <!-- Dark/Light Toggle -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">GÃ¶rÃ¼nÃ¼m</label>
                        <button onclick="toggleTheme()" 
                                class="btn btn-secondary w-full text-left">
                            ${currentTheme === 'dark' ? 'â˜€ï¸ AydÄ±nlÄ±k' : 'ðŸŒ™ KaranlÄ±k'}
                        </button>
                    </div>
                    
                    <!-- Color Schemes -->
                    <div class="mb-4">
                        <label class="block text-sm font-medium mb-2">Renk TemasÄ±</label>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="changeColorScheme('emerald')" 
                                    class="btn btn-secondary text-sm">
                                ðŸŸ¢ YeÅŸil
                            </button>
                            <button onclick="changeColorScheme('blue')" 
                                    class="btn btn-secondary text-sm">
                                ðŸ”µ Mavi
                            </button>
                            <button onclick="changeColorScheme('purple')" 
                                    class="btn btn-secondary text-sm">
                                ðŸŸ£ Mor
                            </button>
                            <button onclick="changeColorScheme('orange')" 
                                    class="btn btn-secondary text-sm">
                                ðŸŸ  Turuncu
                            </button>
                            <button onclick="changeColorScheme('red')" 
                                    class="btn btn-secondary text-sm">
                                ðŸ”´ KÄ±rmÄ±zÄ±
                            </button>
                        </div>
                    </div>
                    
                    <!-- Close Button -->
                    <button onclick="document.getElementById('theme-panel').remove()" 
                            class="btn btn-secondary w-full text-sm">
                        âœ• Kapat
                    </button>
                </div>
            `;
            
            document.body.appendChild(panel);
        }
        
        // Tema paneli toggle
        function toggleThemePanel() {
            const existingPanel = document.getElementById('theme-panel');
            if (existingPanel) {
                existingPanel.remove();
            } else {
                createThemePanel();
            }
        }

        // ====== Ä°ÅžLEM GEÃ‡MÄ°ÅžÄ° PANELÄ° EVENT LÄ°STENERLARI ======
        
        // History panel filter inputs
        if (el.historyStartDate) {
            el.historyStartDate.addEventListener('change', filterAndRenderSalesHistory);
        }
        if (el.historyEndDate) {
            el.historyEndDate.addEventListener('change', filterAndRenderSalesHistory);
        }
        if (el.historyTypeFilter) {
            el.historyTypeFilter.addEventListener('change', filterAndRenderSalesHistory);
        }
        if (el.historySearchInput) {
            el.historySearchInput.addEventListener('input', debounce(() => {
                currentHistoryPage = 1; // Reset to first page when searching
                filterAndRenderSalesHistory();
            }, 300));
            
            // Enter key to trigger immediate search
            el.historySearchInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    currentHistoryPage = 1;
                    filterAndRenderSalesHistory();
                }
            });
        }
        
        // Filter button
        if (el.filterHistoryBtn) {
            el.filterHistoryBtn.addEventListener('click', () => {
                currentHistoryPage = 1;
                filterAndRenderSalesHistory();
            });
        }
        
        // History pagination buttons
        if (el.prevHistoryPage) {
            el.prevHistoryPage.addEventListener('click', () => {
                if (currentHistoryPage > 1) {
                    currentHistoryPage--;
                    filterAndRenderSalesHistory();
                }
            });
        }
        if (el.nextHistoryPage) {
            el.nextHistoryPage.addEventListener('click', () => {
                const totalPages = Math.ceil(filteredHistorySales.length / historyItemsPerPage);
                if (currentHistoryPage < totalPages) {
                    currentHistoryPage++;
                    filterAndRenderSalesHistory();
                }
            });
        }
        
        // History table event delegation for edit/delete buttons
        if (el.salesHistoryLog) {
            el.salesHistoryLog.addEventListener('click', e => {
                const editBtn = e.target.closest('.edit-history-btn');
                const deleteBtn = e.target.closest('.delete-history-btn');
                
                if (editBtn) {
                    handleActionWithButton(editBtn, () => {
                        const saleId = editBtn.dataset.id;
                        const sale = allSales.find(s => s.id === saleId);
                        if (!sale) {
                            showToast('SatÄ±ÅŸ kaydÄ± bulunamadÄ±.', 'error');
                            return;
                        }
                        openEditSaleModal(saleId);
                    });
                } else if (deleteBtn) {
                    handleActionWithButton(deleteBtn, async () => {
                        const saleId = deleteBtn.dataset.id;
                        const sale = allSales.find(s => s.id === saleId);
                        if (!sale) {
                            showToast('SatÄ±ÅŸ kaydÄ± bulunamadÄ±.', 'error');
                            return;
                        }
                        
                        if (confirm(`"${sale.productName}" satÄ±ÅŸ kaydÄ±nÄ± silmek istediÄŸinizden emin misiniz?\n\nBu iÅŸlem geri alÄ±namaz.`)) {
                            try {
                                await deleteDocument(`sales/${saleId}`, "SatÄ±ÅŸ kaydÄ± baÅŸarÄ±yla silindi.");
                                // No need to manually refresh as the real-time listener will handle it
                            } catch (error) {
                                console.error('Delete error:', error);
                                showToast('Silme iÅŸlemi baÅŸarÄ±sÄ±z oldu. LÃ¼tfen tekrar deneyin.', 'error');
                            }
                        }
                    });
                }
            });
        }
        
        // Edit Sale Modal form submission
        if (el.editSaleForm) {
            el.editSaleForm.addEventListener('submit', (e) => {
                e.preventDefault();
                handleActionWithButton(e.submitter, async () => {
                    const saleId = el.editSaleModal.querySelector('#editSaleId').value;
                    const formData = new FormData(el.editSaleForm);
                    
                    const productName = el.editSaleModal.querySelector('#editSaleProductName').textContent.trim();
                    const totalCost = getSafeFloat(el.editSaleModal.querySelector('#editSaleCost').value);
                    const totalRevenue = getSafeFloat(el.editSaleModal.querySelector('#editSaleRevenue').value);
                    
                    if (productName && totalCost >= 0 && totalRevenue >= 0) {
                        const updateData = {
                            totalCost: totalCost,
                            totalRevenue: totalRevenue,
                            totalProfit: totalRevenue - totalCost,
                            lastUpdated: Timestamp.now()
                        };
                        
                        try {
                            await updateDocument(`sales/${saleId}`, updateData, "SatÄ±ÅŸ kaydÄ± baÅŸarÄ±yla gÃ¼ncellendi.");
                            closeModal(el.editSaleModal);
                            // No need to manually refresh as the real-time listener will handle it
                        } catch (error) {
                            console.error('Update error:', error);
                            showToast('GÃ¼ncelleme iÅŸlemi baÅŸarÄ±sÄ±z oldu. LÃ¼tfen tekrar deneyin.', 'error');
                            throw error;
                        }
                    } else {
                        showToast('LÃ¼tfen tÃ¼m alanlarÄ± doÄŸru doldurun (Maliyet >= 0, Ciro >= 0).', 'error');
                        throw new Error("Validation failed");
                    }
                });
            });
        }
        
        // Clear history filters button
        if (el.clearHistoryFilters) {
            el.clearHistoryFilters.addEventListener('click', () => {
                // Reset all filters
                if (el.historyStartDate) el.historyStartDate.value = '';
                if (el.historyEndDate) el.historyEndDate.value = '';
                if (el.historyTypeFilter) el.historyTypeFilter.value = 'all';
                if (el.historySearchInput) el.historySearchInput.value = '';
                
                currentHistoryPage = 1;
                filterAndRenderSalesHistory();
            });
        }
        
        // Global keyboard shortcuts for history panel
        document.addEventListener('keydown', (e) => {
            // Only activate when history panel is visible
            if (el.salesHistoryPanel && el.salesHistoryPanel.style.display !== 'none') {
                if (e.key === 'Escape' && !e.ctrlKey && !e.altKey) {
                    e.preventDefault();
                    // Clear filters
                    if (el.clearHistoryFilters) {
                        el.clearHistoryFilters.click();
                    }
                } else if (e.key === 'F5' || (e.ctrlKey && e.key === 'r')) {
                    e.preventDefault();
                    // Refresh data
                    filterAndRenderSalesHistory();
                }
            }
        });
        
        // ====== PERFORMANS OPTÄ°MÄ°ZASYONU - SADELEÅžTÄ°RÄ°LDÄ° ======
        
        // ULTRA FAST SCROLL HANDLING - TÃœM KASMA SORUNU Ã‡Ã–ZÃœLDÄ°
        let scrollTimeout = null;
        
        function handleScroll() {
            // Throttling ile sadece gerekli olduÄŸunda Ã§alÄ±ÅŸtÄ±r
            if (scrollTimeout) return;
            
            scrollTimeout = setTimeout(() => {
                scrollTimeout = null;
            }, 16); // 60fps iÃ§in 16ms
        }
        
        // Passive scroll listener - minimum kaynak kullanÄ±mÄ±
        window.addEventListener('scroll', handleScroll, { passive: true });
        
        // Wheel event basitleÅŸtirildi
        window.addEventListener('wheel', function(e) {
            // HiÃ§bir iÅŸlem yapma - sadece passive dinle
        }, { passive: true });
        
        // PERFORMANS Ä°Ã‡Ä°N TÃœM ANÄ°MASYONLAR TAMAMEN KAPALI
        const style = document.createElement('style');
        style.textContent = `
            /* TÃœM ANÄ°MASYONLAR DEVRE DIÅžI - MAKSIMUM PERFORMANS */
            *, *::before, *::after {
                animation: none !important;
                transition: none !important;
                transform: none !important;
                will-change: auto !important;
                backface-visibility: visible !important;
                perspective: none !important;
            }
            
            /* Sadece focus border'Ä± iÃ§in minimal geÃ§iÅŸ */
            .input-field:focus {
                transition: border-color 0.1s ease !important;
            }
        `;
        document.head.appendChild(style);

        // Start the application initialization process
        initializeAppCore();
    </script>
</body>
</html>
